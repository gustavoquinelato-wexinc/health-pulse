<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Pulse ETL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .user-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Prevent action buttons from wrapping */
        .table td:last-child {
            white-space: nowrap;
        }

        .btn-admin {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }



        .table-stats-card {
            transition: transform 0.2s ease-in-out;
        }

        .table-stats-card:hover {
            transform: translateY(-2px);
        }

        .collapse .card-body {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard" onclick="navigateToDashboard(event)">
                <i class="fas fa-tachometer-alt me-2"></i>Pulse ETL
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard" onclick="navigateToDashboard(event)">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-mappings">
                            <i class="fas fa-sitemap me-2"></i>Issue Type Mappings
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-hierarchies">
                            <i class="fas fa-layer-group me-2"></i>Issue Type Hierarchies
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/workflows">
                            <i class="fas fa-stream me-2"></i>Workflows
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/status-mappings">
                            <i class="fas fa-exchange-alt me-2"></i>Status Mappings
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-users-cog me-3"></i>Admin Panel
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage users, roles, and system settings</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-light text-dark fs-6">
                        <i class="fas fa-user me-1"></i>{{ user.email }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Navigation -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="h4 mb-0">System Overview</h2>
                        <p class="text-muted mb-0">Database statistics and system management</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshStats()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Statistics (Top Priority) -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-hdd fa-2x text-secondary mb-3"></i>
                        <h3 class="mb-1" id="database-size">-</h3>
                        <p class="text-muted mb-0">Database Size</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-table fa-2x text-dark mb-3"></i>
                        <h3 class="mb-1" id="table-count">-</h3>
                        <p class="text-muted mb-0">Active Tables</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-database fa-2x text-info mb-3"></i>
                        <h3 class="mb-1" id="total-records">-</h3>
                        <p class="text-muted mb-0">Total DB Records</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Details Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Database Table Statistics
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#databaseDetails" aria-expanded="false">
                            <i class="fas fa-chevron-down"></i> Details
                        </button>
                    </div>
                    <div class="collapse" id="databaseDetails">
                        <div class="card-body">
                            <div class="row" id="table-stats-container">
                                <!-- Table statistics will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-users fa-2x text-primary mb-3"></i>
                        <h3 class="mb-1" id="total-users">-</h3>
                        <p class="text-muted mb-0">Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-user-check fa-2x text-success mb-3"></i>
                        <h3 class="mb-1" id="active-users">-</h3>
                        <p class="text-muted mb-0">Active Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-user-clock fa-2x text-info mb-3"></i>
                        <h3 class="mb-1" id="logged-users">-</h3>
                        <p class="text-muted mb-0">Logged Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                    <div class="card-body">
                        <i class="fas fa-user-shield fa-2x text-warning mb-3"></i>
                        <h3 class="mb-1" id="admin-users">-</h3>
                        <p class="text-muted mb-0">Admin Users</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Sessions Management Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Active User Sessions
                            </h5>
                            <div>
                                <button class="btn btn-outline-danger btn-sm me-2" onclick="showTerminateAllSessionsModal()">
                                    <i class="fas fa-sign-out-alt"></i> Terminate All Sessions
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshActiveSessions()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th class="text-center">Role</th>
                                        <th>Login Time</th>
                                        <th>Last Activity</th>
                                        <th>IP Address</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="active-sessions-table-body">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading active sessions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integration Management Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-plug me-2"></i>Integration Management
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshIntegrations()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px;"></th>
                                        <th style="width: 150px;">Name</th>
                                        <th style="width: 250px;">Base URL</th>
                                        <th style="width: 140px;">Username</th>
                                        <th style="width: 100px;" class="text-center">Status</th>
                                        <th style="width: 120px;">Last Sync</th>
                                        <th style="width: 160px;" class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="integrations-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading integrations...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="row">
            <div class="col-12">
                <div class="card user-table">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>User Management
                                </h5>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary btn-sm me-2" onclick="showCreateUserModal()">
                                    <i class="fas fa-plus"></i> Add User
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshUsers()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th class="text-center">Role</th>
                                        <th class="text-center">Status</th>
                                        <th>Last Login</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Create New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="userFirstName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="userLastName">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" autocomplete="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Role *</label>
                            <select class="form-select" id="userRole" required>
                                <option value="view">View - Read-only access</option>
                                <option value="user" selected>User - Full access, no job control</option>
                                <option value="admin">Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="userPassword" class="form-label">Password (optional)</label>
                            <input type="password" class="form-control" id="userPassword" autocomplete="new-password">
                            <div class="form-text">Leave empty for SSO-only users</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="fas fa-save me-1"></i>Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>Edit User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editUserFirstName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editUserLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editUserLastName">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editUserEmail" autocomplete="username" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editUserRole" class="form-label">Role</label>
                            <select class="form-select" id="editUserRole">
                                <option value="view">View - Read-only access</option>
                                <option value="user">User - Full access, no job control</option>
                                <option value="admin">Admin - Full system access</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editUserActive">
                                <label class="form-check-label" for="editUserActive">
                                    Active user
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="fas fa-save me-1"></i>Update User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Permission Management -->
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="fas fa-shield-alt me-2"></i>Permission Management
                                </h5>
                                <small class="text-muted">Manage role-based permissions and custom user
                                    permissions</small>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-outline-secondary btn-sm" onclick="loadPermissionMatrix()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Permission Matrix -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="mb-3">Role Permission Matrix</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered" id="permission-matrix">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Resource</th>
                                                <th class="text-center">Admin</th>
                                                <th class="text-center">User</th>
                                                <th class="text-center">View</th>
                                            </tr>
                                        </thead>
                                        <tbody id="permission-matrix-body">
                                            <!-- Permission matrix will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Role-Based Access Control Info -->
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Role-Based Access Control
                                    </h6>
                                    <p class="mb-1">Permissions are managed through user roles:</p>
                                    <ul class="mb-2">
                                        <li><strong>Admin:</strong> Full system access including admin panel, user management, integration management, status/issue type mappings, and all ETL operations</li>
                                        <li><strong>User:</strong> Can view and use dashboards, view ETL status, download logs (no admin panel access)</li>
                                        <li><strong>View:</strong> Read-only access to dashboards and basic system information (no admin panel access)</li>
                                    </ul>
                                    <p class="mb-1"><small><strong>Admin Panel Access Includes:</strong></small></p>
                                    <ul class="mb-2" style="font-size: 0.875rem;">
                                        <li>User management and role assignment</li>
                                        <li>Integration configuration and management</li>
                                        <li>Status mappings for workflow standardization</li>
                                        <li>Issue type mappings for hierarchy management</li>
                                        <li>System statistics and database information</li>
                                    </ul>
                                    <p class="mb-1"><small><strong>Permission Levels:</strong></small></p>
                                    <ul class="mb-2" style="font-size: 0.875rem;">
                                        <li><span class="badge bg-success me-1">EXECUTE</span> includes read permissions
                                            (can perform actions)</li>
                                        <li><span class="badge bg-primary me-1">READ</span> view-only access</li>
                                    </ul>
                                    <p class="mt-2 mb-0"><small>To change a user's permissions, edit their role in the
                                            User Management section above.</small></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Integration Modal -->
    <div class="modal fade" id="editIntegrationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Integration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editIntegrationForm">
                        <input type="hidden" id="editIntegrationId">
                        <div class="mb-3">
                            <label for="editIntegrationName" class="form-label">Integration Name</label>
                            <input type="text" class="form-control" id="editIntegrationName" readonly>
                            <small class="text-muted">Integration name cannot be changed</small>
                        </div>
                        <div class="mb-3">
                            <label for="editBaseUrl" class="form-label">Base URL</label>
                            <input type="url" class="form-control" id="editBaseUrl" required>
                        </div>
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" autocomplete="username">
                            <small class="text-muted">Optional - leave empty if not required</small>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Password/Token</label>
                            <input type="password" class="form-control" id="editPassword" placeholder="Leave empty to keep current password" autocomplete="current-password">
                            <small class="text-muted">Current password is encrypted and hidden for security</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveIntegrationChanges()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Deactivation Modal -->
    <div class="modal fade" id="userDeactivationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="userDeactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmUserDeactivationBtn" onclick="confirmUserDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Deactivation Modal -->
    <div class="modal fade" id="integrationDeactivationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate Integration
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="integrationDeactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmIntegrationDeactivationBtn" onclick="confirmIntegrationDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminate All Sessions Modal -->
    <div class="modal fade" id="terminateAllSessionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-out-alt me-2"></i>Terminate All User Sessions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will immediately log out all users from the system, including yourself.
                    </div>
                    <p>Are you sure you want to terminate all active user sessions? This will:</p>
                    <ul>
                        <li>Force all users to log in again</li>
                        <li>Log you out immediately after confirmation</li>
                        <li>Invalidate all current authentication tokens</li>
                        <li>Interrupt any ongoing work</li>
                    </ul>
                    <p class="mb-0"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmTerminateAllSessions()">
                        <i class="fas fa-sign-out-alt me-1"></i>Terminate All Sessions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let users = [];
        let integrations = [];
        let stats = {};
        let activeSessions = [];
        let sessionValidationInterval = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function () {
            // Authentication is handled by middleware, load all admin data
            console.log('Admin page loaded, loading all data...');

            // Load all admin sections
            loadSystemStats();
            loadUserStats(); // Load user statistics from Backend Service
            loadUsers();
            loadIntegrations();
            loadActiveSessions();
            loadPermissionMatrix();

            // Note: Session validation disabled - middleware handles authentication
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (sessionValidationInterval) {
                clearInterval(sessionValidationInterval);
            }
        });

        // Get authentication token from cookie
        function getAuthToken() {
            // Try localStorage first (for compatibility)
            let token = localStorage.getItem('pulse_token') || localStorage.getItem('token');

            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'pulse_token') {
                        token = value;
                        break;
                    }
                }
            }

            return token;
        }

        // Session Validation and Management
        async function validateSession() {
            try {
                const token = getAuthToken();
                if (!token) {
                    redirectToLogin('No authentication token found');
                    return false;
                }

                const response = await fetch('/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    redirectToLogin('Session expired or invalid');
                    return false;
                }

                return response.ok;
            } catch (error) {
                console.error('Session validation error:', error);
                return true; // Don't redirect on network errors
            }
        }

        function redirectToLogin(reason) {
            console.log(`Redirecting to login: ${reason}`);
            // Clear any stored tokens
            localStorage.removeItem('pulse_token');
            localStorage.removeItem('token');
            // Clear cookie by setting it to expire
            document.cookie = 'pulse_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            // Stop session validation
            if (sessionValidationInterval) {
                clearInterval(sessionValidationInterval);
            }
            // Redirect to login
            window.location.href = `/login?error=session_expired&reason=${encodeURIComponent(reason)}`;
        }

        function navigateToDashboard(event) {
            event.preventDefault();
            console.log('Navigating to dashboard...');

            // Clear any session validation intervals
            if (sessionValidationInterval) {
                clearInterval(sessionValidationInterval);
            }

            // Navigate to dashboard
            window.location.href = '/dashboard';
        }

        function startSessionValidation() {
            // Validate session every 30 seconds
            sessionValidationInterval = setInterval(async () => {
                await validateSession();
                // Also refresh active sessions to keep the list current
                loadActiveSessions();
            }, 30000);
        }

        // Enhanced fetch wrapper that handles authentication errors
        async function authenticatedFetch(url, options = {}) {
            const token = getAuthToken();
            if (!token) {
                redirectToLogin('No authentication token found');
                return null;
            }

            // Add authorization header
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    redirectToLogin('Session expired or invalid');
                    return null;
                }

                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Active Sessions Management Functions
        async function loadActiveSessions() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    return;
                }

                const response = await fetch('http://localhost:3001/api/v1/admin/active-sessions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    activeSessions = await response.json();
                    updateActiveSessionsDisplay();
                } else {
                    console.error('Failed to load active sessions');
                    document.getElementById('active-sessions-table-body').innerHTML = `
                        <tr><td colspan="7" class="text-center text-danger">Failed to load active sessions</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading active sessions:', error);
                document.getElementById('active-sessions-table-body').innerHTML = `
                    <tr><td colspan="7" class="text-center text-danger">Error loading active sessions</td></tr>
                `;
            }
        }

        function updateActiveSessionsDisplay() {
            const tbody = document.getElementById('active-sessions-table-body');
            tbody.innerHTML = '';

            if (!activeSessions || activeSessions.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="text-center text-muted">No active sessions found</td></tr>
                `;
                return;
            }

            activeSessions.forEach(async (session) => {
                const row = document.createElement('tr');
                const loginTime = session.login_time ? new Date(session.login_time).toLocaleString() : 'Unknown';
                const lastActivity = session.last_activity ? new Date(session.last_activity).toLocaleString() : 'Unknown';
                const isCurrentUser = await isCurrentUserSession(session);

                // Highlight current user's session
                if (isCurrentUser) {
                    row.classList.add('table-warning');
                }

                const userNameDisplay = isCurrentUser ?
                    `${session.user_name || 'Unknown'} <span class="badge bg-info ms-1">YOU</span>` :
                    (session.user_name || 'Unknown');

                const terminateButton = isCurrentUser ?
                    `<button class="btn btn-sm btn-outline-danger" onclick="terminateUserSession('${session.session_id}')" title="Terminate Your Own Session">
                        <i class="fas fa-sign-out-alt"></i> <small>Self</small>
                    </button>` :
                    `<button class="btn btn-sm btn-outline-danger" onclick="terminateUserSession('${session.session_id}')" title="Terminate Session">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>`;

                row.innerHTML = `
                    <td>${userNameDisplay}</td>
                    <td>${session.email || 'Unknown'}</td>
                    <td class="text-center"><span class="badge ${getRoleBadgeClass(session.role || 'user')}">${(session.role || 'USER').toUpperCase()}</span></td>
                    <td>${loginTime}</td>
                    <td>${lastActivity}</td>
                    <td><small class="text-muted">${session.ip_address || 'Unknown'}</small></td>
                    <td class="text-end">
                        ${terminateButton}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshActiveSessions() {
            // Add visual feedback for manual refresh
            const refreshButton = document.querySelector('button[onclick="refreshActiveSessions()"]');
            const originalContent = refreshButton.innerHTML;

            refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshButton.disabled = true;

            loadActiveSessions().then(() => {
                // Restore button after refresh
                setTimeout(() => {
                    refreshButton.innerHTML = originalContent;
                    refreshButton.disabled = false;
                }, 500);
            });
        }

        function showTerminateAllSessionsModal() {
            new bootstrap.Modal(document.getElementById('terminateAllSessionsModal')).show();
        }

        async function confirmTerminateAllSessions() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    alert('Authentication required');
                    return;
                }

                // Call Backend Service directly to terminate all sessions
                const response = await fetch('http://localhost:3001/api/v1/admin/terminate-all-sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    // Check if the current user's session was terminated
                    // Since we're terminating ALL sessions, the current user's session is definitely included
                    alert('All sessions terminated successfully. You will be redirected to the login page.');

                    // Close modal first
                    bootstrap.Modal.getInstance(document.getElementById('terminateAllSessionsModal')).hide();

                    // Clear localStorage and redirect to login
                    localStorage.removeItem('pulse_token');
                    window.location.href = '/login?message=all_sessions_terminated';
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to terminate all sessions');
                }
            } catch (error) {
                console.error('Error terminating all sessions:', error);
                alert('Error terminating all sessions');
            }
        }

        async function terminateUserSession(sessionId) {
            // Check if this might be the user's own session
            const currentSession = activeSessions.find(session => session.session_id === sessionId);
            const isOwnSession = currentSession && await isCurrentUserSession(currentSession);

            let confirmMessage = 'Are you sure you want to terminate this user session?';
            if (isOwnSession) {
                confirmMessage = 'WARNING: You are about to terminate your own session!\n\nThis will immediately log you out and redirect you to the login page.\n\nAre you sure you want to continue?';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    alert('Authentication required');
                    return;
                }

                // Call Backend Service directly to terminate individual session
                const response = await fetch(`http://localhost:3001/api/v1/admin/terminate-session/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (isOwnSession) {
                        // User terminated their own session - immediate redirect
                        alert('Your session has been terminated. You will be redirected to the login page.');
                        localStorage.removeItem('pulse_token');
                        window.location.href = '/login?message=session_terminated';
                    } else {
                        alert(result.message || 'Session terminated successfully');
                        loadActiveSessions();
                    }
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to terminate session');
                }
            } catch (error) {
                console.error('Error terminating session:', error);
                alert('Error terminating session');
            }
        }

        // Helper function to check if a session is the current browser session
        async function isCurrentUserSession(session) {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.log('No token found for session comparison');
                    return false;
                }

                console.log(`Checking if session ${session.session_id} is current session...`);

                // Get current session info from Backend Service
                const response = await fetch('http://localhost:3001/api/v1/admin/current-session', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const currentSession = await response.json();
                    console.log(`Current session ID: ${currentSession.session_id}, Comparing with: ${session.session_id}`);

                    // Compare session IDs to identify the exact current session
                    const isCurrentSession = session.session_id === currentSession.session_id.toString();
                    console.log(`Session ${session.session_id} is current: ${isCurrentSession}`);
                    return isCurrentSession;
                } else {
                    console.warn('Failed to get current session info:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error checking current user session:', error);
                return false;
            }
        }

        // Refresh stats
        function refreshStats() {
            loadSystemStats();
            loadUserStats();
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const etlStats = await response.json();
                    // Preserve existing user stats and only update ETL-specific stats
                    stats = {
                        ...stats, // Keep existing stats (including user stats)
                        ...etlStats, // Add ETL stats
                        // Explicitly preserve user stats if they exist
                        total_users: stats.total_users || etlStats.total_users || 0,
                        active_users: stats.active_users || etlStats.active_users || 0,
                        logged_users: stats.logged_users || etlStats.logged_users || 0,
                        admin_users: stats.admin_users || etlStats.admin_users || 0,
                    };
                    updateStatsDisplay();
                } else {
                    console.error('Failed to load system stats');
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
            }
        }

        // Load user statistics from Backend Service
        async function loadUserStats() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    return;
                }

                const response = await fetch('http://localhost:3001/api/v1/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const backendStats = await response.json();
                    // Extract user statistics and merge with existing stats
                    stats = {
                        ...stats,
                        total_users: backendStats.total_users,
                        active_users: backendStats.active_users,
                        logged_users: backendStats.logged_users,
                        admin_users: backendStats.admin_users,
                        roles_distribution: backendStats.roles_distribution
                    };
                    updateStatsDisplay();
                } else {
                    console.error('Failed to load user stats from Backend Service');
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Update statistics display
        function updateStatsDisplay() {
            document.getElementById('total-users').textContent = stats.total_users || 0;
            document.getElementById('active-users').textContent = stats.active_users || 0;
            document.getElementById('logged-users').textContent = stats.logged_users || 0;
            document.getElementById('admin-users').textContent = stats.admin_users || 0;

            // Display total database records (from backend calculation)
            document.getElementById('total-records').textContent = (stats.total_records || 0).toLocaleString();

            // Display database size
            const sizeInMB = stats.database_size_mb || 0;
            let sizeDisplay;
            if (sizeInMB >= 1024) {
                // Convert to GB if >= 1024 MB
                sizeDisplay = (sizeInMB / 1024).toFixed(2) + ' GB';
            } else {
                sizeDisplay = sizeInMB.toFixed(2) + ' MB';
            }
            document.getElementById('database-size').textContent = sizeDisplay;

            // Display number of active tables (tables with records > 0)
            const dbStats = stats.database_stats || {};
            const activeTables = Object.values(dbStats).filter(count => count > 0).length;
            document.getElementById('table-count').textContent = activeTables;

            // Update detailed table statistics
            updateTableStatsDisplay(dbStats);
        }

        // Update detailed table statistics display
        function updateTableStatsDisplay(dbStats) {
            const container = document.getElementById('table-stats-container');
            container.innerHTML = '';

            // Define table display names and categories
            const tableCategories = {
                'Core Data': ['users', 'user_sessions', 'user_permissions', 'tenants', 'integrations'],
                'Work Items & Workflow': ['projects', 'work_items', 'changelogs', 'wits', 'statuses', 'statuses_mappings', 'workflows', 'wits_mappings', 'wits_hierarchies', 'projects_wits', 'projects_statuses'],
                'Development Data': ['repositories', 'prs', 'prs_commits', 'prs_reviews', 'prs_comments'],
                'Linking & Mapping': ['wits_prs_links'],
                'System': ['job_schedules', 'system_settings', 'migration_history']
            };

            // Create cards for each category
            Object.entries(tableCategories).forEach(([category, tables]) => {
                const categoryTotal = tables.reduce((sum, table) => sum + (dbStats[table] || 0), 0);

                const categoryCard = document.createElement('div');
                categoryCard.className = 'col-md-6 col-lg-4 mb-3';

                categoryCard.innerHTML = `
                    <div class="card h-100 table-stats-card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">${category}</h6>
                            <small class="text-muted">${categoryTotal.toLocaleString()} total records</small>
                        </div>
                        <div class="card-body p-2">
                            ${tables.map(table => {
                                const count = dbStats[table] || 0;
                                const displayName = table.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                return `
                                    <div class="d-flex justify-content-between align-items-center py-1">
                                        <small class="text-muted">${displayName}</small>
                                        <span class="badge ${count > 0 ? 'bg-primary' : 'bg-secondary'}">${count.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                container.appendChild(categoryCard);
            });
        }

        // Integration Management Functions
        async function loadIntegrations() {
            try {
                const response = await fetch('/api/v1/admin/integrations', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    integrations = await response.json();
                    updateIntegrationsDisplay(integrations);
                } else {
                    console.error('Failed to load integrations');
                    document.getElementById('integrations-table-body').innerHTML = `
                        <tr><td colspan="6" class="text-center text-danger">Failed to load integrations</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
                document.getElementById('integrations-table-body').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">Error loading integrations</td></tr>
                `;
            }
        }

        function updateIntegrationsDisplay(integrations) {
            const tbody = document.getElementById('integrations-table-body');
            tbody.innerHTML = '';

            if (!integrations || integrations.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">No integrations configured</td></tr>
                `;
                return;
            }

            integrations.forEach(integration => {
                const row = document.createElement('tr');
                const lastSync = integration.last_sync_at ?
                    new Date(integration.last_sync_at).toLocaleDateString() : 'Never';

                const statusBadge = integration.active ?
                    '<span class="badge bg-success">Active</span>' :
                    '<span class="badge bg-secondary">Inactive</span>';

                // Get integration icon and color based on name
                const integrationName = integration.name.toUpperCase();
                let icon = 'fas fa-plug';
                let iconColor = 'text-secondary';

                if (integrationName === 'GITHUB') {
                    icon = 'fab fa-github';
                    iconColor = 'text-dark';
                } else if (integrationName === 'JIRA') {
                    icon = 'fab fa-atlassian';
                    iconColor = 'text-primary';
                } else if (integrationName === 'AHA!') {
                    icon = 'fas fa-lightbulb';
                    iconColor = 'text-warning';
                } else if (integrationName === 'AZURE DEVOPS') {
                    icon = 'fab fa-microsoft';
                    iconColor = 'text-info';
                }

                // Add inactive row styling if needed
                if (!integration.active) {
                    row.classList.add('table-secondary', 'text-muted');
                }

                row.innerHTML = `
                    <td class="text-center"><i class="${icon} ${iconColor} fa-lg" title="${integration.name}"></i></td>
                    <td><strong>${integration.name.toUpperCase()}</strong></td>
                    <td><small class="text-muted">${integration.base_url || '-'}</small></td>
                    <td><small class="text-muted">${integration.username || '-'}</small></td>
                    <td class="text-center">${statusBadge}</td>
                    <td>${lastSync}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editIntegration(${integration.id}, '${integration.name}', '${integration.base_url || ''}', '${integration.username || ''}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${integration.active ? 'btn-outline-warning' : 'btn-outline-success'} me-1"
                                onclick="${integration.active ? 'showIntegrationDeactivationModal' : 'activateIntegration'}(${integration.id})"
                                title="${integration.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas ${integration.active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteIntegration(${integration.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshIntegrations() {
            loadIntegrations();
        }



        async function editIntegration(id, name, baseUrl, username) {
            try {
                // Fetch detailed integration data from the API
                const response = await fetch(`/api/v1/admin/integrations/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    const integrationDetails = await response.json();

                    // Populate the modal with current values
                    document.getElementById('editIntegrationId').value = integrationDetails.id;
                    document.getElementById('editIntegrationName').value = integrationDetails.name;
                    document.getElementById('editBaseUrl').value = integrationDetails.base_url || '';
                    document.getElementById('editUsername').value = integrationDetails.username || '';

                    // Show masked password if it exists
                    const passwordField = document.getElementById('editPassword');
                    if (integrationDetails.password_masked) {
                        passwordField.placeholder = integrationDetails.password_masked;
                        passwordField.value = ''; // Keep empty for new password entry
                    } else {
                        passwordField.placeholder = 'No password set';
                        passwordField.value = '';
                    }

                    // Show the modal
                    new bootstrap.Modal(document.getElementById('editIntegrationModal')).show();
                } else {
                    alert('Failed to load integration details');
                }
            } catch (error) {
                console.error('Error loading integration details:', error);
                alert('Error loading integration details');
            }
        }

        async function saveIntegrationChanges() {
            const id = document.getElementById('editIntegrationId').value;
            const baseUrl = document.getElementById('editBaseUrl').value;
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;

            if (!baseUrl) {
                alert('Base URL is required');
                return;
            }

            try {
                const updateData = {
                    base_url: baseUrl,
                    username: username || null
                };

                // Only include password if it's provided
                if (password) {
                    updateData.password = password;
                }

                const response = await fetch(`/api/v1/admin/integrations/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    // Close modal and refresh integrations
                    bootstrap.Modal.getInstance(document.getElementById('editIntegrationModal')).hide();
                    loadIntegrations();
                    alert('Integration updated successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed to update integration: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating integration:', error);
                alert('Error updating integration');
            }
        }



        // Load users
        async function loadUsers() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('http://localhost:3001/api/v1/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    users = await response.json();
                    updateUsersTable();
                } else {
                    console.error('Failed to load users');
                    if (response.status === 401) {
                        window.location.href = '/login?error=authentication_required';
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Get role badge class for consistent styling
        function getRoleBadgeClass(role) {
            switch (role.toLowerCase()) {
                case 'admin':
                    return 'bg-danger';     // Red for admin (matches other admin badges)
                case 'user':
                    return 'bg-primary';    // Blue for user
                case 'view':
                    return 'bg-secondary';  // Gray for view-only
                default:
                    return 'bg-secondary';  // Default to gray
            }
        }

        // Refresh users
        function refreshUsers() {
            loadUsers();
        }

        // Update users table
        function updateUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            // Sort users by name (first_name + last_name), then by email if no name
            const sortedUsers = [...users].sort((a, b) => {
                const nameA = ((a.first_name || '') + ' ' + (a.last_name || '')).trim() || a.email;
                const nameB = ((b.first_name || '') + ' ' + (b.last_name || '')).trim() || b.email;
                return nameA.toLowerCase().localeCompare(nameB.toLowerCase());
            });

            sortedUsers.forEach(user => {
                const row = document.createElement('tr');

                // Add inactive row styling if needed
                if (!user.active) {
                    row.classList.add('table-secondary', 'text-muted');
                }

                const fullName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || '-';
                const isCurrentUser = user.email === '{{ user.email }}';

                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${user.email}</td>
                    <td class="text-center"><span class="badge ${getRoleBadgeClass(user.role)}">${user.role.toUpperCase()}</span></td>
                    <td class="text-center">
                        ${user.active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>'
                    }
                    </td>
                    <td>${user.last_login_at ? new Date(user.last_login_at).toLocaleDateString() : 'Never'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${user.active ? 'btn-outline-warning' : 'btn-outline-success'} me-1"
                                onclick="${user.active ? 'showUserDeactivationModal' : 'activateUser'}(${user.id})"
                                title="${user.active ? 'Deactivate' : 'Activate'}"
                                ${isCurrentUser ? 'disabled' : ''}>
                            <i class="fas ${user.active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})"
                                title="Delete"
                                ${isCurrentUser ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show create user modal
        function showCreateUserModal() {
            document.getElementById('createUserForm').reset();
            new bootstrap.Modal(document.getElementById('createUserModal')).show();
        }

        // Create user
        async function createUser() {
            const role = document.getElementById('userRole').value;
            const formData = {
                email: document.getElementById('userEmail').value,
                first_name: document.getElementById('userFirstName').value || null,
                last_name: document.getElementById('userLastName').value || null,
                role: role,
                is_admin: role === 'admin',  // Automatically set based on role
                password: document.getElementById('userPassword').value || null
            };

            try {
                const token = getAuthToken();
                if (!token) {
                    alert('Authentication required. Please login again.');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('http://localhost:3001/api/v1/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    loadUsers();
                    loadSystemStats();
                    alert('User created successfully!');
                } else {
                    const error = await response.json();
                    alert('Error creating user: ' + error.detail);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user');
            }
        }

        // Edit user
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserFirstName').value = user.first_name || '';
            document.getElementById('editUserLastName').value = user.last_name || '';
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserActive').checked = user.active;

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        // Update user
        async function updateUser() {
            const userId = document.getElementById('editUserId').value;
            const role = document.getElementById('editUserRole').value;
            const formData = {
                first_name: document.getElementById('editUserFirstName').value || null,
                last_name: document.getElementById('editUserLastName').value || null,
                role: role,
                is_admin: role === 'admin',  // Automatically set based on role
                active: document.getElementById('editUserActive').checked
            };

            try {
                const token = getAuthToken();
                if (!token) {
                    alert('Authentication required. Please login again.');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch(`http://localhost:3001/api/v1/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadUsers();
                    loadSystemStats();
                    alert('User updated successfully!');
                } else {
                    const error = await response.json();
                    alert('Error updating user: ' + error.detail);
                }
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            if (!confirm(`Are you sure you want to delete user ${user.email}?\n\nThis action cannot be undone.`)) return;

            try {
                const token = getAuthToken();
                if (!token) {
                    alert('Authentication required. Please login again.');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch(`http://localhost:3001/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    loadUsers();
                    loadSystemStats();
                    alert(result.message || 'User permanently deleted successfully!');
                } else {
                    const error = await response.json();
                    alert(`Failed to delete user: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }

        // Permission Management Functions
        let permissionMatrix = {};

        // Load permission matrix
        async function loadPermissionMatrix() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('http://localhost:3001/api/v1/admin/permissions/matrix', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    permissionMatrix = await response.json();
                    displayPermissionMatrix();
                } else {
                    console.error('Failed to load permission matrix');
                }
            } catch (error) {
                console.error('Error loading permission matrix:', error);
            }
        }

        // Display permission matrix
        function displayPermissionMatrix() {
            const tbody = document.getElementById('permission-matrix-body');
            tbody.innerHTML = '';

            if (!permissionMatrix.resources) return;

            permissionMatrix.resources.forEach(resource => {
                const row = document.createElement('tr');

                // Resource name with better formatting
                const resourceCell = document.createElement('td');
                const resourceDisplayNames = {
                    'etl_jobs': 'ETL Jobs',
                    'orchestrator': 'Orchestrator',
                    'dashboards': 'Dashboards',
                    'logs': 'Logs',
                    'settings': 'Settings',
                    'users': 'Users',
                    'integrations': 'Integrations',
                    'admin_panel': 'Admin Panel',
                    'log_download': 'Log Download'
                };
                const displayName = resourceDisplayNames[resource] || resource.replace('_', ' ').toUpperCase();
                resourceCell.innerHTML = `<strong>${displayName}</strong>`;
                row.appendChild(resourceCell);

                // Role permissions
                permissionMatrix.roles.forEach(role => {
                    const cell = document.createElement('td');
                    cell.className = 'text-center';

                    const actions = permissionMatrix.matrix[role][resource] || [];
                    if (actions.length > 0) {
                        // Filter out 'admin' action for cleaner display and sort actions
                        const filteredActions = actions.filter(action => action !== 'admin').sort();
                        const hasAdminAccess = actions.includes('admin');

                        if (hasAdminAccess) {
                            cell.innerHTML = '<span class="badge bg-danger">FULL ACCESS</span>';
                        } else if (filteredActions.length > 0) {
                            // Show only the highest level permission (hierarchy: EXECUTE > READ)
                            let highestAction = '';
                            let badgeClass = '';

                            if (filteredActions.includes('execute')) {
                                highestAction = 'EXECUTE';
                                badgeClass = 'bg-success'; // green for execute
                            } else if (filteredActions.includes('read')) {
                                highestAction = 'READ';
                                badgeClass = 'bg-primary'; // blue for read
                            }

                            if (highestAction) {
                                // Add tooltip explaining permission hierarchy
                                let tooltip = '';
                                if (highestAction === 'EXECUTE') {
                                    tooltip = 'Can execute and read';
                                } else if (highestAction === 'READ') {
                                    tooltip = 'Can read only';
                                }

                                cell.innerHTML = `<span class="badge ${badgeClass}" title="${tooltip}">${highestAction}</span>`;
                            } else {
                                cell.innerHTML = '<span class="text-muted">-</span>';
                            }
                        } else {
                            cell.innerHTML = '<span class="text-muted">-</span>';
                        }
                    } else {
                        cell.innerHTML = '<span class="text-muted">-</span>';
                    }

                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Enhanced User Management Functions
        let currentDeactivationUserId = null;

        async function showUserDeactivationModal(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                currentDeactivationUserId = id;
                const user = users.find(u => u.id === id);

                document.getElementById('userDeactivationContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Deactivate User:</strong> ${user.first_name} ${user.last_name} (${user.email})
                    </div>
                    <p>This user will be deactivated and will no longer be able to access the system.</p>
                    <input type="hidden" name="deactivationAction" value="deactivate">
                `;

                new bootstrap.Modal(document.getElementById('userDeactivationModal')).show();
            } catch (error) {
                console.error('Error showing user deactivation modal:', error);
                alert('Error showing deactivation modal');
            }
        }

        async function confirmUserDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`http://localhost:3001/api/v1/admin/users/${currentDeactivationUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ active: false })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('User deactivated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('userDeactivationModal')).hide();
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate user: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deactivating user:', error);
                alert('Error deactivating user');
            }
        }

        async function activateUser(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`http://localhost:3001/api/v1/admin/users/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ active: true })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('User activated successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate user: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating user:', error);
                alert('Error activating user');
            }
        }

        // Enhanced Integration Management Functions
        let currentDeactivationIntegrationId = null;

        async function showIntegrationDeactivationModal(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                currentDeactivationIntegrationId = id;
                const integration = integrations.find(i => i.id === id);

                document.getElementById('integrationDeactivationContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Deactivate Integration:</strong> ${integration.name}
                    </div>
                    <p>This integration will be deactivated and will no longer sync data.</p>
                    <input type="hidden" name="deactivationAction" value="deactivate">
                `;

                new bootstrap.Modal(document.getElementById('integrationDeactivationModal')).show();
            } catch (error) {
                console.error('Error showing integration deactivation modal:', error);
                alert('Error showing deactivation modal');
            }
        }

        async function confirmIntegrationDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/integrations/${currentDeactivationIntegrationId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'deactivate' })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Integration deactivated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('integrationDeactivationModal')).hide();
                    loadIntegrations();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate integration: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deactivating integration:', error);
                alert('Error deactivating integration');
            }
        }

        async function activateIntegration(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/integrations/${id}/activate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Integration activated successfully');
                    loadIntegrations();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate integration: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating integration:', error);
                alert('Error activating integration');
            }
        }

        async function deleteIntegration(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                if (confirm('Are you sure you want to delete this integration?\n\nThis action cannot be undone.')) {
                    const response = await fetch(`/api/v1/admin/integrations/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message || 'Integration deleted successfully');
                        loadIntegrations();
                    } else {
                        const error = await response.json();
                        alert(`Failed to delete integration: ${error.detail}`);
                    }
                }
            } catch (error) {
                console.error('Error deleting integration:', error);
                alert('Error deleting integration');
            }
        }

        // Logout function
        async function logout() {
            try {
                // Get token before clearing localStorage
                const token = getAuthToken();

                if (token) {
                    console.log('Admin logout: Calling Backend Service to invalidate session...');
                    // Call Backend Service directly to invalidate session
                    const response = await fetch('http://localhost:3001/api/v1/admin/auth/invalidate-session', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        console.log('Γ£à Admin logout: Session invalidated successfully');
                    } else {
                        console.warn('Γ¥î Admin logout: Session invalidation failed:', response.status);
                    }
                } else {
                    console.log('Admin logout: No token found for session invalidation');
                }
            } catch (error) {
                console.warn('Admin logout: Session invalidation error:', error);
            }

            // Clear localStorage
            localStorage.removeItem('pulse_token');

            // ETL service logout to clear cookies and redirect
            window.location.href = '/logout';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadSystemStats();
            loadUsers();
            loadPermissionMatrix();
        });
    </script>
</body>

</html>
