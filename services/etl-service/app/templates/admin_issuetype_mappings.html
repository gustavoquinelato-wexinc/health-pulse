<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Type Mappings - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .stats-card {
            transition: transform 0.2s ease-in-out;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }

        /* Sortable column styles */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }

        .sortable.sort-asc i:before {
            content: "\f0de";
            opacity: 1;
        }

        .sortable.sort-desc i:before {
            content: "\f0dd";
            opacity: 1;
        }

        /* Hierarchy level colors */
        .hierarchy-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .hierarchy-4 {
            background-color: #dc3545;
            color: white;
        }

        .hierarchy-3 {
            background-color: #e91e63;
            color: white;
        }

        .hierarchy-2 {
            background-color: #9c27b0;
            color: white;
        }

        .hierarchy-1 {
            background-color: #ff9800;
            color: white;
        }

        .hierarchy-0 {
            background-color: #198754;
            color: white;
        }

        .hierarchy--1 {
            background-color: #0d6efd;
            color: white;
        }

        .hierarchy-other {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Pulse ETL
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item active" href="/admin/issuetype-mappings">
                            <i class="fas fa-sitemap me-2"></i>Issue Type Mappings
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-hierarchies">
                            <i class="fas fa-layer-group me-2"></i>Issue Type Hierarchies
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/workflows">
                            <i class="fas fa-stream me-2"></i>Workflows
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/status-mappings">
                            <i class="fas fa-exchange-alt me-2"></i>Status Mappings
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-tags me-3"></i>Issue Type Mappings
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage issue type mappings for standardization</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Issue Type Mappings Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Issue Type Mappings
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshIssueTypeMappings()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showCreateIssueTypeMappingModal()">
                                    <i class="fas fa-plus"></i> Add Mapping
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filters -->
                        <div class="row mb-3">
                            <div class="col-lg-3 col-md-4">
                                <label for="searchIssueType" class="form-label text-dark fw-bold">Search Issue Type Mappings</label>
                                <input type="text" class="form-control" id="searchIssueType" placeholder="Search issue types..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterToIssueType" class="form-label text-dark fw-bold">To Issue Type</label>
                                <select class="form-select" id="filterToIssueType" onchange="applyFilters()">
                                    <option value="">All To Types</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterHierarchyLevel" class="form-label text-dark fw-bold">Hierarchy Level</label>
                                <select class="form-select" id="filterHierarchyLevel" onchange="applyFilters()">
                                    <option value="">All Levels</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterIntegration" class="form-label text-dark fw-bold">Integration</label>
                                <select class="form-select" id="filterIntegration" onchange="applyFilters()">
                                    <option value="">All Integrations</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-3">
                                <label for="filterActive" class="form-label text-dark fw-bold">Status</label>
                                <select class="form-select" id="filterActive" onchange="applyFilters()">
                                    <option value="">All Statuses</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" onclick="sortTable('issuetype_from')">
                                            From Issue Type <i class="fas fa-sort" id="sort-issuetype_from"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('issuetype_to')">
                                            To Issue Type <i class="fas fa-sort" id="sort-issuetype_to"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('hierarchy_name')">
                                            Hierarchy Name <i class="fas fa-sort" id="sort-hierarchy_name"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('hierarchy_level')">
                                            Level Number <i class="fas fa-sort" id="sort-hierarchy_level"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('integration_name')">
                                            Integration <i class="fas fa-sort" id="sort-integration_name"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('active')">
                                            Status <i class="fas fa-sort" id="sort-active"></i>
                                        </th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="issuetype-mappings-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading issue type mappings...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Issue Type Mapping Modal -->
    <div class="modal fade" id="issueTypeMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="issueTypeMappingModalTitle">Add Issue Type Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="issueTypeMappingForm">
                        <div class="mb-3">
                            <label for="issueTypeFrom" class="form-label">From Issue Type</label>
                            <input type="text" class="form-control" id="issueTypeFrom" required>
                        </div>
                        <div class="mb-3">
                            <label for="issueTypeTo" class="form-label">To Issue Type</label>
                            <input type="text" class="form-control" id="issueTypeTo" required>
                        </div>
                        <div class="mb-3">
                            <label for="hierarchyLevel" class="form-label">Hierarchy Level</label>
                            <select class="form-select" id="hierarchyLevel" required>
                                <option value="">Select Level</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="integration" class="form-label">Integration</label>
                            <select class="form-control" id="integration">
                                <option value="">Select Integration</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveIssueTypeMapping()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivation Modal -->
    <div class="modal fade" id="deactivationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate Issue Type Mapping
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="deactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmDeactivationBtn" onclick="confirmDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let issueTypeMappings = [];
        let filteredMappings = [];
        let integrations = [];
        let editingMappingId = null;
        let currentSort = { column: 'hierarchy_level', direction: 'desc' };

        // Load integrations
        async function loadIntegrations() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/integrations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    integrations = await response.json();
                    populateIntegrationDropdown();
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
            }
        }

        function populateIntegrationDropdown() {
            const integrationSelect = document.getElementById('integration');
            const filterSelect = document.getElementById('filterIntegration');

            integrationSelect.innerHTML = '<option value="">Select Integration</option>';
            filterSelect.innerHTML = '<option value="">All Integrations</option>';

            integrations.forEach(integration => {
                if (integration.active) {
                    const option = new Option(integration.name, integration.id);
                    const filterOption = new Option(integration.name, integration.name);
                    integrationSelect.appendChild(option);
                    filterSelect.appendChild(filterOption);
                }
            });
        }

        // Get integration icon and color
        function getIntegrationIcon(integrationName) {
            if (!integrationName) return '<i class="fas fa-plug text-secondary"></i>';

            const name = integrationName.toUpperCase();
            let icon = 'fas fa-plug';
            let iconColor = 'text-secondary';

            if (name === 'GITHUB') {
                icon = 'fab fa-github';
                iconColor = 'text-dark';
            } else if (name === 'JIRA') {
                icon = 'fab fa-atlassian';
                iconColor = 'text-primary';
            } else if (name === 'AHA!') {
                icon = 'fas fa-lightbulb';
                iconColor = 'text-warning';
            } else if (name === 'AZURE DEVOPS') {
                icon = 'fab fa-microsoft';
                iconColor = 'text-info';
            }

            return `<i class="${icon} ${iconColor}"></i>`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadIssueTypeMappings();
            loadHierarchies();
            loadIntegrations();
            updateSortIndicators();
        });

        // Get authentication token from cookie
        function getAuthToken() {
            // Try localStorage first (for compatibility)
            let token = localStorage.getItem('pulse_token') || localStorage.getItem('token');

            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'pulse_token' || name === 'access_token') {
                        token = value;
                        break;
                    }
                }
            }

            return token;
        }

        // Load issue type mappings
        async function loadIssueTypeMappings() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('/api/v1/admin/issuetype-mappings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    issueTypeMappings = await response.json();
                    filteredMappings = [...issueTypeMappings]; // Initialize filtered data
                    populateFilters();
                    updateIssueTypeMappingsDisplay();
                } else if (response.status === 401) {
                    console.error('Authentication failed');
                    window.location.href = '/login?error=authentication_expired';
                } else {
                    console.error('Failed to load issue type mappings');
                    document.getElementById('issuetype-mappings-table-body').innerHTML = `
                        <tr><td colspan="4" class="text-center text-danger">Failed to load issue type mappings</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading issue type mappings:', error);
                document.getElementById('issuetype-mappings-table-body').innerHTML = `
                    <tr><td colspan="4" class="text-center text-danger">Error loading issue type mappings</td></tr>
                `;
            }
        }

        function populateFilters() {
            // Populate To Issue Type filter
            const toIssueTypeSet = new Set(issueTypeMappings.map(m => m.issuetype_to));
            const toIssueTypeSelect = document.getElementById('filterToIssueType');
            toIssueTypeSelect.innerHTML = '<option value="">All To Issue Types</option>';
            Array.from(toIssueTypeSet).sort().forEach(issueType => {
                toIssueTypeSelect.add(new Option(issueType, issueType));
            });
        }

        function updateIssueTypeMappingsDisplay() {
            const tbody = document.getElementById('issuetype-mappings-table-body');
            tbody.innerHTML = '';

            if (!filteredMappings || filteredMappings.length === 0) {
                const message = issueTypeMappings.length === 0 ? 'No issue type mappings found' : 'No mappings match the current filters';
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">${message}</td></tr>
                `;
                return;
            }

            filteredMappings.forEach(mapping => {
                const row = document.createElement('tr');

                // Add inactive row styling if needed
                if (!mapping.active) {
                    row.classList.add('table-secondary', 'text-muted');
                }

                // Get hierarchy color class
                const hierarchyClass = getHierarchyColorClass(mapping.hierarchy_level);

                // Prepare hierarchy name and number for separate columns
                const hierarchyName = mapping.hierarchy_name || 'Unknown';
                const hierarchyNumber = mapping.hierarchy_level;

                row.innerHTML = `
                    <td>${mapping.issuetype_from}</td>
                    <td>${mapping.issuetype_to}</td>
                    <td class="text-center">
                        <span class="hierarchy-badge ${hierarchyClass}">${hierarchyName}</span>
                    </td>
                    <td class="text-center">
                        ${hierarchyNumber}
                    </td>
                    <td class="text-center">${getIntegrationIcon(mapping.integration_name)}</td>
                    <td class="text-center">
                        ${mapping.active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'
                        }
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editIssueTypeMapping(${mapping.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${mapping.active ? 'btn-outline-warning' : 'btn-outline-success'} me-1"
                                onclick="${mapping.active ? 'showDeactivationModal' : 'activateIssueTypeMapping'}(${mapping.id})"
                                title="${mapping.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas ${mapping.active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteIssueTypeMapping(${mapping.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshIssueTypeMappings() {
            loadIssueTypeMappings();
        }

        // Load hierarchies for dropdown
        async function loadHierarchies() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/issuetype-hierarchies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const hierarchies = await response.json();

                    // Populate the hierarchy dropdown
                    const hierarchySelect = document.getElementById('hierarchyLevel');

                    // Clear existing options except the first one
                    hierarchySelect.innerHTML = '<option value="">Select Level</option>';

                    // Add active hierarchies only
                    hierarchies
                        .filter(h => h.active)
                        .sort((a, b) => b.level_number - a.level_number) // Sort by level number descending
                        .forEach(hierarchy => {
                            const option = document.createElement('option');
                            option.value = hierarchy.level_number;
                            option.textContent = `${hierarchy.level_name} (${hierarchy.level_number})`;
                            option.dataset.hierarchyId = hierarchy.id;
                            hierarchySelect.appendChild(option);
                        });

                    // Also update the filter dropdown
                    const filterSelect = document.getElementById('filterHierarchyLevel');
                    if (filterSelect) {
                        // Clear existing options except the first one
                        filterSelect.innerHTML = '<option value="">All Levels</option>';

                        hierarchies
                            .filter(h => h.active)
                            .sort((a, b) => b.level_number - a.level_number)
                            .forEach(hierarchy => {
                                const option = document.createElement('option');
                                option.value = hierarchy.level_number;
                                option.textContent = `${hierarchy.level_name} (${hierarchy.level_number})`;
                                filterSelect.appendChild(option);
                            });
                    }
                } else {
                    console.error('Failed to load hierarchies');
                }
            } catch (error) {
                console.error('Error loading hierarchies:', error);
            }
        }

        function showCreateIssueTypeMappingModal() {
            editingMappingId = null;
            document.getElementById('issueTypeMappingModalTitle').textContent = 'Add Issue Type Mapping';
            document.getElementById('issueTypeMappingForm').reset();

            // Populate integration dropdown
            populateIntegrationDropdown();

            new bootstrap.Modal(document.getElementById('issueTypeMappingModal')).show();
        }

        function editIssueTypeMapping(id) {
            alert(`Edit issue type mapping ${id} - To be implemented`);
        }

        async function deleteIssueTypeMapping(id) {
            // First check if this mapping has dependencies
            try {
                const token = getAuthToken();
                if (!token) return;

                // Check dependencies first
                const depResponse = await fetch(`/api/v1/admin/issuetype-mappings/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (depResponse.ok) {
                    const depData = await depResponse.json();

                    if (!depData.has_dependencies) {
                        // Safe to delete - confirm with user
                        const mapping = issueTypeMappings.find(m => m.id === id);
                        if (confirm(`Are you sure you want to permanently delete the mapping "${mapping.issuetype_from} → ${mapping.issuetype_to}"?\n\nThis action cannot be undone.`)) {
                            await performDelete(id);
                        }
                        return;
                    }
                }

                // Has dependencies - open deactivation modal with delete context
                await showDeactivationModal(id, true); // true indicates delete context
            } catch (error) {
                console.error('Error checking dependencies:', error);
                // Fallback to modal
                await showDeactivationModal(id, true);
            }
        }

        async function performDelete(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/issuetype-mappings/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Issue type mapping deleted successfully');
                    // Close modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deactivationModal'));
                    if (modal) modal.hide();
                    loadIssueTypeMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting mapping:', error);
                alert('Error deleting mapping');
            }
        }

        function getHierarchyColorClass(level) {
            switch(level) {
                case 4: return 'hierarchy-4';   // Level 4 - Red
                case 3: return 'hierarchy-3';   // Level 3 - Pink
                case 2: return 'hierarchy-2';   // Level 2 - Purple
                case 1: return 'hierarchy-1';   // Level 1 - Orange
                case 0: return 'hierarchy-0';   // Level 0 - Green
                case -1: return 'hierarchy--1'; // Level -1 - Blue
                default: return 'hierarchy-other'; // Other levels - Gray
            }
        }

        // Filtering functionality
        function applyFilters() {
            const searchTerm = document.getElementById('searchIssueType').value.toLowerCase();
            const filterToIssueType = document.getElementById('filterToIssueType').value;
            const filterHierarchyLevel = document.getElementById('filterHierarchyLevel').value;
            const filterIntegration = document.getElementById('filterIntegration').value;
            const filterActive = document.getElementById('filterActive').value;

            filteredMappings = issueTypeMappings.filter(mapping => {
                const matchesSearch = !searchTerm ||
                    mapping.issuetype_from.toLowerCase().includes(searchTerm) ||
                    mapping.issuetype_to.toLowerCase().includes(searchTerm) ||
                    (mapping.hierarchy_name && mapping.hierarchy_name.toLowerCase().includes(searchTerm));

                const matchesToIssueType = !filterToIssueType ||
                    mapping.issuetype_to === filterToIssueType;

                const matchesHierarchyLevel = !filterHierarchyLevel ||
                    mapping.hierarchy_level.toString() === filterHierarchyLevel;

                const matchesIntegration = !filterIntegration ||
                    mapping.integration_name === filterIntegration;

                const matchesActive = !filterActive ||
                    mapping.active.toString() === filterActive;

                return matchesSearch && matchesToIssueType && matchesHierarchyLevel && matchesIntegration && matchesActive;
            });

            // Re-apply current sort to filtered data
            if (currentSort.column) {
                sortTable(currentSort.column);
            } else {
                updateIssueTypeMappingsDisplay();
            }
        }

        // Sorting functionality
        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Sort the filtered data
            filteredMappings.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle numeric sorting for hierarchy_level
                if (column === 'hierarchy_level') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                }
                // Handle hierarchy_name sorting
                else if (column === 'hierarchy_name') {
                    aVal = (a.hierarchy_name || 'Unknown').toLowerCase();
                    bVal = (b.hierarchy_name || 'Unknown').toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            updateSortIndicators();
            updateIssueTypeMappingsDisplay();
        }

        function updateSortIndicators() {
            // Reset all sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Set current sort indicator
            if (currentSort.column) {
                const currentTh = document.querySelector(`#sort-${currentSort.column}`);
                if (currentTh) {
                    currentTh.parentElement.classList.add(`sort-${currentSort.direction}`);
                }
            }
        }

        function editIssueTypeMapping(id) {
            // Find the mapping to edit
            const mapping = issueTypeMappings.find(m => m.id === id);
            if (!mapping) {
                alert('Mapping not found');
                return;
            }

            // Populate the form with existing data
            editingMappingId = id;
            document.getElementById('issueTypeMappingModalTitle').textContent = 'Edit Issue Type Mapping';
            document.getElementById('issueTypeFrom').value = mapping.issuetype_from;
            document.getElementById('issueTypeTo').value = mapping.issuetype_to;

            // Set the hierarchy level dropdown value
            const hierarchySelect = document.getElementById('hierarchyLevel');
            hierarchySelect.value = mapping.hierarchy_level;

            // If the value doesn't exist in the dropdown (e.g., hierarchy was deleted/deactivated), add it temporarily
            if (hierarchySelect.value !== mapping.hierarchy_level.toString()) {
                const option = document.createElement('option');
                option.value = mapping.hierarchy_level;
                option.textContent = `${mapping.hierarchy_level} - ${mapping.hierarchy_name || 'Level ' + mapping.hierarchy_level} (Inactive)`;
                option.style.color = '#dc3545'; // Red color to indicate inactive
                option.style.fontStyle = 'italic';
                hierarchySelect.appendChild(option);
                hierarchySelect.value = mapping.hierarchy_level;
            }

            // Set the integration dropdown value
            const integrationSelect = document.getElementById('integration');
            integrationSelect.value = mapping.integration_id || '';

            // Show the modal
            new bootstrap.Modal(document.getElementById('issueTypeMappingModal')).show();
        }

        async function saveIssueTypeMapping() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const issueTypeFrom = document.getElementById('issueTypeFrom').value.trim();
                const issueTypeTo = document.getElementById('issueTypeTo').value.trim();
                const hierarchyLevel = document.getElementById('hierarchyLevel').value;
                const integrationId = document.getElementById('integration').value;

                if (!issueTypeFrom || !issueTypeTo || !hierarchyLevel) {
                    alert('Please fill in all required fields');
                    return;
                }

                const data = {
                    issuetype_from: issueTypeFrom,
                    issuetype_to: issueTypeTo,
                    hierarchy_level: parseInt(hierarchyLevel),
                    integration_id: integrationId || null
                };

                let response;
                if (editingMappingId) {
                    // Update existing mapping
                    response = await fetch(`/api/v1/admin/issuetype-mappings/${editingMappingId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new mapping
                    response = await fetch('/api/v1/admin/issuetype-mappings', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || `Issue type mapping ${editingMappingId ? 'updated' : 'created'} successfully`);
                    bootstrap.Modal.getInstance(document.getElementById('issueTypeMappingModal')).hide();
                    loadIssueTypeMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to ${editingMappingId ? 'update' : 'create'} mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error(`Error ${editingMappingId ? 'updating' : 'creating'} mapping:`, error);
                alert(`Error ${editingMappingId ? 'updating' : 'creating'} mapping`);
            }
        }

        // Enhanced deactivate/activate functionality
        let currentDeactivationMappingId = null;
        let currentDeactivationData = null;

        let isDeleteContext = false;

        async function showDeactivationModal(id, deleteContext = false) {
            isDeleteContext = deleteContext;
            try {
                const token = getAuthToken();
                if (!token) return;

                currentDeactivationMappingId = id;
                const mapping = issueTypeMappings.find(m => m.id === id);

                // Show loading state first
                document.getElementById('deactivationContent').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>Checking dependencies...
                    </div>
                `;

                // Update modal title and button based on context
                const modalTitle = document.querySelector('#deactivationModal .modal-title');
                const confirmButton = document.getElementById('confirmDeactivationBtn');

                if (isDeleteContext) {
                    modalTitle.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Issue Type Mapping';
                    confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                    confirmButton.className = 'btn btn-danger';
                } else {
                    modalTitle.innerHTML = '<i class="fas fa-pause me-2"></i>Deactivate Issue Type Mapping';
                    confirmButton.innerHTML = '<i class="fas fa-pause me-1"></i>Deactivate';
                    confirmButton.className = 'btn btn-warning';
                }

                new bootstrap.Modal(document.getElementById('deactivationModal')).show();

                // Check for dependencies
                const response = await fetch(`/api/v1/admin/issuetype-mappings/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    const contextMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Issue Type Mapping:</strong> ${mapping.issuetype_from} → ${mapping.issuetype_to}
                           </div>`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Issue Type Mapping:</strong> ${mapping.issuetype_from} → ${mapping.issuetype_to}
                           </div>`;

                    let content = contextMessage;

                    if (data.has_dependencies) {
                        content += `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Impact:</strong> This mapping has active dependencies:
                            </div>
                            <ul class="mb-3">
                        `;

                        if (data.dependent_issuetypes_count > 0) {
                            content += `<li><strong>${data.dependent_issuetypes_count}</strong> active issue type(s) using this mapping</li>`;
                        }

                        if (data.dependent_issues_count > 0) {
                            content += `<li><strong>${data.dependent_issues_count}</strong> active issue(s) connected through these issue types</li>`;
                        }

                        content += `
                            </ul>
                            <h6 class="mb-3">${isDeleteContext
                                ? 'Reassign dependencies before deletion:'
                                : 'Choose how to handle dependent issue types:'}</h6>
                            ${isDeleteContext
                                ? '<p class="text-muted mb-3">To delete this mapping, all dependent issue types must be reassigned to another active mapping.</p>'
                                : ''}

                            ${data.reassignment_targets.length > 0 ? `
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="deactivationAction" id="reassignIssuetypes" value="reassign_issuetypes" checked>
                                <label class="form-check-label" for="reassignIssuetypes">
                                    <strong>Reassign issue types to another mapping</strong> ${isDeleteContext ? '(required for deletion)' : '(recommended)'}
                                    <div class="mt-2">
                                        <select class="form-select" id="targetMapping">
                                            <option value="">Select target mapping...</option>
                                            ${data.reassignment_targets.map(target =>
                                                `<option value="${target.id}">${target.issuetype_from} → ${target.issuetype_to} (Level ${target.hierarchy_level || 'N/A'}) - Active</option>`
                                            ).join('')}
                                        </select>
                                        <small class="text-muted">Only active mappings are shown as reassignment targets.</small>
                                    </div>
                                </label>
                            </div>
                            ` : `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Cannot ${isDeleteContext ? 'delete' : 'deactivate'}:</strong> No other active mappings available for reassignment.
                            </div>
                            <p>You must have at least one other active mapping to reassign the dependent issue types before ${isDeleteContext ? 'deletion' : 'deactivation'} can proceed.</p>
                            <p><strong>Options:</strong></p>
                            <ul>
                                <li>Create a new mapping first, then try again</li>
                                <li>Activate an existing inactive mapping, then try again</li>
                            </ul>
                            <input type="hidden" name="deactivationAction" value="blocked">
                            `}

                            ${!isDeleteContext ? `
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="deactivationAction" id="keepIssuetypes" value="keep_issuetypes">
                                <label class="form-check-label" for="keepIssuetypes">
                                    <strong>Keep issue types active</strong> (they will reference this inactive mapping)
                                    <small class="d-block text-muted mt-1">Issue types will continue to work but may cause data inconsistencies</small>
                                </label>
                            </div>
                            ` : ''}
                        `;
                    } else {
                        if (isDeleteContext) {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to delete:</strong> No active issue types or issues are using this mapping.
                                </div>
                                <p>This mapping can be safely deleted without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="safe_delete">
                            `;
                        } else {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to deactivate:</strong> No active issue types or issues are using this mapping.
                                </div>
                                <p>This mapping can be safely deactivated without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="keep_issuetypes">
                            `;
                        }
                    }

                    document.getElementById('deactivationContent').innerHTML = content;
                } else {
                    // Fallback to simple modal if dependencies check fails
                    const fallbackMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Issue Type Mapping:</strong> ${mapping.issuetype_from} → ${mapping.issuetype_to}
                           </div>
                           <p>Unable to check dependencies. This mapping will be deleted.</p>
                           <input type="hidden" name="deactivationAction" value="safe_delete">`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Issue Type Mapping:</strong> ${mapping.issuetype_from} → ${mapping.issuetype_to}
                           </div>
                           <p>This mapping will be deactivated and excluded from future processing.</p>
                           <input type="hidden" name="deactivationAction" value="keep_issuetypes">`;

                    document.getElementById('deactivationContent').innerHTML = fallbackMessage;
                }
            } catch (error) {
                console.error('Error showing deactivation modal:', error);
                alert('Error showing deactivation modal');
            }
        }

        async function confirmDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                // Get selected action
                const selectedAction = document.querySelector('input[name="deactivationAction"]:checked')?.value || 'keep_issuetypes';

                let targetMappingId = null;
                if (selectedAction === 'reassign_issuetypes') {
                    targetMappingId = document.getElementById('targetMapping')?.value;
                    if (!targetMappingId) {
                        alert('Please select a target mapping for reassignment');
                        return;
                    }

                    // Additional validation: ensure target is not the same as current mapping
                    if (parseInt(targetMappingId) === currentDeactivationMappingId) {
                        alert('Cannot reassign to the same mapping. Please select a different target.');
                        return;
                    }
                }

                // For delete context: handle both safe delete and reassignment
                if (isDeleteContext) {
                    if (selectedAction === 'safe_delete') {
                        // Safe to delete directly - no dependencies
                        await performDelete(currentDeactivationMappingId);
                        return;
                    }

                    // Force reassignment for delete context with dependencies
                    if (selectedAction !== 'reassign_issuetypes') {
                        alert('Reassignment is required for deletion');
                        return;
                    }

                    // Check if there are any reassignment targets available
                    const targetSelect = document.getElementById('targetMapping');
                    if (!targetSelect || targetSelect.options.length <= 1) { // <= 1 because first option is "Select target..."
                        alert('Cannot delete: No active mappings available for reassignment. You must have at least one other active mapping to delete this one.');
                        return;
                    }

                    // Step 1: Reassign dependencies
                    const reassignBody = {
                        action: 'reassign_issuetypes',
                        target_mapping_id: parseInt(targetMappingId)
                    };

                    const reassignResponse = await fetch(`/api/v1/admin/issuetype-mappings/${currentDeactivationMappingId}/deactivate`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reassignBody)
                    });

                    if (!reassignResponse.ok) {
                        const error = await reassignResponse.json();
                        alert(`Failed to reassign dependencies: ${error.detail}`);
                        return;
                    }

                    // Step 2: Now delete the mapping (should be safe now)
                    const deleteResponse = await fetch(`/api/v1/admin/issuetype-mappings/${currentDeactivationMappingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        alert(`Dependencies reassigned and mapping deleted successfully`);
                        bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                        loadIssueTypeMappings();
                    } else {
                        const error = await deleteResponse.json();
                        alert(`Dependencies reassigned but failed to delete mapping: ${error.detail}`);
                    }
                    return;
                }

                // For deactivate context, use deactivate API
                const requestBody = {
                    action: selectedAction,
                    target_mapping_id: targetMappingId ? parseInt(targetMappingId) : null
                };

                const response = await fetch(`/api/v1/admin/issuetype-mappings/${currentDeactivationMappingId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Issue type mapping deactivated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                    loadIssueTypeMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deactivating mapping:', error);
                alert('Error deactivating mapping');
            }
        }

        async function activateIssueTypeMapping(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/issuetype-mappings/${id}/activate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Issue type mapping activated successfully');
                    loadIssueTypeMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating mapping:', error);
                alert('Error activating mapping');
            }
        }


    </script>
</body>
</html>
