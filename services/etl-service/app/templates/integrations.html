{% extends "layouts/modern_layout.html" %}

{% block title %}Pulse ETL Management - Integrations{% endblock %}

{% block extra_head %}
<style>
    /* Action button styles matching other admin pages exactly */
    .job-action-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .job-action-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Light mode specific hover - use dark text for visibility */
    [data-theme="light"] .job-action-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    [data-theme="light"] .job-action-btn:hover i {
        color: var(--text-primary);
    }

    .job-action-btn:disabled,
    .job-action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
{% if not embedded %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                Integrations
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">Manage system integrations and connections</p>
        </div>

    </div>
</div>
{% endif %}

<!-- Filters Section -->
<div class="mb-6 p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Name Filter -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Name</label>
            <input type="text" id="filterName" placeholder="Filter by name..." class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" oninput="applyFilters()">
        </div>

        <!-- Type Filter -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Type</label>
            <select id="filterType" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="data_source">Data Source</option>
                <option value="ai_provider">AI Provider</option>
                <option value="embedding">Embedding</option>
            </select>
        </div>

        <!-- Provider Filter -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Provider</label>
            <select id="filterProvider" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Providers</option>
                <option value="jira">Jira</option>
                <option value="github">GitHub</option>
                <option value="fabric">WEX Fabric</option>
                <option value="openai">OpenAI</option>
                <option value="azure">Azure</option>
            </select>
        </div>

        <!-- Status Filter -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Status</label>
            <select id="filterStatus" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
    </div>
</div>

<!-- Integrations Table -->
<div class="rounded-lg overflow-hidden" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <div class="px-6 py-4 border-b flex justify-between items-center" style="border-color: var(--border-color); background-color: var(--bg-tertiary);">
        <div>
            <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Data & Embedding Integrations</h2>
            <p class="text-sm mt-1" style="color: var(--text-secondary);">Manage data sources and embedding providers for ETL operations</p>
        </div>
        <button onclick="showCreateModal()" class="btn-crud-create">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Create Integration
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead style="background-color: var(--bg-tertiary);">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Logo</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Base URL</th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Status</th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Last Sync</th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Actions</th>
                </tr>
            </thead>
            <tbody id="integrationsTableBody" style="background-color: var(--bg-secondary);">
                <!-- Integrations will be loaded here -->
            </tbody>
        </table>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="p-8 text-center">
        <i data-lucide="loader-2" class="w-8 h-8 mb-2 animate-spin mx-auto" style="color: var(--crud-edit);"></i>
        <p class="text-sm" style="color: var(--text-secondary);">Loading integrations...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="p-8 text-center hidden">
        <i data-lucide="plug" class="w-16 h-16 mb-4 mx-auto" style="color: var(--text-muted);"></i>
        <h3 class="text-lg font-medium mb-2" style="color: var(--text-primary);">No Integrations Found</h3>
        <p class="text-sm" style="color: var(--text-secondary);">Use the Create Integration button above to get started.</p>
    </div>
</div>

<!-- Create/Edit Integration Modal -->
<div id="integrationModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm items-center justify-center z-50 hidden">
    <div class="modal-content max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-default">
            <h3 id="modalTitle" class="text-xl font-semibold text-primary">Create Integration</h3>
            <button onclick="closeModal('integrationModal')" class="text-muted hover:text-primary transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="integrationForm">
                <input type="hidden" id="integrationId" name="id">
                
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Provider</label>
                        <input type="text" id="provider" name="provider" required placeholder="e.g., jira, github, local_embeddings" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Type</label>
                        <select id="type" name="type" required class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                            <option value="">Select Type</option>
                            <option value="Data">Data</option>
                            <option value="Embedding">Embedding</option>
                        </select>
                    </div>
                </div>
                
                <!-- Base URL and Logo - Hidden for Embedding types -->
                <div id="dataProviderFields" class="grid grid-cols-1 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                            Base URL <span id="baseUrlRequired" class="text-red-500">*</span>
                        </label>
                        <input type="url" id="baseUrl" name="base_url" placeholder="https://example.com" required class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Logo File</label>
                        <div class="space-y-2">
                            <input type="file" id="logoFile" name="logo_file" accept="image/*" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                            <input type="hidden" id="logoFilename" name="logo_filename">
                            <div id="currentLogo" class="text-sm" style="color: var(--text-muted);" style="display: none;">
                                Current: <span id="currentLogoName"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Username/Password - Hidden for Embedding types -->
                <div id="credentialFields" class="grid grid-cols-1 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Password/Token</label>
                        <input type="password" id="password" name="password" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Model</label>
                    <input type="text" id="model" name="ai_model" placeholder="e.g., all-MiniLM-L6-v2, gpt-4o-mini" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                </div>

                <!-- Embedding Provider Specific Fields -->
                <div id="embeddingProviderFields" style="display: none;">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Model Configuration</label>
                        <textarea id="modelConfig" name="ai_model_config" rows="3" placeholder='{"model_path": "models/sentence-transformers/all-mpnet-base-v2", "cost_tier": "free", "gateway_route": false, "source": "local"}' class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);"></textarea>
                        <small class="text-muted">JSON configuration for embedding model parameters (model_path, cost_tier, gateway_route, etc.)</small>
                    </div>

                    <!-- Fallback removed for embedding integrations - different models create incompatible vector spaces -->
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="active" name="active" checked class="mr-2">
                        <span style="color: var(--text-primary);">Active</span>
                    </label>
                </div>
            </form>
        </div>
        <div class="flex justify-end space-x-3 p-6 border-t border-default">
            <button type="button" onclick="closeModal('integrationModal')" class="btn-neutral-secondary">Cancel</button>
            <button type="button" onclick="saveIntegration()" class="btn-crud-create">Save</button>
        </div>
    </div>
</div>

<style>
/* Fix dropdown option text color */
select option {
    color: var(--text-primary) !important;
    background-color: var(--bg-primary) !important;
}
</style>

<script>
let integrations = [];

// Function to show fallback icon when image fails to load
function showFallbackIcon(imgElement) {
    const iconElement = document.createElement('i');
    iconElement.setAttribute('data-lucide', 'plug');
    iconElement.className = 'w-6 h-6';
    iconElement.style.color = 'var(--text-muted)';
    imgElement.parentNode.replaceChild(iconElement, imgElement);
    // Re-initialize Lucide icons for the new element
    lucide.createIcons();
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadIntegrations();

    // Add file change event listener for logo file picker
    const logoFileInput = document.getElementById('logoFile');
    if (logoFileInput) {
        logoFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Update the hidden filename field with the selected file name
                document.getElementById('logoFilename').value = file.name;

                // Show file selection feedback
                const currentLogoDiv = document.getElementById('currentLogo');
                const currentLogoName = document.getElementById('currentLogoName');
                currentLogoName.textContent = `Selected: ${file.name}`;
                currentLogoDiv.style.display = 'block';
            }
        });
    }

    // Add type change event listener to show/hide provider-specific fields
    const typeSelect = document.getElementById('type');
    if (typeSelect) {
        typeSelect.addEventListener('change', function() {
            toggleProviderFields();
        });
    }

    // Fallback integrations removed for embedding providers
});

function toggleProviderFields() {
    const typeSelect = document.getElementById('type');
    const dataProviderFields = document.getElementById('dataProviderFields');
    const credentialFields = document.getElementById('credentialFields');
    const embeddingProviderFields = document.getElementById('embeddingProviderFields');
    const baseUrlInput = document.getElementById('baseUrl');
    const baseUrlRequired = document.getElementById('baseUrlRequired');

    if (typeSelect) {
        const selectedType = typeSelect.value;

        if (selectedType === 'Embedding') {
            // Show embedding-specific fields, hide data provider fields
            if (embeddingProviderFields) embeddingProviderFields.style.display = 'block';
            if (dataProviderFields) dataProviderFields.style.display = 'none';
            if (credentialFields) credentialFields.style.display = 'none';
            // Base URL not required for embedding integrations
            if (baseUrlInput) baseUrlInput.removeAttribute('required');
            if (baseUrlRequired) baseUrlRequired.style.display = 'none';
        } else if (selectedType === 'Data') {
            // Show data provider fields, hide embedding fields
            if (embeddingProviderFields) embeddingProviderFields.style.display = 'none';
            if (dataProviderFields) dataProviderFields.style.display = 'block';
            if (credentialFields) credentialFields.style.display = 'block';
            // Base URL required for data integrations
            if (baseUrlInput) baseUrlInput.setAttribute('required', 'required');
            if (baseUrlRequired) baseUrlRequired.style.display = 'inline';
        } else {
            // Hide all provider-specific fields
            if (embeddingProviderFields) embeddingProviderFields.style.display = 'none';
            if (dataProviderFields) dataProviderFields.style.display = 'block';
            if (credentialFields) credentialFields.style.display = 'block';
            // Base URL required by default
            if (baseUrlInput) baseUrlInput.setAttribute('required', 'required');
            if (baseUrlRequired) baseUrlRequired.style.display = 'inline';
        }
    }
}

// Fallback integrations removed for embedding providers
// Different embedding models create incompatible vector spaces

async function loadIntegrations() {
    try {
        // Show loading state
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';

        const response = await fetch('/api/v1/admin/integrations', {
            credentials: 'include'
        });
        if (response.ok) {
            const allIntegrations = await response.json();

            // Filter to show only Data and Embedding types (exclude AI providers)
            // Note: API returns integration_type field, not type field
            integrations = allIntegrations.filter(integration => {
                // Map integration names to types since API doesn't return the type field correctly
                const dataProviders = ['Jira', 'GitHub', 'WEX Fabric', 'WEX AD'];
                const embeddingProviders = ['Local Embeddings', 'WEX Embeddings'];

                return dataProviders.includes(integration.name) || embeddingProviders.includes(integration.name);
            });

            renderIntegrationsTable();
        } else {
            showError('Failed to load integrations');
        }
    } catch (error) {
        console.error('Error loading integrations:', error);
        showError('Error loading integrations');
    } finally {
        // Hide loading state
        document.getElementById('loadingState').style.display = 'none';
    }
}

function renderIntegrationsTable() {
    const tbody = document.getElementById('integrationsTableBody');
    tbody.innerHTML = '';

    if (integrations.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    } else {
        document.getElementById('emptyState').style.display = 'none';
    }

    integrations.forEach(integration => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        row.style.borderColor = 'var(--border-color)';
        
        // Construct logo path: /static/assets/{tenant_name}/integrations/{logo_filename}
        const tenantName = '{{ tenant_name|lower }}' || 'wex';  // Get tenant name from template context
        const hasLogo = integration.logo_filename && integration.logo_filename.trim() !== '';
        const logoPath = hasLogo ? `/static/assets/${tenantName}/integrations/${integration.logo_filename}` : null;


        const logoHtml = hasLogo ?
            `<img src="${logoPath}" alt="${integration.name}" class="w-6 h-6 object-contain" onerror="showFallbackIcon(this)">` :
            `<i data-lucide="plug" class="w-6 h-6" style="color: var(--text-muted);"></i>`;
        
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">
                ${logoHtml}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.name || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.integration_type || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.base_url || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <div class="job-toggle-switch" onclick="toggleIntegration(${integration.id})">
                    <div class="toggle-switch ${integration.active ? 'active' : ''}">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label">${integration.active ? 'On' : 'Off'}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center" style="color: var(--text-primary);">${integration.last_sync_at ? new Date(integration.last_sync_at).toLocaleDateString() : 'Never'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                <div class="flex justify-center space-x-1">
                    <button onclick="editIntegration(${integration.id})" class="job-action-btn" title="Edit">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteIntegration(${integration.id})" class="job-action-btn" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Re-initialize Lucide icons after adding new content
    lucide.createIcons();
}

function toggleIntegration(id) {
    const integration = integrations.find(i => i.id === id);
    if (integration) {
        const newActiveState = !integration.active;
        if (newActiveState) {
            resumeIntegration(id);
        } else {
            pauseIntegration(id);
        }
    }
}

function applyFilters() {
    const nameFilter = document.getElementById('filterName').value.toLowerCase();
    const typeFilter = document.getElementById('filterType').value.toLowerCase();
    const providerFilter = document.getElementById('filterProvider').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;

    const filteredIntegrations = integrations.filter(integration => {
        // Name filter
        if (nameFilter && !integration.name.toLowerCase().includes(nameFilter)) {
            return false;
        }

        // Type filter
        if (typeFilter && (!integration.integration_type || integration.integration_type.toLowerCase() !== typeFilter)) {
            return false;
        }

        // Provider filter
        if (providerFilter && (!integration.provider || integration.provider.toLowerCase() !== providerFilter)) {
            return false;
        }

        // Status filter
        if (statusFilter) {
            const isActive = integration.active;
            if (statusFilter === 'active' && !isActive) return false;
            if (statusFilter === 'inactive' && isActive) return false;
        }

        return true;
    });

    renderFilteredIntegrationsTable(filteredIntegrations);
}

function renderFilteredIntegrationsTable(filteredIntegrations) {
    const tbody = document.getElementById('integrationsTableBody');
    tbody.innerHTML = '';

    if (filteredIntegrations.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    } else {
        document.getElementById('emptyState').style.display = 'none';
    }

    filteredIntegrations.forEach(integration => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        row.style.borderColor = 'var(--border-color)';

        // Construct logo path: /static/assets/{tenant_name}/integrations/{logo_filename}
        const tenantName = '{{ tenant_name|lower }}' || 'wex';  // Get tenant name from template context
        const hasLogo = integration.logo_filename && integration.logo_filename.trim() !== '';
        const logoPath = hasLogo ? `/static/assets/${tenantName}/integrations/${integration.logo_filename}` : null;

        const logoHtml = hasLogo ?
            `<img src="${logoPath}" alt="${integration.name}" class="w-6 h-6 object-contain" onerror="showFallbackIcon(this)">` :
            `<i data-lucide="plug" class="w-6 h-6" style="color: var(--text-muted);"></i>`;

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">
                ${logoHtml}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.name || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.integration_type || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" style="color: var(--text-primary);">${integration.base_url || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <div class="job-toggle-switch" onclick="toggleIntegration(${integration.id})">
                    <div class="toggle-switch ${integration.active ? 'active' : ''}">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label">${integration.active ? 'On' : 'Off'}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center" style="color: var(--text-primary);">${integration.last_sync_at ? new Date(integration.last_sync_at).toLocaleDateString() : 'Never'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                <div class="flex justify-center space-x-1">
                    <button onclick="editIntegration(${integration.id})" class="job-action-btn" title="Edit">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteIntegration(${integration.id})" class="job-action-btn" title="Delete">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Re-initialize Lucide icons after adding new content
    lucide.createIcons();
}

function showCreateModal() {
    document.getElementById('modalTitle').textContent = 'Create Integration';
    document.getElementById('integrationForm').reset();
    document.getElementById('integrationId').value = '';
    document.getElementById('active').checked = true;

    // Reset logo file picker and hide current logo display
    document.getElementById('logoFile').value = '';
    document.getElementById('logoFilename').value = '';
    document.getElementById('currentLogo').style.display = 'none';

    // Clear embedding provider fields
    document.getElementById('modelConfig').value = '';
    document.getElementById('fallbackIntegration').value = '';

    // Hide embedding provider fields initially and show data provider fields
    document.getElementById('embeddingProviderFields').style.display = 'none';
    document.getElementById('dataProviderFields').style.display = 'block';
    document.getElementById('credentialFields').style.display = 'block';

    // Fallback integrations removed for embedding providers

    openModal('integrationModal');
}

async function editIntegration(id) {
    try {
        // Get full integration details from API
        const response = await fetch(`/api/v1/admin/integrations/${id}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            showError('Failed to load integration details');
            return;
        }

        const integration = await response.json();

        document.getElementById('modalTitle').textContent = 'Edit Integration';
        document.getElementById('integrationId').value = integration.id;
        document.getElementById('provider').value = integration.name || ''; // Use name from API response
        document.getElementById('type').value = integration.integration_type || '';
        document.getElementById('baseUrl').value = integration.base_url || '';

        // Handle logo filename display
        const logoFilename = integration.logo_filename || '';
        document.getElementById('logoFilename').value = logoFilename;

        // Show current logo if exists
        const currentLogoDiv = document.getElementById('currentLogo');
        const currentLogoName = document.getElementById('currentLogoName');
        if (logoFilename) {
            currentLogoName.textContent = logoFilename;
            currentLogoDiv.style.display = 'block';
        } else {
            currentLogoDiv.style.display = 'none';
        }

        // Clear file input
        document.getElementById('logoFile').value = '';
        document.getElementById('username').value = integration.username || '';

        // Show masked password if exists
        document.getElementById('password').value = integration.password_masked || '';

        document.getElementById('model').value = integration.ai_model || '';

        // Load Embedding provider specific fields if type is Embedding
        if (integration.integration_type === 'Embedding') {
            document.getElementById('modelConfig').value = integration.ai_model_config ? JSON.stringify(integration.ai_model_config, null, 2) : '';
            document.getElementById('fallbackIntegration').value = integration.fallback_integration_id || '';
        }

        document.getElementById('active').checked = integration.active;

        // Show/hide provider-specific fields based on type
        toggleProviderFields();

        // Fallback integrations removed for embedding providers

        openModal('integrationModal');

    } catch (error) {
        console.error('Error loading integration details:', error);
        showError('Error loading integration details');
    }
}

async function saveIntegration() {
    const form = document.getElementById('integrationForm');
    const formData = new FormData(form);
    const id = formData.get('id');

    // Client-side validation
    const type = formData.get('type');
    const baseUrl = formData.get('base_url');

    if (type === 'Data' && (!baseUrl || baseUrl.trim() === '')) {
        showError('Base URL is required for Data integrations');
        return;
    }

    // Store file for upload after integration save
    let logoFilename = formData.get('logo_filename') || null; // Current filename
    const logoFile = formData.get('logo_file');

    // Parse JSON fields for Embedding providers
    let modelConfig = null;

    try {
        const modelConfigText = formData.get('ai_model_config');
        if (modelConfigText && modelConfigText.trim()) {
            modelConfig = JSON.parse(modelConfigText);
        }
    } catch (e) {
        showError('Invalid JSON in Model Configuration');
        return;
    }

    const data = {
        name: formData.get('provider'), // API expects 'name' field
        provider: formData.get('provider'),
        type: formData.get('type'),
        base_url: formData.get('base_url') || null,
        logo_filename: logoFilename,
        username: formData.get('username') || null,
        password: formData.get('password') || null,
        ai_model: formData.get('ai_model') || null,
        ai_model_config: modelConfig,
        fallback_integration_id: formData.get('fallback_integration_id') || null,
        active: formData.has('active')
    };
    
    try {
        const url = id ? `/api/v1/admin/integrations/${id}` : '/api/v1/admin/integrations';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();

            // Handle file upload if a new file was selected
            if (logoFile && logoFile.size > 0) {
                try {
                    // Get the integration ID (either from existing ID or from creation response)
                    const integrationId = id || result.id;


                    if (integrationId) {
                        const uploadFormData = new FormData();
                        uploadFormData.append('logo', logoFile);

                        const uploadResponse = await fetch(`/api/v1/admin/integrations/${integrationId}/logo`, {
                            method: 'POST',
                            credentials: 'include',
                            body: uploadFormData
                        });

                        if (uploadResponse.ok) {
                            const uploadResult = await uploadResponse.json();
                            showSuccess(`Integration ${id ? 'updated' : 'created'} and logo uploaded successfully!`);
                        } else {
                            const uploadError = await uploadResponse.json();
                            console.error('Upload failed:', uploadError);
                            showError(`Integration saved but logo upload failed: ${uploadError.detail}`);
                        }
                    } else {
                        console.error('No integration ID available for logo upload');
                        showError('Integration saved but logo upload failed: No integration ID');
                    }
                } catch (uploadError) {
                    console.error('Error uploading logo:', uploadError);
                    showError(`Integration saved but logo upload failed: ${uploadError.message}`);
                }
            } else {
                showSuccess(id ? 'Integration updated successfully' : 'Integration created successfully');
            }

            closeModal('integrationModal');
            loadIntegrations();
        } else {
            const error = await response.text();
            showError(`Failed to save integration: ${error}`);
        }
    } catch (error) {
        console.error('Error saving integration:', error);
        showError('Error saving integration');
    }
}



async function pauseIntegration(id) {
    try {
        const response = await fetch(`/api/v1/admin/integrations/${id}/deactivate`, {
            method: 'PATCH',
            credentials: 'include'
        });

        if (response.ok) {
            loadIntegrations();
            showSuccess('Integration inactivated successfully');
        } else {
            showError('Failed to inactivate integration');
        }
    } catch (error) {
        console.error('Error inactivating integration:', error);
        showError('Error inactivating integration');
    }
}

async function resumeIntegration(id) {
    try {
        const response = await fetch(`/api/v1/admin/integrations/${id}/activate`, {
            method: 'PATCH',
            credentials: 'include'
        });

        if (response.ok) {
            loadIntegrations();
            showSuccess('Integration activated successfully');
        } else {
            showError('Failed to activate integration');
        }
    } catch (error) {
        console.error('Error activating integration:', error);
        showError('Error activating integration');
    }
}

async function deleteIntegration(id) {
    if (confirm('Are you sure you want to delete this integration? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/v1/admin/integrations/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                loadIntegrations();
                showSuccess('Integration deleted successfully');
            } else {
                showError('Failed to delete integration');
            }
        } catch (error) {
            console.error('Error deleting integration:', error);
            showError('Error deleting integration');
        }
    }
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Modern notification system - consistent across all pages
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm max-w-sm transition-all duration-300 transform translate-x-full`;

    // Set background color based on type
    switch (type) {
        case 'success':
            notification.style.backgroundColor = '#10b981';
            break;
        case 'error':
            notification.style.backgroundColor = '#ef4444';
            break;
        case 'warning':
            notification.style.backgroundColor = 'var(--color-1)';
            break;
        default:
            notification.style.backgroundColor = '#3b82f6';
    }

    notification.textContent = message;
    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(full)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function showSuccess(message) {
    showNotification(message, 'success');
}

function showError(message) {
    showNotification(message, 'error');
}
</script>

{% endblock %}
