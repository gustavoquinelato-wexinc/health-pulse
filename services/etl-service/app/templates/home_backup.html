{% extends "layouts/modern_layout.html" %}

{% block title %}Pulse ETL - Job Control{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                ETL Job Control
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">Monitor and manage your data integration workflows</p>
        </div>
        <div class="flex items-center space-x-3">
            <div class="text-sm" style="color: var(--text-secondary);">
                <i class="fas fa-user mr-2"></i><span id="user-email">Loading...</span>
                <span id="user-role-badge" class="ml-2 px-2 py-1 rounded text-xs font-semibold" style="display: none;"></span>
            </div>
            <select id="refreshInterval" class="px-3 py-2 rounded-lg text-sm" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
                <option value="0">Manual Refresh</option>
                <option value="5000">5 seconds</option>
                <option value="10000">10 seconds</option>
                <option value="30000" selected>30 seconds</option>
                <option value="60000">1 minute</option>
            </select>
            <button onclick="refreshData(); refreshSystemHealth();" class="btn-neutral-secondary">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
        </div>
    </div>
    <div class="text-sm" style="color: var(--text-muted);" id="lastUpdate">
        Last updated: Never
    </div>
</div>

<!-- System Health Section -->
<div id="system-health-section" class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); display: none;">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold" style="color: var(--text-primary);">
            <i class="fas fa-heartbeat mr-2"></i>System Health
        </h3>
        <div class="flex space-x-2">
            <button onclick="refreshSystemHealth()" class="btn-neutral-secondary">
                <i class="fas fa-sync mr-1"></i>Refresh
            </button>
            <button id="logs-button" onclick="showLogManagement()" class="btn-color-4">
                <i class="fas fa-file-alt mr-1"></i>Logs
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Database Status -->
        <div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm" style="color: var(--text-secondary);">Database</span>
                <span id="dbStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                </span>
            </div>
            <div id="dbDetails" class="text-xs" style="color: var(--text-muted);">
                PostgreSQL Connection
            </div>
        </div>

        <!-- Jira API Status -->
        <div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm" style="color: var(--text-secondary);">Jira API</span>
                <span id="jiraApiStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                </span>
            </div>
            <div id="jiraApiDetails" class="text-xs" style="color: var(--text-muted);">
                API Connectivity
            </div>
        </div>

        <!-- GitHub API Status -->
        <div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm" style="color: var(--text-secondary);">GitHub API</span>
                <span id="githubApiStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                </span>
            </div>
            <div id="githubApiDetails" class="text-xs" style="color: var(--text-muted);">
                Rate Limits & Connectivity
            </div>
        </div>

        <!-- System Resources -->
        <div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm" style="color: var(--text-secondary);">System</span>
                <span id="systemStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                </span>
            </div>
            <div id="systemDetails" class="text-xs" style="color: var(--text-muted);">
                Memory & CPU Usage
            </div>
        </div>
    </div>
</div>

<!-- Orchestrator Control Section -->
<div class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
            <h2 class="text-xl font-semibold" style="color: var(--text-primary);">
                <i class="fas fa-cogs mr-2"></i>Orchestrator
            </h2>
            <span id="orchestratorStatusBadge" class="px-2 py-1 rounded text-xs font-medium bg-gray-600 text-white">
                Loading...
            </span>
        </div>
        <div class="flex items-center space-x-3">
            <div class="text-sm" style="color: var(--text-secondary);">
                Next Run: <span id="countdownTimer" class="font-mono">--:--:--</span>
            </div>
            <button onclick="forceStartOrchestrator()" id="forceStartOrchestratorBtn" class="btn-neutral-primary">
                <i class="fas fa-play mr-1"></i>Force Start
            </button>
            <button onclick="pauseOrchestrator()" id="pauseOrchestratorBtn" class="btn-status-warning hidden">
                <i class="fas fa-pause mr-1"></i>Pause
            </button>
            <button onclick="resumeOrchestrator()" id="resumeOrchestratorBtn" class="btn-neutral-primary hidden">
                <i class="fas fa-play mr-1"></i>Resume
            </button>
            <button onclick="showOrchestratorSettings()" class="btn-color-2">
                <i class="fas fa-cog mr-1"></i>Settings
            </button>
        </div>
    </div>
</div>

<!-- Orchestrator Settings Modal -->
<div id="orchestratorSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="rounded-lg shadow-xl max-w-md w-full" style="background-color: var(--bg-secondary);">
            <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">
                    <i class="fas fa-cog mr-2"></i>Orchestrator Settings
                </h3>
            </div>
            <div class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                            Run Interval
                        </label>
                        <select id="orchestratorInterval" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <option value="60" selected>Every 1 hour</option>
                            <option value="120">Every 2 hours</option>
                            <option value="240">Every 4 hours</option>
                            <option value="480">Every 8 hours</option>
                            <option value="720">Every 12 hours</option>
                            <option value="1440">Every 24 hours</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="orchestratorEnabled" checked class="mr-2 h-4 w-4 rounded" style="color: var(--color-1);">
                            <span class="text-sm font-medium" style="color: var(--text-primary);">Enable Orchestrator</span>
                        </label>
                    </div>

                    <!-- Fast Retry Configuration -->
                    <div class="border-t pt-4" style="border-color: var(--border-color);">
                        <h4 class="text-sm font-semibold mb-3" style="color: var(--text-primary);">
                            <i class="fas fa-redo mr-1"></i>Fast Retry Settings
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="retryEnabled" checked class="mr-2 h-4 w-4 rounded" style="color: var(--color-1);">
                                    <span class="text-sm font-medium" style="color: var(--text-primary);">Enable Fast Retry</span>
                                </label>
                                <p class="text-xs mt-1 ml-6" style="color: var(--text-muted);">
                                    Retry failed jobs sooner instead of waiting for the next scheduled run
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                                    Retry Interval
                                </label>
                                <select id="retryInterval" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="5">Every 5 minutes</option>
                                    <option value="10">Every 10 minutes</option>
                                    <option value="15" selected>Every 15 minutes</option>
                                    <option value="20">Every 20 minutes</option>
                                    <option value="30">Every 30 minutes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                                    Max Retry Attempts
                                </label>
                                <select id="maxRetryAttempts" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="1">1 attempt</option>
                                    <option value="2">2 attempts</option>
                                    <option value="3" selected>3 attempts</option>
                                    <option value="4">4 attempts</option>
                                    <option value="5">5 attempts</option>
                                </select>
                                <p class="text-xs mt-1" style="color: var(--text-muted);">
                                    After max attempts, falls back to normal interval
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t flex justify-end space-x-3" style="border-color: var(--border-color);">
                <button onclick="hideOrchestratorSettings()" class="btn-neutral-secondary">
                    Cancel
                </button>
                <button onclick="saveOrchestratorSettings()" class="btn-neutral-primary">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Management Modal -->
<div id="logManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="rounded-lg shadow-xl max-w-6xl w-full" style="background-color: var(--bg-secondary);">
            <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-semibold" style="color: var(--text-primary);">ETL Service Log Management</h3>
                        <p class="text-sm mt-1" style="color: var(--text-secondary);">Manage all log files in the ETL service directory</p>
                    </div>
                    <button onclick="hideLogManagement()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="px-6 py-4">
                <!-- Log Files List -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium" style="color: var(--text-primary);">Current Log Files</h4>
                        <div class="flex items-center space-x-2">
                            <select id="bulkCleanupDays" class="px-2 py-1 rounded text-xs" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30" selected>30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                                <option value="0">All logs</option>
                            </select>
                            <button onclick="bulkCleanupLogs()" class="btn-status-error text-xs" id="bulkDeleteBtn" title="Delete files based on selected option">
                                <i class="fas fa-trash mr-1"></i><span id="bulkDeleteText">Delete Old</span>
                            </button>
                        </div>
                    </div>
                    <div id="logFilesList" class="space-y-2">
                        <!-- Log files will be loaded here -->
                    </div>
                </div>

                <!-- Recent Log Entries -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium" style="color: var(--text-primary);">Recent Log Entries</h4>
                        <button onclick="refreshLogEntries()" class="text-sm" style="color: var(--color-1);">
                            <i class="fas fa-sync mr-1"></i>Refresh
                        </button>
                    </div>

                    <!-- Log Table -->
                    <div class="rounded-lg overflow-hidden" style="background-color: var(--bg-tertiary);">
                        <div id="logTableContainer" class="max-h-64 overflow-y-auto">
                            <table class="w-full text-xs">
                                <thead class="sticky top-0" style="background-color: var(--bg-secondary);">
                                    <tr>
                                        <th class="text-left p-2 font-medium w-36" style="color: var(--text-secondary);">Time</th>
                                        <th class="text-left p-2 font-medium w-20" style="color: var(--text-secondary);">Level</th>
                                        <th class="text-left p-2 font-medium w-40" style="color: var(--text-secondary);">Module</th>
                                        <th class="text-left p-2 font-medium" style="color: var(--text-secondary);">Message</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody">
                                    <tr>
                                        <td colspan="4" class="p-4 text-center" style="color: var(--text-muted);">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading log entries...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="px-3 py-2 flex justify-between items-center text-xs" style="background-color: var(--bg-secondary);">
                            <div style="color: var(--text-muted);">
                                <span id="logPaginationInfo">Loading...</span>
                            </div>
                            <div class="flex space-x-1">
                                <button id="logPrevPage" onclick="changeLogPage(-1)" class="px-2 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="logNextPage" onclick="changeLogPage(1)" class="px-2 py-1 rounded disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="text-xs mt-2" style="color: var(--text-muted);">
                        <i class="fas fa-info-circle mr-1"></i>
                        Use the download button next to each file above to download complete logs.
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t flex justify-end" style="border-color: var(--border-color);">
                <button onclick="hideLogManagement()" class="btn-neutral-secondary">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Cards Container -->
<div id="jobsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Job cards will be dynamically inserted here -->
</div>
{% endblock %}

{% block extra_head %}
<style>
    /* Job Control Styles */
    .glass-effect {
        background: linear-gradient(135deg, var(--color-1), var(--color-2));
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    /* Status Classes */
    .status-running { background-color: #10b981; color: white; }
    .status-pending { background-color: #f59e0b; color: white; }
    .status-finished { background-color: #6b7280; color: white; }
    .status-paused { background-color: #8b5cf6; color: white; }
    .status-not-started { background-color: #374151; color: white; }
    .status-error { background-color: #ef4444; color: white; }

    /* WebSocket Progress Styles */
    .ws-progress-container {
        width: 100%;
        height: 8px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }

    .ws-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-3), var(--color-4));
        transition: width 0.3s ease;
    }

    .ws-progress-text {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 0.5rem;
    }

    /* Exception Log Styles */
    .exception-log {
        max-height: 150px;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 0.5rem;
    }

    .exception-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.75rem;
    }

    .exception-item:last-child {
        border-bottom: none;
    }

    .exception-item.error {
        color: #fca5a5;
    }

    .exception-item.warning {
        color: #fcd34d;
    }

    .exception-item.info {
        color: #93c5fd;
    }
</style>

<script>
    let refreshTimer = null;

    // WebSocket connections for real-time progress
    let websockets = {
        jira_sync: null,
        github_sync: null,
        orchestrator: null
    };

    // Progress and exception data
    let jobProgress = {
        jira_sync: { percentage: 0, step: '', exceptions: [] },
        github_sync: { percentage: 0, step: '', exceptions: [] },
        orchestrator: { percentage: 0, step: '', exceptions: [] }
    };

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        // Simple auth check
        const token = getAuthToken();
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Load data immediately
        refreshData();
        refreshOrchestratorStatus();
        setupAutoRefresh();
        initializeWebSockets();

        // Load user info and system health in background
        loadUserInfo().catch(error => {
            console.error('Failed to load user info:', error);
        });

        refreshSystemHealth().catch(error => {
            console.error('System health check failed:', error);
        });
    });

    // WebSocket Management
    function initializeWebSockets() {
        const jobs = ['jira_sync', 'github_sync'];
        jobs.forEach(jobName => {
            connectWebSocket(jobName);
        });
    }

    function connectWebSocket(jobName) {
        if (websockets[jobName]) {
            websockets[jobName].close();
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/progress/${jobName}`;

        try {
            const ws = new WebSocket(wsUrl);

            ws.onopen = function () {
                console.log(`WebSocket connected for ${jobName}`);
                websockets[jobName] = ws;
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(jobName, data);
                } catch (e) {
                    console.error(`Error parsing WebSocket message for ${jobName}:`, e);
                }
            };

            ws.onclose = function () {
                console.log(`WebSocket disconnected for ${jobName}`);
                websockets[jobName] = null;
                setTimeout(() => {
                    if (!websockets[jobName]) {
                        connectWebSocket(jobName);
                    }
                }, 5000);
            };

            ws.onerror = function (error) {
                console.error(`WebSocket error for ${jobName}:`, error);
            };

        } catch (e) {
            console.error(`Failed to create WebSocket for ${jobName}:`, e);
        }
    }

    function handleWebSocketMessage(jobName, data) {
        switch (data.type) {
            case 'progress':
                updateJobProgress(jobName, data.percentage, data.step);
                break;
            case 'exception':
                addJobException(jobName, data.level, data.message, data.timestamp);
                break;
            case 'status':
                updateJobStatus(jobName, data.status);
                break;
            case 'completion':
                handleJobCompletion(jobName, data.success, data.summary);
                break;
            default:
                console.log(`Unknown WebSocket message type: ${data.type}`);
        }
    }

    function updateJobProgress(jobName, percentage, step) {
        jobProgress[jobName].percentage = percentage;
        jobProgress[jobName].step = step;

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardProgress(jobCard, percentage, step);
        }
    }

    function addJobException(jobName, level, message, timestamp) {
        const exception = {
            level: level,
            message: message,
            timestamp: timestamp
        };

        jobProgress[jobName].exceptions.unshift(exception);

        if (jobProgress[jobName].exceptions.length > 10) {
            jobProgress[jobName].exceptions = jobProgress[jobName].exceptions.slice(0, 10);
        }

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardExceptions(jobCard, jobProgress[jobName].exceptions);
        }
    }

    function updateJobStatus(jobName, status) {
        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardStatus(jobCard, status);
        }
    }

    function handleJobCompletion(jobName, success, summary) {
        console.log(`Job ${jobName} completed:`, { success, summary });

        if (success) {
            updateJobProgress(jobName, 100, 'Completed successfully');
        } else {
            addJobException(jobName, 'ERROR', summary.error || 'Job failed', new Date().toISOString());
        }

        setTimeout(() => {
            refreshData();
        }, 2000);
    }

    // Data refresh functions
    async function refreshData() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/jobs/status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                console.error('API response not ok:', response.status, response.statusText);
                return;
            }

            const data = await response.json();

            // Handle different response formats
            let jobsData = data.jobs || data;

            // If still no jobs data, create fallback data
            if (!jobsData || Object.keys(jobsData).length === 0) {
                jobsData = {
                    jira_sync: {
                        status: 'PENDING',
                        last_run_started_at: null,
                        last_success_at: null,
                        retry_count: 0,
                        error_message: null,
                        checkpoint_data: null
                    },
                    github_sync: {
                        status: 'PENDING',
                        last_run_started_at: null,
                        last_success_at: null,
                        retry_count: 0,
                        error_message: null,
                        checkpoint_data: null
                    }
                };
            }

            updateJobCards(jobsData);
            updateLastRefreshTime();
        } catch (error) {
            console.error('Error fetching job status:', error);
            // Create fallback job cards on error
            const fallbackJobs = {
                jira_sync: {
                    status: 'ERROR',
                    last_run_started_at: null,
                    last_success_at: null,
                    retry_count: 0,
                    error_message: 'Failed to load job status',
                    checkpoint_data: null
                },
                github_sync: {
                    status: 'ERROR',
                    last_run_started_at: null,
                    last_success_at: null,
                    retry_count: 0,
                    error_message: 'Failed to load job status',
                    checkpoint_data: null
                }
            };
            updateJobCards(fallbackJobs);
        }
    }

    function updateJobCards(jobsData) {
        const container = document.getElementById('jobsContainer');

        if (!container) {
            console.error('Job container not found!');
            return;
        }

        container.innerHTML = '';

        if (!jobsData || Object.keys(jobsData).length === 0) {
            container.innerHTML = '<div class="col-span-2 text-center py-8" style="color: var(--text-muted);">No job data available</div>';
            return;
        }

        Object.entries(jobsData).forEach(([jobName, jobData]) => {
            const card = createJobCard(jobName, jobData, jobsData);
            container.appendChild(card);
        });

        updateOrchestratorButtonState(jobsData);
    }

    function updateOrchestratorButtonState(jobsData) {
        const orchestratorBtn = document.getElementById('forceStartOrchestratorBtn');
        if (!orchestratorBtn) return;

        const anyJobRunning = Object.values(jobsData).some(jobData => jobData.status === 'RUNNING');

        if (anyJobRunning) {
            orchestratorBtn.disabled = true;
            orchestratorBtn.className = 'bg-gray-500 cursor-not-allowed text-white px-3 py-1 rounded text-sm font-medium';
            orchestratorBtn.title = 'Cannot start orchestrator while jobs are running';
        } else {
            orchestratorBtn.disabled = false;
            orchestratorBtn.className = 'btn-neutral-primary';
            orchestratorBtn.title = '';
        }
    }

    function setupAutoRefresh() {
        const select = document.getElementById('refreshInterval');
        select.addEventListener('change', function () {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }

            const interval = parseInt(this.value);
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval);
            }
        });

        const defaultInterval = parseInt(select.value);
        if (defaultInterval > 0) {
            refreshTimer = setInterval(refreshData, defaultInterval);
        }
    }

    function updateLastRefreshTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent =
            `Last updated: ${now.toLocaleTimeString()}`;
    }

    function createJobCard(jobName, jobData, allJobsData) {
        const card = document.createElement('div');
        card.className = 'glass-effect rounded-lg p-6';
        card.setAttribute('data-job', jobName);

        const statusClass = getStatusClass(jobData.status);
        const statusIcon = getStatusIcon(jobData.status);

        card.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-white capitalize">
                    <i class="fas fa-${jobName === 'jira_sync' ? 'ticket-alt' : 'code-branch'} mr-2"></i>
                    ${jobName.replace('_', ' ')}
                </h3>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                    <i class="fas fa-${statusIcon} mr-1"></i>${jobData.status}
                </span>
            </div>

            ${createJobDetails(jobName, jobData)}
            ${createWebSocketProgress(jobName)}
            ${createExceptionLog(jobName)}

            <div class="mt-4 flex flex-wrap gap-2">
                ${createActionButtons(jobName, jobData, allJobsData)}
            </div>
        `;

        return card;
    }

    function createJobDetails(jobName, jobData) {
        let details = `
            <div class="space-y-3 text-white text-opacity-80 text-sm">
                <div class="flex justify-between">
                    <span>Last Run:</span>
                    <span>${jobData.last_run_started_at ? new Date(jobData.last_run_started_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Last Success:</span>
                    <span>${jobData.last_success_at ? new Date(jobData.last_success_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Retry Count:</span>
                    <span>${jobData.retry_count || 0}</span>
                </div>
            </div>
        `;

        if (jobData.status === 'PENDING' && jobData.checkpoint_data) {
            details += createRecoveryDetails(jobData.checkpoint_data);
        }

        if (jobData.error_message) {
            details += `
                <div class="mt-3 p-3 bg-red-500 bg-opacity-20 rounded-lg border border-red-500 border-opacity-50">
                    <div class="text-red-200 text-xs font-medium mb-1">Error Message:</div>
                    <div class="text-red-100 text-xs">${jobData.error_message}</div>
                </div>
            `;
        }

        return details;
    }

    function createRecoveryDetails(checkpointData) {
        if (!checkpointData) return '';

        let recoveryHtml = `
            <div class="mt-3 p-3 bg-yellow-500 bg-opacity-20 rounded-lg border border-yellow-500 border-opacity-50">
                <div class="text-yellow-200 text-xs font-medium mb-2">
                    <i class="fas fa-redo mr-1"></i>Recovery Information:
                </div>
        `;

        if (checkpointData.repo_processing_queue) {
            let queue;
            if (typeof checkpointData.repo_processing_queue === 'string') {
                queue = JSON.parse(checkpointData.repo_processing_queue);
            } else {
                queue = checkpointData.repo_processing_queue;
            }

            const finished = queue.filter(r => r.finished).length;
            const total = queue.length;
            const remaining = total - finished;

            recoveryHtml += `
                <div class="text-yellow-100 text-xs mb-1">
                    Repositories: ${finished}/${total} completed (${remaining} remaining)
                </div>
            `;
        }

        const cursors = ['last_pr_cursor', 'current_pr_node_id', 'last_commit_cursor', 'last_review_cursor', 'last_comment_cursor'];
        cursors.forEach(cursor => {
            if (checkpointData[cursor]) {
                recoveryHtml += `
                    <div class="text-yellow-100 text-xs mb-1">
                        ${cursor.replace(/_/g, ' ')}: ${checkpointData[cursor].substring(0, 20)}...
                    </div>
                `;
            }
        });

        recoveryHtml += '</div>';
        return recoveryHtml;
    }

    function createActionButtons(jobName, jobData, allJobsData) {
        const canStart = ['PENDING', 'FINISHED', 'NOT_STARTED'].includes(jobData.status);
        const canStop = jobData.status === 'RUNNING';
        const canPause = ['PENDING', 'FINISHED'].includes(jobData.status);
        const canUnpause = jobData.status === 'PAUSED';

        const otherJobRunning = Object.entries(allJobsData).some(([name, data]) =>
            name !== jobName && data.status === 'RUNNING'
        );

        const canStartSafe = canStart && !otherJobRunning;
        const canPauseSafe = canPause && jobData.status !== 'RUNNING';

        return `
            <button onclick="forceStart('${jobName}')"
                    ${!canStartSafe ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${canStartSafe ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                    title="${!canStartSafe && otherJobRunning ? 'Cannot start while another job is running' : ''}">
                <i class="fas fa-play mr-1"></i>Force Start
            </button>
            <button onclick="forceStop('${jobName}')"
                    ${!canStop ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${canStop ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300">
                <i class="fas fa-stop mr-1"></i>Force Stop
            </button>
            <button onclick="${canUnpause ? 'unpauseJob' : 'pauseJob'}('${jobName}')"
                    ${!(canPauseSafe || canUnpause) ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${(canPauseSafe || canUnpause) ? (canUnpause ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-amber-500 hover:bg-amber-600') : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                    title="${!canPauseSafe && jobData.status === 'RUNNING' ? 'Cannot pause while job is running' : ''}">
                <i class="fas fa-${canUnpause ? 'play' : 'pause'} mr-1"></i>${canUnpause ? 'Unpause' : 'Pause'}
            </button>
            <button onclick="showJobDetails('${jobName}')"
                    class="px-3 py-1 rounded text-sm bg-purple-500 hover:bg-purple-600 text-white transition duration-300">
                <i class="fas fa-info-circle mr-1"></i>Details
            </button>
        `;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'RUNNING': return 'status-running';
            case 'PENDING': return 'status-pending';
            case 'FINISHED': return 'status-finished';
            case 'PAUSED': return 'status-paused';
            case 'NOT_STARTED': return 'status-not-started';
            default: return 'status-error';
        }
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'RUNNING': return 'spinner fa-spin';
            case 'PENDING': return 'clock';
            case 'FINISHED': return 'check-circle';
            case 'PAUSED': return 'pause-circle';
            case 'NOT_STARTED': return 'circle';
            default: return 'exclamation-triangle';
        }
    }

    function createWebSocketProgress(jobName) {
        const progress = jobProgress[jobName];
        if (!progress || progress.percentage === 0) {
            return '';
        }

        return `
            <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-medium text-white">Real-time Progress</span>
                    <span class="text-xs text-white">${Math.round(progress.percentage)}%</span>
                </div>
                <div class="ws-progress-container">
                    <div class="ws-progress-bar" style="width: ${progress.percentage}%"></div>
                </div>
                <div class="ws-progress-text">${progress.step}</div>
            </div>
        `;
    }

    function createExceptionLog(jobName) {
        const exceptions = jobProgress[jobName].exceptions;
        if (!exceptions || exceptions.length === 0) {
            return '';
        }

        const exceptionsHtml = exceptions.map(exception => `
            <div class="exception-item ${exception.level.toLowerCase()}">
                <div class="flex justify-between items-start">
                    <span class="font-medium">${exception.level}:</span>
                    <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="mt-1">${exception.message}</div>
            </div>
        `).join('');

        return `
            <div class="mt-4">
                <div class="text-xs font-medium text-white mb-2">Issues & Warnings</div>
                <div class="exception-log">
                    ${exceptionsHtml}
                </div>
            </div>
        `;
    }

    function updateJobCardProgress(jobCard, percentage, step) {
        let progressSection = jobCard.querySelector('.ws-progress-container');
        if (!progressSection) {
            const detailsSection = jobCard.querySelector('.space-y-3');
            if (detailsSection) {
                const progressHtml = createWebSocketProgress(jobCard.getAttribute('data-job'));
                detailsSection.insertAdjacentHTML('afterend', progressHtml);
                progressSection = jobCard.querySelector('.ws-progress-container');
            }
        }

        if (progressSection) {
            const progressBar = progressSection.querySelector('.ws-progress-bar');
            const progressText = jobCard.querySelector('.ws-progress-text');
            const progressPercentage = progressSection.parentElement.querySelector('.text-xs:last-child');

            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = step;
            if (progressPercentage) progressPercentage.textContent = `${Math.round(percentage)}%`;
        }
    }

    function updateJobCardExceptions(jobCard, exceptions) {
        let exceptionSection = jobCard.querySelector('.exception-log');
        if (!exceptionSection && exceptions.length > 0) {
            const progressSection = jobCard.querySelector('.ws-progress-container');
            const insertPoint = progressSection ? progressSection.parentElement : jobCard.querySelector('.space-y-3');
            if (insertPoint) {
                const exceptionHtml = createExceptionLog(jobCard.getAttribute('data-job'));
                insertPoint.insertAdjacentHTML('afterend', exceptionHtml);
                exceptionSection = jobCard.querySelector('.exception-log');
            }
        }

        if (exceptionSection && exceptions.length > 0) {
            const exceptionsHtml = exceptions.map(exception => `
                <div class="exception-item ${exception.level.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <span class="font-medium">${exception.level}:</span>
                        <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-1">${exception.message}</div>
                </div>
            `).join('');
            exceptionSection.innerHTML = exceptionsHtml;
        }
    }

    function updateJobCardStatus(jobCard, status) {
        const statusSpan = jobCard.querySelector('.px-3.py-1.rounded-full');
        if (statusSpan) {
            const statusClass = getStatusClass(status);
            const statusIcon = getStatusIcon(status);
            statusSpan.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClass}`;
            statusSpan.innerHTML = `<i class="fas fa-${statusIcon} mr-1"></i>${status}`;
        }
    }

    // Job action functions
    async function forceStart(jobName) {
        if (!confirm(`Are you sure you want to force start ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/start`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} started successfully`);
                refreshData();
            } else {
                console.error(`Failed to start ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error starting ${jobName}: ${error.message}`);
        }
    }

    async function forceStop(jobName) {
        if (!confirm(`Are you sure you want to force stop ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/stop`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} stopped successfully`);
                refreshData();
            } else {
                console.error(`Failed to stop ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error stopping ${jobName}: ${error.message}`);
        }
    }

    async function pauseJob(jobName) {
        if (!confirm(`Are you sure you want to pause ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/pause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} paused successfully`);
                await refreshData();
            } else {
                console.error(`Failed to pause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error pausing ${jobName}: ${error.message}`);
        }
    }

    async function unpauseJob(jobName) {
        if (!confirm(`Are you sure you want to unpause ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/unpause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} unpaused successfully - new status: ${result.status}`);
                await refreshData();
            } else {
                console.error(`Failed to unpause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error unpausing ${jobName}: ${error.message}`);
        }
    }

    function showJobDetails(jobName) {
        console.log(`Showing details for ${jobName} (feature coming soon)`);
    }

    // Orchestrator Control Functions
    async function forceStartOrchestrator() {
        const button = event.target.closest('button');

        if (button.disabled) {
            console.warn('Cannot start orchestrator while jobs are running');
            return;
        }

        const originalText = button.innerHTML;

        try {
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Starting...';
            button.disabled = true;

            console.log('Force starting orchestrator... (this may take a few seconds)');

            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log('Orchestrator started successfully');
                setTimeout(refreshOrchestratorStatus, 1000);
            } else {
                console.error(`Failed to start orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error starting orchestrator: ${error.message}`);
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    async function pauseOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/pause', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.warn('Orchestrator paused');
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to pause orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error pausing orchestrator: ${error.message}`);
        }
    }

    async function resumeOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/resume', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log('Orchestrator resumed');
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to resume orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error resuming orchestrator: ${error.message}`);
        }
    }

    async function refreshOrchestratorStatus() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const status = await response.json();
                updateOrchestratorUI(status);
            }
        } catch (error) {
            console.error('Error fetching orchestrator status:', error);
        }
    }

    let countdownInterval = null;

    function updateOrchestratorUI(status) {
        const statusBadge = document.getElementById('orchestratorStatusBadge');
        const pauseBtn = document.getElementById('pauseOrchestratorBtn');
        const resumeBtn = document.getElementById('resumeOrchestratorBtn');

        statusBadge.textContent = status.status;
        statusBadge.className = 'px-2 py-1 rounded text-xs font-medium ';

        if (status.status === 'running') {
            statusBadge.className += 'bg-green-600 text-white';
            pauseBtn.classList.remove('hidden');
            resumeBtn.classList.add('hidden');
            startCountdownTimer(status.next_run);
        } else if (status.status === 'paused') {
            statusBadge.className += 'bg-yellow-600 text-white';
            pauseBtn.classList.add('hidden');
            resumeBtn.classList.remove('hidden');
            stopCountdownTimer();
        } else {
            statusBadge.className += 'bg-gray-600 text-white';
            pauseBtn.classList.add('hidden');
            resumeBtn.classList.add('hidden');
            stopCountdownTimer();
        }
    }

    function startCountdownTimer(nextRunTime) {
        stopCountdownTimer();

        if (!nextRunTime) {
            document.getElementById('countdownTimer').textContent = '--:--:--';
            return;
        }

        const nextRun = new Date(nextRunTime);

        countdownInterval = setInterval(() => {
            const now = new Date();
            const timeDiff = nextRun - now;

            if (timeDiff <= 0) {
                document.getElementById('countdownTimer').textContent = '00:00:00';
                setTimeout(refreshOrchestratorStatus, 1000);
                return;
            }

            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('countdownTimer').textContent = timeString;
        }, 1000);
    }

    function stopCountdownTimer() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        document.getElementById('countdownTimer').textContent = '--:--:--';
    }

    // Orchestrator Settings Functions
    async function showOrchestratorSettings() {
        try {
            const response = await fetch('/api/v1/settings', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const settings = data.settings;

                const intervalSelect = document.getElementById('orchestratorInterval');
                const enabledCheckbox = document.getElementById('orchestratorEnabled');

                if (settings.orchestrator_interval_minutes) {
                    intervalSelect.value = settings.orchestrator_interval_minutes.value;
                }

                if (settings.orchestrator_enabled) {
                    enabledCheckbox.checked = settings.orchestrator_enabled.value;
                }
            }

            document.getElementById('orchestratorSettingsModal').classList.remove('hidden');

        } catch (error) {
            console.error('Failed to load orchestrator settings:', error);
        }
    }

    function hideOrchestratorSettings() {
        document.getElementById('orchestratorSettingsModal').classList.add('hidden');
    }

    async function saveOrchestratorSettings() {
        try {
            const intervalSelect = document.getElementById('orchestratorInterval');
            const enabledCheckbox = document.getElementById('orchestratorEnabled');

            const intervalMinutes = parseInt(intervalSelect.value);
            const enabled = enabledCheckbox.checked;

            const response = await fetch('/api/v1/orchestrator/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    interval_minutes: intervalMinutes,
                    enabled: enabled
                })
            });

            const result = await response.json();

            if (response.ok) {
                console.log(`Orchestrator schedule updated: ${intervalMinutes} minutes, enabled: ${enabled}`);
                hideOrchestratorSettings();
                setTimeout(refreshOrchestratorStatus, 1000);
            } else {
                console.error(`Failed to update orchestrator schedule: ${result.detail}`);
            }

        } catch (error) {
            console.error('Failed to save orchestrator settings:', error);
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        checkAuth();
        refreshData();
        setupAutoRefresh();
        refreshOrchestratorStatus();
        initializeWebSockets();
    });

    function checkAuth() {
        const token = getAuthToken();
        if (!token) {
            window.location.href = '/login';
            return;
        }
    }

    // WebSocket Management
    function initializeWebSockets() {
        const jobs = ['jira_sync', 'github_sync'];
        jobs.forEach(jobName => {
            connectWebSocket(jobName);
        });
    }

    function connectWebSocket(jobName) {
        if (websockets[jobName]) {
            websockets[jobName].close();
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/progress/${jobName}`;

        try {
            const ws = new WebSocket(wsUrl);

            ws.onopen = function () {
                console.log(`WebSocket connected for ${jobName}`);
                websockets[jobName] = ws;
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(jobName, data);
                } catch (e) {
                    console.error(`Error parsing WebSocket message for ${jobName}:`, e);
                }
            };

            ws.onclose = function () {
                console.log(`WebSocket disconnected for ${jobName}`);
                websockets[jobName] = null;
                setTimeout(() => {
                    if (!websockets[jobName]) {
                        connectWebSocket(jobName);
                    }
                }, 5000);
            };

            ws.onerror = function (error) {
                console.error(`WebSocket error for ${jobName}:`, error);
            };

        } catch (e) {
            console.error(`Failed to create WebSocket for ${jobName}:`, e);
        }
    }

    function handleWebSocketMessage(jobName, data) {
        switch (data.type) {
            case 'progress':
                updateJobProgress(jobName, data.percentage, data.step);
                break;
            case 'exception':
                addJobException(jobName, data.level, data.message, data.timestamp);
                break;
            case 'status':
                updateJobStatus(jobName, data.status);
                break;
            case 'completion':
                handleJobCompletion(jobName, data.success, data.summary);
                break;
            default:
                console.log(`Unknown WebSocket message type: ${data.type}`);
        }
    }

    function updateJobProgress(jobName, percentage, step) {
        jobProgress[jobName].percentage = percentage;
        jobProgress[jobName].step = step;

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardProgress(jobCard, percentage, step);
        }
    }

    function addJobException(jobName, level, message, timestamp) {
        const exception = {
            level: level,
            message: message,
            timestamp: timestamp
        };

        jobProgress[jobName].exceptions.unshift(exception);

        if (jobProgress[jobName].exceptions.length > 10) {
            jobProgress[jobName].exceptions = jobProgress[jobName].exceptions.slice(0, 10);
        }

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardExceptions(jobCard, jobProgress[jobName].exceptions);
        }
    }

    function updateJobStatus(jobName, status) {
        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardStatus(jobCard, status);
        }
    }

    function handleJobCompletion(jobName, success, summary) {
        console.log(`Job ${jobName} completed:`, { success, summary });

        if (success) {
            updateJobProgress(jobName, 100, 'Completed successfully');
        } else {
            addJobException(jobName, 'ERROR', summary.error || 'Job failed', new Date().toISOString());
        }

        setTimeout(() => {
            refreshData();
        }, 2000);
    }

    // Data refresh functions
    async function refreshData() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/jobs/status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }

            const data = await response.json();
            updateJobCards(data.jobs || data);
            updateLastRefreshTime();
        } catch (error) {
            console.error('Error fetching job status:', error);
        }
    }

    function updateJobCards(jobsData) {
        const container = document.getElementById('jobsContainer');
        container.innerHTML = '';

        Object.entries(jobsData).forEach(([jobName, jobData]) => {
            const card = createJobCard(jobName, jobData, jobsData);
            container.appendChild(card);
        });

        updateOrchestratorButtonState(jobsData);
    }

    function updateOrchestratorButtonState(jobsData) {
        const orchestratorBtn = document.getElementById('forceStartOrchestratorBtn');
        if (!orchestratorBtn) return;

        const anyJobRunning = Object.values(jobsData).some(jobData => jobData.status === 'RUNNING');

        if (anyJobRunning) {
            orchestratorBtn.disabled = true;
            orchestratorBtn.className = 'bg-gray-500 cursor-not-allowed text-white px-3 py-1 rounded text-sm font-medium';
            orchestratorBtn.title = 'Cannot start orchestrator while jobs are running';
        } else {
            orchestratorBtn.disabled = false;
            orchestratorBtn.className = 'btn-neutral-primary';
            orchestratorBtn.title = '';
        }
    }

    function setupAutoRefresh() {
        const select = document.getElementById('refreshInterval');
        select.addEventListener('change', function () {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }

            const interval = parseInt(this.value);
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval);
            }
        });

        const defaultInterval = parseInt(select.value);
        if (defaultInterval > 0) {
            refreshTimer = setInterval(refreshData, defaultInterval);
        }
    }

    function updateLastRefreshTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent =
            `Last updated: ${now.toLocaleTimeString()}`;
    }

    function createJobCard(jobName, jobData, allJobsData) {
        const card = document.createElement('div');
        card.className = 'glass-effect rounded-lg p-6';
        card.setAttribute('data-job', jobName);

        const statusClass = getStatusClass(jobData.status);
        const statusIcon = getStatusIcon(jobData.status);

        card.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-white capitalize">
                    <i class="fas fa-${jobName === 'jira_sync' ? 'ticket-alt' : 'code-branch'} mr-2"></i>
                    ${jobName.replace('_', ' ')}
                </h3>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                    <i class="fas fa-${statusIcon} mr-1"></i>${jobData.status}
                </span>
            </div>

            ${createJobDetails(jobName, jobData)}
            ${createWebSocketProgress(jobName)}
            ${createExceptionLog(jobName)}

            <div class="mt-4 flex flex-wrap gap-2">
                ${createActionButtons(jobName, jobData, allJobsData)}
            </div>
        `;

        return card;
    }

    function createJobDetails(jobName, jobData) {
        let details = `
            <div class="space-y-3 text-white text-opacity-80 text-sm">
                <div class="flex justify-between">
                    <span>Last Run:</span>
                    <span>${jobData.last_run_started_at ? new Date(jobData.last_run_started_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Last Success:</span>
                    <span>${jobData.last_success_at ? new Date(jobData.last_success_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Retry Count:</span>
                    <span>${jobData.retry_count || 0}</span>
                </div>
            </div>
        `;

        if (jobData.status === 'PENDING' && jobData.checkpoint_data) {
            details += createRecoveryDetails(jobData.checkpoint_data);
        }

        if (jobData.error_message) {
            details += `
                <div class="mt-3 p-3 bg-red-500 bg-opacity-20 rounded-lg border border-red-500 border-opacity-50">
                    <div class="text-red-200 text-xs font-medium mb-1">Error Message:</div>
                    <div class="text-red-100 text-xs">${jobData.error_message}</div>
                </div>
            `;
        }

        return details;
    }

    function createRecoveryDetails(checkpointData) {
        if (!checkpointData) return '';

        let recoveryHtml = `
            <div class="mt-3 p-3 bg-yellow-500 bg-opacity-20 rounded-lg border border-yellow-500 border-opacity-50">
                <div class="text-yellow-200 text-xs font-medium mb-2">
                    <i class="fas fa-redo mr-1"></i>Recovery Information:
                </div>
        `;

        if (checkpointData.repo_processing_queue) {
            let queue;
            if (typeof checkpointData.repo_processing_queue === 'string') {
                queue = JSON.parse(checkpointData.repo_processing_queue);
            } else {
                queue = checkpointData.repo_processing_queue;
            }

            const finished = queue.filter(r => r.finished).length;
            const total = queue.length;
            const remaining = total - finished;

            recoveryHtml += `
                <div class="text-yellow-100 text-xs mb-1">
                    Repositories: ${finished}/${total} completed (${remaining} remaining)
                </div>
            `;
        }

        const cursors = ['last_pr_cursor', 'current_pr_node_id', 'last_commit_cursor', 'last_review_cursor', 'last_comment_cursor'];
        cursors.forEach(cursor => {
            if (checkpointData[cursor]) {
                recoveryHtml += `
                    <div class="text-yellow-100 text-xs mb-1">
                        ${cursor.replace(/_/g, ' ')}: ${checkpointData[cursor].substring(0, 20)}...
                    </div>
                `;
            }
        });

        recoveryHtml += '</div>';
        return recoveryHtml;
    }

    function createActionButtons(jobName, jobData, allJobsData) {
        const canStart = ['PENDING', 'FINISHED', 'NOT_STARTED'].includes(jobData.status);
        const canStop = jobData.status === 'RUNNING';
        const canPause = ['PENDING', 'FINISHED'].includes(jobData.status);
        const canUnpause = jobData.status === 'PAUSED';

        const otherJobRunning = Object.entries(allJobsData).some(([name, data]) =>
            name !== jobName && data.status === 'RUNNING'
        );

        const canStartSafe = canStart && !otherJobRunning;
        const canPauseSafe = canPause && jobData.status !== 'RUNNING';

        return `
            <button onclick="forceStart('${jobName}')"
                    ${!canStartSafe ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${canStartSafe ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                    title="${!canStartSafe && otherJobRunning ? 'Cannot start while another job is running' : ''}">
                <i class="fas fa-play mr-1"></i>Force Start
            </button>
            <button onclick="forceStop('${jobName}')"
                    ${!canStop ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${canStop ? 'bg-red-500 hover:bg-red-600' : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300">
                <i class="fas fa-stop mr-1"></i>Force Stop
            </button>
            <button onclick="${canUnpause ? 'unpauseJob' : 'pauseJob'}('${jobName}')"
                    ${!(canPauseSafe || canUnpause) ? 'disabled' : ''}
                    class="px-3 py-1 rounded text-sm ${(canPauseSafe || canUnpause) ? (canUnpause ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-amber-500 hover:bg-amber-600') : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                    title="${!canPauseSafe && jobData.status === 'RUNNING' ? 'Cannot pause while job is running' : ''}">
                <i class="fas fa-${canUnpause ? 'play' : 'pause'} mr-1"></i>${canUnpause ? 'Unpause' : 'Pause'}
            </button>
            <button onclick="showJobDetails('${jobName}')"
                    class="px-3 py-1 rounded text-sm bg-purple-500 hover:bg-purple-600 text-white transition duration-300">
                <i class="fas fa-info-circle mr-1"></i>Details
            </button>
        `;
    }

    function getStatusClass(status) {
        switch (status) {
            case 'RUNNING': return 'status-running';
            case 'PENDING': return 'status-pending';
            case 'FINISHED': return 'status-finished';
            case 'PAUSED': return 'status-paused';
            case 'NOT_STARTED': return 'status-not-started';
            default: return 'status-error';
        }
    }

    function getStatusIcon(status) {
        switch (status) {
            case 'RUNNING': return 'spinner fa-spin';
            case 'PENDING': return 'clock';
            case 'FINISHED': return 'check-circle';
            case 'PAUSED': return 'pause-circle';
            case 'NOT_STARTED': return 'circle';
            default: return 'exclamation-triangle';
        }
    }

    function createWebSocketProgress(jobName) {
        const progress = jobProgress[jobName];
        if (!progress || progress.percentage === 0) {
            return '';
        }

        return `
            <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-medium text-white">Real-time Progress</span>
                    <span class="text-xs text-white">${Math.round(progress.percentage)}%</span>
                </div>
                <div class="ws-progress-container">
                    <div class="ws-progress-bar" style="width: ${progress.percentage}%"></div>
                </div>
                <div class="ws-progress-text">${progress.step}</div>
            </div>
        `;
    }

    function createExceptionLog(jobName) {
        const exceptions = jobProgress[jobName].exceptions;
        if (!exceptions || exceptions.length === 0) {
            return '';
        }

        const exceptionsHtml = exceptions.map(exception => `
            <div class="exception-item ${exception.level.toLowerCase()}">
                <div class="flex justify-between items-start">
                    <span class="font-medium">${exception.level}:</span>
                    <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="mt-1">${exception.message}</div>
            </div>
        `).join('');

        return `
            <div class="mt-4">
                <div class="text-xs font-medium text-white mb-2">Issues & Warnings</div>
                <div class="exception-log">
                    ${exceptionsHtml}
                </div>
            </div>
        `;
    }

    function updateJobCardProgress(jobCard, percentage, step) {
        let progressSection = jobCard.querySelector('.ws-progress-container');
        if (!progressSection) {
            const detailsSection = jobCard.querySelector('.space-y-3');
            if (detailsSection) {
                const progressHtml = createWebSocketProgress(jobCard.getAttribute('data-job'));
                detailsSection.insertAdjacentHTML('afterend', progressHtml);
                progressSection = jobCard.querySelector('.ws-progress-container');
            }
        }

        if (progressSection) {
            const progressBar = progressSection.querySelector('.ws-progress-bar');
            const progressText = jobCard.querySelector('.ws-progress-text');
            const progressPercentage = progressSection.parentElement.querySelector('.text-xs:last-child');

            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = step;
            if (progressPercentage) progressPercentage.textContent = `${Math.round(percentage)}%`;
        }
    }

    function updateJobCardExceptions(jobCard, exceptions) {
        let exceptionSection = jobCard.querySelector('.exception-log');
        if (!exceptionSection && exceptions.length > 0) {
            const progressSection = jobCard.querySelector('.ws-progress-container');
            const insertPoint = progressSection ? progressSection.parentElement : jobCard.querySelector('.space-y-3');
            if (insertPoint) {
                const exceptionHtml = createExceptionLog(jobCard.getAttribute('data-job'));
                insertPoint.insertAdjacentHTML('afterend', exceptionHtml);
                exceptionSection = jobCard.querySelector('.exception-log');
            }
        }

        if (exceptionSection && exceptions.length > 0) {
            const exceptionsHtml = exceptions.map(exception => `
                <div class="exception-item ${exception.level.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <span class="font-medium">${exception.level}:</span>
                        <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-1">${exception.message}</div>
                </div>
            `).join('');
            exceptionSection.innerHTML = exceptionsHtml;
        }
    }

    function updateJobCardStatus(jobCard, status) {
        const statusSpan = jobCard.querySelector('.px-3.py-1.rounded-full');
        if (statusSpan) {
            const statusClass = getStatusClass(status);
            const statusIcon = getStatusIcon(status);
            statusSpan.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClass}`;
            statusSpan.innerHTML = `<i class="fas fa-${statusIcon} mr-1"></i>${status}`;
        }
    }

    // Simple authentication function
    function getAuthToken() {
        let token = localStorage.getItem('pulse_token');
        if (!token) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'pulse_token') {
                    token = value;
                    break;
                }
            }
        }
        return token;
    }

    function redirectToLogin(reason) {
        // Clear localStorage tokens
        localStorage.removeItem('pulse_token');
        localStorage.removeItem('token');

        // Clear cookie by expiring it
        document.cookie = 'pulse_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

        // Redirect with reason
        window.location.href = `/login?error=session_expired&reason=${encodeURIComponent(reason)}`;
    }

    // Cache auth status to avoid redundant checks
    let lastAuthCheck = null;
    let lastAuthResult = false;
    const AUTH_CACHE_TTL = 60000; // 1 minute cache

    async function checkAuth(forceCheck = false) {
        const token = getAuthToken();

        if (!token) {
            redirectToLogin('No authentication token found');
            return false;
        }

        // Use cached result if recent and not forced
        const now = Date.now();
        if (!forceCheck && lastAuthCheck && (now - lastAuthCheck) < AUTH_CACHE_TTL && lastAuthResult) {
            return lastAuthResult;
        }

        // Validate token with server
        try {
            const response = await fetch('/api/v1/auth/validate', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            lastAuthCheck = now;
            lastAuthResult = response.ok;

            if (!response.ok) {
                redirectToLogin('Session expired or invalid');
                return false;
            }

            return true;
        } catch (error) {
            console.error('Auth validation error:', error);
            redirectToLogin('Authentication check failed');
            return false;
        }
    }

    // Check for error messages in URL parameters and display them
    function checkForErrorMessages() {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const resource = urlParams.get('resource');

        if (error === 'permission_denied' && resource) {
            const resourceName = resource.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            showPermissionDeniedMessage(resourceName);

            // Clean up URL without reloading the page
            const url = new URL(window.location);
            url.searchParams.delete('error');
            url.searchParams.delete('resource');
            window.history.replaceState({}, document.title, url.pathname);
        }
    }

    // Show permission denied message
    function showPermissionDeniedMessage(resourceName) {
        const message = `
            <div id="permission-error-banner" class="fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg max-w-md" style="background-color: var(--status-error-bg); color: var(--status-error-text);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-3"></i>
                        <div>
                            <div class="font-semibold">Access Denied</div>
                            <div class="text-sm opacity-90">You don't have permission to access ${resourceName}</div>
                        </div>
                    </div>
                    <button onclick="closePermissionBanner()" class="ml-4 hover:opacity-75">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', message);

        // Auto-hide after 5 seconds
        setTimeout(() => {
            closePermissionBanner();
        }, 5000);
    }

    // Close permission banner
    function closePermissionBanner() {
        const banner = document.getElementById('permission-error-banner');
        if (banner) {
            banner.remove();
        }
    }

    // Load user information
    async function loadUserInfo() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/auth/user', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const user = await response.json();
                document.getElementById('user-email').textContent = user.email || 'Unknown';

                const roleBadge = document.getElementById('user-role-badge');
                if (user.role) {
                    roleBadge.textContent = user.role.toUpperCase();
                    roleBadge.style.display = 'inline';
                    roleBadge.style.backgroundColor = user.role === 'admin' ? 'var(--color-2)' : 'var(--color-4)';
                    roleBadge.style.color = 'white';

                    // Show system health section for admin users
                    if (user.role === 'admin') {
                        document.getElementById('system-health-section').style.display = 'block';
                    }
                }
            }
        } catch (error) {
            console.error('Error loading user info:', error);
            document.getElementById('user-email').textContent = 'Error loading user';
        }
    }

    // System Health Functions
    async function refreshSystemHealth() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/health/detailed', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const health = await response.json();
                updateSystemHealthUI(health);
            } else {
                console.error('Failed to fetch system health');
            }
        } catch (error) {
            console.error('Error fetching system health:', error);
        }
    }

    function updateSystemHealthUI(health) {
        // Database Status
        const dbStatus = document.getElementById('dbStatus');
        const dbDetails = document.getElementById('dbDetails');
        if (health.database) {
            dbStatus.className = `px-2 py-1 rounded text-xs font-medium ${health.database.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            dbStatus.innerHTML = `<i class="fas fa-${health.database.status === 'healthy' ? 'check' : 'times'} mr-1"></i>${health.database.status}`;
            dbDetails.textContent = health.database.details || 'PostgreSQL Connection';
        }

        // Jira API Status
        const jiraStatus = document.getElementById('jiraApiStatus');
        const jiraDetails = document.getElementById('jiraApiDetails');
        if (health.jira_api) {
            jiraStatus.className = `px-2 py-1 rounded text-xs font-medium ${health.jira_api.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            jiraStatus.innerHTML = `<i class="fas fa-${health.jira_api.status === 'healthy' ? 'check' : 'times'} mr-1"></i>${health.jira_api.status}`;
            jiraDetails.textContent = health.jira_api.details || 'API Connectivity';
        }

        // GitHub API Status
        const githubStatus = document.getElementById('githubApiStatus');
        const githubDetails = document.getElementById('githubApiDetails');
        if (health.github_api) {
            githubStatus.className = `px-2 py-1 rounded text-xs font-medium ${health.github_api.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            githubStatus.innerHTML = `<i class="fas fa-${health.github_api.status === 'healthy' ? 'check' : 'times'} mr-1"></i>${health.github_api.status}`;
            githubDetails.textContent = health.github_api.details || 'Rate Limits & Connectivity';
        }

        // System Resources
        const systemStatus = document.getElementById('systemStatus');
        const systemDetails = document.getElementById('systemDetails');
        if (health.system) {
            systemStatus.className = `px-2 py-1 rounded text-xs font-medium ${health.system.status === 'healthy' ? 'bg-green-500' : 'bg-yellow-500'} text-white`;
            systemStatus.innerHTML = `<i class="fas fa-${health.system.status === 'healthy' ? 'check' : 'exclamation-triangle'} mr-1"></i>${health.system.status}`;
            systemDetails.textContent = health.system.details || 'Memory & CPU Usage';
        }
    }

    // Log Management Functions
    function showLogManagement() {
        document.getElementById('logManagementModal').classList.remove('hidden');
        loadLogFiles();
        refreshLogEntries();
    }

    function hideLogManagement() {
        document.getElementById('logManagementModal').classList.add('hidden');
    }

    async function loadLogFiles() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/logs/files', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const files = await response.json();
                updateLogFilesList(files);
            }
        } catch (error) {
            console.error('Error loading log files:', error);
        }
    }

    function updateLogFilesList(files) {
        const container = document.getElementById('logFilesList');
        if (!files || files.length === 0) {
            container.innerHTML = '<div class="text-center py-4" style="color: var(--text-muted);">No log files found</div>';
            return;
        }

        container.innerHTML = files.map(file => `
            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-file-alt" style="color: var(--color-3);"></i>
                    <div>
                        <div class="font-medium text-sm" style="color: var(--text-primary);">${file.name}</div>
                        <div class="text-xs" style="color: var(--text-muted);">${file.size}  ${file.modified}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="downloadLogFile('${file.name}')" class="btn-color-1 text-xs">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                    <button onclick="deleteLogFile('${file.name}')" class="btn-status-error text-xs">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function downloadLogFile(filename) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/logs/download/${filename}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        } catch (error) {
            console.error('Error downloading log file:', error);
        }
    }

    async function deleteLogFile(filename) {
        if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/logs/delete/${filename}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                loadLogFiles(); // Refresh the list
            }
        } catch (error) {
            console.error('Error deleting log file:', error);
        }
    }

    async function bulkCleanupLogs() {
        const days = document.getElementById('bulkCleanupDays').value;
        const confirmText = days === '0' ? 'delete ALL log files' : `delete log files older than ${days} days`;

        if (!confirm(`Are you sure you want to ${confirmText}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/logs/cleanup', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ days: parseInt(days) })
            });

            if (response.ok) {
                const result = await response.json();
                alert(`Deleted ${result.deleted_count} log files`);
                loadLogFiles(); // Refresh the list
            }
        } catch (error) {
            console.error('Error during bulk cleanup:', error);
        }
    }

    let currentLogPage = 1;
    async function refreshLogEntries() {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/logs/entries?page=${currentLogPage}&limit=50`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                updateLogTable(data.entries);
                updateLogPagination(data.pagination);
            }
        } catch (error) {
            console.error('Error loading log entries:', error);
        }
    }

    function updateLogTable(entries) {
        const tbody = document.getElementById('logTableBody');
        if (!entries || entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center" style="color: var(--text-muted);">No log entries found</td></tr>';
            return;
        }

        tbody.innerHTML = entries.map(entry => `
            <tr class="border-b" style="border-color: var(--border-color);">
                <td class="p-2 text-xs" style="color: var(--text-secondary);">${entry.timestamp}</td>
                <td class="p-2">
                    <span class="px-2 py-1 rounded text-xs font-medium ${getLevelClass(entry.level)}">
                        ${entry.level}
                    </span>
                </td>
                <td class="p-2 text-xs" style="color: var(--text-secondary);">${entry.module}</td>
                <td class="p-2 text-xs" style="color: var(--text-primary);">${entry.message}</td>
            </tr>
        `).join('');
    }

    function getLevelClass(level) {
        switch (level.toLowerCase()) {
            case 'error': return 'bg-red-500 text-white';
            case 'warning': return 'bg-yellow-500 text-white';
            case 'info': return 'bg-blue-500 text-white';
            case 'debug': return 'bg-gray-500 text-white';
            default: return 'bg-gray-400 text-white';
        }
    }

    function updateLogPagination(pagination) {
        document.getElementById('logPaginationInfo').textContent =
            `Page ${pagination.current_page} of ${pagination.total_pages} (${pagination.total_entries} entries)`;

        document.getElementById('logPrevPage').disabled = pagination.current_page <= 1;
        document.getElementById('logNextPage').disabled = pagination.current_page >= pagination.total_pages;
    }

    function changeLogPage(direction) {
        currentLogPage += direction;
        if (currentLogPage < 1) currentLogPage = 1;
        refreshLogEntries();
    }

    // Job Action Functions
    async function forceStart(jobName) {
        if (!confirm(`Are you sure you want to force start ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/start`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} started successfully`);
                refreshData();
            } else {
                console.error(`Failed to start ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error starting ${jobName}: ${error.message}`);
        }
    }

    async function forceStop(jobName) {
        if (!confirm(`Are you sure you want to force stop ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/stop`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} stopped successfully`);
                refreshData();
            } else {
                console.error(`Failed to stop ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error stopping ${jobName}: ${error.message}`);
        }
    }

    async function pauseJob(jobName) {
        if (!confirm(`Are you sure you want to pause ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/pause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} paused successfully`);
                await refreshData();
            } else {
                console.error(`Failed to pause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error pausing ${jobName}: ${error.message}`);
        }
    }

    async function unpauseJob(jobName) {
        if (!confirm(`Are you sure you want to unpause ${jobName}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/unpause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} unpaused successfully - new status: ${result.status}`);
                await refreshData();
            } else {
                console.error(`Failed to unpause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error unpausing ${jobName}: ${error.message}`);
        }
    }

    function showJobDetails(jobName) {
        // Future enhancement: Implement job details modal with execution history, performance metrics, and detailed logs
        console.log(`Showing details for ${jobName} (feature coming soon)`);
    }

    // Orchestrator Control Functions
    async function forceStartOrchestrator() {
        const button = event.target.closest('button');

        // Check if button is disabled
        if (button.disabled) {
            console.warn('Cannot start orchestrator while jobs are running');
            return;
        }

        const originalText = button.innerHTML;

        try {
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Starting...';
            button.disabled = true;

            console.log('Force starting orchestrator... (this may take a few seconds)');

            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log('Orchestrator started successfully');
                setTimeout(refreshOrchestratorStatus, 1000);
            } else {
                console.error(`Failed to start orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error starting orchestrator: ${error.message}`);
        } finally {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    async function pauseOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/pause', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.warn('Orchestrator paused');
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to pause orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error pausing orchestrator: ${error.message}`);
        }
    }

    async function resumeOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/resume', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log('Orchestrator resumed');
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to resume orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error resuming orchestrator: ${error.message}`);
        }
    }

    async function refreshOrchestratorStatus() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const status = await response.json();
                updateOrchestratorUI(status);
            } else {
                console.error('Failed to fetch orchestrator status:', response.status, response.statusText);
                // Use fallback status
                updateOrchestratorUI({
                    status: 'unknown',
                    next_run: null
                });
            }
        } catch (error) {
            console.error('Error fetching orchestrator status:', error);
            // Use fallback status
            updateOrchestratorUI({
                status: 'error',
                next_run: null
            });
        }
    }

    // Enhanced Orchestrator Settings Functions
    async function showOrchestratorSettings() {
        try {
            // Load current settings
            const response = await fetch('/api/v1/settings', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const settings = data.settings;

                // Update modal with current values
                const intervalSelect = document.getElementById('orchestratorInterval');
                const enabledCheckbox = document.getElementById('orchestratorEnabled');
                const retryEnabledCheckbox = document.getElementById('retryEnabled');
                const retryIntervalSelect = document.getElementById('retryInterval');
                const maxRetryAttemptsSelect = document.getElementById('maxRetryAttempts');

                if (settings.orchestrator_interval_minutes) {
                    intervalSelect.value = settings.orchestrator_interval_minutes.value;
                }

                if (settings.orchestrator_enabled) {
                    enabledCheckbox.checked = settings.orchestrator_enabled.value;
                }

                if (settings.retry_enabled) {
                    retryEnabledCheckbox.checked = settings.retry_enabled.value;
                }

                if (settings.retry_interval_minutes) {
                    retryIntervalSelect.value = settings.retry_interval_minutes.value;
                }

                if (settings.max_retry_attempts) {
                    maxRetryAttemptsSelect.value = settings.max_retry_attempts.value;
                }
            }

            // Show modal
            document.getElementById('orchestratorSettingsModal').classList.remove('hidden');

        } catch (error) {
            console.error('Failed to load orchestrator settings:', error);
        }
    }

    function hideOrchestratorSettings() {
        document.getElementById('orchestratorSettingsModal').classList.add('hidden');
    }

    async function saveOrchestratorSettings() {
        try {
            const intervalSelect = document.getElementById('orchestratorInterval');
            const enabledCheckbox = document.getElementById('orchestratorEnabled');
            const retryEnabledCheckbox = document.getElementById('retryEnabled');
            const retryIntervalSelect = document.getElementById('retryInterval');
            const maxRetryAttemptsSelect = document.getElementById('maxRetryAttempts');

            const intervalMinutes = parseInt(intervalSelect.value);
            const enabled = enabledCheckbox.checked;
            const retryEnabled = retryEnabledCheckbox.checked;
            const retryIntervalMinutes = parseInt(retryIntervalSelect.value);
            const maxRetryAttempts = parseInt(maxRetryAttemptsSelect.value);

            const response = await fetch('/api/v1/orchestrator/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    interval_minutes: intervalMinutes,
                    enabled: enabled,
                    retry_enabled: retryEnabled,
                    retry_interval_minutes: retryIntervalMinutes,
                    max_retry_attempts: maxRetryAttempts
                })
            });

            const result = await response.json();

            if (response.ok) {
                console.log(`Orchestrator schedule updated: ${intervalMinutes} minutes, enabled: ${enabled}, retry: ${retryEnabled}`);
                hideOrchestratorSettings();

                // Refresh orchestrator status to show new schedule
                setTimeout(refreshOrchestratorStatus, 1000);
            } else {
                console.error(`Failed to update orchestrator schedule: ${result.detail}`);
            }

        } catch (error) {
            console.error('Failed to save orchestrator settings:', error);
        }
    }
</script>
{% endblock %}

