{% extends "layouts/modern_layout.html" %}

{% block title %}Pulse ETL Management - Admin Panel{% endblock %}

{% block extra_head %}
<style>
    /* Admin-specific styles */
    .stats-card {
        transition: transform 0.2s ease-in-out;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        background-color: var(--bg-secondary);
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .admin-section {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .section-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-tertiary);
        border-radius: 0.75rem 0.75rem 0 0;
    }
    
    .section-content {
        padding: 1.5rem;
    }
    
    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .btn-admin {
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                <i class="fas fa-users-cog mr-3"></i>Admin Panel
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">Manage users, roles, and system settings</p>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="refreshStats()" class="btn-neutral-secondary">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
        </div>
    </div>
</div>

<!-- Database Statistics -->
<div class="admin-section">
    <div class="section-header">
        <h2 class="text-xl font-semibold" style="color: var(--text-primary);">
            <i class="fas fa-database mr-2"></i>Database Statistics
        </h2>
    </div>
    <div class="section-content">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="stats-card p-6 text-center">
                <i class="fas fa-hdd text-3xl mb-3" style="color: var(--color-4);"></i>
                <h3 class="text-2xl font-bold mb-1" style="color: var(--text-primary);" id="database-size">-</h3>
                <p class="text-sm" style="color: var(--text-muted);">Database Size</p>
            </div>
            <div class="stats-card p-6 text-center">
                <i class="fas fa-table text-3xl mb-3" style="color: var(--color-2);"></i>
                <h3 class="text-2xl font-bold mb-1" style="color: var(--text-primary);" id="table-count">-</h3>
                <p class="text-sm" style="color: var(--text-muted);">Active Tables</p>
            </div>
            <div class="stats-card p-6 text-center">
                <i class="fas fa-database text-3xl mb-3" style="color: var(--color-1);"></i>
                <h3 class="text-2xl font-bold mb-1" style="color: var(--text-primary);" id="total-records">-</h3>
                <p class="text-sm" style="color: var(--text-muted);">Total Records</p>
            </div>
        </div>
    </div>
</div>

<!-- User Statistics -->
<div class="admin-section">
    <div class="section-header">
        <h2 class="text-xl font-semibold" style="color: var(--text-primary);">
            <i class="fas fa-users mr-2"></i>User Management
        </h2>
    </div>
    <div class="section-content">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stats-card p-4 text-center">
                <i class="fas fa-users text-2xl mb-2" style="color: var(--color-1);"></i>
                <h3 class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="total-users">-</h3>
                <p class="text-xs" style="color: var(--text-muted);">Total Users</p>
            </div>
            <div class="stats-card p-4 text-center">
                <i class="fas fa-user-check text-2xl mb-2" style="color: var(--color-3);"></i>
                <h3 class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="active-users">-</h3>
                <p class="text-xs" style="color: var(--text-muted);">Active Users</p>
            </div>
            <div class="stats-card p-4 text-center">
                <i class="fas fa-user-clock text-2xl mb-2" style="color: var(--color-4);"></i>
                <h3 class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="logged-users">-</h3>
                <p class="text-xs" style="color: var(--text-muted);">Logged Users</p>
            </div>
            <div class="stats-card p-4 text-center">
                <i class="fas fa-user-shield text-2xl mb-2" style="color: var(--color-5);"></i>
                <h3 class="text-xl font-bold mb-1" style="color: var(--text-primary);" id="admin-users">-</h3>
                <p class="text-xs" style="color: var(--text-muted);">Admin Users</p>
            </div>
        </div>
        
        <!-- Users Table -->
        <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);" class="rounded-lg overflow-hidden">
            <div class="px-6 py-4 flex items-center justify-between" style="border-bottom: 1px solid var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Users</h3>
                <button onclick="showCreateUserModal()" class="btn-crud-create">
                    <i class="fas fa-plus mr-2"></i>Add User
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background-color: var(--bg-tertiary);">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Last Login</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" style="background-color: var(--bg-secondary);">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center" style="color: var(--text-muted);">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Integrations Section -->
<div class="admin-section">
    <div class="section-header">
        <h2 class="text-xl font-semibold" style="color: var(--text-primary);">
            <i class="fas fa-plug mr-2"></i>Integrations
        </h2>
    </div>
    <div class="section-content">
        <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);" class="rounded-lg overflow-hidden">
            <div class="px-6 py-4 flex items-center justify-between" style="border-bottom: 1px solid var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Active Integrations</h3>
                <button onclick="refreshIntegrations()" class="btn-neutral-secondary">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background-color: var(--bg-tertiary);">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Last Sync</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="integrations-table-body" style="background-color: var(--bg-secondary);">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center" style="color: var(--text-muted);">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading integrations...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let users = [];
    let integrations = [];
    let stats = {};

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function () {
        // Load all admin data
        loadSystemStats();
        loadUsers();
        loadIntegrations();
    });

    // Authentication helper
    function getAuthToken() {
        // Check localStorage first, then cookies
        let token = localStorage.getItem('pulse_token');
        if (!token) {
            // Check cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'pulse_token') {
                    token = value;
                    break;
                }
            }
        }
        return token;
    }

    // Load system statistics
    async function loadSystemStats() {
        try {
            const token = getAuthToken();
            if (!token) return;

            const response = await fetch('/api/v1/admin/stats', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                stats = await response.json();
                updateStatsDisplay();
            }
        } catch (error) {
            console.error('Error loading system stats:', error);
        }
    }

    // Update statistics display
    function updateStatsDisplay() {
        if (stats.database_stats) {
            document.getElementById('database-size').textContent = stats.database_stats.size || '-';
            document.getElementById('table-count').textContent = stats.database_stats.table_count || '-';
            document.getElementById('total-records').textContent = stats.database_stats.total_records?.toLocaleString() || '-';
        }
        
        if (stats.user_stats) {
            document.getElementById('total-users').textContent = stats.user_stats.total || '-';
            document.getElementById('active-users').textContent = stats.user_stats.active || '-';
            document.getElementById('logged-users').textContent = stats.user_stats.logged || '-';
            document.getElementById('admin-users').textContent = stats.user_stats.admin || '-';
        }
    }

    // Load users
    async function loadUsers() {
        try {
            const token = getAuthToken();
            if (!token) return;

            const response = await fetch('http://localhost:3001/api/v1/admin/users', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                users = await response.json();
                updateUsersTable();
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // Update users table
    function updateUsersTable() {
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';

        if (!users || users.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="px-6 py-4 text-center" style="color: var(--text-muted);">No users found</td></tr>
            `;
            return;
        }

        users.forEach(user => {
            const row = document.createElement('tr');
            row.className = 'border-b border-default hover:bg-tertiary';
            
            const displayName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email;
            const statusBadge = user.active ? 
                '<span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--color-3); color: white;">Active</span>' :
                '<span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--text-muted); color: white;">Inactive</span>';
            
            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3" style="background-color: var(--color-1);">
                            <span class="text-sm font-medium text-white">${displayName.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium" style="color: var(--text-primary);">${displayName}</div>
                            <div class="text-sm" style="color: var(--text-muted);">${user.email}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm" style="color: var(--text-secondary);">${user.role}</td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4 text-sm" style="color: var(--text-secondary);">${user.last_login_at ? new Date(user.last_login_at).toLocaleDateString() : 'Never'}</td>
                <td class="px-6 py-4 text-sm">
                    <button onclick="editUser(${user.id})" class="btn-neutral-secondary mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${user.active ? 
                        `<button onclick="deactivateUser(${user.id})" class="btn-crud-delete">
                            <i class="fas fa-user-slash"></i>
                        </button>` :
                        `<button onclick="activateUser(${user.id})" class="btn-crud-create">
                            <i class="fas fa-user-check"></i>
                        </button>`
                    }
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Load integrations
    async function loadIntegrations() {
        try {
            const token = getAuthToken();
            if (!token) return;

            const response = await fetch('/api/v1/admin/integrations', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                integrations = await response.json();
                updateIntegrationsTable();
            }
        } catch (error) {
            console.error('Error loading integrations:', error);
        }
    }

    // Update integrations table
    function updateIntegrationsTable() {
        const tbody = document.getElementById('integrations-table-body');
        tbody.innerHTML = '';

        if (!integrations || integrations.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="5" class="px-6 py-4 text-center" style="color: var(--text-muted);">No integrations configured</td></tr>
            `;
            return;
        }

        integrations.forEach(integration => {
            const row = document.createElement('tr');
            row.className = 'border-b border-default hover:bg-tertiary';
            
            const statusBadge = integration.active ? 
                '<span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--color-3); color: white;">Active</span>' :
                '<span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--text-muted); color: white;">Inactive</span>';
            
            row.innerHTML = `
                <td class="px-6 py-4">
                    <span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--color-2); color: white;">${integration.integration_type}</span>
                </td>
                <td class="px-6 py-4 text-sm font-medium" style="color: var(--text-primary);">${integration.name}</td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4 text-sm" style="color: var(--text-secondary);">${integration.last_sync_at ? new Date(integration.last_sync_at).toLocaleDateString() : 'Never'}</td>
                <td class="px-6 py-4 text-sm">
                    <button onclick="editIntegration(${integration.id})" class="btn-neutral-secondary mr-2">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deactivateIntegration(${integration.id})" class="btn-crud-delete">
                        <i class="fas fa-pause"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Refresh functions
    function refreshStats() {
        loadSystemStats();
    }

    function refreshIntegrations() {
        loadIntegrations();
    }

    // Placeholder functions for user/integration management
    function showCreateUserModal() {
        alert('Create user modal would open here');
    }

    function editUser(userId) {
        alert(`Edit user ${userId} modal would open here`);
    }

    function deactivateUser(userId) {
        alert(`Deactivate user ${userId} confirmation would show here`);
    }

    function activateUser(userId) {
        alert(`Activate user ${userId} confirmation would show here`);
    }

    function editIntegration(integrationId) {
        alert(`Edit integration ${integrationId} modal would open here`);
    }

    function deactivateIntegration(integrationId) {
        alert(`Deactivate integration ${integrationId} confirmation would show here`);
    }

    // Logout function - redirect to ETL service logout for proper session invalidation
    function logout() {
        window.location.href = '/logout';
    }
</script>
{% endblock %}
