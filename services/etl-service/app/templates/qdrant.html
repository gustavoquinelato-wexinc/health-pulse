{% extends "layouts/modern_layout.html" %}

{% block title %}Qdrant Analysis - Pulse ETL{% endblock %}

{% block content %}

<!-- Header Section -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                Qdrant Database
            </h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">
                Vector database analysis and vectorization validation
            </p>
        </div>
        <div class="flex items-center space-x-2">
            <div id="qdrantStatusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span class="text-sm" style="color: var(--text-secondary);" id="qdrantStatusText">Connecting...</span>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="mb-8">
    <div class="flex space-x-1 border-b" style="border-color: var(--border-color);">
        <button onclick="showQdrantTab('dashboard')" id="qdrantTabDashboard" class="qdrant-tab active px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i>Dashboard
        </button>


        <button onclick="showQdrantTab('management')" id="qdrantTabManagement" class="qdrant-tab px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="settings" class="w-4 h-4 mr-2"></i>Management
        </button>
    </div>
</div>

<!-- Tab Content -->
<div id="qdrantTabContent" class="min-h-96">
    <!-- Content will be populated by JavaScript -->
    <div class="text-center py-16" style="color: var(--text-muted);">
        <i data-lucide="loader-2" class="w-12 h-12 mx-auto mb-4 animate-spin"></i>
        <p class="text-lg">Loading Qdrant analysis...</p>
        <p class="text-sm mt-2">Connecting to vector database...</p>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<script>
    // ===== COLOR SCHEMA APPLICATION =====

    // Apply color schema from backend
    document.addEventListener('DOMContentLoaded', function() {
        const colorSchemaData = {{ color_schema | tojson | safe }};

        // Check if we have color data (either with success flag or direct colors)
        if (colorSchemaData && ((colorSchemaData.success && colorSchemaData.colors) || colorSchemaData.colors)) {
            const colors = colorSchemaData.colors;
            const root = document.documentElement;

            // Apply the 5-color system
            if (colors.color1) {
                root.style.setProperty('--color-1', colors.color1);
            }
            if (colors.color2) {
                root.style.setProperty('--color-2', colors.color2);
            }
            if (colors.color3) root.style.setProperty('--color-3', colors.color3);
            if (colors.color4) root.style.setProperty('--color-4', colors.color4);
            if (colors.color5) root.style.setProperty('--color-5', colors.color5);

            // Apply gradient variables
            if (colors.color1 && colors.color2) {
                const gradient = `linear-gradient(135deg, ${colors.color1}, ${colors.color2})`;
                root.style.setProperty('--gradient-1-2', gradient);
                root.style.setProperty('--on-gradient-1-2', '#ffffff');
            }
            if (colors.color2 && colors.color3) {
                const gradient = `linear-gradient(135deg, ${colors.color2}, ${colors.color3})`;
                root.style.setProperty('--gradient-2-3', gradient);
                root.style.setProperty('--on-gradient-2-3', '#ffffff');
            }
            if (colors.color3 && colors.color4) {
                const gradient = `linear-gradient(135deg, ${colors.color3}, ${colors.color4})`;
                root.style.setProperty('--gradient-3-4', gradient);
                root.style.setProperty('--on-gradient-3-4', '#ffffff');
            }
        } else {
            console.log('Using default colors for Qdrant page');
            console.log('Reason: colorSchemaData =', colorSchemaData);
        }

        // Get entity key from display name (reverse mapping)
        window.getEntityKey = function(displayName) {
            const reverseMap = {
                'Work Items': 'work_items',
                'Changelogs': 'changelogs',
                'Projects': 'projects',
                'Statuses': 'statuses',
                'Work Item Types': 'wits',
                'WIT Hierarchies': 'wits_hierarchies',
                'WIT Mappings': 'wits_mappings',
                'WIT PR Links': 'wits_prs_links',
                'Status Mappings': 'statuses_mappings',
                'Workflows': 'workflows',
                'Pull Requests': 'prs',
                'PR Comments': 'prs_comments',
                'PR Reviews': 'prs_reviews',
                'PR Commits': 'prs_commits',
                'Repositories': 'repositories'
            };
            return reverseMap[displayName] || displayName.toLowerCase().replace(/\s+/g, '_');
        };

        // Helper functions for validation data in collection details modal
        window.getDatabaseCount = function(entityKey) {
            const dbData = qdrantData.databaseCounts[entityKey] || {};
            return (dbData.unique_count || 0).toLocaleString();
        };

        window.getMissingCount = function(entityKey, qdrantCount) {
            const dbData = qdrantData.databaseCounts[entityKey] || {};
            const dbCount = dbData.unique_count || 0;
            return Math.max(0, dbCount - (qdrantCount || 0));
        };

        window.getCompletionPercentage = function(entityKey, qdrantCount) {
            const dbData = qdrantData.databaseCounts[entityKey] || {};
            const dbCount = dbData.unique_count || 0;
            if (dbCount === 0) return 100;
            return Math.round(((qdrantCount || 0) / dbCount) * 100);
        };

        window.getHealthStatus = function(entityKey, qdrantCount) {
            const completion = getCompletionPercentage(entityKey, qdrantCount);
            if (completion >= 100) {
                return { label: 'Complete', class: 'bg-green-100 text-green-700' };
            } else if (completion >= 80) {
                return { label: 'Good', class: 'bg-blue-100 text-blue-700' };
            } else if (completion >= 50) {
                return { label: 'Partial', class: 'bg-yellow-100 text-yellow-700' };
            } else {
                return { label: 'Needs Attention', class: 'bg-red-100 text-red-700' };
            }
        };

        // Helper function for entity display names
        window.getEntityDisplayName = function(entityKey) {
            const entityNameMap = {
                'changelogs': 'Changelogs',
                'prs_comments': 'PR Comments',
                'prs_commits': 'PR Commits',
                'prs_reviews': 'PR Reviews',
                'projects': 'Projects',
                'prs': 'Pull Requests',
                'repositories': 'Repositories',
                'statuses_mappings': 'Status Mappings',
                'statuses': 'Statuses',
                'wits_hierarchies': 'WIT Hierarchies',
                'wits_mappings': 'WIT Mappings',
                'wits_prs_links': 'WIT PR Links',
                'wits': 'Work Item Types',
                'work_items': 'Work Items',
                'workflows': 'Workflows'
            };
            return entityNameMap[entityKey] || entityKey;
        };

        // Helper function for formatting bytes
        window.formatBytes = function(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // Group entities by integration context
        window.getEntityGroupsByIntegration = function(entities) {
            const tenantName = '{{ tenant_name|lower }}' || 'wex';

            const groups = [
                {
                    title: 'Jira',
                    logoPath: `/static/assets/${tenantName}/integrations/jira.svg`,
                    entities: entities.filter(e => [
                        'Work Items', 'Changelogs', 'Projects', 'Statuses', 'Work Item Types',
                        'WIT Hierarchies', 'WIT Mappings', 'WIT PR Links', 'Status Mappings', 'Workflows'
                    ].includes(e.name))
                },
                {
                    title: 'GitHub',
                    logoPath: `/static/assets/${tenantName}/integrations/github.svg`,
                    entities: entities.filter(e => ['Pull Requests', 'PR Comments', 'PR Reviews', 'PR Commits', 'Repositories'].includes(e.name))
                }
            ];

            return groups.filter(group => group.entities.length > 0);
        };

        // Get Lucide icons for entities (matching sidebar menu icons)
        window.getEntityIcon = function(entityName) {
            const iconMap = {
                'Pull Requests': 'git-pull-request',
                'PR Comments': 'message-circle',
                'PR Reviews': 'eye',
                'PR Commits': 'git-commit',
                'Repositories': 'folder-git',
                'Work Items': 'list-todo',
                'Changelogs': 'history',
                'Projects': 'folder',
                'Statuses': 'flag',
                'Work Item Types': 'tag',
                'WIT Hierarchies': 'layers',        // matches sidebar: layers
                'WIT Mappings': 'network',          // matches sidebar: network
                'Status Mappings': 'arrow-left-right', // matches sidebar: arrow-left-right
                'Workflows': 'workflow'             // matches sidebar: workflow
            };

            return iconMap[entityName] || 'circle';
        };


    });
</script>
<style>
    /* Qdrant Analysis Tab Styles */
    .qdrant-tab {
        background-color: transparent;
        color: var(--text-secondary);
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .qdrant-tab:hover {
        color: var(--text-primary);
        background-color: var(--bg-tertiary);
    }

    .qdrant-tab.active {
        color: var(--color-1);
        border-bottom-color: var(--color-1);
        background-color: var(--bg-tertiary);
    }

    /* Qdrant Analysis Content Styles */
    .qdrant-metric-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.2s ease;
    }

    .qdrant-metric-card:hover {
        border-color: var(--color-1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .qdrant-status-healthy {
        color: var(--status-success);
    }

    .qdrant-status-warning {
        color: var(--status-warning);
    }

    .qdrant-status-error {
        color: var(--status-error);
    }

    .qdrant-progress-bar {
        height: 8px;
        background-color: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
    }

    .qdrant-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-1), var(--color-2));
        transition: width 0.3s ease;
    }

    /* Dashboard Tiles Styles */
    .entity-tiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .entity-tile {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .entity-tile:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--color-1);
    }

    /* Entity Groups by Integration */
    .entity-groups {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .entity-group {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .group-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .group-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
    }

    .integration-logo {
        width: 24px;
        height: 24px;
        object-fit: contain;
    }

    .entity-group-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .group-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .group-subtitle {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-left: auto;
    }

    /* Rectangle Entity Tiles */
    .entity-tiles-rectangle {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
    }

    .entity-tile-rect {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 0.75rem 1rem;
        height: 60px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .entity-tile-rect:hover {
        border-color: var(--color-1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .entity-icon {
        width: 20px;
        height: 20px;
        color: var(--text-secondary);
        flex-shrink: 0;
    }

    .entity-content {
        flex: 1;
        min-width: 0;
    }

    .entity-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .entity-stats {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .entity-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .view-details-btn {
        background: var(--color-1);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 6px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .view-details-btn:hover {
        opacity: 1;
    }

    .completion-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        min-width: 45px;
        text-align: center;
    }

    .completion-complete {
        background-color: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
    }

    .completion-partial {
        background-color: rgba(245, 158, 11, 0.1);
        color: rgb(245, 158, 11);
    }

    .completion-empty {
        background-color: rgba(107, 114, 128, 0.1);
        color: rgb(107, 114, 128);
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-dot.complete {
        background-color: rgb(34, 197, 94);
    }

    .status-dot.partial {
        background-color: rgb(245, 158, 11);
    }

    .status-dot.empty {
        background-color: rgb(107, 114, 128);
    }

    /* Responsive behavior */
    @media (max-width: 1024px) {
        .entity-tiles-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    @media (max-width: 640px) {
        .entity-tiles-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .entity-tile {
            padding: 0.75rem;
        }

        .entity-tile-count {
            font-size: 1.125rem;
        }
    }

    /* Enhanced styling for better visual hierarchy */
    .qdrant-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .qdrant-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .qdrant-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .qdrant-tab {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .qdrant-tab i {
            width: 1rem;
            height: 1rem;
        }
        
        .qdrant-metric-card {
            padding: 1rem;
        }
    }
</style>

<script>
    // ===== QDRANT ANALYSIS FUNCTIONS =====

    // Qdrant API configuration
    const QDRANT_URL = 'http://localhost:6333';
    let qdrantData = {
        collections: [],
        dashboard: null
    };

    // Initialize Lucide icons after content loads
    function initializeLucideIcons() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            // Retry after a short delay if Lucide isn't loaded yet
            setTimeout(initializeLucideIcons, 100);
        }
    }

    // Fallback icon function for integration logos
    function showFallbackIcon(imgElement, integrationName) {
        const iconName = integrationName.toLowerCase() === 'github' ? 'github' :
                        integrationName.toLowerCase() === 'jira' ? 'ticket' : 'plug';

        imgElement.outerHTML = `<i data-lucide="${iconName}" class="group-logo" style="color: var(--text-secondary);"></i>`;

        // Re-initialize Lucide icons for the new element
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Initialize Qdrant Analysis on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Get initial tab from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const initialTab = urlParams.get('tab') || 'dashboard';
        
        initializeQdrantAnalysis(initialTab);
    });

    async function initializeQdrantAnalysis(initialTab = 'dashboard') {
        try {
            updateStatusIndicator('loading', 'Connecting to Qdrant...');
            await refreshQdrantAnalysis();
            showQdrantTab(initialTab);
            updateStatusIndicator('healthy', 'Connected');
        } catch (error) {
            console.error('Failed to initialize Qdrant analysis:', error);
            updateStatusIndicator('error', 'Connection failed');
            showQdrantError('Failed to connect to Qdrant. Please ensure Qdrant is running on localhost:6333');
        }
    }

    function updateStatusIndicator(status, text) {
        const statusDot = document.getElementById('qdrantStatusDot');
        const statusText = document.getElementById('qdrantStatusText');
        
        if (statusDot) {
            switch (status) {
                case 'loading':
                    statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                    break;
                case 'healthy':
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                    break;
                default:
                    statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
            }
        }
        
        if (statusText) {
            statusText.textContent = text;
        }
    }

    async function refreshQdrantAnalysis() {
        try {
            updateStatusIndicator('loading', 'Refreshing data...');

            // Fetch data from Qdrant and backend
            await Promise.all([
                fetchQdrantCollections(),
                fetchDatabaseCounts(),
                fetchVectorizationQueue()
            ]);

            updateStatusIndicator('healthy', 'Connected');

            // Refresh current tab
            const activeTab = document.querySelector('.qdrant-tab.active');
            if (activeTab) {
                const tabName = activeTab.id.replace('qdrantTab', '').toLowerCase();
                showQdrantTab(tabName);
            }

        } catch (error) {
            console.error('Error refreshing Qdrant analysis:', error);
            updateStatusIndicator('error', 'Refresh failed');
            showQdrantError('Failed to refresh Qdrant data: ' + error.message);
        }
    }

    async function fetchQdrantCollections() {
        try {
            const response = await fetch(`${QDRANT_URL}/collections`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            qdrantData.collections = data.result?.collections || [];

            // Fetch detailed info for each collection
            for (let collection of qdrantData.collections) {
                try {
                    const detailResponse = await fetch(`${QDRANT_URL}/collections/${collection.name}`);
                    if (detailResponse.ok) {
                        const detailData = await detailResponse.json();
                        collection.details = detailData.result;
                    }
                } catch (error) {
                    console.warn(`Failed to fetch details for collection ${collection.name}:`, error);
                }
            }
        } catch (error) {
            console.error('Error fetching Qdrant collections:', error);
            qdrantData.collections = [];
            throw error;
        }
    }

    async function fetchDatabaseCounts() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/database/summary', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                qdrantData.databaseCounts = data.summary?.tables || {};
            } else {
                console.warn('Failed to fetch database counts:', response.status);
                qdrantData.databaseCounts = {};
            }
        } catch (error) {
            console.error('Error fetching database counts:', error);
            qdrantData.databaseCounts = {};
        }
    }

    async function fetchVectorizationQueue() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/summary', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                qdrantData.queueData = data;
            } else {
                console.warn('Failed to fetch vectorization queue:', response.status);
                qdrantData.queueData = {};
            }
        } catch (error) {
            console.error('Error fetching vectorization queue:', error);
            qdrantData.queueData = {};
        }
    }

    function showQdrantTab(tabName) {
        // Update URL without page reload
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.replaceState({}, '', url);

        // Update tab buttons
        document.querySelectorAll('.qdrant-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const activeTab = document.getElementById(`qdrantTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
        if (activeTab) {
            activeTab.classList.add('active');
        }

        // Show tab content
        const content = document.getElementById('qdrantTabContent');
        if (!content) return;

        switch (tabName) {
            case 'dashboard':
                content.innerHTML = generateDashboardContent();
                break;


            case 'management':
                content.innerHTML = generateManagementContent();
                break;
            default:
                content.innerHTML = '<div class="text-center py-8" style="color: var(--text-muted);">Tab not found</div>';
        }

        // Refresh Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Initialize icons for new content
        initializeLucideIcons();
    }

    function generateDashboardContent() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const comparisonData = calculateComparisonData(tenantPrefix);

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="qdrant-section-title">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
                        Vectorization Dashboard
                    </h3>
                    <div class="text-sm" style="color: var(--text-secondary);">
                        Tenant: ${tenantName}
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="qdrant-summary-grid">
                    <div class="rounded-xl p-6 space-y-4 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-1) 0%, var(--color-2) 100%); color: var(--on-gradient-1-2);">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium opacity-90">Total Records</h3>
                            <div class="w-3 h-3 bg-white bg-opacity-30 rounded-full"></div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-2xl font-bold">${comparisonData.totalDatabase.toLocaleString()}</div>
                            <div class="text-xs opacity-80">In Database</div>
                        </div>
                    </div>
                    <div class="rounded-xl p-6 space-y-4 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-2) 0%, var(--color-3) 100%); color: var(--on-gradient-2-3);">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium opacity-90">Vectorized</h3>
                            <div class="w-3 h-3 bg-white bg-opacity-30 rounded-full"></div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-2xl font-bold">${comparisonData.totalVectorized.toLocaleString()}</div>
                            <div class="text-xs opacity-80">In Qdrant</div>
                        </div>
                    </div>
                    <div class="rounded-xl p-6 space-y-4 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-3) 0%, var(--color-4) 100%); color: var(--text-primary); opacity: 1; transform: none;">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium opacity-90">Completion</h3>
                            <div class="w-3 h-3 bg-white bg-opacity-30 rounded-full"></div>
                        </div>
                        <div class="space-y-2">
                            <div class="text-2xl font-bold">${comparisonData.overallCompletion}%</div>
                            <div class="text-xs opacity-80">Overall Progress</div>
                        </div>
                    </div>
                </div>

                <!-- Entity Breakdown by Integration -->
                <div class="entity-groups">
                    ${getEntityGroupsByIntegration(comparisonData.entities).map(group => `
                        <div class="entity-group">
                            <div class="group-header">
                                <img src="${group.logoPath}" alt="${group.title}" class="group-logo" onerror="showFallbackIcon(this, '${group.title}')">
                                <h5 class="group-title">${group.title.toUpperCase()}</h5>
                                <div class="group-subtitle">${group.entities.length} entities</div>
                            </div>
                            <div class="entity-tiles-rectangle">
                                ${group.entities.map(entity => {
                                    // Determine status classes
                                    let statusClass = 'empty';
                                    let completionClass = 'completion-empty';

                                    if (entity.completion >= 100) {
                                        statusClass = 'complete';
                                        completionClass = 'completion-complete';
                                    } else if (entity.completion > 0) {
                                        statusClass = 'partial';
                                        completionClass = 'completion-partial';
                                    }

                                    return `
                                    <div class="entity-tile-rect">
                                        <i data-lucide="${getEntityIcon(entity.name)}" class="entity-icon"></i>
                                        <div class="entity-content">
                                            <div class="entity-name">${entity.name}</div>
                                            <div class="entity-stats">${entity.qdrant}/${entity.database} vectorized</div>
                                        </div>
                                        <div class="entity-actions">
                                            <div class="completion-badge ${completionClass}">${entity.completion}%</div>
                                            <div class="status-dot ${statusClass}"></div>
                                            <button class="view-details-btn" onclick="showCollectionDetails('${getCurrentTenantName().toLowerCase()}_${getEntityKey(entity.name)}')" title="View Details">
                                                <i data-lucide="eye" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>




                </div>
            </div>
        `;
    }



    function generateCollectionCard(collection, tenantPrefix) {
        const details = collection.details || {};
        const entityKey = collection.name.replace(tenantPrefix, '');
        const status = details.status || 'unknown';
        const pointsCount = details.points_count || 0;
        const vectorsCount = details.vectors_count || 0;
        const vectorSize = details.config?.params?.vectors?.size || 'unknown';
        const distance = details.config?.params?.vectors?.distance || 'unknown';

        // Map entity keys to display names (same as Dashboard)
        const entityNameMap = {
            'changelogs': 'Changelogs',
            'prs_comments': 'PR Comments',
            'prs_commits': 'PR Commits',
            'prs_reviews': 'PR Reviews',
            'projects': 'Projects',
            'prs': 'Pull Requests',
            'repositories': 'Repositories',
            'statuses_mappings': 'Status Mappings',
            'statuses': 'Statuses',
            'wits_hierarchies': 'WIT Hierarchies',
            'wits_mappings': 'WIT Mappings',
            'wits_prs_links': 'WIT PR Links',
            'wits': 'Work Item Types',
            'work_items': 'Work Items',
            'workflows': 'Workflows'
        };

        const entityDisplayName = entityNameMap[entityKey] || entityKey;

        return `
            <div class="qdrant-metric-card">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-semibold" style="color: var(--text-primary);">${entityDisplayName}</h4>
                        <div class="text-xs" style="color: var(--text-muted);">${collection.name}</div>
                    </div>
                    <div class="w-3 h-3 rounded-full ${status === 'green' ? 'bg-green-500' : status === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'}"></div>
                </div>

                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span style="color: var(--text-secondary);">Points:</span>
                        <span class="font-medium" style="color: var(--text-primary);">${pointsCount.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span style="color: var(--text-secondary);">Vectors:</span>
                        <span class="font-medium" style="color: var(--text-primary);">${vectorsCount.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span style="color: var(--text-secondary);">Dimensions:</span>
                        <span class="font-medium" style="color: var(--text-primary);">${vectorSize}</span>
                    </div>
                    <div class="flex justify-between">
                        <span style="color: var(--text-secondary);">Distance:</span>
                        <span class="font-medium" style="color: var(--text-primary);">${distance}</span>
                    </div>
                </div>

                <div class="mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                    <button onclick="showCollectionDetails('${collection.name}')" class="text-xs px-3 py-1 rounded" style="background-color: var(--color-1); color: white;">
                        View Details
                    </button>
                </div>
            </div>
        `;
    }






    function generateManagementContent() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

        // Calculate real statistics
        const totalVectors = tenantCollections.reduce((sum, c) => sum + (c.details?.points_count || 0), 0);
        const totalStorage = tenantCollections.reduce((sum, c) => {
            const points = c.details?.points_count || 0;
            const dimensions = c.details?.config?.params?.vectors?.size || 0;
            return sum + (points * dimensions * 4); // 4 bytes per float
        }, 0);

        // Get queue statistics
        const queueStats = qdrantData.queueData || {};
        const pendingItems = queueStats.total_pending || 0;
        const failedItems = queueStats.total_failed || 0;

        return `
            <div class="space-y-6">
                <h3 class="qdrant-section-title">
                    <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                    Management Tools
                </h3>

                <!-- System Overview -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">System Overview</h4>
                    <div class="qdrant-summary-grid text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold" style="color: var(--text-primary);">${tenantCollections.length}</div>
                            <div style="color: var(--text-secondary);">Collections</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold" style="color: var(--text-primary);">${totalVectors.toLocaleString()}</div>
                            <div style="color: var(--text-secondary);">Total Vectors</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold" style="color: var(--text-primary);">${formatBytes(totalStorage)}</div>
                            <div style="color: var(--text-secondary);">Storage Used</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${pendingItems > 0 ? 'text-yellow-600' : 'text-green-600'}">${pendingItems}</div>
                            <div style="color: var(--text-secondary);">Queue Pending</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Quick Actions</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="triggerVectorization()" class="p-4 rounded-lg border text-left hover:bg-opacity-80 transition-colors" style="background-color: var(--color-1); color: white; border-color: var(--color-1);">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                <div>
                                    <div class="font-medium">Start Vectorization</div>
                                    <div class="text-sm opacity-80">Process pending queue items</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="cleanupFailedItems()" class="p-4 rounded-lg border text-left hover:bg-opacity-80 transition-colors" style="background-color: var(--status-warning); color: white; border-color: var(--status-warning);">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <div>
                                    <div class="font-medium">Cleanup Failed Items</div>
                                    <div class="text-sm opacity-80">${failedItems} failed items to clean</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="optimizeCollections()" class="p-4 rounded-lg border text-left hover:bg-opacity-80 transition-colors" style="background-color: var(--color-3); color: white; border-color: var(--color-3);">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="zap" class="w-5 h-5"></i>
                                <div>
                                    <div class="font-medium">Optimize Collections</div>
                                    <div class="text-sm opacity-80">Improve query performance</div>
                                </div>
                            </div>
                        </button>
                        <button onclick="exportVectorData()" class="p-4 rounded-lg border text-left hover:bg-opacity-80 transition-colors" style="background-color: var(--color-4); color: white; border-color: var(--color-4);">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <div>
                                    <div class="font-medium">Export Data</div>
                                    <div class="text-sm opacity-80">Download vector collections</div>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Collection Management -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Collection Management</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b" style="border-color: var(--border-color);">
                                    <th class="text-left py-2" style="color: var(--text-secondary);">Collection</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Vectors</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Size</th>
                                    <th class="text-center py-2" style="color: var(--text-secondary);">Status</th>
                                    <th class="text-center py-2" style="color: var(--text-secondary);">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tenantCollections.map(collection => {
                                    const entityKey = collection.name.replace(tenantPrefix, '');
                                    const entityName = getEntityDisplayName(entityKey);
                                    const points = collection.details?.points_count || 0;
                                    const dimensions = collection.details?.config?.params?.vectors?.size || 0;
                                    const sizeBytes = points * dimensions * 4;
                                    const status = collection.details?.status || 'unknown';

                                    return `
                                        <tr class="border-b" style="border-color: var(--border-color);">
                                            <td class="py-2 font-medium" style="color: var(--text-primary);">${entityName}</td>
                                            <td class="py-2 text-right" style="color: var(--text-primary);">${points.toLocaleString()}</td>
                                            <td class="py-2 text-right" style="color: var(--text-primary);">${formatBytes(sizeBytes)}</td>
                                            <td class="py-2 text-center">
                                                <span class="px-2 py-1 rounded text-xs ${status === 'green' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${status}</span>
                                            </td>
                                            <td class="py-2 text-center">
                                                <button onclick="showCollectionDetails('${collection.name}')" class="text-xs px-2 py-1 rounded hover:opacity-80" style="background-color: var(--color-1); color: white;" title="View Details">
                                                    <i data-lucide="eye" class="w-3 h-3"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- System Information -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">System Information</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Qdrant URL</div>
                            <div style="color: var(--text-primary);">${QDRANT_URL}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Tenant</div>
                            <div style="color: var(--text-primary);">${tenantName || 'Unknown'}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Last Refresh</div>
                            <div style="color: var(--text-primary);">${new Date().toLocaleTimeString()}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Connection</div>
                            <div class="qdrant-status-healthy">Connected</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ===== HELPER FUNCTIONS =====

    function getCurrentTenantName() {
        // Get tenant name from auth data or default
        try {
            const authData = JSON.parse(localStorage.getItem('authData') || '{}');
            // Map tenant_id to tenant name for collection prefixes
            const tenantIdToName = {
                1: 'client_1',
                2: 'client_2',
                3: 'client_3'
            };

            if (authData.tenant_id) {
                return tenantIdToName[authData.tenant_id] || `client_${authData.tenant_id}`;
            }

            // Fallback to client_1 (WEX)
            return 'client_1';
        } catch {
            return 'client_1';
        }
    }

    function calculateComparisonData(tenantPrefix) {
        const entities = [
            // Ordered alphabetically by name for better UX
            { key: 'changelogs', name: 'Changelogs' },
            { key: 'prs_comments', name: 'PR Comments' },
            { key: 'prs_commits', name: 'PR Commits' },
            { key: 'prs_reviews', name: 'PR Reviews' },
            { key: 'projects', name: 'Projects' },
            { key: 'prs', name: 'Pull Requests' },
            { key: 'repositories', name: 'Repositories' },
            { key: 'statuses_mappings', name: 'Status Mappings' },
            { key: 'statuses', name: 'Statuses' },
            { key: 'wits_hierarchies', name: 'WIT Hierarchies' },
            { key: 'wits_mappings', name: 'WIT Mappings' },
            { key: 'wits', name: 'Work Item Types' },
            { key: 'work_items', name: 'Work Items' },
            { key: 'workflows', name: 'Workflows' }
        ];

        let totalDatabase = 0;
        let totalVectorized = 0;
        let healthyCollections = 0;
        const entityData = [];

        entities.forEach(entity => {
            const dbData = qdrantData.databaseCounts[entity.key] || {};
            const totalCount = dbData.total_count || 0;
            const uniqueCount = dbData.unique_count || 0;

            const expectedCollectionName = tenantPrefix + entity.key;
            const collection = qdrantData.collections.find(c => c.name === expectedCollectionName);

            const qdrantCount = collection?.details?.points_count || 0;
            const queueCount = qdrantData.queueData?.by_entity_type?.[entity.key] || 0;

            // Use unique count for completion calculation (matches what's actually in Qdrant)
            const completion = uniqueCount > 0 ? Math.round((qdrantCount / uniqueCount) * 100) : 0;

            totalDatabase += uniqueCount; // Use unique count for totals
            totalVectorized += qdrantCount;

            if (completion >= 100) healthyCollections++;

            entityData.push({
                name: entity.name,
                database: uniqueCount,
                totalReferences: totalCount,
                qdrant: qdrantCount,
                queue: queueCount,
                completion: completion
            });
        });

        const overallCompletion = totalDatabase > 0 ? Math.round((totalVectorized / totalDatabase) * 100) : 0;
        const missingRecords = Math.max(0, totalDatabase - totalVectorized);

        return {
            entities: entityData,
            totalDatabase,
            totalVectorized,
            overallCompletion,
            healthyCollections,
            missingRecords
        };
    }



    function calculateAnalyticsData() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

        let totalVectors = 0;
        let totalDimensions = 0;
        let collectionCount = 0;

        const collectionStats = tenantCollections.map((collection, index) => {
            const details = collection.details || {};
            const pointsCount = details.points_count || 0;
            const vectorSize = details.config?.params?.vectors?.size || 0;

            totalVectors += pointsCount;
            if (vectorSize > 0) {
                totalDimensions += vectorSize;
                collectionCount++;
            }

            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];

            return {
                name: collection.name.replace(tenantPrefix, ''),
                count: pointsCount,
                percentage: 0, // Will be calculated after total is known
                color: colors[index % colors.length]
            };
        });

        // Calculate percentages
        collectionStats.forEach(stat => {
            stat.percentage = totalVectors > 0 ? Math.round((stat.count / totalVectors) * 100) : 0;
        });

        const avgVectorSize = collectionCount > 0 ? Math.round(totalDimensions / collectionCount) : 0;
        const estimatedStorageBytes = totalVectors * avgVectorSize * 4; // 4 bytes per float
        const storageUsage = formatBytes(estimatedStorageBytes);

        return {
            totalVectors,
            avgVectorSize,
            storageUsage,
            collectionStats: collectionStats.sort((a, b) => b.count - a.count)
        };
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showQdrantError(message) {
        const content = document.getElementById('qdrantTabContent');
        if (content) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4 text-red-500"></i>
                    <p class="text-lg font-medium mb-2" style="color: var(--text-primary);">Qdrant Connection Error</p>
                    <p style="color: var(--text-secondary);">${message}</p>
                    <button onclick="refreshQdrantAnalysis()" class="mt-4 px-4 py-2 rounded" style="background-color: var(--color-1); color: white;">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Retry Connection
                    </button>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }

    // ===== MANAGEMENT ACTION FUNCTIONS =====

    async function triggerVectorization() {
        if (!confirm('This will start processing the vectorization queue. Continue?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/jobs/vectorization/trigger', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showNotification('Vectorization job triggered successfully', 'success');
                // Redirect to home page to see job progress
                window.location.href = '/';
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error triggering vectorization:', error);
            showNotification('Failed to trigger vectorization job', 'error');
        }
    }

    async function cleanupFailedItems() {
        if (!confirm('This will remove all failed items from the vectorization queue. Continue?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/cleanup-failed', {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Cleaned up ${result.deleted_count || 0} failed items`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error cleaning up failed items:', error);
            showNotification('Failed to cleanup failed items', 'error');
        }
    }

    async function optimizeCollections() {
        if (!confirm('This will optimize all Qdrant collections. This may take some time. Continue?')) return;

        try {
            showNotification('Collection optimization started...', 'info');

            const tenantName = getCurrentTenantName();
            const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
            const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

            let optimized = 0;
            for (const collection of tenantCollections) {
                try {
                    const response = await fetch(`${QDRANT_URL}/collections/${collection.name}/index`, {
                        method: 'POST'
                    });
                    if (response.ok) optimized++;
                } catch (error) {
                    console.warn(`Failed to optimize collection ${collection.name}:`, error);
                }
            }

            showNotification(`Optimized ${optimized}/${tenantCollections.length} collections`, 'success');
        } catch (error) {
            console.error('Error optimizing collections:', error);
            showNotification('Failed to optimize collections', 'error');
        }
    }

    async function exportVectorData() {
        try {
            showNotification('Preparing vector data export...', 'info');

            const tenantName = getCurrentTenantName();
            const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
            const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

            const exportData = {
                tenant: tenantName,
                exported_at: new Date().toISOString(),
                collections: tenantCollections.map(c => ({
                    name: c.name,
                    points_count: c.details?.points_count || 0,
                    vector_size: c.details?.config?.params?.vectors?.size || 0,
                    distance: c.details?.config?.params?.vectors?.distance || 'unknown'
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qdrant-export-${tenantName}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Vector data exported successfully', 'success');
        } catch (error) {
            console.error('Error exporting vector data:', error);
            showNotification('Failed to export vector data', 'error');
        }
    }

    async function revectorizeAllMissing() {
        if (!confirm('This will queue all missing records for re-vectorization. Continue?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/missing', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing missing records:', error);
            showNotification('Failed to queue missing records for re-vectorization', 'error');
        }
    }

    async function revectorizeEntityType() {
        const entityType = prompt('Enter entity type to re-vectorize (prs, prs_comments, prs_reviews, prs_commits, issues, issues_comments):');
        if (!entityType) return;

        if (!confirm(`This will re-vectorize all ${entityType} records. Continue?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/entity-type', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entity_type: entityType })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} ${entityType} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing entity type:', error);
            showNotification(`Failed to queue ${entityType} records for re-vectorization`, 'error');
        }
    }

    async function revectorizeByDateRange() {
        const fromDate = prompt('Enter start date (YYYY-MM-DD):');
        if (!fromDate) return;

        const toDate = prompt('Enter end date (YYYY-MM-DD):');
        if (!toDate) return;

        if (!confirm(`This will re-vectorize all records from ${fromDate} to ${toDate}. Continue?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/date-range', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    from_date: fromDate,
                    to_date: toDate
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing date range:', error);
            showNotification('Failed to queue records by date range for re-vectorization', 'error');
        }
    }

    async function cleanupOrphanedVectors() {
        if (!confirm('This will remove vectors that no longer have corresponding database records. This action cannot be undone. Continue?')) return;

        try {
            showNotification('Orphaned vector cleanup is not yet implemented', 'warning');
            // TODO: Implement orphaned vector cleanup
            // This would require comparing Qdrant vectors with database records
            // and removing vectors that don't have corresponding DB entries
        } catch (error) {
            console.error('Error cleaning orphaned vectors:', error);
            showNotification('Failed to clean orphaned vectors', 'error');
        }
    }

    async function optimizeCollections() {
        if (!confirm('This will optimize all Qdrant collections. This may take some time. Continue?')) return;

        try {
            showNotification('Collection optimization is not yet implemented', 'warning');
            // TODO: Implement collection optimization
            // This would call Qdrant's optimize endpoint for each collection
        } catch (error) {
            console.error('Error optimizing collections:', error);
            showNotification('Failed to optimize collections', 'error');
        }
    }

    async function exportVectorData() {
        try {
            showNotification('Vector data export is not yet implemented', 'warning');
            // TODO: Implement vector data export
            // This would export vector data in a standard format
        } catch (error) {
            console.error('Error exporting vector data:', error);
            showNotification('Failed to export vector data', 'error');
        }
    }

    async function executeBulkRevectorization() {
        const entityType = document.getElementById('bulkEntityType')?.value;
        const dateFrom = document.getElementById('bulkDateFrom')?.value;
        const dateTo = document.getElementById('bulkDateTo')?.value;

        if (!confirm('Execute bulk re-vectorization with the specified parameters?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/bulk', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_type: entityType || null,
                    from_date: dateFrom || null,
                    to_date: dateTo || null
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for bulk re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error executing bulk re-vectorization:', error);
            showNotification('Failed to execute bulk re-vectorization', 'error');
        }
    }

    async function previewBulkOperation() {
        const entityType = document.getElementById('bulkEntityType')?.value;
        const dateFrom = document.getElementById('bulkDateFrom')?.value;
        const dateTo = document.getElementById('bulkDateTo')?.value;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/bulk/preview', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_type: entityType || null,
                    from_date: dateFrom || null,
                    to_date: dateTo || null
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Preview: ${result.estimated_count || 0} records would be queued for re-vectorization`, 'info');
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error previewing bulk operation:', error);
            showNotification('Failed to preview bulk operation', 'error');
        }
    }

    async function showCollectionDetails(collectionName) {
        try {
            const collection = qdrantData.collections.find(c => c.name === collectionName);
            if (!collection) {
                showNotification('Collection not found', 'error');
                return;
            }

            const details = collection.details || {};
            const entityKey = collectionName.replace(getCurrentTenantName().toLowerCase() + '_', '');
            const entityNameMap = {
                'changelogs': 'Changelogs',
                'prs_comments': 'PR Comments',
                'prs_commits': 'PR Commits',
                'prs_reviews': 'PR Reviews',
                'projects': 'Projects',
                'prs': 'Pull Requests',
                'repositories': 'Repositories',
                'statuses_mappings': 'Status Mappings',
                'statuses': 'Statuses',
                'wits_hierarchies': 'WIT Hierarchies',
                'wits_mappings': 'WIT Mappings',
                'wits_prs_links': 'WIT PR Links',
                'wits': 'Work Item Types',
                'work_items': 'Work Items',
                'workflows': 'Workflows'
            };
            const entityDisplayName = entityNameMap[entityKey] || entityKey;

            // Create modal similar to job details modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 p-4';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';

            modal.innerHTML = `
                <div class="rounded-lg w-full max-w-4xl mx-auto my-8 max-h-[80vh] overflow-y-auto" style="background-color: var(--bg-primary); width: min(90vw, 800px);">
                    <div class="flex justify-between items-center p-3 border-b sticky top-0 z-10" style="border-color: var(--border-color); background-color: var(--bg-primary);">
                        <div class="flex items-center gap-2">
                            <i data-lucide="database" class="w-4 h-4" style="color: var(--text-primary);"></i>
                            <h3 class="text-lg font-bold" style="color: var(--text-primary);">${entityDisplayName}</h3>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="hover:opacity-75" style="color: var(--text-secondary);" title="Close">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="space-y-4">
                            <!-- Collection Overview -->
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <div class="rounded-xl p-4 space-y-3 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-1) 0%, var(--color-2) 100%); color: var(--on-gradient-1-2);">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-xs font-medium opacity-90">Total Points</h3>
                                        <div class="w-2 h-2 bg-white bg-opacity-30 rounded-full"></div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="text-xl font-bold">${(details.points_count || 0).toLocaleString()}</div>
                                        <div class="text-xs opacity-80">In Collection</div>
                                    </div>
                                </div>
                                <div class="rounded-xl p-4 space-y-3 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-2) 0%, var(--color-3) 100%); color: var(--on-gradient-2-3);">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-xs font-medium opacity-90">Vectors</h3>
                                        <div class="w-2 h-2 bg-white bg-opacity-30 rounded-full"></div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="text-xl font-bold">${(details.vectors_count || 0).toLocaleString()}</div>
                                        <div class="text-xs opacity-80">Vector Count</div>
                                    </div>
                                </div>
                                <div class="rounded-xl p-4 space-y-3 backdrop-blur-sm hover:shadow-md transition-all duration-300" style="background: linear-gradient(135deg, var(--color-3) 0%, var(--color-4) 100%); color: var(--text-primary);">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-xs font-medium opacity-90">Dimensions</h3>
                                        <div class="w-2 h-2 bg-white bg-opacity-30 rounded-full"></div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="text-xl font-bold">${details.config?.params?.vectors?.size || 'N/A'}</div>
                                        <div class="text-xs opacity-80">Vector Size</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-3">
                                    <h4 class="text-sm font-semibold" style="color: var(--text-primary);">Collection Information</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Collection:</span>
                                            <span class="font-medium text-xs" style="color: var(--text-primary);">${collectionName}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Status:</span>
                                            <span class="px-2 py-1 rounded text-xs ${details.status === 'green' ? 'bg-green-100 text-green-800' : details.status === 'yellow' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${details.status || 'unknown'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Indexed:</span>
                                            <span class="font-medium" style="color: var(--text-primary);">${(details.indexed_vectors_count || 0).toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Distance:</span>
                                            <span class="font-medium" style="color: var(--text-primary);">${details.config?.params?.vectors?.distance || 'unknown'}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <h4 class="text-sm font-semibold" style="color: var(--text-primary);">Data Validation</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Database Records:</span>
                                            <span class="font-medium" style="color: var(--text-primary);">${getDatabaseCount(entityKey)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Vectorized:</span>
                                            <span class="font-medium" style="color: var(--text-primary);">${details.points_count || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Missing:</span>
                                            <span class="font-medium ${getMissingCount(entityKey, details.points_count) > 0 ? 'text-red-600' : 'text-green-600'}">${getMissingCount(entityKey, details.points_count)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Completion:</span>
                                            <span class="font-medium" style="color: var(--text-primary);">${getCompletionPercentage(entityKey, details.points_count)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span style="color: var(--text-secondary);">Health:</span>
                                            <span class="px-2 py-1 rounded text-xs ${getHealthStatus(entityKey, details.points_count).class}">${getHealthStatus(entityKey, details.points_count).label}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            ${details.config ? `
                                <div class="space-y-2">
                                    <h4 class="text-sm font-semibold" style="color: var(--text-primary);">Configuration</h4>
                                    <pre class="text-xs p-3 rounded-lg overflow-x-auto max-h-48" style="background-color: var(--bg-tertiary); color: var(--text-primary);">${JSON.stringify(details.config, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex justify-end p-3 border-t" style="border-color: var(--border-color); background-color: var(--bg-primary);">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 rounded hover:opacity-90 transition-opacity text-sm" style="background-color: var(--color-1); color: white;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize Lucide icons for the modal
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

        } catch (error) {
            console.error('Error showing collection details:', error);
            showNotification('Failed to load collection details', 'error');
        }
    }

    // ===== UTILITY FUNCTIONS =====

    function getAuthToken() {
        // Try to get token from localStorage first
        try {
            const authData = JSON.parse(localStorage.getItem('authData') || '{}');
            if (authData.token) {
                return authData.token;
            }
        } catch (e) {
            console.warn('Failed to parse auth data from localStorage');
        }

        // Fallback to cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'pulse_token') {
                return value;
            }
        }

        return null;
    }

    function showNotification(message, type = 'info', htmlContent = null) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full`;

        // Set background color based on type
        switch (type) {
            case 'success':
                notification.style.backgroundColor = 'var(--status-success)';
                notification.style.color = 'white';
                break;
            case 'error':
                notification.style.backgroundColor = 'var(--status-error)';
                notification.style.color = 'white';
                break;
            case 'warning':
                notification.style.backgroundColor = 'var(--status-warning)';
                notification.style.color = 'white';
                break;
            default:
                notification.style.backgroundColor = 'var(--color-1)';
                notification.style.color = 'white';
        }

        // Set content
        if (htmlContent) {
            notification.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <strong>${message}</strong>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="text-sm">${htmlContent}</div>
            `;
        } else {
            notification.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        // Add to page
        document.body.appendChild(notification);

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto-remove after 5 seconds (unless it has HTML content)
        if (!htmlContent) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    }



    // ===== END QDRANT ANALYSIS FUNCTIONS =====
</script>

{% endblock %}
