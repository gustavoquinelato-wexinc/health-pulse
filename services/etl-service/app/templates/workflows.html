{% extends "layouts/modern_layout.html" %}

{% block title %}Pulse ETL Management - Workflows{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', path='js/vectorization-card.js') }}"></script>
<style>
    /* Action button styles matching home page job buttons exactly */
    .job-action-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .job-action-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Light mode specific hover - use dark text for visibility */
    [data-theme="light"] .job-action-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    [data-theme="light"] .job-action-btn:hover i {
        color: var(--text-primary);
    }

    .job-action-btn:disabled,
    .job-action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Toggle Switch Styles - Using Home Page Style (defined in main CSS) */
</style>
{% endblock %}

{% block content %}
{% if not embedded %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                Workflows
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">Manage workflow steps and configurations</p>
        </div>
    </div>
</div>
{% else %}
<!-- Embedded Header - Minimal -->
<div class="mb-6">
    <div class="flex items-center justify-end">
        <button onclick="showCreateModal()" class="btn-crud-create">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Create Workflow
        </button>
    </div>
</div>
{% endif %}

<!-- Vectorization Card -->
<div id="vectorization-card-container"></div>

<!-- Filters Section -->
<div class="mb-6 p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- 1. Step Name -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Step Name</label>
            <input type="text" id="filterStepName" placeholder="Filter by step name..." class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" oninput="applyFilters()">
        </div>

        <!-- 2. Integration -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Integration</label>
            <select id="filterIntegration" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Integrations</option>
                <option value="jira">Jira</option>
                <option value="github">GitHub</option>
            </select>
        </div>

        <!-- 3. Step Category -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Step Category</label>
            <select id="filterStepCategory" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Categories</option>
                <option value="todo">To Do</option>
                <option value="in_progress">In Progress</option>
                <option value="waiting">Waiting</option>
                <option value="done">Done</option>
                <option value="discarded">Discarded</option>
            </select>
        </div>

        <!-- 4. Status -->
        <div>
            <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Status</label>
            <select id="filterStatus" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
    </div>
</div>

<!-- Workflows Table -->
<div class="rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <div class="px-6 py-4 border-b flex justify-between items-center" style="border-color: var(--border-color); background-color: var(--bg-tertiary);">
        <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Workflows</h2>
        <button onclick="showCreateModal()" class="btn-crud-create">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Create Workflow
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full">
            <thead style="background-color: var(--bg-tertiary);">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Step Name
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Step Number
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Step Category
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Integration
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Active
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody id="workflowsTableBody" style="background-color: var(--bg-secondary);">
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center" style="color: var(--text-muted);">
                        <i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin inline"></i>Loading workflows...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden p-8 text-center">
        <i data-lucide="workflow" class="w-16 h-16 mb-4 mx-auto" style="color: var(--text-muted);"></i>
        <h3 class="text-lg font-medium mb-2" style="color: var(--text-primary);">No workflows found</h3>
        <p class="mb-4" style="color: var(--text-secondary);">Get started by creating your first workflow step using the Create button above.</p>
    </div>
</div>

<!-- Create/Edit Workflow Modal -->
<div id="workflowModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm items-center justify-center z-50 hidden">
    <div class="modal-content max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-default">
            <h2 id="workflowModalTitle" class="text-xl font-semibold text-primary">Create Workflow</h2>
            <button onclick="closeModal('workflowModal')" class="text-muted hover:text-primary transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-6">
    <form id="workflowForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Step Name</label>
                <input type="text" id="stepName" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Step Number</label>
                <input type="number" id="stepNumber" min="1" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" required>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Step Category</label>
                <select id="stepCategory" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
                    <option value="todo">To Do</option>
                    <option value="in_progress" selected>In Progress</option>
                    <option value="waiting">Waiting</option>
                    <option value="done">Done</option>
                    <option value="discarded">Discarded</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Integration</label>
                <select id="workflowIntegration" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);" required>
                    <option value="">Select Integration</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
        </div>
        <div class="mb-4">
            <div class="job-toggle-switch" onclick="toggleModalActive()" style="justify-content: flex-start;">
                <div class="toggle-switch active" id="modalToggleSwitch">
                    <div class="toggle-slider"></div>
                </div>
                <span class="toggle-label" id="modalToggleLabel">On</span>
            </div>
            <input type="hidden" id="workflowActive" name="active" value="true">
        </div>
        <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeModal('workflowModal')" class="btn-neutral-secondary">
                Cancel
            </button>
            <button type="submit" class="btn-crud-create">
                <i data-lucide="save" class="w-4 h-4 mr-2"></i>Save Workflow
            </button>
        </div>
    </form>
        </div>
    </div>
</div>

<!-- Delete Workflow Modal -->
{% from 'components/modal.html' import modal %}
{% call modal('deleteWorkflowModal', 'Delete Workflow', 'lg') %}
    <div class="mb-4">
        <p class="text-sm mb-4" style="color: var(--text-secondary);">
            You are about to delete the workflow: <strong id="deleteWorkflowName" style="color: var(--text-primary);"></strong>
        </p>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">
            This workflow has dependencies. You can optionally reassign them to another workflow, or leave empty to keep all associated records.
        </p>
    </div>

    <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Reassign to Workflow (Optional)</label>
        <select id="deleteReassignToWorkflow" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
            <option value="">Select a workflow to reassign items to (or leave empty to keep all)</option>
        </select>
    </div>

    <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal('deleteWorkflowModal')" class="btn-neutral-secondary">
            Cancel
        </button>
        <button type="button" onclick="confirmDeleteWorkflow()" class="btn-crud-delete">
            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Delete Workflow
        </button>
    </div>
{% endcall %}

<!-- Deactivate Workflow Modal -->
{% from 'components/modal.html' import modal %}
{% call modal('deactivateWorkflowModal', 'Inactivate Workflow', 'lg') %}
    <div class="mb-4">
        <p class="text-sm mb-4" style="color: var(--text-secondary);">
            You are about to inactivate the workflow: <strong id="deactivateWorkflowName" style="color: var(--text-primary);"></strong>
        </p>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">
            This workflow has dependencies. You can optionally reassign them to another workflow, or leave empty to keep all associated records.
        </p>
    </div>

    <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">Reassign to Workflow (Optional)</label>
        <select id="reassignToWorkflow" class="w-full px-3 py-2 border rounded-lg" style="border-color: var(--border-color); background-color: var(--bg-primary); color: var(--text-primary);">
            <option value="">Select a workflow to reassign items to (or leave empty to keep all)</option>
        </select>
    </div>

    <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal('deactivateWorkflowModal')" class="btn-neutral-secondary">
            Cancel
        </button>
        <button type="button" onclick="confirmDeactivateWorkflow()" class="btn-crud-delete">
            <i data-lucide="x-circle" class="w-4 h-4 mr-2"></i>Inactivate
        </button>
    </div>
{% endcall %}
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let workflows = [];
    let integrations = [];
    let currentWorkflowId = null;

    // Authentication helper
    function getAuthToken() {
        let token = localStorage.getItem('pulse_token');
        if (!token) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'pulse_token') {
                    token = value;
                    break;
                }
            }
        }
        return token;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
        await loadIntegrations(); // Load integrations first
        await loadWorkflows(); // Then load workflows

        // Initialize vectorization card
        initializeVectorizationCard();
    });

    // Initialize vectorization card
    function initializeVectorizationCard() {
        const vectorizationCard = new VectorizationCard({
            tableName: 'workflows',
            displayName: 'Workflows',
            containerId: 'vectorization-card-container',
            apiBaseUrl: '{{ backend_service_url }}/api/v1/vectorization'
        });
    }

    async function loadWorkflows() {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch('/api/v1/admin/workflows', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            workflows = await response.json();

            // Ensure integrations are loaded before rendering
            if (integrations.length === 0) {
                await loadIntegrations();
            }

            renderWorkflowsTable();

        } catch (error) {
            console.error('Error loading workflows:', error);
            showNotification(`Error loading workflows: ${error.message}`, 'error');
        }
    }

    async function loadIntegrations() {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch('/api/v1/admin/integrations', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            integrations = await response.json();
            updateIntegrationDropdown();

        } catch (error) {
            console.error('Error loading integrations:', error);
            // Set default integrations if API fails
            integrations = [
                { id: 1, name: 'Jira', active: true },
                { id: 2, name: 'GitHub', active: true }
            ];
            updateIntegrationDropdown();
        }
    }

    function updateIntegrationDropdown() {
        const dropdown = document.getElementById('workflowIntegration');
        dropdown.innerHTML = '<option value="">Select Integration</option>';

        // Filter to only show Data type integrations
        const dataIntegrations = integrations.filter(integration =>
            integration.active && (
                integration.integration_type === 'data_source' ||
                integration.integration_type === 'Data' ||
                integration.type === 'data_source' ||
                integration.type === 'Data'
            )
        );

        dataIntegrations.forEach(integration => {
            const option = document.createElement('option');
            option.value = integration.id;
            option.textContent = integration.name;
            dropdown.appendChild(option);
        });
    }

    function renderWorkflowsTable(filteredWorkflows = null) {
        const tbody = document.getElementById('workflowsTableBody');
        const emptyState = document.getElementById('emptyState');
        const workflowsToRender = filteredWorkflows || workflows;

        if (!workflowsToRender || workflowsToRender.length === 0) {
            tbody.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        tbody.innerHTML = '';

        workflowsToRender.forEach(workflow => {
            const row = document.createElement('tr');
            row.className = 'border-b border-default hover:bg-tertiary';

            // Add darker background for inactive items
            if (!workflow.active) {
                row.style.backgroundColor = 'rgba(0, 0, 0, 0.08)';
                row.style.opacity = '0.7';
            }

            // Toggle switch for active/inactive
            const toggleSwitch = `
                <div class="job-toggle-switch" onclick="toggleWorkflow(${workflow.id})">
                    <div class="toggle-switch ${workflow.active ? 'active' : ''}">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label">${workflow.active ? 'On' : 'Off'}</span>
                </div>
            `;

            const integration = integrations.find(i => i.id === workflow.integration_id);
            const integrationName = integration ? integration.name : 'Unknown';

            // Construct integration logo display
            const tenantName = '{{ tenant_name|lower }}' || 'wex';
            const hasLogo = integration && integration.logo_filename && integration.logo_filename.trim() !== '';
            const logoPath = hasLogo ? `/static/assets/${tenantName}/integrations/${integration.logo_filename}` : null;

            const integrationDisplay = logoPath ?
                `<div class="flex items-center justify-center">
                    <img src="${logoPath}" alt="${integrationName}" class="h-6 w-auto max-w-16 object-contain"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <span class="text-sm" style="color: var(--text-primary); display: none;">${integrationName}</span>
                </div>` :
                `<span class="text-sm" style="color: var(--text-primary);">${integrationName}</span>`;

            const textColorPrimary = workflow.active ? 'var(--text-primary)' : 'var(--text-muted)';
            const textColorSecondary = workflow.active ? 'var(--text-secondary)' : 'var(--text-muted)';

            // Get step category badge with correct colors
            let categoryBadge = '';
            const category = workflow.step_category || 'unknown';

            switch(category.toLowerCase()) {
                case 'todo':
                case 'to_do':
                case 'to do':
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--neutral-secondary); color: white;">To Do</span>`;
                    break;
                case 'in_progress':
                case 'in progress':
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--crud-edit); color: white;">In Progress</span>`;
                    break;
                case 'waiting':
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--status-warning); color: white;">Waiting</span>`;
                    break;
                case 'done':
                case 'completed':
                case 'complete':
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--crud-create); color: white;">Done</span>`;
                    break;
                case 'discarded':
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--crud-delete); color: white;">Discarded</span>`;
                    break;
                default:
                    categoryBadge = `<span class="px-2 py-1 text-xs rounded" style="background-color: var(--neutral-secondary); color: white;">${category}</span>`;
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium" style="color: ${textColorPrimary};">${workflow.step_name || 'Unnamed Step'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <span class="text-sm" style="color: ${textColorSecondary};">${workflow.step_number || '-'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    ${categoryBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    ${integrationDisplay}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">${toggleSwitch}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex justify-center space-x-1">
                        <button onclick="editWorkflow(${workflow.id})" class="job-action-btn" title="Edit">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteWorkflow(${workflow.id})" class="job-action-btn" title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });

        // Re-initialize Lucide icons after table rendering
        refreshLucideIcons();
    }

    function applyFilters() {
        const stepNameFilter = document.getElementById('filterStepName').value.toLowerCase();
        const integrationFilter = document.getElementById('filterIntegration').value.toLowerCase();
        const stepCategoryFilter = document.getElementById('filterStepCategory').value;
        const statusFilter = document.getElementById('filterStatus').value;

        const filteredWorkflows = workflows.filter(workflow => {
            // Step name filter
            if (stepNameFilter && (!workflow.step_name || !workflow.step_name.toLowerCase().includes(stepNameFilter))) {
                return false;
            }

            // Integration filter
            if (integrationFilter) {
                const integration = integrations.find(i => i.id === workflow.integration_id);
                const integrationName = integration ? integration.name.toLowerCase() : '';
                if (!integrationName.includes(integrationFilter)) {
                    return false;
                }
            }

            // Step category filter
            if (stepCategoryFilter && workflow.step_category !== stepCategoryFilter) {
                return false;
            }

            // Status filter
            if (statusFilter) {
                if (statusFilter === 'active' && !workflow.active) return false;
                if (statusFilter === 'inactive' && workflow.active) return false;
            }

            return true;
        });

        renderWorkflowsTable(filteredWorkflows);
    }

    function toggleWorkflow(id) {
        const workflow = workflows.find(w => w.id === id);
        if (workflow) {
            const newActiveState = !workflow.active;
            toggleWorkflowActive(id, newActiveState, workflow.step_name || 'Unnamed Step');
        }
    }

    function showCreateModal() {
        document.getElementById('workflowForm').reset();
        document.getElementById('workflowActive').checked = true;
        currentWorkflowId = null;
        // Set modal title for create mode
        document.getElementById('workflowModalTitle').textContent = 'Create Workflow';
        openModal('workflowModal');
    }

    function editWorkflow(id) {
        // Find workflow and populate form
        const workflow = workflows.find(w => w.id === id);
        if (!workflow) return;

        // Debug: Log workflow data to see step_category
        console.log('Editing workflow:', workflow);

        // Set modal title for edit mode
        document.getElementById('workflowModalTitle').textContent = 'Edit Workflow';

        // Populate form fields
        document.getElementById('stepName').value = workflow.step_name || '';
        document.getElementById('stepNumber').value = workflow.step_number || '';
        document.getElementById('stepCategory').value = workflow.step_category || 'in_progress';
        document.getElementById('workflowIntegration').value = workflow.integration_id || '';
        document.getElementById('workflowActive').checked = workflow.active;

        // Debug: Log what was set in the step category field
        console.log('Step category set to:', workflow.step_category || 'in_progress');

        currentWorkflowId = id;
        openModal('workflowModal');
    }

    async function deleteWorkflow(id) {
        currentWorkflowId = id;

        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            // Find the workflow name for display
            const workflow = workflows.find(w => w.id === id);
            const workflowName = workflow ? workflow.step_name : 'Unknown Workflow';

            // Check for dependencies first
            const response = await fetch(`/api/v1/admin/workflows/${id}/dependencies`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const dependencies = await response.json();

            // If no dependencies, delete directly
            if (dependencies.can_delete_safely) {
                await deleteWorkflowDirectly(id, workflowName);
                return;
            }

            // Show modal for reassignment if there are dependencies
            document.getElementById('deleteWorkflowName').textContent = workflowName;

            // Populate reassignment dropdown with other active workflows
            const reassignSelect = document.getElementById('deleteReassignToWorkflow');
            reassignSelect.innerHTML = '<option value="">Select a workflow to reassign items to (or leave empty to keep all)</option>';

            dependencies.reassignment_targets.forEach(target => {
                const option = document.createElement('option');
                option.value = target.id;
                option.textContent = target.step_name;
                reassignSelect.appendChild(option);
            });

            openModal('deleteWorkflowModal');

        } catch (error) {
            console.error('Error checking dependencies:', error);
            showNotification(`Error checking dependencies: ${error.message}`, 'error');
        }
    }

    async function deleteWorkflowDirectly(id, workflowName) {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/admin/workflows/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow deleted successfully', 'success');
            loadWorkflows();

        } catch (error) {
            console.error('Error deleting workflow:', error);
            showNotification(`Error deleting workflow: ${error.message}`, 'error');
        }
    }

    async function confirmDeleteWorkflow() {
        if (!currentWorkflowId) return;

        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const reassignToId = document.getElementById('deleteReassignToWorkflow').value;
            const requestBody = {
                action: reassignToId ? 'reassign_issues' : 'keep_issues'
            };

            // Add reassignment target if selected
            if (reassignToId) {
                requestBody.target_workflow_id = parseInt(reassignToId);
            }

            const response = await fetch(`/api/v1/admin/workflows/${currentWorkflowId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow deleted successfully', 'success');
            closeModal('deleteWorkflowModal');
            loadWorkflows();

        } catch (error) {
            console.error('Error deleting workflow:', error);
            showNotification(`Error deleting workflow: ${error.message}`, 'error');
            closeModal('deleteWorkflowModal');
        }
    }

    async function showPauseModal(id, workflowName) {
        currentWorkflowId = id;

        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            // Check for dependencies first
            const response = await fetch(`/api/v1/admin/workflows/${id}/dependencies`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const dependencies = await response.json();

            // If no dependencies, deactivate directly
            if (dependencies.can_delete_safely) {
                await deactivateWorkflowDirectly(id, workflowName);
                return;
            }

            // Show modal for reassignment if there are dependencies
            document.getElementById('deactivateWorkflowName').textContent = workflowName;

            // Populate reassignment dropdown with other active workflows
            const reassignSelect = document.getElementById('reassignToWorkflow');
            reassignSelect.innerHTML = '<option value="">Select a workflow to reassign items to (or leave empty to keep all)</option>';

            dependencies.reassignment_targets.forEach(target => {
                const option = document.createElement('option');
                option.value = target.id;
                option.textContent = target.step_name;
                reassignSelect.appendChild(option);
            });

            openModal('deactivateWorkflowModal');

        } catch (error) {
            console.error('Error checking dependencies:', error);
            showNotification(`Error checking dependencies: ${error.message}`, 'error');
        }
    }

    async function deactivateWorkflowDirectly(id, workflowName) {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/admin/workflows/${id}/deactivate`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ action: 'keep_issues' })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow inactivated successfully', 'success');
            loadWorkflows();

        } catch (error) {
            console.error('Error pausing workflow:', error);
            showNotification(`Error pausing workflow: ${error.message}`, 'error');
        }
    }

    async function confirmDeactivateWorkflow() {
        if (!currentWorkflowId) return;

        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const reassignToId = document.getElementById('reassignToWorkflow').value;
            const requestBody = {
                action: reassignToId ? 'reassign_issues' : 'keep_issues'
            };

            // Add reassignment target if selected
            if (reassignToId) {
                requestBody.target_workflow_id = parseInt(reassignToId);
            }

            const response = await fetch(`/api/v1/admin/workflows/${currentWorkflowId}/deactivate`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow inactivated successfully', 'success');
            closeModal('deactivateWorkflowModal');
            loadWorkflows();

        } catch (error) {
            console.error('Error pausing workflow:', error);
            showNotification(`Error pausing workflow: ${error.message}`, 'error');
            closeModal('deactivateWorkflowModal');
        }
    }

    async function resumeWorkflow(id) {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/admin/workflows/${id}/activate`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow resumed successfully', 'success');
            loadWorkflows();

        } catch (error) {
            console.error('Error resuming workflow:', error);
            showNotification(`Error resuming workflow: ${error.message}`, 'error');
        }
    }

    // Toggle function for active/inactive switch
    async function toggleWorkflowActive(id, isActive, workflowName) {
        try {
            if (!isActive) {
                // When deactivating, we could show a modal for dependencies if needed
                // For now, we'll directly deactivate
                await deactivateWorkflow(id);
            } else {
                // Activating - direct API call
                await resumeWorkflow(id);
            }
        } catch (error) {
            console.error('Error toggling workflow:', error);
            showNotification('Error updating workflow status', 'error');

            // Reset toggle on error
            const toggle = document.querySelector(`input[onchange*="${id}"]`);
            if (toggle) toggle.checked = !isActive;
        }
    }

    async function deactivateWorkflow(id) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/admin/workflows/${id}/deactivate`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification('Workflow deactivated successfully', 'success');
            loadWorkflows();
        } catch (error) {
            console.error('Error deactivating workflow:', error);
            showNotification(`Error deactivating workflow: ${error.message}`, 'error');
        }
    }

    // Form submission
    document.getElementById('workflowForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            step_name: document.getElementById('stepName').value,
            step_number: parseInt(document.getElementById('stepNumber').value),
            step_category: document.getElementById('stepCategory').value,
            integration_id: parseInt(document.getElementById('workflowIntegration').value),
            active: document.getElementById('workflowActive').checked
        };

        try {
            const token = getAuthToken();
            const url = currentWorkflowId ?
                `/api/v1/admin/workflows/${currentWorkflowId}` :
                '/api/v1/admin/workflows';

            const method = currentWorkflowId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            showNotification(currentWorkflowId ? 'Workflow updated successfully' : 'Workflow created successfully', 'success');
            closeModal('workflowModal');
            loadWorkflows();
        } catch (error) {
            console.error('Error saving workflow:', error);
            showNotification(`Error saving workflow: ${error.message}`, 'error');
        }
    });

    function toggleModalActive() {
        const toggleSwitch = document.getElementById('modalToggleSwitch');
        const toggleLabel = document.getElementById('modalToggleLabel');
        const hiddenInput = document.getElementById('workflowActive');

        const isActive = toggleSwitch.classList.contains('active');

        if (isActive) {
            toggleSwitch.classList.remove('active');
            toggleLabel.textContent = 'Off';
            hiddenInput.value = 'false';
        } else {
            toggleSwitch.classList.add('active');
            toggleLabel.textContent = 'On';
            hiddenInput.value = 'true';
        }
    }

    // Modern notification system - consistent across all pages
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm max-w-sm transition-all duration-300 transform translate-x-full`;

        // Set background color based on type
        switch (type) {
            case 'success':
                notification.style.backgroundColor = '#10b981';
                break;
            case 'error':
                notification.style.backgroundColor = '#ef4444';
                break;
            case 'warning':
                notification.style.backgroundColor = 'var(--color-1)';
                break;
            default:
                notification.style.backgroundColor = '#3b82f6';
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(full)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function showSuccess(message) {
        showNotification(message, 'success');
    }

    function showError(message) {
        showNotification(message, 'error');
    }

    // Function to re-initialize Lucide icons after dynamic content updates
    function refreshLucideIcons() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
</script>
{% endblock %}
