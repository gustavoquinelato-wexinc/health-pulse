<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Steps - Pulse ETL Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .stats-card {
            transition: transform 0.2s ease-in-out;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }

        /* Sortable column styles */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }

        .sortable.sort-asc i:before {
            content: "\f0de";
            opacity: 1;
        }

        .sortable.sort-desc i:before {
            content: "\f0dd";
            opacity: 1;
        }

        /* Category badge colors */
        .category-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .category-todo {
            background-color: #6c757d;
            color: white;
        }

        .category-inprogress {
            background-color: #0d6efd;
            color: white;
        }

        .category-waiting {
            background-color: #ffc107;
            color: black;
        }

        .category-done {
            background-color: #198754;
            color: white;
        }

        .category-discarded {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Pulse ETL
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-mappings">
                            <i class="fas fa-sitemap me-2"></i>Issue Type Mappings
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-hierarchies">
                            <i class="fas fa-layer-group me-2"></i>Issue Type Hierarchies
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item active" href="/admin/flow-steps">
                            <i class="fas fa-stream me-2"></i>Flow Steps
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/status-mappings">
                            <i class="fas fa-exchange-alt me-2"></i>Status Mappings
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="fas fa-stream me-3"></i>Flow Steps Management
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage workflow flow steps and their configurations</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Flow Steps Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Flow Steps
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshFlowSteps()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showCreateFlowStepModal()">
                                    <i class="fas fa-plus"></i> Add Flow Step
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="searchFlowStep" class="form-label text-dark fw-bold">Search Flow Steps</label>
                                <input type="text" class="form-control" id="searchFlowStep" placeholder="Type to search..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-4">
                                <label for="filterStepCategory" class="form-label text-dark fw-bold">Filter Category</label>
                                <select class="form-select" id="filterStepCategory" onchange="applyFilters()">
                                    <option value="">All Categories</option>
                                    <option value="To Do">To Do</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Waiting">Waiting</option>
                                    <option value="Done">Done</option>
                                    <option value="Discarded">Discarded</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterActive" class="form-label text-dark fw-bold">Filter Status</label>
                                <select class="form-select" id="filterActive" onchange="applyFilters()">
                                    <option value="">All Statuses</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable text-center" onclick="sortTable('step_number')">
                                            Step # <i class="fas fa-sort" id="sort-step_number"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('name')">
                                            Name <i class="fas fa-sort" id="sort-name"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('step_category')">
                                            Category <i class="fas fa-sort" id="sort-step_category"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('active')">
                                            Status <i class="fas fa-sort" id="sort-active"></i>
                                        </th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="flow-steps-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading flow steps...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Flow Step Modal -->
    <div class="modal fade" id="editFlowStepModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Flow Step</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editFlowStepForm">
                        <input type="hidden" id="editFlowStepId">
                        <div class="mb-3">
                            <label for="editFlowStepName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editFlowStepName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editFlowStepNumber" class="form-label">Flow Step Number</label>
                            <input type="number" class="form-control" id="editFlowStepNumber" min="1" placeholder="Leave empty for no step number">
                        </div>
                        <div class="mb-3">
                            <label for="editFlowStepCategory" class="form-label">Category</label>
                            <select class="form-control" id="editFlowStepCategory" required>
                                <option value="">Select Category</option>
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Waiting">Waiting</option>
                                <option value="Done">Done</option>
                                <option value="Discarded">Discarded</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFlowStepChanges()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivation Options Modal -->
    <div class="modal fade" id="deactivationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate Flow Step
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="deactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmDeactivationBtn" onclick="confirmDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let flowSteps = [];
        let filteredFlowSteps = [];
        let currentSort = { column: 'step_number', direction: 'asc' };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadFlowSteps();
            updateSortIndicators();
        });

        // Get authentication token from cookie
        function getAuthToken() {
            // Try localStorage first (for compatibility)
            let token = localStorage.getItem('pulse_token') || localStorage.getItem('token');

            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'pulse_token' || name === 'access_token') {
                        token = value;
                        break;
                    }
                }
            }

            return token;
        }

        // Sorting functionality
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            filteredFlowSteps.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                // Convert to lowercase for case-insensitive sorting
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            updateFlowStepsDisplay();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            // Reset all sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set current sort indicator
            const currentHeader = document.querySelector(`#sort-${currentSort.column}`);
            if (currentHeader) {
                const th = currentHeader.closest('th');
                th.classList.add(`sort-${currentSort.direction}`);
            }
        }

        // Filtering functionality
        function applyFilters() {
            const searchTerm = document.getElementById('searchFlowStep').value.toLowerCase();
            const filterCategory = document.getElementById('filterStepCategory').value;
            const filterActive = document.getElementById('filterActive').value;

            filteredFlowSteps = flowSteps.filter(step => {
                const matchesSearch = !searchTerm ||
                    step.name.toLowerCase().includes(searchTerm) ||
                    (step.step_category && step.step_category.toLowerCase().includes(searchTerm));

                const matchesCategory = !filterCategory ||
                    step.step_category === filterCategory;

                const matchesActive = !filterActive ||
                    step.active.toString() === filterActive;

                return matchesSearch && matchesCategory && matchesActive;
            });

            // Re-apply current sort to filtered data
            if (currentSort.column) {
                sortTable(currentSort.column);
            } else {
                updateFlowStepsDisplay();
            }
        }

        function getCategoryColorClass(category) {
            const categoryLower = category.toLowerCase();

            if (categoryLower === 'to do') {
                return 'category-todo';
            } else if (categoryLower === 'in progress') {
                return 'category-inprogress';
            } else if (categoryLower === 'waiting') {
                return 'category-waiting';
            } else if (categoryLower === 'done') {
                return 'category-done';
            } else if (categoryLower === 'discarded') {
                return 'category-discarded';
            } else {
                return 'category-todo';
            }
        }

        // Load flow steps
        async function loadFlowSteps() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('/api/v1/admin/flow-steps', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    flowSteps = await response.json();
                    filteredFlowSteps = [...flowSteps]; // Initialize filtered data
                    updateFlowStepsDisplay();
                } else if (response.status === 401) {
                    console.error('Authentication failed');
                    window.location.href = '/login?error=authentication_expired';
                } else {
                    console.error('Failed to load flow steps');
                    document.getElementById('flow-steps-table-body').innerHTML = `
                        <tr><td colspan="5" class="text-center text-danger">Failed to load flow steps</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading flow steps:', error);
                document.getElementById('flow-steps-table-body').innerHTML = `
                    <tr><td colspan="5" class="text-center text-danger">Error loading flow steps</td></tr>
                `;
            }
        }

        function updateFlowStepsDisplay() {
            const tbody = document.getElementById('flow-steps-table-body');
            tbody.innerHTML = '';

            if (!filteredFlowSteps || filteredFlowSteps.length === 0) {
                const message = flowSteps.length === 0 ? 'No flow steps found' : 'No flow steps match the current search';
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">${message}</td></tr>
                `;
                return;
            }

            filteredFlowSteps.forEach(step => {
                const row = document.createElement('tr');

                // Get category color class
                const categoryClass = getCategoryColorClass(step.step_category);

                // Add inactive styling if step is not active
                if (!step.active) {
                    row.classList.add('table-secondary');
                    row.style.opacity = '0.7';
                }

                row.innerHTML = `
                    <td class="text-center">${step.step_number || '-'}</td>
                    <td>${step.name}</td>
                    <td class="text-center"><span class="category-badge ${categoryClass}">${step.step_category}</span></td>
                    <td class="text-center">
                        <span class="badge ${step.active ? 'bg-success' : 'bg-secondary'}">
                            <i class="fas ${step.active ? 'fa-check-circle' : 'fa-pause-circle'} me-1"></i>
                            ${step.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editFlowStep(${step.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${step.active ? 'btn-outline-warning' : 'btn-outline-success'} me-1" onclick="toggleFlowStepActive(${step.id}, ${step.active})" title="${step.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas ${step.active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFlowStep(${step.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshFlowSteps() {
            loadFlowSteps();
        }

        function showCreateFlowStepModal() {
            // Reset form and show modal
            document.getElementById('editFlowStepForm').reset();
            document.getElementById('editFlowStepId').value = '';
            document.querySelector('#editFlowStepModal .modal-title').textContent = 'Create Flow Step';
            new bootstrap.Modal(document.getElementById('editFlowStepModal')).show();
        }

        // Global variables for deactivation modal
        let currentDeactivationStepId = null;
        let currentDeactivationData = null;

        async function toggleFlowStepActive(id, isActive) {
            if (isActive) {
                // Deactivating - show enhanced modal
                await showDeactivationModal(id);
            } else {
                // Activating - simple toggle
                await activateFlowStep(id);
            }
        }

        async function showDeactivationModal(id, context = 'deactivate') {
            try {
                const token = getAuthToken();
                if (!token) return;

                // Check dependencies first
                const response = await fetch(`/api/v1/admin/flow-steps/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentDeactivationStepId = id;
                    currentDeactivationData = data;

                    populateDeactivationModal(data, context);
                    new bootstrap.Modal(document.getElementById('deactivationModal')).show();
                } else {
                    alert('Failed to check dependencies');
                }
            } catch (error) {
                console.error('Error checking dependencies:', error);
                alert('Error checking dependencies');
            }
        }

        function populateDeactivationModal(data, context = 'deactivate') {
            const content = document.getElementById('deactivationContent');
            const flowStep = data.flow_step;
            const hasDependencies = data.dependency_count > 0;

            // Customize messaging based on context
            const isDeleteContext = context === 'delete';
            const actionWord = isDeleteContext ? 'delete' : 'deactivate';
            const actionPastTense = isDeleteContext ? 'deleted' : 'deactivated';

            if (hasDependencies) {
                const contextMessage = isDeleteContext
                    ? `<div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Cannot delete directly:</strong> This flow step has dependencies.
                        Choose how to handle them before removal.
                       </div>`
                    : '';

                const impactMessage = data.affected_issues_count
                    ? `${data.dependency_count} status mappings, ${data.affected_statuses_count} statuses, and ${data.affected_issues_count} issues will be affected.`
                    : `${data.dependency_count} status mappings and ${data.affected_statuses_count} statuses will be affected.`;

                content.innerHTML = `
                    ${contextMessage}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Impact:</strong> ${impactMessage}
                    </div>

                    ${isDeleteContext
                        ? `<h6 class="mb-3">Reassign dependencies before deletion:</h6>
                           <p class="text-muted mb-3">To delete this flow step, all dependent data must be reassigned to another active flow step.</p>`
                        : `<h6 class="mb-3">Choose how to handle dependent status mappings:</h6>`
                    }

                    ${!isDeleteContext ? `
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="deactivationAction" id="keepMappings" value="keep_mappings">
                        <label class="form-check-label" for="keepMappings">
                            <strong>Keep mappings active</strong> (they'll point to inactive step)
                            <div class="text-muted small mt-1">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                New extracted items will still map to this step<br>
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                May cause confusion in reports and metrics
                            </div>
                        </label>
                    </div>` : ''}

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="deactivationAction" id="reassignMappings" value="reassign_mappings" checked>
                        <label class="form-check-label" for="reassignMappings">
                            <strong>Reassign mappings to another step</strong> ${isDeleteContext ? '(required for deletion)' : '(recommended)'}
                            <div class="mt-2">
                                <select class="form-select" id="targetFlowStep" ${data.reassignment_targets.length === 0 ? 'disabled' : ''}>
                                    <option value="">Select target flow step...</option>
                                    ${data.reassignment_targets.map(target =>
                                        `<option value="${target.id}">${target.name} (Step ${target.step_number || 'N/A'}) - Active</option>`
                                    ).join('')}
                                </select>
                                ${data.reassignment_targets.length === 0 ?
                                    '<small class="text-danger">No active flow steps available for reassignment. You must have at least one other active flow step to delete this one.</small>' :
                                    '<small class="text-muted">Only active flow steps are shown as reassignment targets.</small>'
                                }
                            </div>
                        </label>
                    </div>

                    <div class="mt-3">
                        <h6>Affected Status Mappings:</h6>
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>From Status</th>
                                        <th>To Status</th>
                                        <th>Statuses</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.dependent_mappings.map(mapping => `
                                        <tr>
                                            <td><code>${mapping.status_from}</code></td>
                                            <td><span class="badge bg-secondary">${mapping.status_to}</span></td>
                                            <td>${mapping.affected_statuses}</td>
                                            <td>${mapping.affected_issues || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                const safeMessage = isDeleteContext
                    ? `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Safe to delete:</strong> This flow step has no dependencies.
                       </div>
                       <p>This flow step can be safely deleted without affecting other data.</p>`
                    : `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Safe to deactivate:</strong> This flow step has no dependencies.
                       </div>
                       <p>This flow step can be safely deactivated without affecting other data.</p>`;

                content.innerHTML = `
                    ${safeMessage}
                    <input type="hidden" name="deactivationAction" value="keep_mappings">
                `;
            }

            // Update modal title and button based on context
            const modalTitle = isDeleteContext
                ? `<i class="fas fa-trash me-2"></i>Remove '${flowStep.name}' Flow Step`
                : `<i class="fas fa-pause me-2"></i>Deactivate '${flowStep.name}' Flow Step`;

            const buttonText = isDeleteContext ? 'Remove Flow Step' : 'Deactivate';
            const buttonIcon = isDeleteContext ? 'fa-trash' : 'fa-pause';

            document.querySelector('#deactivationModal .modal-title').innerHTML = modalTitle;
            document.querySelector('#confirmDeactivationBtn').innerHTML =
                `<i class="fas ${buttonIcon} me-1"></i>${buttonText}`;

            // Update modal header color based on context
            const modalHeader = document.querySelector('#deactivationModal .modal-header');
            if (isDeleteContext) {
                modalHeader.className = 'modal-header bg-danger text-white';
            } else {
                modalHeader.className = 'modal-header bg-warning text-dark';
            }

            // Store context for confirmation function
            document.getElementById('deactivationModal').setAttribute('data-context', context);
        }

        async function confirmDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const context = document.getElementById('deactivationModal').getAttribute('data-context') || 'deactivate';
                const isDeleteContext = context === 'delete';

                // Get selected action from either checked radio button or hidden input
                let selectedAction = document.querySelector('input[name="deactivationAction"]:checked')?.value;
                if (!selectedAction) {
                    // Check for hidden input (used when no dependencies exist)
                    selectedAction = document.querySelector('input[name="deactivationAction"][type="hidden"]')?.value;
                }

                if (!selectedAction) {
                    alert('Please select an option');
                    return;
                }

                let targetFlowStepId = null;
                if (selectedAction === 'reassign_mappings') {
                    targetFlowStepId = document.getElementById('targetFlowStep')?.value;
                    if (!targetFlowStepId) {
                        alert('Please select a target flow step for reassignment');
                        return;
                    }

                    // Additional validation: ensure target is not the same as current step
                    if (parseInt(targetFlowStepId) === currentDeactivationStepId) {
                        alert('Cannot reassign to the same flow step. Please select a different target.');
                        return;
                    }
                }

                // For delete context with no dependencies, use delete API
                if (isDeleteContext && currentDeactivationData.can_delete_safely) {
                    const response = await fetch(`/api/v1/admin/flow-steps/${currentDeactivationStepId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                        loadFlowSteps();
                    } else {
                        const error = await response.json();
                        alert(`Failed to delete flow step: ${error.detail}`);
                    }
                    return;
                }

                // For delete context with dependencies: reassign then delete
                if (isDeleteContext) {
                    // Force reassignment for delete context
                    if (selectedAction !== 'reassign_mappings') {
                        alert('Reassignment is required for deletion');
                        return;
                    }

                    // Check if there are any reassignment targets available
                    const targetSelect = document.getElementById('targetFlowStep');
                    if (!targetSelect || targetSelect.options.length <= 1) { // <= 1 because first option is "Select target..."
                        alert('Cannot delete: No active flow steps available for reassignment. You must have at least one other active flow step to delete this one.');
                        return;
                    }

                    // Step 1: Reassign dependencies
                    const reassignBody = {
                        action: 'reassign_mappings',
                        target_flow_step_id: parseInt(targetFlowStepId)
                    };

                    const reassignResponse = await fetch(`/api/v1/admin/flow-steps/${currentDeactivationStepId}/deactivate`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reassignBody)
                    });

                    if (!reassignResponse.ok) {
                        const error = await reassignResponse.json();
                        alert(`Failed to reassign dependencies: ${error.detail}`);
                        return;
                    }

                    // Step 2: Now delete the flow step (should be safe now)
                    const deleteResponse = await fetch(`/api/v1/admin/flow-steps/${currentDeactivationStepId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        alert(`Dependencies reassigned and flow step deleted successfully`);
                        bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                        loadFlowSteps();
                    } else {
                        const error = await deleteResponse.json();
                        alert(`Dependencies reassigned but failed to delete flow step: ${error.detail}`);
                    }
                    return;
                }

                // For deactivate context, use deactivate API
                const requestBody = {
                    action: selectedAction,
                    target_flow_step_id: targetFlowStepId ? parseInt(targetFlowStepId) : null
                };

                const response = await fetch(`/api/v1/admin/flow-steps/${currentDeactivationStepId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                    loadFlowSteps();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate flow step: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error processing flow step action:', error);
                alert('Error processing flow step action');
            }
        }

        async function activateFlowStep(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/flow-steps/${id}/toggle-active`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadFlowSteps();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate flow step: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating flow step:', error);
                alert('Error activating flow step');
            }
        }

        async function deleteFlowStep(id) {
            // First check if this flow step has dependencies
            try {
                const token = getAuthToken();
                if (!token) return;

                // Check dependencies first
                const depResponse = await fetch(`/api/v1/admin/flow-steps/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (depResponse.ok) {
                    const depData = await depResponse.json();

                    if (!depData.can_delete_safely) {
                        // Has dependencies - open deactivation modal directly with delete context
                        await showDeactivationModal(id, 'delete');
                        return;
                    }
                }

                // Safe to delete - confirm with user
                if (confirm('Are you sure you want to permanently delete this flow step?\n\nThis action cannot be undone.')) {
                    const response = await fetch(`/api/v1/admin/flow-steps/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert(result.message);
                        loadFlowSteps();
                    } else {
                        const error = await response.json();
                        alert(`Failed to delete flow step: ${error.detail}`);
                    }
                }
            } catch (error) {
                console.error('Error deleting flow step:', error);
                alert('Error deleting flow step');
            }
        }

        async function editFlowStep(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/flow-steps/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const step = await response.json();
                    
                    // Populate the modal
                    document.getElementById('editFlowStepId').value = step.id;
                    document.getElementById('editFlowStepName').value = step.name;
                    document.getElementById('editFlowStepNumber').value = step.step_number || '';
                    document.getElementById('editFlowStepCategory').value = step.step_category || '';
                    
                    // Show the modal
                    new bootstrap.Modal(document.getElementById('editFlowStepModal')).show();
                } else {
                    alert('Failed to load flow step details');
                }
            } catch (error) {
                console.error('Error loading flow step:', error);
                alert('Error loading flow step details');
            }
        }

        async function saveFlowStepChanges() {
            const id = document.getElementById('editFlowStepId').value;
            const name = document.getElementById('editFlowStepName').value;
            const stepNumber = document.getElementById('editFlowStepNumber').value;
            const stepCategory = document.getElementById('editFlowStepCategory').value;

            if (!name || !stepCategory) {
                alert('Please fill in name and category');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) return;

                const data = {
                    name: name,
                    step_number: stepNumber ? parseInt(stepNumber) : null,
                    step_category: stepCategory
                };

                let response;
                if (id) {
                    // Update existing flow step
                    response = await fetch(`/api/v1/admin/flow-steps/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new flow step
                    response = await fetch('/api/v1/admin/flow-steps', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    // Close modal and refresh data
                    bootstrap.Modal.getInstance(document.getElementById('editFlowStepModal')).hide();
                    loadFlowSteps();
                    alert(id ? 'Flow step updated successfully' : 'Flow step created successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed to ${id ? 'update' : 'create'} flow step: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(`Error ${id ? 'updating' : 'creating'} flow step:`, error);
                alert(`Error ${id ? 'updating' : 'creating'} flow step`);
            }
        }
    </script>
</body>

</html>
