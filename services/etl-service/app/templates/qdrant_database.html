{% extends "layouts/modern_layout.html" %}

{% block title %}Qdrant Analysis - Pulse ETL{% endblock %}

{% block content %}

<!-- Header Section -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                Qdrant Database
            </h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">
                Vector database analysis and vectorization validation
            </p>
        </div>
        <div class="flex items-center space-x-2">
            <div id="qdrantStatusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span class="text-sm" style="color: var(--text-secondary);" id="qdrantStatusText">Connecting...</span>
            <button onclick="refreshQdrantAnalysis()" class="btn-neutral-secondary" title="Refresh Analysis">
                <i data-lucide="refresh-cw"></i>
            </button>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="mb-8">
    <div class="flex space-x-1 border-b" style="border-color: var(--border-color);">
        <button onclick="showQdrantTab('dashboard')" id="qdrantTabDashboard" class="qdrant-tab active px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i>Dashboard
        </button>
        <button onclick="showQdrantTab('collections')" id="qdrantTabCollections" class="qdrant-tab px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="layers" class="w-4 h-4 mr-2"></i>Collections
        </button>
        <button onclick="showQdrantTab('validation')" id="qdrantTabValidation" class="qdrant-tab px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>Validation
        </button>
        <button onclick="showQdrantTab('analytics')" id="qdrantTabAnalytics" class="qdrant-tab px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>Analytics
        </button>
        <button onclick="showQdrantTab('management')" id="qdrantTabManagement" class="qdrant-tab px-6 py-3 text-sm font-medium rounded-t-lg transition-colors">
            <i data-lucide="settings" class="w-4 h-4 mr-2"></i>Management
        </button>
    </div>
</div>

<!-- Tab Content -->
<div id="qdrantTabContent" class="min-h-96">
    <!-- Content will be populated by JavaScript -->
    <div class="text-center py-16" style="color: var(--text-muted);">
        <i data-lucide="loader-2" class="w-12 h-12 mx-auto mb-4 animate-spin"></i>
        <p class="text-lg">Loading Qdrant analysis...</p>
        <p class="text-sm mt-2">Connecting to vector database...</p>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<style>
    /* Qdrant Analysis Tab Styles */
    .qdrant-tab {
        background-color: transparent;
        color: var(--text-secondary);
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .qdrant-tab:hover {
        color: var(--text-primary);
        background-color: var(--bg-tertiary);
    }

    .qdrant-tab.active {
        color: var(--color-1);
        border-bottom-color: var(--color-1);
        background-color: var(--bg-tertiary);
    }

    /* Qdrant Analysis Content Styles */
    .qdrant-metric-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.2s ease;
    }

    .qdrant-metric-card:hover {
        border-color: var(--color-1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .qdrant-status-healthy {
        color: var(--status-success);
    }

    .qdrant-status-warning {
        color: var(--status-warning);
    }

    .qdrant-status-error {
        color: var(--status-error);
    }

    .qdrant-progress-bar {
        height: 8px;
        background-color: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
    }

    .qdrant-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-1), var(--color-2));
        transition: width 0.3s ease;
    }

    /* Enhanced styling for better visual hierarchy */
    .qdrant-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .qdrant-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .qdrant-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .qdrant-tab {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        .qdrant-tab i {
            width: 1rem;
            height: 1rem;
        }
        
        .qdrant-metric-card {
            padding: 1rem;
        }
    }
</style>

<script>
    // ===== QDRANT ANALYSIS FUNCTIONS =====

    // Qdrant API configuration
    const QDRANT_URL = 'http://localhost:6333';
    let qdrantData = {
        collections: [],
        dashboard: null,
        validation: null,
        analytics: null
    };

    // Initialize Qdrant Analysis on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Get initial tab from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const initialTab = urlParams.get('tab') || 'dashboard';
        
        initializeQdrantAnalysis(initialTab);
    });

    async function initializeQdrantAnalysis(initialTab = 'dashboard') {
        try {
            updateStatusIndicator('loading', 'Connecting to Qdrant...');
            await refreshQdrantAnalysis();
            showQdrantTab(initialTab);
            updateStatusIndicator('healthy', 'Connected');
        } catch (error) {
            console.error('Failed to initialize Qdrant analysis:', error);
            updateStatusIndicator('error', 'Connection failed');
            showQdrantError('Failed to connect to Qdrant. Please ensure Qdrant is running on localhost:6333');
        }
    }

    function updateStatusIndicator(status, text) {
        const statusDot = document.getElementById('qdrantStatusDot');
        const statusText = document.getElementById('qdrantStatusText');
        
        if (statusDot) {
            switch (status) {
                case 'loading':
                    statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                    break;
                case 'healthy':
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                    break;
                case 'error':
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                    break;
                default:
                    statusDot.className = 'w-3 h-3 rounded-full bg-gray-400';
            }
        }
        
        if (statusText) {
            statusText.textContent = text;
        }
    }

    async function refreshQdrantAnalysis() {
        try {
            updateStatusIndicator('loading', 'Refreshing data...');

            // Fetch data from Qdrant and backend
            await Promise.all([
                fetchQdrantCollections(),
                fetchDatabaseCounts(),
                fetchVectorizationQueue()
            ]);

            updateStatusIndicator('healthy', 'Connected');

            // Refresh current tab
            const activeTab = document.querySelector('.qdrant-tab.active');
            if (activeTab) {
                const tabName = activeTab.id.replace('qdrantTab', '').toLowerCase();
                showQdrantTab(tabName);
            }

        } catch (error) {
            console.error('Error refreshing Qdrant analysis:', error);
            updateStatusIndicator('error', 'Refresh failed');
            showQdrantError('Failed to refresh Qdrant data: ' + error.message);
        }
    }

    async function fetchQdrantCollections() {
        try {
            const response = await fetch(`${QDRANT_URL}/collections`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            qdrantData.collections = data.result?.collections || [];

            // Fetch detailed info for each collection
            for (let collection of qdrantData.collections) {
                try {
                    const detailResponse = await fetch(`${QDRANT_URL}/collections/${collection.name}`);
                    if (detailResponse.ok) {
                        const detailData = await detailResponse.json();
                        collection.details = detailData.result;
                    }
                } catch (error) {
                    console.warn(`Failed to fetch details for collection ${collection.name}:`, error);
                }
            }
        } catch (error) {
            console.error('Error fetching Qdrant collections:', error);
            qdrantData.collections = [];
            throw error;
        }
    }

    async function fetchDatabaseCounts() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/database/summary', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                qdrantData.databaseCounts = data.summary?.tables || {};
            } else {
                console.warn('Failed to fetch database counts:', response.status);
                qdrantData.databaseCounts = {};
            }
        } catch (error) {
            console.error('Error fetching database counts:', error);
            qdrantData.databaseCounts = {};
        }
    }

    async function fetchVectorizationQueue() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/summary', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                qdrantData.queueData = data;
            } else {
                console.warn('Failed to fetch vectorization queue:', response.status);
                qdrantData.queueData = {};
            }
        } catch (error) {
            console.error('Error fetching vectorization queue:', error);
            qdrantData.queueData = {};
        }
    }

    function showQdrantTab(tabName) {
        // Update URL without page reload
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.replaceState({}, '', url);

        // Update tab buttons
        document.querySelectorAll('.qdrant-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const activeTab = document.getElementById(`qdrantTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
        if (activeTab) {
            activeTab.classList.add('active');
        }

        // Show tab content
        const content = document.getElementById('qdrantTabContent');
        if (!content) return;

        switch (tabName) {
            case 'dashboard':
                content.innerHTML = generateDashboardContent();
                break;
            case 'collections':
                content.innerHTML = generateCollectionsContent();
                break;
            case 'validation':
                content.innerHTML = generateValidationContent();
                break;
            case 'analytics':
                content.innerHTML = generateAnalyticsContent();
                break;
            case 'management':
                content.innerHTML = generateManagementContent();
                break;
            default:
                content.innerHTML = '<div class="text-center py-8" style="color: var(--text-muted);">Tab not found</div>';
        }

        // Refresh Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function generateDashboardContent() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const comparisonData = calculateComparisonData(tenantPrefix);

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="qdrant-section-title">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
                        Vectorization Dashboard
                    </h3>
                    <div class="text-sm" style="color: var(--text-secondary);">
                        Tenant: ${tenantName}
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="qdrant-summary-grid">
                    <div class="qdrant-metric-card text-center">
                        <div class="text-3xl font-bold mb-2" style="color: var(--color-1);">${comparisonData.totalDatabase.toLocaleString()}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Total Records</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">In Database</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-3xl font-bold mb-2" style="color: var(--color-2);">${comparisonData.totalVectorized.toLocaleString()}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Vectorized</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">In Qdrant</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-3xl font-bold mb-2 ${comparisonData.overallCompletion >= 100 ? 'qdrant-status-healthy' : comparisonData.overallCompletion >= 80 ? 'qdrant-status-warning' : 'qdrant-status-error'}">${comparisonData.overallCompletion}%</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Completion</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">Overall Progress</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-3xl font-bold mb-2 ${comparisonData.missingRecords === 0 ? 'qdrant-status-healthy' : 'qdrant-status-error'}">${comparisonData.missingRecords.toLocaleString()}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Missing</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">Not Vectorized</div>
                    </div>
                </div>

                <!-- Entity Breakdown -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Entity Type Breakdown</h4>
                    <div class="space-y-4">
                        ${comparisonData.entities.map(entity => `
                            <div class="flex items-center justify-between p-3 rounded-lg" style="background-color: var(--bg-tertiary);">
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium" style="color: var(--text-primary);">${entity.name}</span>
                                        <span class="text-sm" style="color: var(--text-secondary);">${entity.completion}%</span>
                                    </div>
                                    <div class="qdrant-progress-bar">
                                        <div class="qdrant-progress-fill" style="width: ${entity.completion}%;"></div>
                                    </div>
                                    <div class="flex justify-between text-xs mt-1" style="color: var(--text-muted);">
                                        <span>DB: ${entity.database.toLocaleString()}</span>
                                        <span>Qdrant: ${entity.qdrant.toLocaleString()}</span>
                                        ${entity.queue > 0 ? `<span class="qdrant-status-warning">Queue: ${entity.queue}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="qdrant-detail-grid">
                    <div class="qdrant-metric-card">
                        <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Quick Actions</h4>
                        <div class="space-y-3">
                            ${comparisonData.missingRecords > 0 ? `
                                <button onclick="revectorizeAllMissing()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--color-1); color: white;">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    <span>Vectorize ${comparisonData.missingRecords} Missing Records</span>
                                </button>
                            ` : `
                                <div class="text-center py-4 text-sm qdrant-status-healthy">
                                    <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2"></i>
                                    All records are vectorized!
                                </div>
                            `}
                            <button onclick="showQdrantTab('validation')" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--color-2); color: white;">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>Run Validation Check</span>
                            </button>
                            <button onclick="showQdrantTab('management')" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--neutral-secondary); color: white;">
                                <i data-lucide="tool" class="w-4 h-4"></i>
                                <span>Management Tools</span>
                            </button>
                        </div>
                    </div>

                    <div class="qdrant-metric-card">
                        <h4 class="font-semibold mb-4" style="color: var(--text-primary);">System Health</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span style="color: var(--text-secondary);">Collections:</span>
                                <span class="font-medium" style="color: var(--text-primary);">${qdrantData.collections.length}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span style="color: var(--text-secondary);">Healthy Collections:</span>
                                <span class="font-medium qdrant-status-healthy">${comparisonData.healthyCollections}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span style="color: var(--text-secondary);">Qdrant Status:</span>
                                <span class="font-medium qdrant-status-healthy">Connected</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span style="color: var(--text-secondary);">Last Updated:</span>
                                <span class="font-medium" style="color: var(--text-primary);">${new Date().toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function generateCollectionsContent() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="qdrant-section-title">
                        <i data-lucide="layers" class="w-5 h-5 mr-2"></i>
                        Collections Overview
                    </h3>
                    <div class="text-sm" style="color: var(--text-secondary);">
                        ${tenantCollections.length} collections found
                    </div>
                </div>

                <div class="qdrant-detail-grid">
                    ${tenantCollections.map(collection => {
                        const details = collection.details || {};
                        const entityType = collection.name.replace(tenantPrefix, '');
                        const status = details.status || 'unknown';
                        const pointsCount = details.points_count || 0;
                        const vectorsCount = details.vectors_count || 0;
                        const vectorSize = details.config?.params?.vectors?.size || 'unknown';
                        const distance = details.config?.params?.vectors?.distance || 'unknown';

                        return `
                            <div class="qdrant-metric-card">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold" style="color: var(--text-primary);">${entityType}</h4>
                                        <div class="text-xs" style="color: var(--text-muted);">${collection.name}</div>
                                    </div>
                                    <div class="w-3 h-3 rounded-full ${status === 'green' ? 'bg-green-500' : status === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'}"></div>
                                </div>

                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span style="color: var(--text-secondary);">Points:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${pointsCount.toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span style="color: var(--text-secondary);">Vectors:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${vectorsCount.toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span style="color: var(--text-secondary);">Dimensions:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${vectorSize}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span style="color: var(--text-secondary);">Distance:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${distance}</span>
                                    </div>
                                </div>

                                <div class="mt-3 pt-3 border-t" style="border-color: var(--border-color);">
                                    <button onclick="showCollectionDetails('${collection.name}')" class="text-xs px-3 py-1 rounded" style="background-color: var(--color-1); color: white;">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                ${tenantCollections.length === 0 ? `
                    <div class="text-center py-8" style="color: var(--text-muted);">
                        <i data-lucide="database" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No collections found for tenant: ${tenantName}</p>
                        <p class="text-sm mt-2">Collections should be prefixed with: ${tenantPrefix}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }

    function generateValidationContent() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const validationResults = calculateValidationResults(tenantPrefix);

        return `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="qdrant-section-title">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        Data Validation
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full ${validationResults.overallHealth === 'healthy' ? 'bg-green-500' : 'bg-yellow-500'}"></div>
                        <span class="text-sm" style="color: var(--text-secondary);">${validationResults.overallHealth}</span>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="qdrant-summary-grid">
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold qdrant-status-healthy">${validationResults.syncedEntities}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Synced</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold qdrant-status-warning">${validationResults.outOfSyncEntities}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Out of Sync</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold qdrant-status-error">${validationResults.missingRecords}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Missing</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold" style="color: var(--text-primary);">${validationResults.orphanedRecords}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Orphaned</div>
                    </div>
                </div>

                <!-- Detailed Validation Results -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Entity Validation Details</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b" style="border-color: var(--border-color);">
                                    <th class="text-left py-2" style="color: var(--text-secondary);">Entity Type</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Database</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Qdrant</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Missing</th>
                                    <th class="text-right py-2" style="color: var(--text-secondary);">Orphaned</th>
                                    <th class="text-center py-2" style="color: var(--text-secondary);">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${validationResults.entities.map(entity => `
                                    <tr class="border-b" style="border-color: var(--border-color);">
                                        <td class="py-2 font-medium" style="color: var(--text-primary);">${entity.name}</td>
                                        <td class="py-2 text-right" style="color: var(--text-primary);">${entity.database.toLocaleString()}</td>
                                        <td class="py-2 text-right" style="color: var(--text-primary);">${entity.qdrant.toLocaleString()}</td>
                                        <td class="py-2 text-right ${entity.missing > 0 ? 'qdrant-status-error' : 'qdrant-status-healthy'}">${entity.missing.toLocaleString()}</td>
                                        <td class="py-2 text-right ${entity.orphaned > 0 ? 'qdrant-status-warning' : 'qdrant-status-healthy'}">${entity.orphaned.toLocaleString()}</td>
                                        <td class="py-2 text-center">
                                            <span class="px-2 py-1 rounded text-xs ${entity.status === 'synced' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${entity.status}</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                ${validationResults.outOfSyncEntities > 0 ? `
                    <div class="qdrant-metric-card">
                        <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Recommended Actions</h4>
                        <div class="space-y-2 text-sm">
                            ${validationResults.missingRecords > 0 ? `
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="alert-triangle" class="w-4 h-4 qdrant-status-warning"></i>
                                    <span style="color: var(--text-primary);">Re-vectorize ${validationResults.missingRecords} missing records</span>
                                    <button onclick="revectorizeAllMissing()" class="ml-auto text-xs px-2 py-1 rounded" style="background-color: var(--color-1); color: white;">Fix Now</button>
                                </div>
                            ` : ''}
                            ${validationResults.orphanedRecords > 0 ? `
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="trash-2" class="w-4 h-4 qdrant-status-error"></i>
                                    <span style="color: var(--text-primary);">Clean up ${validationResults.orphanedRecords} orphaned vectors</span>
                                    <button onclick="cleanupOrphanedVectors()" class="ml-auto text-xs px-2 py-1 rounded" style="background-color: var(--status-error); color: white;">Clean Up</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }

    function generateAnalyticsContent() {
        const analyticsData = calculateAnalyticsData();

        return `
            <div class="space-y-6">
                <h3 class="qdrant-section-title">
                    <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                    Analytics & Insights
                </h3>

                <!-- Performance Metrics -->
                <div class="qdrant-summary-grid">
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold" style="color: var(--color-1);">${analyticsData.totalVectors.toLocaleString()}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Total Vectors</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">Across all collections</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold" style="color: var(--color-2);">${analyticsData.avgVectorSize}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Avg Vector Size</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">Dimensions</div>
                    </div>
                    <div class="qdrant-metric-card text-center">
                        <div class="text-2xl font-bold" style="color: var(--status-success);">${analyticsData.storageUsage}</div>
                        <div class="text-sm" style="color: var(--text-secondary);">Est. Storage</div>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">Approximate</div>
                    </div>
                </div>

                <!-- Collection Distribution -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Collection Distribution</h4>
                    <div class="space-y-3">
                        ${analyticsData.collectionStats.map(stat => `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-4 h-4 rounded" style="background-color: ${stat.color};"></div>
                                    <span style="color: var(--text-primary);">${stat.name}</span>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium" style="color: var(--text-primary);">${stat.count.toLocaleString()}</div>
                                    <div class="text-xs" style="color: var(--text-muted);">${stat.percentage}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Queue Performance -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Vectorization Queue Status</h4>
                    ${qdrantData.queueData && qdrantData.queueData.summary ? `
                        <div class="qdrant-summary-grid text-center">
                            <div>
                                <div class="text-xl font-bold" style="color: var(--status-warning);">${qdrantData.queueData.summary.total_pending || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Pending</div>
                            </div>
                            <div>
                                <div class="text-xl font-bold" style="color: var(--color-2);">${qdrantData.queueData.summary.total_processing || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Processing</div>
                            </div>
                            <div>
                                <div class="text-xl font-bold" style="color: var(--status-success);">${qdrantData.queueData.summary.total_completed || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Completed</div>
                            </div>
                            <div>
                                <div class="text-xl font-bold" style="color: var(--status-error);">${qdrantData.queueData.summary.total_failed || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Failed</div>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-4" style="color: var(--text-muted);">
                            Queue data unavailable
                        </div>
                    `}
                </div>
            </div>
        `;
    }

    function generateManagementContent() {
        return `
            <div class="space-y-6">
                <h3 class="qdrant-section-title">
                    <i data-lucide="tool" class="w-5 h-5 mr-2"></i>
                    Management Tools
                </h3>

                <!-- Quick Actions -->
                <div class="qdrant-detail-grid">
                    <div class="qdrant-metric-card">
                        <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Vectorization Actions</h4>
                        <div class="space-y-3">
                            <button onclick="revectorizeAllMissing()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--color-1); color: white;">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Re-vectorize Missing Records</span>
                            </button>
                            <button onclick="revectorizeEntityType()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--color-2); color: white;">
                                <i data-lucide="layers" class="w-4 h-4"></i>
                                <span>Re-vectorize by Entity Type</span>
                            </button>
                            <button onclick="revectorizeByDateRange()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--neutral-primary); color: white;">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>Re-vectorize by Date Range</span>
                            </button>
                        </div>
                    </div>

                    <div class="qdrant-metric-card">
                        <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Cleanup Actions</h4>
                        <div class="space-y-3">
                            <button onclick="cleanupOrphanedVectors()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--status-warning); color: white;">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Clean Orphaned Vectors</span>
                            </button>
                            <button onclick="optimizeCollections()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--neutral-secondary); color: white;">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                <span>Optimize Collections</span>
                            </button>
                            <button onclick="exportVectorData()" class="w-full px-4 py-2 rounded flex items-center justify-center space-x-2" style="background-color: var(--neutral-tertiary); color: white;">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span>Export Vector Data</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">Bulk Operations</h4>
                    <div class="qdrant-detail-grid">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Entity Type</label>
                            <select id="bulkEntityType" class="w-full px-3 py-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                <option value="">All Types</option>
                                <option value="prs">Pull Requests</option>
                                <option value="prs_comments">PR Comments</option>
                                <option value="prs_reviews">PR Reviews</option>
                                <option value="prs_commits">PR Commits</option>
                                <option value="issues">Issues</option>
                                <option value="issues_comments">Issue Comments</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Date Range</label>
                            <input type="date" id="bulkDateFrom" class="w-full px-3 py-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">&nbsp;</label>
                            <input type="date" id="bulkDateTo" class="w-full px-3 py-2 rounded" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="executeBulkRevectorization()" class="px-4 py-2 rounded" style="background-color: var(--color-1); color: white;">
                            Execute Bulk Re-vectorization
                        </button>
                        <button onclick="previewBulkOperation()" class="px-4 py-2 rounded" style="background-color: var(--neutral-secondary); color: white;">
                            Preview Changes
                        </button>
                    </div>
                </div>

                <!-- System Information -->
                <div class="qdrant-metric-card">
                    <h4 class="font-semibold mb-4" style="color: var(--text-primary);">System Information</h4>
                    <div class="qdrant-summary-grid text-sm">
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Qdrant URL</div>
                            <div style="color: var(--text-primary);">${QDRANT_URL}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Collections</div>
                            <div style="color: var(--text-primary);">${qdrantData.collections.length}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Last Refresh</div>
                            <div style="color: var(--text-primary);">${new Date().toLocaleTimeString()}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Status</div>
                            <div class="qdrant-status-healthy">Connected</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ===== HELPER FUNCTIONS =====

    function getCurrentTenantName() {
        // Get tenant name from auth data or default
        try {
            const authData = JSON.parse(localStorage.getItem('authData') || '{}');
            return authData.tenant_name || 'wex';
        } catch {
            return 'wex';
        }
    }

    function calculateComparisonData(tenantPrefix) {
        const entities = [
            { key: 'prs', name: 'Pull Requests' },
            { key: 'prs_comments', name: 'PR Comments' },
            { key: 'prs_reviews', name: 'PR Reviews' },
            { key: 'prs_commits', name: 'PR Commits' },
            { key: 'issues', name: 'Issues' },
            { key: 'issues_comments', name: 'Issue Comments' }
        ];

        let totalDatabase = 0;
        let totalVectorized = 0;
        let healthyCollections = 0;
        const entityData = [];

        entities.forEach(entity => {
            const dbCount = qdrantData.databaseCounts[entity.key]?.total_count || 0;
            const collection = qdrantData.collections.find(c => c.name === tenantPrefix + entity.key);
            const qdrantCount = collection?.details?.points_count || 0;
            const queueCount = qdrantData.queueData?.by_entity_type?.[entity.key] || 0;

            const completion = dbCount > 0 ? Math.round((qdrantCount / dbCount) * 100) : 100;

            totalDatabase += dbCount;
            totalVectorized += qdrantCount;

            if (completion >= 100) healthyCollections++;

            entityData.push({
                name: entity.name,
                database: dbCount,
                qdrant: qdrantCount,
                queue: queueCount,
                completion: completion
            });
        });

        const overallCompletion = totalDatabase > 0 ? Math.round((totalVectorized / totalDatabase) * 100) : 100;
        const missingRecords = Math.max(0, totalDatabase - totalVectorized);

        return {
            entities: entityData,
            totalDatabase,
            totalVectorized,
            overallCompletion,
            healthyCollections,
            missingRecords
        };
    }

    function calculateValidationResults(tenantPrefix) {
        const comparisonData = calculateComparisonData(tenantPrefix);

        let syncedEntities = 0;
        let outOfSyncEntities = 0;
        let missingRecords = 0;
        let orphanedRecords = 0;

        const entityResults = comparisonData.entities.map(entity => {
            const missing = Math.max(0, entity.database - entity.qdrant);
            const orphaned = Math.max(0, entity.qdrant - entity.database);
            const status = missing === 0 && orphaned === 0 ? 'synced' : 'out_of_sync';

            if (status === 'synced') syncedEntities++;
            else outOfSyncEntities++;

            missingRecords += missing;
            orphanedRecords += orphaned;

            return {
                name: entity.name,
                database: entity.database,
                qdrant: entity.qdrant,
                missing,
                orphaned,
                status
            };
        });

        return {
            entities: entityResults,
            syncedEntities,
            outOfSyncEntities,
            missingRecords,
            orphanedRecords,
            overallHealth: outOfSyncEntities === 0 ? 'healthy' : 'needs_attention'
        };
    }

    function calculateAnalyticsData() {
        const tenantName = getCurrentTenantName();
        const tenantPrefix = tenantName ? tenantName.toLowerCase() + '_' : '';
        const tenantCollections = qdrantData.collections.filter(c => c.name.startsWith(tenantPrefix));

        let totalVectors = 0;
        let totalDimensions = 0;
        let collectionCount = 0;

        const collectionStats = tenantCollections.map((collection, index) => {
            const details = collection.details || {};
            const pointsCount = details.points_count || 0;
            const vectorSize = details.config?.params?.vectors?.size || 0;

            totalVectors += pointsCount;
            if (vectorSize > 0) {
                totalDimensions += vectorSize;
                collectionCount++;
            }

            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];

            return {
                name: collection.name.replace(tenantPrefix, ''),
                count: pointsCount,
                percentage: 0, // Will be calculated after total is known
                color: colors[index % colors.length]
            };
        });

        // Calculate percentages
        collectionStats.forEach(stat => {
            stat.percentage = totalVectors > 0 ? Math.round((stat.count / totalVectors) * 100) : 0;
        });

        const avgVectorSize = collectionCount > 0 ? Math.round(totalDimensions / collectionCount) : 0;
        const estimatedStorageBytes = totalVectors * avgVectorSize * 4; // 4 bytes per float
        const storageUsage = formatBytes(estimatedStorageBytes);

        return {
            totalVectors,
            avgVectorSize,
            storageUsage,
            collectionStats: collectionStats.sort((a, b) => b.count - a.count)
        };
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showQdrantError(message) {
        const content = document.getElementById('qdrantTabContent');
        if (content) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-4 text-red-500"></i>
                    <p class="text-lg font-medium mb-2" style="color: var(--text-primary);">Qdrant Connection Error</p>
                    <p style="color: var(--text-secondary);">${message}</p>
                    <button onclick="refreshQdrantAnalysis()" class="mt-4 px-4 py-2 rounded" style="background-color: var(--color-1); color: white;">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Retry Connection
                    </button>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    }

    // ===== MANAGEMENT ACTION FUNCTIONS =====

    async function revectorizeAllMissing() {
        if (!confirm('This will queue all missing records for re-vectorization. Continue?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/missing', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing missing records:', error);
            showNotification('Failed to queue missing records for re-vectorization', 'error');
        }
    }

    async function revectorizeEntityType() {
        const entityType = prompt('Enter entity type to re-vectorize (prs, prs_comments, prs_reviews, prs_commits, issues, issues_comments):');
        if (!entityType) return;

        if (!confirm(`This will re-vectorize all ${entityType} records. Continue?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/entity-type', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ entity_type: entityType })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} ${entityType} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing entity type:', error);
            showNotification(`Failed to queue ${entityType} records for re-vectorization`, 'error');
        }
    }

    async function revectorizeByDateRange() {
        const fromDate = prompt('Enter start date (YYYY-MM-DD):');
        if (!fromDate) return;

        const toDate = prompt('Enter end date (YYYY-MM-DD):');
        if (!toDate) return;

        if (!confirm(`This will re-vectorize all records from ${fromDate} to ${toDate}. Continue?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/date-range', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    from_date: fromDate,
                    to_date: toDate
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error queueing date range:', error);
            showNotification('Failed to queue records by date range for re-vectorization', 'error');
        }
    }

    async function cleanupOrphanedVectors() {
        if (!confirm('This will remove vectors that no longer have corresponding database records. This action cannot be undone. Continue?')) return;

        try {
            showNotification('Orphaned vector cleanup is not yet implemented', 'warning');
            // TODO: Implement orphaned vector cleanup
            // This would require comparing Qdrant vectors with database records
            // and removing vectors that don't have corresponding DB entries
        } catch (error) {
            console.error('Error cleaning orphaned vectors:', error);
            showNotification('Failed to clean orphaned vectors', 'error');
        }
    }

    async function optimizeCollections() {
        if (!confirm('This will optimize all Qdrant collections. This may take some time. Continue?')) return;

        try {
            showNotification('Collection optimization is not yet implemented', 'warning');
            // TODO: Implement collection optimization
            // This would call Qdrant's optimize endpoint for each collection
        } catch (error) {
            console.error('Error optimizing collections:', error);
            showNotification('Failed to optimize collections', 'error');
        }
    }

    async function exportVectorData() {
        try {
            showNotification('Vector data export is not yet implemented', 'warning');
            // TODO: Implement vector data export
            // This would export vector data in a standard format
        } catch (error) {
            console.error('Error exporting vector data:', error);
            showNotification('Failed to export vector data', 'error');
        }
    }

    async function executeBulkRevectorization() {
        const entityType = document.getElementById('bulkEntityType')?.value;
        const dateFrom = document.getElementById('bulkDateFrom')?.value;
        const dateTo = document.getElementById('bulkDateTo')?.value;

        if (!confirm('Execute bulk re-vectorization with the specified parameters?')) return;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/bulk', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_type: entityType || null,
                    from_date: dateFrom || null,
                    to_date: dateTo || null
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Queued ${result.queued_count || 0} records for bulk re-vectorization`, 'success');
                await refreshQdrantAnalysis();
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error executing bulk re-vectorization:', error);
            showNotification('Failed to execute bulk re-vectorization', 'error');
        }
    }

    async function previewBulkOperation() {
        const entityType = document.getElementById('bulkEntityType')?.value;
        const dateFrom = document.getElementById('bulkDateFrom')?.value;
        const dateTo = document.getElementById('bulkDateTo')?.value;

        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/vectorization/queue/bulk/preview', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    entity_type: entityType || null,
                    from_date: dateFrom || null,
                    to_date: dateTo || null
                })
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`Preview: ${result.estimated_count || 0} records would be queued for re-vectorization`, 'info');
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('Error previewing bulk operation:', error);
            showNotification('Failed to preview bulk operation', 'error');
        }
    }

    async function showCollectionDetails(collectionName) {
        try {
            const collection = qdrantData.collections.find(c => c.name === collectionName);
            if (!collection) {
                showNotification('Collection not found', 'error');
                return;
            }

            const details = collection.details || {};
            const detailsHtml = `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold" style="color: var(--text-primary);">Collection: ${collectionName}</h4>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Status</div>
                            <div style="color: var(--text-primary);">${details.status || 'unknown'}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Points Count</div>
                            <div style="color: var(--text-primary);">${(details.points_count || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Vectors Count</div>
                            <div style="color: var(--text-primary);">${(details.vectors_count || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Indexed Vectors</div>
                            <div style="color: var(--text-primary);">${(details.indexed_vectors_count || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Vector Size</div>
                            <div style="color: var(--text-primary);">${details.config?.params?.vectors?.size || 'unknown'}</div>
                        </div>
                        <div>
                            <div class="font-medium" style="color: var(--text-secondary);">Distance Metric</div>
                            <div style="color: var(--text-primary);">${details.config?.params?.vectors?.distance || 'unknown'}</div>
                        </div>
                    </div>

                    ${details.config ? `
                        <div>
                            <div class="font-medium mb-2" style="color: var(--text-secondary);">Configuration</div>
                            <pre class="text-xs p-3 rounded" style="background-color: var(--bg-tertiary); color: var(--text-primary); overflow-x: auto;">${JSON.stringify(details.config, null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `;

            showNotification(`Collection Details: ${collectionName}`, 'info', detailsHtml);
        } catch (error) {
            console.error('Error showing collection details:', error);
            showNotification('Failed to load collection details', 'error');
        }
    }

    // ===== UTILITY FUNCTIONS =====

    function getAuthToken() {
        // Try to get token from localStorage first
        try {
            const authData = JSON.parse(localStorage.getItem('authData') || '{}');
            if (authData.token) {
                return authData.token;
            }
        } catch (e) {
            console.warn('Failed to parse auth data from localStorage');
        }

        // Fallback to cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'pulse_token') {
                return value;
            }
        }

        return null;
    }

    function showNotification(message, type = 'info', htmlContent = null) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full`;

        // Set background color based on type
        switch (type) {
            case 'success':
                notification.style.backgroundColor = 'var(--status-success)';
                notification.style.color = 'white';
                break;
            case 'error':
                notification.style.backgroundColor = 'var(--status-error)';
                notification.style.color = 'white';
                break;
            case 'warning':
                notification.style.backgroundColor = 'var(--status-warning)';
                notification.style.color = 'white';
                break;
            default:
                notification.style.backgroundColor = 'var(--color-1)';
                notification.style.color = 'white';
        }

        // Set content
        if (htmlContent) {
            notification.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <strong>${message}</strong>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="text-sm">${htmlContent}</div>
            `;
        } else {
            notification.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        // Add to page
        document.body.appendChild(notification);

        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto-remove after 5 seconds (unless it has HTML content)
        if (!htmlContent) {
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    }

    // ===== END QDRANT ANALYSIS FUNCTIONS =====
</script>

{% endblock %}
