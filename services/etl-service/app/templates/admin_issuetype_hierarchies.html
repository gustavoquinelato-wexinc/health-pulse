<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Type Hierarchies - Pulse Platform Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        /* Sortable column styles */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }

        .sortable.sort-asc i:before {
            content: "\f0de";
            opacity: 1;
        }

        .sortable.sort-desc i:before {
            content: "\f0dd";
            opacity: 1;
        }

        /* Hierarchy level colors */
        .hierarchy-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .hierarchy-4 {
            background-color: #dc3545;
            color: white;
        }

        .hierarchy-3 {
            background-color: #e91e63;
            color: white;
        }

        .hierarchy-2 {
            background-color: #9c27b0;
            color: white;
        }

        .hierarchy-1 {
            background-color: #ff9800;
            color: white;
        }

        .hierarchy-0 {
            background-color: #4caf50;
            color: white;
        }

        .hierarchy--1 {
            background-color: #2196f3;
            color: white;
        }

        .hierarchy-other {
            background-color: #6c757d;
            color: white;
        }




    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Pulse ETL
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-chart-line me-1"></i>Dashboard
                    </a>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                            <li><a class="dropdown-item" href="/admin">
                                <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/admin/issuetype-mappings">
                                <i class="fas fa-sitemap me-2"></i>Issue Type Mappings
                            </a></li>
                            <li><a class="dropdown-item active" href="/admin/issuetype-hierarchies">
                                <i class="fas fa-layer-group me-2"></i>Issue Type Hierarchies
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/admin/workflows">
                                <i class="fas fa-stream me-2"></i>Workflows
                            </a></li>
                            <li><a class="dropdown-item" href="/admin/status-mappings">
                                <i class="fas fa-exchange-alt me-2"></i>Status Mappings
                            </a></li>
                        </ul>
                    </div>
                    <a class="nav-link" href="/logout">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0">
                        <i class="fas fa-layer-group me-3"></i>Issue Type Hierarchies Management
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage hierarchy levels and their properties</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Issue Type Hierarchies Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Issue Type Hierarchies
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshIssuetypeHierarchies()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showCreateHierarchyModal()">
                                    <i class="fas fa-plus"></i> Add Hierarchy
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filters -->
                        <div class="row mb-3">
                            <div class="col-lg-4 col-md-5">
                                <label for="searchHierarchy" class="form-label text-dark fw-bold">Search Issue Type Hierarchies</label>
                                <input type="text" class="form-control" id="searchHierarchy" placeholder="Search hierarchies..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-lg-3 col-md-3">
                                <label for="filterLevel" class="form-label text-dark fw-bold">Hierarchy Level</label>
                                <select class="form-select" id="filterLevel" onchange="applyFilters()">
                                    <option value="">All Levels</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-3">
                                <label for="filterIntegration" class="form-label text-dark fw-bold">Integration</label>
                                <select class="form-select" id="filterIntegration" onchange="applyFilters()">
                                    <option value="">All Integrations</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterActive" class="form-label text-dark fw-bold">Status</label>
                                <select class="form-select" id="filterActive" onchange="applyFilters()">
                                    <option value="">All Statuses</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" onclick="sortTable('level_name')">
                                            Hierarchy Name <i class="fas fa-sort" id="sort-level_name"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('level_number')">
                                            Level # <i class="fas fa-sort" id="sort-level_number"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('description')">
                                            Description <i class="fas fa-sort" id="sort-description"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('integration_name')">
                                            Integration <i class="fas fa-sort" id="sort-integration_name"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('active')">
                                            Status <i class="fas fa-sort" id="sort-active"></i>
                                        </th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hierarchies-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading hierarchies...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Create/Edit Hierarchy Modal -->
    <div class="modal fade" id="hierarchyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hierarchyModalTitle">Add Hierarchy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="hierarchyForm">
                    <div class="modal-body">
                        <input type="hidden" id="editHierarchyId">
                        
                        <div class="mb-3">
                            <label for="levelName" class="form-label">Level Name</label>
                            <input type="text" class="form-control" id="levelName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="levelNumber" class="form-label">Level Number</label>
                            <input type="number" class="form-control" id="levelNumber" required>
                            <div class="form-text text-muted">
                                Higher numbers = higher in hierarchy (e.g., 4=Theme, 1=Epic, 0=Story, -1=Sub-task)
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3" placeholder="Optional description"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="integration" class="form-label">Integration</label>
                            <select class="form-control" id="integration">
                                <option value="">Select Integration</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Hierarchy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deactivation Modal -->
    <div class="modal fade" id="deactivationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate Issue Type Hierarchy
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="deactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmDeactivationBtn" onclick="confirmDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let issuetypeHierarchies = [];
        let filteredHierarchies = [];
        let integrations = [];
        let editingHierarchyId = null;
        let currentSort = { column: 'level_name', direction: 'asc' };

        // Load integrations
        async function loadIntegrations() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/integrations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    integrations = await response.json();
                    populateIntegrationDropdown();
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
            }
        }

        function populateIntegrationDropdown() {
            const integrationSelect = document.getElementById('integration');
            const filterSelect = document.getElementById('filterIntegration');

            integrationSelect.innerHTML = '<option value="">Select Integration</option>';
            filterSelect.innerHTML = '<option value="">All Integrations</option>';

            integrations.forEach(integration => {
                if (integration.active) {
                    const option = new Option(integration.name, integration.id);
                    const filterOption = new Option(integration.name, integration.name);
                    integrationSelect.appendChild(option);
                    filterSelect.appendChild(filterOption);
                }
            });
        }

        // Get integration icon and color
        function getIntegrationIcon(integrationName) {
            if (!integrationName) return '<i class="fas fa-plug text-secondary"></i>';

            const name = integrationName.toUpperCase();
            let icon = 'fas fa-plug';
            let iconColor = 'text-secondary';

            if (name === 'GITHUB') {
                icon = 'fab fa-github';
                iconColor = 'text-dark';
            } else if (name === 'JIRA') {
                icon = 'fab fa-atlassian';
                iconColor = 'text-primary';
            } else if (name === 'AHA!') {
                icon = 'fas fa-lightbulb';
                iconColor = 'text-warning';
            } else if (name === 'AZURE DEVOPS') {
                icon = 'fab fa-microsoft';
                iconColor = 'text-info';
            }

            return `<i class="${icon} ${iconColor}"></i>`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadIssuetypeHierarchies();
            loadIntegrations();
            updateSortIndicators();
        });

        // Get authentication token from cookie
        function getAuthToken() {
            // Try localStorage first (for compatibility)
            let token = localStorage.getItem('pulse_token') || localStorage.getItem('token');

            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'pulse_token' || name === 'access_token') {
                        token = value;
                        break;
                    }
                }
            }

            return token;
        }

        // Refresh function (alias for load)
        function refreshIssuetypeHierarchies() {
            loadIssuetypeHierarchies();
        }

        // Load issuetype hierarchies
        async function loadIssuetypeHierarchies() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/issuetype-hierarchies', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    issuetypeHierarchies = await response.json();
                    filteredHierarchies = [...issuetypeHierarchies]; // Initialize filtered data
                    updateLevelFilter();
                    updateHierarchiesDisplay();
                } else {
                    console.error('Failed to load issuetype hierarchies');
                    document.getElementById('hierarchies-table-body').innerHTML = `
                        <tr><td colspan="4" class="text-center text-danger">Failed to load hierarchies</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading issuetype hierarchies:', error);
                document.getElementById('hierarchies-table-body').innerHTML = `
                    <tr><td colspan="4" class="text-center text-danger">Error loading hierarchies</td></tr>
                `;
            }
        }



        // Update level filter dropdown
        function updateLevelFilter() {
            const filterLevel = document.getElementById('filterLevel');
            const currentValue = filterLevel.value;

            // Clear existing options except "All Levels"
            filterLevel.innerHTML = '<option value="">All Levels</option>';

            // Get unique levels and sort them
            const levels = [...new Set(issuetypeHierarchies.map(h => h.level_number))].sort((a, b) => a - b);

            levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `Level ${level}`;
                filterLevel.appendChild(option);
            });

            // Restore previous selection if it still exists
            if (currentValue && levels.includes(parseInt(currentValue))) {
                filterLevel.value = currentValue;
            }
        }

        function getHierarchyColorClass(level) {
            switch(level) {
                case 4: return 'hierarchy-4';   // Level 4 - Red
                case 3: return 'hierarchy-3';   // Level 3 - Pink
                case 2: return 'hierarchy-2';   // Level 2 - Purple
                case 1: return 'hierarchy-1';   // Level 1 - Orange
                case 0: return 'hierarchy-0';   // Level 0 - Green
                case -1: return 'hierarchy--1'; // Level -1 - Blue
                default: return 'hierarchy-other'; // Other levels - Gray
            }
        }

        // Update hierarchies display
        function updateHierarchiesDisplay() {
            const tbody = document.getElementById('hierarchies-table-body');
            tbody.innerHTML = '';

            if (!filteredHierarchies || filteredHierarchies.length === 0) {
                const message = issuetypeHierarchies.length === 0 ? 'No hierarchies found' : 'No hierarchies match the current filters';
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">${message}</td></tr>
                `;
                return;
            }

            filteredHierarchies.forEach(hierarchy => {
                const row = document.createElement('tr');

                // Add inactive row styling if needed
                if (!hierarchy.active) {
                    row.classList.add('table-secondary', 'text-muted');
                }

                // Get hierarchy color class
                const hierarchyClass = getHierarchyColorClass(hierarchy.level_number);

                const statusBadge = hierarchy.active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';

                const actionButton = hierarchy.active
                    ? `<button class="btn btn-sm btn-outline-warning me-1" onclick="showDeactivationModal(${hierarchy.id})" title="Deactivate">
                        <i class="fas fa-pause"></i>
                       </button>`
                    : `<button class="btn btn-sm btn-outline-success me-1" onclick="activateHierarchy(${hierarchy.id})" title="Activate">
                        <i class="fas fa-play"></i>
                       </button>`;

                row.innerHTML = `
                    <td><span class="hierarchy-badge ${hierarchyClass}">${hierarchy.level_name}</span></td>
                    <td>${hierarchy.level_number}</td>
                    <td>${hierarchy.description || '<em class="text-muted">No description</em>'}</td>
                    <td class="text-center">${getIntegrationIcon(hierarchy.integration_name)}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editHierarchy(${hierarchy.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${actionButton}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHierarchy(${hierarchy.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filtering functionality
        function applyFilters() {
            const searchTerm = document.getElementById('searchHierarchy').value.toLowerCase();
            const filterActive = document.getElementById('filterActive').value;
            const filterLevel = document.getElementById('filterLevel').value;
            const filterIntegration = document.getElementById('filterIntegration').value;

            filteredHierarchies = issuetypeHierarchies.filter(hierarchy => {
                const matchesSearch = !searchTerm ||
                    hierarchy.level_name.toLowerCase().includes(searchTerm) ||
                    (hierarchy.description && hierarchy.description.toLowerCase().includes(searchTerm)) ||
                    hierarchy.level_number.toString().includes(searchTerm);

                let matchesActive = true;
                if (filterActive === 'true') {
                    matchesActive = hierarchy.active === true;
                } else if (filterActive === 'false') {
                    matchesActive = hierarchy.active === false;
                }

                let matchesLevel = true;
                if (filterLevel) {
                    matchesLevel = hierarchy.level_number.toString() === filterLevel;
                }

                const matchesIntegration = !filterIntegration ||
                    hierarchy.integration_name === filterIntegration;

                return matchesSearch && matchesActive && matchesLevel && matchesIntegration;
            });

            // Re-apply current sort to filtered data
            if (currentSort.column) {
                sortTable(currentSort.column);
            } else {
                updateHierarchiesDisplay();
            }
        }

        // Sorting functionality
        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Sort the filtered data
            filteredHierarchies.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle numeric sorting for level_number
                if (column === 'level_number') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                }

                // Handle null/undefined values
                if (aVal == null) aVal = '';
                if (bVal == null) bVal = '';

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            updateSortIndicators();
            updateHierarchiesDisplay();
        }

        function updateSortIndicators() {
            // Reset all sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Set current sort indicator
            if (currentSort.column) {
                const currentTh = document.querySelector(`#sort-${currentSort.column}`);
                if (currentTh) {
                    currentTh.parentElement.classList.add(`sort-${currentSort.direction}`);
                }
            }
        }

        // Show create hierarchy modal
        function showCreateHierarchyModal() {
            editingHierarchyId = null;
            document.getElementById('hierarchyModalTitle').textContent = 'Add Hierarchy';
            document.getElementById('hierarchyForm').reset();

            // Populate integration dropdown
            populateIntegrationDropdown();

            new bootstrap.Modal(document.getElementById('hierarchyModal')).show();
        }

        // Edit hierarchy
        async function editHierarchy(id) {
            const hierarchy = issuetypeHierarchies.find(h => h.id === id);
            if (!hierarchy) {
                alert('Hierarchy not found');
                return;
            }

            editingHierarchyId = id;
            document.getElementById('hierarchyModalTitle').textContent = 'Edit Hierarchy';
            document.getElementById('editHierarchyId').value = id;
            document.getElementById('levelName').value = hierarchy.level_name;
            document.getElementById('levelNumber').value = hierarchy.level_number;
            document.getElementById('description').value = hierarchy.description || '';
            document.getElementById('integration').value = hierarchy.integration_id || '';

            new bootstrap.Modal(document.getElementById('hierarchyModal')).show();
        }

        // Delete hierarchy
        async function deleteHierarchy(id) {
            // First check if this hierarchy has dependencies
            try {
                const token = getAuthToken();
                if (!token) return;

                // Check dependencies first
                const depResponse = await fetch(`/api/v1/admin/issuetype-hierarchies/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (depResponse.ok) {
                    const depData = await depResponse.json();

                    if (!depData.has_dependencies) {
                        // Safe to delete - confirm with user
                        const hierarchy = issuetypeHierarchies.find(h => h.id === id);
                        if (confirm(`Are you sure you want to permanently delete the hierarchy "${hierarchy.level_name}" (Level ${hierarchy.level_number})?\n\nThis action cannot be undone.`)) {
                            await performDelete(id);
                        }
                        return;
                    }
                }

                // Has dependencies - open deactivation modal with delete context
                await showDeactivationModal(id, true); // true indicates delete context
            } catch (error) {
                console.error('Error checking dependencies:', error);
                // Fallback to modal
                await showDeactivationModal(id, true);
            }
        }

        // Deactivation modal functionality
        let currentDeactivationHierarchyId = null;
        let isDeleteContext = false;

        async function showDeactivationModal(id, deleteContext = false) {
            isDeleteContext = deleteContext;
            try {
                const token = getAuthToken();
                if (!token) return;

                currentDeactivationHierarchyId = id;
                const hierarchy = issuetypeHierarchies.find(h => h.id === id);

                // Show loading state first
                document.getElementById('deactivationContent').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>Checking dependencies...
                    </div>
                `;

                // Update modal title and button based on context
                const modalTitle = document.querySelector('#deactivationModal .modal-title');
                const confirmButton = document.getElementById('confirmDeactivationBtn');

                if (isDeleteContext) {
                    modalTitle.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Issue Type Hierarchy';
                    confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                    confirmButton.className = 'btn btn-danger';
                } else {
                    modalTitle.innerHTML = '<i class="fas fa-pause me-2"></i>Deactivate Issue Type Hierarchy';
                    confirmButton.innerHTML = '<i class="fas fa-pause me-1"></i>Deactivate';
                    confirmButton.className = 'btn btn-warning';
                }

                new bootstrap.Modal(document.getElementById('deactivationModal')).show();

                // Check for dependencies
                const response = await fetch(`/api/v1/admin/issuetype-hierarchies/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    const contextMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Issue Type Hierarchy:</strong> ${hierarchy.level_name} (Level ${hierarchy.level_number})
                           </div>`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Issue Type Hierarchy:</strong> ${hierarchy.level_name} (Level ${hierarchy.level_number})
                           </div>`;

                    let content = contextMessage;

                    if (data.has_dependencies) {
                        content += `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Impact:</strong> This hierarchy has active dependencies:
                            </div>
                            <ul class="mb-3">
                        `;

                        if (data.dependent_mappings_count > 0) {
                            content += `<li><strong>${data.dependent_mappings_count}</strong> active issue type mapping(s) using this hierarchy</li>`;
                        }

                        if (data.dependent_issues_count > 0) {
                            content += `<li><strong>${data.dependent_issues_count}</strong> active issue(s) connected through these mappings</li>`;
                        }

                        content += `
                            </ul>
                            <h6 class="mb-3">${isDeleteContext
                                ? 'Reassign dependencies before deletion:'
                                : 'Choose how to handle dependent mappings:'}</h6>
                            ${isDeleteContext
                                ? '<p class="text-muted mb-3">To delete this hierarchy, all dependent mappings must be reassigned to another active hierarchy.</p>'
                                : ''}

                            ${data.reassignment_targets.length > 0 ? `
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="deactivationAction" id="reassignMappings" value="reassign_mappings" checked>
                                <label class="form-check-label" for="reassignMappings">
                                    <strong>Reassign mappings to another hierarchy</strong> ${isDeleteContext ? '(required for deletion)' : '(recommended)'}
                                    <div class="mt-2">
                                        <select class="form-select" id="targetHierarchy">
                                            <option value="">Select target hierarchy...</option>
                                            ${data.reassignment_targets.map(target =>
                                                `<option value="${target.id}">${target.level_name} (Level ${target.level_number}) - Active</option>`
                                            ).join('')}
                                        </select>
                                        <small class="text-muted">Only active hierarchies are shown as reassignment targets.</small>
                                    </div>
                                </label>
                            </div>
                            ` : `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Cannot ${isDeleteContext ? 'delete' : 'deactivate'}:</strong> No other active hierarchies available for reassignment.
                            </div>
                            <p>You must have at least one other active hierarchy to reassign the dependent mappings before ${isDeleteContext ? 'deletion' : 'deactivation'} can proceed.</p>
                            <p><strong>Options:</strong></p>
                            <ul>
                                <li>Create a new hierarchy first, then try again</li>
                                <li>Activate an existing inactive hierarchy, then try again</li>
                            </ul>
                            <input type="hidden" name="deactivationAction" value="blocked">
                            `}

                            ${!isDeleteContext ? `
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="deactivationAction" id="keepMappings" value="keep_mappings">
                                <label class="form-check-label" for="keepMappings">
                                    <strong>Keep mappings active</strong> (they will reference this inactive hierarchy)
                                    <small class="d-block text-muted mt-1">Mappings will continue to work but may cause data inconsistencies</small>
                                </label>
                            </div>
                            ` : ''}
                        `;
                    } else {
                        if (isDeleteContext) {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to delete:</strong> No active mappings or issues are using this hierarchy.
                                </div>
                                <p>This hierarchy can be safely deleted without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="safe_delete">
                            `;
                        } else {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to deactivate:</strong> No active mappings or issues are using this hierarchy.
                                </div>
                                <p>This hierarchy can be safely deactivated without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="keep_mappings">
                            `;
                        }
                    }

                    document.getElementById('deactivationContent').innerHTML = content;

                    // Disable confirmation button if action is blocked
                    const confirmButton = document.getElementById('confirmDeactivationBtn');
                    if (data.has_dependencies && data.reassignment_targets.length === 0) {
                        confirmButton.disabled = true;
                        confirmButton.innerHTML = '<i class="fas fa-ban me-1"></i>Cannot Proceed';
                        confirmButton.className = 'btn btn-secondary';
                    } else {
                        confirmButton.disabled = false;
                        if (isDeleteContext) {
                            confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                            confirmButton.className = 'btn btn-danger';
                        } else {
                            confirmButton.innerHTML = '<i class="fas fa-pause me-1"></i>Deactivate';
                            confirmButton.className = 'btn btn-warning';
                        }
                    }
                } else {
                    // Fallback to simple modal if dependencies check fails
                    const fallbackMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Issue Type Hierarchy:</strong> ${hierarchy.level_name} (Level ${hierarchy.level_number})
                           </div>
                           <p>Unable to check dependencies. This hierarchy will be deleted.</p>
                           <input type="hidden" name="deactivationAction" value="safe_delete">`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Issue Type Hierarchy:</strong> ${hierarchy.level_name} (Level ${hierarchy.level_number})
                           </div>
                           <p>This hierarchy will be deactivated and excluded from future processing.</p>
                           <input type="hidden" name="deactivationAction" value="keep_mappings">`;

                    document.getElementById('deactivationContent').innerHTML = fallbackMessage;
                }
            } catch (error) {
                console.error('Error showing deactivation modal:', error);
                alert('Error showing deactivation modal');
            }
        }

        async function confirmDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                // Get selected action
                const selectedAction = document.querySelector('input[name="deactivationAction"]:checked')?.value || 'keep_mappings';

                let targetHierarchyId = null;
                if (selectedAction === 'reassign_mappings') {
                    targetHierarchyId = document.getElementById('targetHierarchy')?.value;
                    if (!targetHierarchyId) {
                        alert('Please select a target hierarchy for reassignment');
                        return;
                    }

                    // Additional validation: ensure target is not the same as current hierarchy
                    if (parseInt(targetHierarchyId) === currentDeactivationHierarchyId) {
                        alert('Cannot reassign to the same hierarchy. Please select a different target.');
                        return;
                    }
                }

                // For delete context: handle both safe delete and reassignment
                if (isDeleteContext) {
                    if (selectedAction === 'safe_delete') {
                        // Safe to delete directly - no dependencies
                        await performDelete(currentDeactivationHierarchyId);
                        return;
                    }

                    if (selectedAction === 'blocked') {
                        alert('Cannot proceed: No other active hierarchies available for reassignment. Please create or activate another hierarchy first.');
                        return;
                    }

                    // Force reassignment for delete context with dependencies
                    if (selectedAction !== 'reassign_mappings') {
                        alert('Reassignment is required for deletion');
                        return;
                    }

                    // Validate target selection
                    const targetSelect = document.getElementById('targetHierarchy');
                    if (!targetSelect) {
                        alert('Cannot delete: No reassignment targets available.');
                        return;
                    }

                    // Step 1: Reassign dependencies
                    const reassignBody = {
                        action: 'reassign_mappings',
                        target_hierarchy_id: parseInt(targetHierarchyId)
                    };

                    const reassignResponse = await fetch(`/api/v1/admin/issuetype-hierarchies/${currentDeactivationHierarchyId}/deactivate`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reassignBody)
                    });

                    if (!reassignResponse.ok) {
                        const error = await reassignResponse.json();
                        alert(`Failed to reassign dependencies: ${error.detail}`);
                        return;
                    }

                    // Step 2: Now delete the hierarchy (should be safe now)
                    const deleteResponse = await fetch(`/api/v1/admin/issuetype-hierarchies/${currentDeactivationHierarchyId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        alert(`Dependencies reassigned and hierarchy deleted successfully`);
                        bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                        loadIssuetypeHierarchies();
                    } else {
                        const error = await deleteResponse.json();
                        alert(`Dependencies reassigned but failed to delete hierarchy: ${error.detail}`);
                    }
                    return;
                }

                // For deactivate context, use deactivate API
                const requestBody = {
                    action: selectedAction,
                    target_hierarchy_id: targetHierarchyId ? parseInt(targetHierarchyId) : null
                };

                const response = await fetch(`/api/v1/admin/issuetype-hierarchies/${currentDeactivationHierarchyId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Issue type hierarchy deactivated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                    loadIssuetypeHierarchies();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate hierarchy: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deactivating hierarchy:', error);
                alert('Error deactivating hierarchy');
            }
        }

        async function activateHierarchy(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/issuetype-hierarchies/${id}/activate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Issue type hierarchy activated successfully');
                    loadIssuetypeHierarchies();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate hierarchy: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating hierarchy:', error);
                alert('Error activating hierarchy');
            }
        }

        async function performDelete(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/issuetype-hierarchies/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Issue type hierarchy deleted successfully');
                    // Close modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deactivationModal'));
                    if (modal) modal.hide();
                    loadIssuetypeHierarchies();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete hierarchy: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting hierarchy:', error);
                alert('Error deleting hierarchy');
            }
        }

        // Handle form submission
        document.getElementById('hierarchyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const levelName = document.getElementById('levelName').value;
            const levelNumber = parseInt(document.getElementById('levelNumber').value);
            const description = document.getElementById('description').value;
            const integrationId = document.getElementById('integration').value;

            if (!levelName || isNaN(levelNumber)) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) return;

                const data = {
                    level_name: levelName,
                    level_number: levelNumber,
                    description: description || null,
                    integration_id: integrationId || null
                };

                let response;
                if (editingHierarchyId) {
                    // Update existing hierarchy
                    response = await fetch(`/api/v1/admin/issuetype-hierarchies/${editingHierarchyId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new hierarchy
                    response = await fetch('/api/v1/admin/issuetype-hierarchies', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    // Close modal and refresh data
                    bootstrap.Modal.getInstance(document.getElementById('hierarchyModal')).hide();
                    loadIssuetypeHierarchies();
                    alert(editingHierarchyId ? 'Hierarchy updated successfully' : 'Hierarchy created successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed to ${editingHierarchyId ? 'update' : 'create'} hierarchy: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(`Error ${editingHierarchyId ? 'updating' : 'creating'} hierarchy:`, error);
                alert(`Error ${editingHierarchyId ? 'updating' : 'creating'} hierarchy`);
            }
        });
    </script>
</body>
</html>
