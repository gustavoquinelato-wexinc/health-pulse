<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse ETL - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="gradient-bg min-h-screen flex items-center justify-center">
    <div class="glass-effect rounded-2xl p-8 w-full max-w-md shadow-2xl">
        <!-- Logo and Title -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-white bg-opacity-20 rounded-full mb-4">
                <i class="fas fa-database text-2xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Pulse ETL</h1>
            <p class="text-white text-opacity-80">Data Pipeline Management</p>
            <div class="mt-4 p-3 bg-blue-500 bg-opacity-20 border border-blue-500 border-opacity-50 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-300 mr-2"></i>
                    <span class="text-blue-100 text-sm">Authentication powered by centralized Backend Service.</span>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage"
            class="hidden mb-4 p-3 bg-red-500 bg-opacity-20 border border-red-500 border-opacity-50 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-300 mr-2"></i>
                <span id="errorText" class="text-red-100 text-sm"></span>
            </div>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-white mb-2">
                    <i class="fas fa-user mr-2"></i>Username
                </label>
                <input type="text" id="email" name="email"
                    class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 focus:border-transparent"
                    placeholder="Enter email (gustavo.quinelato@wexinc.com)" autocomplete="username" required>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-white mb-2">
                    <i class="fas fa-lock mr-2"></i>Password
                </label>
                <input type="password" id="password" name="password"
                    class="w-full px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 focus:border-transparent"
                    placeholder="Enter your password" autocomplete="current-password" required>
            </div>

            <!-- Error Message -->
            <div id="errorMessage"
                class="hidden bg-red-500 bg-opacity-20 border border-red-500 border-opacity-50 text-red-100 px-4 py-3 rounded-lg">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="errorText">Invalid credentials. Please try again.</span>
            </div>

            <!-- Login Button -->
            <button type="submit" id="loginButton"
                class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                <i class="fas fa-sign-in-alt mr-2"></i>
                <span id="loginButtonText">Sign In</span>
            </button>
        </form>

        <!-- Available Users Info -->
        <div class="mt-6 p-4 bg-white bg-opacity-10 rounded-lg border border-white border-opacity-20">
            <h3 class="text-white text-sm font-medium mb-2">
                <i class="fas fa-info-circle mr-2"></i>Available Test Users
            </h3>
            <div class="text-white text-opacity-80 text-xs space-y-1">
                <div><strong>gustavo.quinelato@wexinc.com</strong> - Admin access</div>
                <div><strong>admin@pulse.com</strong> - Admin access</div>
                <div><strong>user@pulse.com</strong> - Standard user access</div>
                <div><strong>viewer@pulse.com</strong> - View-only access</div>
                <div class="mt-2 text-white text-opacity-60">Password for all users: <strong>pulse</strong></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-white text-opacity-60 text-sm">
            <p>Pulse Platform - ETL Service</p>
            <p class="mt-1">Â© 2025 WEX Inc.</p>
        </div>
    </div>

    <script>
        const errorDiv = document.getElementById('errorMessage');

        // Check for error parameters in URL
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const message = urlParams.get('message');
        const resource = urlParams.get('resource');

        // Handle success messages
        if (message) {
            let successMessage = '';
            switch (message) {
                case 'logged_out':
                    successMessage = 'You have been successfully logged out.';
                    break;
                default:
                    successMessage = message;
            }

            // Show success message (reuse error div but with different styling)
            document.getElementById('errorText').textContent = successMessage;
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('hidden', 'bg-red-500', 'border-red-500');
            errorDiv.classList.add('bg-green-500', 'border-green-500');
            errorDiv.querySelector('i').className = 'fas fa-check-circle text-green-300 mr-2';

            // Clean up URL after showing message (optional)
            if (window.history.replaceState) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        if (error) {
            let errorMessage = '';
            switch (error) {
                case 'authentication_required':
                    errorMessage = 'Please log in to access this page.';
                    break;
                case 'invalid_token':
                    errorMessage = 'Your session has expired. Please log in again.';
                    break;
                case 'authentication_failed':
                    errorMessage = 'Authentication failed. Please log in again.';
                    break;
                case 'permission_denied':
                    errorMessage = resource ?
                        `You don't have permission to access ${resource}. Please contact an administrator.` :
                        'You don\'t have permission to access this resource.';
                    break;
                case 'invalid_permission':
                    errorMessage = 'Invalid permission request. Please contact support.';
                    break;
                case 'page_not_found':
                    errorMessage = 'The page you requested was not found. Please log in to access the system.';
                    break;
                case 'server_error':
                    errorMessage = 'A server error occurred. Please log in and try again.';
                    break;
                default:
                    errorMessage = 'Please log in to continue.';
            }

            document.getElementById('errorText').textContent = errorMessage;
            errorDiv.classList.remove('hidden');

            // Clear URL parameters to avoid showing error on refresh
            if (window.history.replaceState) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');

            // Show loading state
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Signing In...';
            errorDiv.classList.add('hidden');

            try {
                // Authenticate with Backend Service API
                const backendUrl = 'http://localhost:3001'; // This should be configured properly

                const response = await fetch(`${backendUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Store token and redirect to dashboard
                    localStorage.setItem('pulse_token', data.token);

                    // Also set cookie for compatibility
                    document.cookie = `pulse_token=${data.token}; path=/; max-age=86400`; // 24 hours

                    window.location.href = '/dashboard';
                } else {
                    // Show error
                    document.getElementById('errorText').textContent = data.detail || 'Invalid credentials. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('errorText').textContent = 'Connection error. Please check if the backend service is running.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Reset button state
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i><span id="loginButtonText">Sign In</span>';
            }
        });

        // Auto-focus username field
        document.getElementById('email').focus();
    </script>
</body>

</html>