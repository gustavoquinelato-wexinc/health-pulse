{% extends "layouts/modern_layout.html" %}

{% block title %}Pulse ETL Management{% endblock %}

{% block content %}


<!-- Header Section with Title and Settings -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-3xl font-bold" style="color: var(--text-primary);">
                Welcome to Pulse ETL Management
            </h1>
            <p class="text-lg mt-2" style="color: var(--text-secondary);">
                Monitor and control your data integration workflows
            </p>
        </div>

    </div>
</div>

<!-- ETL Orchestrator Section -->
<div class="mb-8 p-6 rounded-lg transition-all duration-200 hover:shadow-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                <i data-lucide="bot" class="w-7 h-7" style="color: var(--color-1);"></i>
            </div>
            <div>
                <h2 class="text-xl font-semibold" style="color: var(--text-primary);">ETL Orchestrator</h2>
                <div class="flex items-center space-x-2 mt-1">
                    <div id="orchestratorStatusDot" class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-sm" style="color: var(--text-secondary);">Job Scheduler</span>
                </div>
            </div>
        </div>
        <div class="text-sm" style="color: var(--text-muted);" id="lastUpdate">
            Last updated: Never
        </div>
    </div>

    <!-- Countdown and Controls -->
    <div class="flex items-center justify-between">
        <!-- Next Run Timer -->
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <i data-lucide="clock" class="w-4 h-4" style="color: var(--text-secondary);"></i>
                <span class="text-sm font-medium" style="color: var(--text-secondary);">Next run in:</span>
            </div>
            <div id="countdownTimer" class="text-lg font-mono font-bold px-3 py-1 rounded" style="color: var(--color-1); background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                --:--:--
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="flex items-center space-x-2">
            <button onclick="forceStartOrchestrator()" id="forceStartOrchestratorBtn" class="action-icon-btn force-pending" title="Run Now">
                <i data-lucide="flag"></i>
            </button>
            <button onclick="toggleOrchestratorPause()" id="pauseOrchestratorBtn" class="btn-status-warning-sm" title="Pause">
                <i data-lucide="pause"></i>
            </button>
            <button onclick="showLogManagement()" class="btn-neutral-secondary" title="Logs">
                <i data-lucide="file-text"></i>
            </button>
            <button onclick="showOrchestratorSettings()" class="btn-neutral-primary-sm" title="Settings">
                <i data-lucide="settings"></i>
            </button>
        </div>
    </div>
</div>

<!-- Orchestrator Settings Modal -->
<div id="orchestratorSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="rounded-lg shadow-xl max-w-md w-full" style="background-color: var(--bg-secondary);">
            <div class="flex justify-between items-center px-6 py-4 border-b" style="border-color: var(--border-color);">
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">
                    <i class="fas fa-cog mr-2"></i>Orchestrator Settings
                </h3>
                <button onclick="hideOrchestratorSettings()" class="hover:opacity-75" style="color: var(--text-secondary);" title="Close">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="px-6 py-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                            Run Interval
                        </label>
                        <select id="orchestratorInterval" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <option value="60" selected>Every 1 hour</option>
                            <option value="120">Every 2 hours</option>
                            <option value="240">Every 4 hours</option>
                            <option value="480">Every 8 hours</option>
                            <option value="720">Every 12 hours</option>
                            <option value="1440">Every 24 hours</option>
                        </select>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="orchestratorEnabled" checked class="mr-2 h-4 w-4 rounded" style="color: var(--color-1);">
                            <span class="text-sm font-medium" style="color: var(--text-primary);">Enable Orchestrator</span>
                        </label>
                    </div>

                    <!-- Retry Settings Section -->
                    <div class="pt-4 border-t" style="border-color: var(--border-color);">
                        <h4 class="text-sm font-semibold mb-3" style="color: var(--text-primary);">
                            <i class="fas fa-redo mr-2"></i>Retry Settings
                        </h4>

                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="orchestratorRetryEnabled" class="mr-2 h-4 w-4 rounded" style="color: var(--color-1);">
                                    <span class="text-sm font-medium" style="color: var(--text-primary);">Enable Fast Retry</span>
                                </label>
                                <p class="text-xs mt-1 ml-6" style="color: var(--text-muted);">Retry failed jobs at shorter intervals</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                                    Retry Interval
                                </label>
                                <select id="orchestratorRetryInterval" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="5">Every 5 minutes</option>
                                    <option value="10" selected>Every 10 minutes</option>
                                    <option value="15">Every 15 minutes</option>
                                    <option value="30">Every 30 minutes</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-primary);">
                                    Max Retry Attempts
                                </label>
                                <select id="orchestratorMaxRetryAttempts" class="w-full px-3 py-2 rounded-md" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="3" selected>3 attempts</option>
                                    <option value="5">5 attempts</option>
                                    <option value="10">10 attempts</option>
                                    <option value="0">Unlimited</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t flex justify-end space-x-3" style="border-color: var(--border-color);">
                <button onclick="hideOrchestratorSettings()" class="btn-neutral-secondary" title="Cancel changes">
                    Cancel
                </button>
                <button onclick="saveOrchestratorSettings()" class="btn-crud-create" title="Save orchestrator settings">
                    <i class="fas fa-save mr-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Divider between Orchestrator and Jobs -->
<div class="orchestrator-divider mb-6"></div>

<!-- Vertical Job Pipeline -->
<div id="jobPipeline" class="job-pipeline-vertical mb-8">
    <!-- Job rows will be dynamically inserted here -->
</div>

<!-- Job Details Modal -->
<div id="jobDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden p-4" style="display: none;">
    <div class="rounded-lg max-w-6xl w-full max-h-[85vh] overflow-y-auto" style="background-color: var(--bg-primary);">
        <div class="flex justify-between items-center p-4 border-b" style="border-color: var(--border-color);">
            <h3 class="text-xl font-bold" style="color: var(--text-primary);">
                <span id="jobDetailsIcon"><i class="fas fa-info-circle mr-2"></i></span><span id="jobDetailsTitle">Job Details</span>
            </h3>
            <button onclick="closeJobDetailsModal()" class="hover:opacity-75" style="color: var(--text-secondary);" title="Close">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-4">
            <div id="jobDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="hideJobDetails()" class="btn-neutral-secondary" title="Close job details">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GitHub Rate Limits Modal -->
<div id="rateLimitsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden p-4" style="display: none;">
    <div class="rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-primary);">
        <div class="flex justify-between items-center p-4 border-b" style="border-color: var(--border-color);">
            <h2 class="text-xl font-bold" style="color: var(--text-primary);">
                <i class="fab fa-github mr-2"></i>GitHub API Rate Limits
            </h2>
            <button onclick="hideGitHubRateLimits()" class="hover:opacity-75" style="color: var(--text-secondary);" title="Close">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-4">
            <div id="rateLimitsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="hideGitHubRateLimits()" class="btn-neutral-secondary" title="Close rate limits">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Management Modal -->
<div id="logManagementModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden p-4" style="display: none;">
    <div class="rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--bg-primary);">
        <div class="flex justify-between items-start p-4 border-b" style="border-color: var(--border-color);">
            <div>
                <h3 class="text-lg font-semibold" style="color: var(--text-primary);">
                    <i data-lucide="file-text" class="w-5 h-5 inline mr-2"></i>ETL Service Log Management
                </h3>
                <p class="text-sm mt-1" style="color: var(--text-secondary);">Manage all log files in the ETL service directory</p>
            </div>
            <button onclick="hideLogManagement()" class="hover:opacity-75" style="color: var(--text-secondary);" title="Close">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-4">
            <div id="logManagementContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="hideLogManagement()" class="btn-neutral-secondary" title="Close log management">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<style>
    /* Job Control Styles */
    .glass-effect {
        background: linear-gradient(135deg, var(--color-1), var(--color-1));
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    /* Status Classes */
    .status-running { background-color: var(--crud-edit); color: white; }
    .status-pending { background-color: var(--color-1); color: white; }
    .status-finished { background-color: var(--status-success); color: white; }
    .status-paused { background-color: var(--color-4); color: white; }
    .status-not-started { background-color: var(--neutral-secondary); color: white; }

    /* Status Badge Classes for Job Pipeline */
    .status-badge {
        padding: 4px 12px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
        min-width: 120px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .status-badge-running { background-color: var(--crud-edit); color: white; }
    .status-badge-pending { background-color: var(--color-1); color: white; }
    .status-badge-finished { background-color: var(--status-success); color: white; }
    .status-badge-paused { background-color: var(--color-4); color: white; }
    .status-badge-not-started { background-color: var(--neutral-secondary); color: white; }

    /* Status Dot Classes */
    .status-dot-color-1 { background-color: var(--color-1); }

    /* Loading Indicator Styles */
    #loadingIndicator {
        transition: all 0.3s ease-in-out;
    }

    /* WebSocket Progress Styles */
    .ws-progress-container {
        width: 100%;
        height: 8px;
        background-color: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
    }

    .ws-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--color-3), var(--color-4));
        transition: width 0.3s ease;
    }

    .ws-progress-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    /* Modal Styles */
    .modal-show {
        display: flex !important;
        align-items: center;
        justify-content: center;
    }

    /* Exception Log Styles */
    .exception-log {
        max-height: 150px;
        overflow-y: auto;
        background-color: var(--bg-tertiary);
        border-radius: 4px;
        padding: 0.5rem;
    }

    .exception-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.75rem;
    }

    .exception-item:last-child {
        border-bottom: none;
    }

    .exception-item.error {
        color: var(--status-error);
    }

    .exception-item.warning {
        color: var(--status-warning);
    }

    .exception-item.info {
        color: var(--status-info);
    }



    /* Simple inactive job card styling - no grayscale, just visual indication */
    .job-card-inactive {
        opacity: 0.8;
        border-left: 4px solid var(--status-neutral) !important;
    }

    /* Vertical Pipeline Layout Styles */
    .orchestrator-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--border-color) 20%, var(--border-color) 80%, transparent);
        margin: 24px 0;
        position: relative;
    }

    .orchestrator-divider::before {
        content: "JOBS PIPELINE";
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-primary);
        padding: 0 16px;
        font-size: 10px;
        font-weight: 600;
        color: var(--text-secondary);
        letter-spacing: 1px;
    }

    .job-pipeline-vertical {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .job-row {
        height: 80px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        padding: 0 20px;
        cursor: grab;
        transition: all 0.2s ease;
        position: relative;
    }

    .job-row:hover {
        background: var(--bg-tertiary);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    .job-row.dragging {
        opacity: 0.7;
        transform: scale(1.02);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        z-index: 1000;
        cursor: grabbing;
        background: var(--bg-secondary);
    }

    .job-row.drag-over {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .drag-handle {
        color: var(--text-muted);
        font-size: 18px;
        margin-right: 12px;
        cursor: grab;
        user-select: none;
    }

    .drag-handle:hover {
        color: var(--text-primary);
    }

    .execution-number {
        background: var(--primary-color);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .job-icon {
        font-size: 20px;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .job-name-section {
        flex-grow: 1;
        margin-right: 16px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .job-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .job-metadata {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.2;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
    }

    .job-dates {
        display: inline-block;
    }

    .job-duration-inline {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .job-error-message {
        font-weight: 600;
    }

    .error-text {
        color: #ef4444;
    }

    .alert-text {
        color: #f59e0b;
    }



    .job-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
        margin-right: 16px;
    }

    /* Individual button containers for precise ordering */
    .job-force-pending,
    .job-pause-resume,
    .job-details {
        flex-shrink: 0;
        margin-right: 8px;
    }

    .job-status {
        display: flex;
        align-items: center;
        font-size: 14px;
        font-weight: 500;
        min-width: 120px;
        width: 120px;
        justify-content: center;
        flex-shrink: 0;
    }

    .job-action-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .job-action-btn:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .job-action-btn:disabled,
    .job-action-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .job-action-btn.error-btn {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .job-action-btn.error-btn:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
    }

    .job-action-btn.alert-btn {
        background: rgba(245, 158, 11, 0.1);
        border-color: rgba(245, 158, 11, 0.3);
        color: #f59e0b;
    }

    .job-action-btn.alert-btn:hover {
        background: #f59e0b;
        color: white;
        border-color: #f59e0b;
    }

    /* Progress bar for job rows */
    .job-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-color);
        border-radius: 0 0 8px 8px;
        transition: width 0.3s ease;
        width: 0%;
        max-width: 100%;
        display: none; /* Hidden by default */
    }

    .job-progress.visible {
        display: block;
    }

    /* Drop zone indicator */
    .drop-zone {
        height: 4px;
        background: var(--primary-color);
        border-radius: 2px;
        margin: 4px 0;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .drop-zone.active {
        opacity: 1;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--bg-primary);
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--bg-secondary);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: var(--bg-secondary);
    }

    .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        border-color: var(--primary-dark);
    }

    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-color: var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--bg-quaternary);
        color: var(--text-primary);
    }

    /* Toggle Switch for Active/Inactive */
    .job-toggle-container {
        margin-left: 12px;
        flex-shrink: 0;
    }

    .job-toggle-switch {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .toggle-switch {
        position: relative;
        width: 36px;
        height: 20px;
        background: #ccc;
        border-radius: 20px;
        transition: background 0.3s ease;
        margin-right: 6px;
    }

    .toggle-switch.active {
        background: var(--primary-color);
    }

    .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(16px);
    }

    .toggle-label {
        font-size: 10px;
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        min-width: 24px;
        text-align: center;
        display: inline-block;
    }

    /* Toggle Switch Styling */
    .job-toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .toggle-switch {
        position: relative;
        width: 36px;
        height: 18px;
        background-color: var(--status-neutral);
        border-radius: 9px;
        transition: background-color 0.3s ease;
        cursor: pointer;
    }

    .toggle-switch.active {
        background-color: var(--crud-create);
    }

    .toggle-slider {
        position: absolute;
        top: 1px;
        left: 1px;
        width: 16px;
        height: 16px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(18px);
    }

    .toggle-label {
        margin-right: 8px;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    /* Icon-only action buttons */
    .action-icon-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        position: relative;
    }

    .action-icon-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .action-icon-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Icon button variants */
    .action-icon-btn.force-pending {
        background-color: var(--color-1);
        color: white;
    }

    .action-icon-btn.pause-resume {
        background-color: var(--status-warning);
        color: white;
    }

    .action-icon-btn.resume {
        background-color: var(--crud-create);
        color: white;
    }

    .action-icon-btn.details {
        background-color: var(--neutral-secondary);
        color: white;
    }

    .action-icon-btn.disabled {
        background-color: var(--neutral-tertiary);
        color: var(--text-muted);
    }



    /* Orchestrator Control Buttons - Force Uniform Sizing */
    #forceStartOrchestratorBtn,
    #pauseOrchestratorBtn,
    button[onclick="showLogManagement()"],
    button[onclick="showOrchestratorSettings()"] {
        width: 2.5rem !important;
        height: 2.5rem !important;
        min-width: 2.5rem !important;
        min-height: 2.5rem !important;
        padding: 0 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 0.375rem !important;
        font-size: 0.875rem !important;
        box-sizing: border-box !important;
    }
</style>

<script>
    let refreshTimer = null;

    // WebSocket connections for real-time progress with connection management
    let websockets = {
        'Jira': null,
        'GitHub': null,
        orchestrator: null
    };

    // Connection management
    let connectionAttempts = {
        'Jira': 0,
        'GitHub': 0,
        orchestrator: 0
    };

    const maxReconnectAttempts = 3;
    let isPageUnloading = false;

    // Progress and exception data - will be dynamically populated
    let jobProgress = {};

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', async function () {
        // Validate token and clear stale data if needed
        const isValidToken = await validateToken();
        if (!isValidToken) {
            console.error('Token validation failed - redirecting to login');
            handleAuthenticationFailure();
            return;
        }

        // Smart authentication with loop prevention
        const token = getAuthToken();
        if (!token) {
            console.error('No auth token available after validation');
            handleAuthenticationFailure();
            return;
        }

        // User info is loaded by the modern layout template

        // Load initial data ONCE only
        refreshData();
        refreshOrchestratorStatus();

        // Set up page unload detection to properly close WebSocket connections
        window.addEventListener('beforeunload', function() {
            isPageUnloading = true;

            // Close all WebSocket connections
            Object.keys(websockets).forEach(jobName => {
                if (websockets[jobName]) {
                    websockets[jobName].close(1000, 'Page unloading'); // 1000 = normal closure
                    websockets[jobName] = null;
                }
            });
        });

        // Colors are handled by the modern layout template - no need to load again

        // Enable WebSockets for real-time job progress AND color updates (with small delay to ensure auth is ready)
        setTimeout(() => {
            initializeWebSockets();
        }, 500);


    });

    // Clear all authentication data
    function clearAllAuthenticationData() {
        // Clear localStorage completely
        localStorage.clear();

        // Clear sessionStorage
        sessionStorage.clear();

        // Clear all cookies
        document.cookie.split(";").forEach(cookie => {
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
            // Clear for current domain
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
            // Clear for parent domain
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=localhost`;
            // Clear for all subdomains
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.localhost`;
        });
    }

    // Cross-service navigation helper
    function navigateToFrontend(openInNewTab = false) {
        const token = getAuthToken();
        if (!token) {
            return;
        }

        const frontendUrl = 'http://localhost:3000';

        try {
            // Set up cross-service authentication
            fetch(`${frontendUrl}/api/v1/auth/cross-service-login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include'
            }).then(response => {
                if (response.ok) {
                    // Navigate to frontend
                    if (openInNewTab) {
                        window.open(frontendUrl, '_blank');
                    } else {
                        window.location.href = frontendUrl;
                    }
                } else {
                    // Navigate anyway even if cross-service auth failed
                    if (openInNewTab) {
                        window.open(frontendUrl, '_blank');
                    } else {
                        window.location.href = frontendUrl;
                    }
                }
            }).catch(error => {
                // Only log if it's not a network error (frontend not running)
                if (!error.message.includes('fetch') && !error.message.includes('NetworkError')) {
                    console.warn('Cross-service authentication error, navigating anyway:', error);
                }
                if (openInNewTab) {
                    window.open(frontendUrl, '_blank');
                } else {
                    window.location.href = frontendUrl;
                }
            });
        } catch (error) {
            console.error('Navigation error:', error);
        }
    }

    // Close all WebSocket connections (for debugging)
    function closeAllWebSockets() {
        isPageUnloading = true; // Prevent reconnections

        Object.keys(websockets).forEach(jobName => {
            if (websockets[jobName]) {
                websockets[jobName].close(1000, 'Manual close');
                websockets[jobName] = null;
            }
            connectionAttempts[jobName] = 0; // Reset attempts
        });

        // Reset unloading flag after a delay
        setTimeout(() => {
            isPageUnloading = false;
        }, 1000);
    }

    // Expose functions globally for debugging
    window.clearAuthData = clearAllAuthenticationData;
    window.navigateToFrontend = navigateToFrontend;
    window.closeAllWebSockets = closeAllWebSockets;

    // Authentication helper
    // Prefer cookie token; keep localStorage in sync so other scripts can read it
    function getAuthToken() {
        const cookieToken = getCookie('pulse_token');
        let lsToken = localStorage.getItem('pulse_token');
        if (cookieToken && cookieToken !== lsToken) {
            localStorage.setItem('pulse_token', cookieToken);
            lsToken = cookieToken;
        }
        return lsToken || cookieToken || null;
    }

    // Check if token is valid by making a test API call
    async function validateToken() {
        const token = getAuthToken();
        if (!token) {
            console.warn('No token found - clearing any stale data');
            clearAllAuthenticationData();
            return false;
        }

        try {
            const response = await fetch('/api/v1/auth/validate-web', {
                method: 'GET',
            });

            if (response.status === 401) {
                console.warn('Token validation failed - clearing stale authentication data');
                clearAllAuthenticationData();
                return false;
            }

            return response.ok;
        } catch (error) {
            console.warn('Token validation error - clearing stale authentication data:', error);
            clearAllAuthenticationData();
            return false;
        }
    }

    function checkAuth() {
        const token = getAuthToken();
        if (!token) {
            console.error('Authentication check failed - no token available');
            handleAuthenticationFailure();
            return false;
        }
        return true;
    }

    // Smart authentication failure handling with loop prevention
    function handleAuthenticationFailure() {
        const redirectKey = 'pulse_auth_redirect_count';
        const redirectTimeKey = 'pulse_auth_redirect_time';
        const maxRedirects = 3;
        const resetTimeMs = 60000; // 1 minute

        try {
            const now = Date.now();
            const lastRedirectTime = parseInt(localStorage.getItem(redirectTimeKey) || '0');
            const redirectCount = parseInt(localStorage.getItem(redirectKey) || '0');

            // Reset counter if enough time has passed
            if (now - lastRedirectTime > resetTimeMs) {
                localStorage.setItem(redirectKey, '0');
                localStorage.setItem(redirectTimeKey, now.toString());
            }

            // Check if we've exceeded redirect limit
            if (redirectCount >= maxRedirects) {
                console.warn('Too many authentication redirects - showing login message instead');
                showAuthenticationRequired();
                return;
            }

            // Increment counter and redirect
            localStorage.setItem(redirectKey, (redirectCount + 1).toString());
            localStorage.setItem(redirectTimeKey, now.toString());

            console.log(`Redirecting to login (attempt ${redirectCount + 1}/${maxRedirects})`);
            window.location.href = '/login';

        } catch (error) {
            console.error('Error in authentication handling:', error);
            showAuthenticationRequired();
        }
    }

    // Show authentication required message instead of redirecting
    function showAuthenticationRequired() {
        const container = document.body;
        container.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--bg-primary, #f8f9fa);">
                <div style="text-align: center; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="color: #dc3545; margin-bottom: 1rem;">Authentication Required</h2>
                    <p style="margin-bottom: 1.5rem; color: #6c757d;">You need to be logged in to access this page.</p>
                    <a href="/login" style="display: inline-block; padding: 0.5rem 1rem; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;">
                        Go to Login
                    </a>
                </div>
            </div>
        `;
    }

    // User info loading is handled by the modern layout template



    // Color schema is now handled automatically by CSS custom properties
    // No JavaScript intervention needed - colors update on page refresh

    function showNotification(message, type = 'info') {
        // Simple notification system
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${type === 'success' ? 'var(--status-success)' : 'var(--color-1)'};
            color: white;
            border-radius: 6px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }







    // WebSocket Management
    function initializeWebSockets() {
        const jobs = ['Jira', 'GitHub', 'WEX Fabric', 'WEX AD', 'Vectorization'];
        jobs.forEach(jobName => {
            connectWebSocket(jobName);
        });
    }

    function connectWebSocket(jobName) {
        // Prevent connection if page is unloading
        if (isPageUnloading) {
            return;
        }

        // Check if we've exceeded max reconnection attempts
        if (connectionAttempts[jobName] >= maxReconnectAttempts) {
            return;
        }

        // Close existing connection if any
        if (websockets[jobName]) {
            websockets[jobName].close();
            websockets[jobName] = null;
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/progress/${jobName}`;

        try {
            const ws = new WebSocket(wsUrl);

            ws.onopen = function () {
                websockets[jobName] = ws;
                connectionAttempts[jobName] = 0; // Reset attempts on successful connection
            };

            ws.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(jobName, data);
                } catch (e) {
                    console.error(`Error parsing WebSocket message for ${jobName}:`, e);
                }
            };

            ws.onclose = function (event) {
                websockets[jobName] = null;

                // Only attempt reconnection if not intentionally closed and page is not unloading
                if (!isPageUnloading && event.code !== 1000 && connectionAttempts[jobName] < maxReconnectAttempts) {
                    connectionAttempts[jobName]++;
                    const delay = Math.min(5000 * connectionAttempts[jobName], 30000); // Exponential backoff, max 30s

                    setTimeout(() => {
                        if (!websockets[jobName] && !isPageUnloading) {
                            connectWebSocket(jobName);
                        }
                    }, delay);
                }
            };

            ws.onerror = function (error) {
                // Only log WebSocket errors if we're not in the process of unloading
                if (!isPageUnloading) {
                    console.error(`WebSocket error for ${jobName}:`, error);
                }
            };

        } catch (e) {
            console.error(`Failed to create WebSocket for ${jobName}:`, e);
        }
    }

    function handleWebSocketMessage(jobName, data) {
        switch (data.type) {
            case 'progress':
                updateJobProgress(jobName, data.percentage, data.step);
                break;
            case 'exception':
                addJobException(jobName, data.level, data.message, data.timestamp);
                break;
            case 'status':
                updateJobStatus(jobName, data.status);
                break;
            case 'completion':
                handleJobCompletion(jobName, data.success, data.summary);
                break;
            // Handle real-time color schema updates
            case 'color_schema_updated':
            case 'color_schema_mode_updated':
                handleColorSchemaUpdate(data);
                break;
            default:
                console.log(`Unknown WebSocket message type: ${data.type}`);
        }
    }

    function handleColorSchemaUpdate(data) {
        console.log('ðŸŽ¨ Received color schema update:', data);

        try {
            // Show notification to user
            showNotification('ðŸŽ¨ Color scheme updated! Refreshing page...', 'info');

            // Simple approach: reload the page to apply new colors
            // This ensures all colors are properly updated from the server
            setTimeout(() => {
                window.location.reload();
            }, 1500); // Give user time to see the notification

        } catch (error) {
            console.error('âŒ Error handling color schema update:', error);
            showNotification('âŒ Failed to apply color update', 'error');
        }
    }

    function updateJobProgress(jobName, percentage, step) {
        jobProgress[jobName].percentage = percentage;
        jobProgress[jobName].step = step;

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardProgress(jobCard, percentage, step);
        }
    }

    function addJobException(jobName, level, message, timestamp) {
        const exception = {
            level: level,
            message: message,
            timestamp: timestamp
        };

        jobProgress[jobName].exceptions.unshift(exception);

        if (jobProgress[jobName].exceptions.length > 10) {
            jobProgress[jobName].exceptions = jobProgress[jobName].exceptions.slice(0, 10);
        }

        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardExceptions(jobCard, jobProgress[jobName].exceptions);
        }
    }

    function clearJobExceptions(jobName) {
        // Clear exceptions for the specific job
        if (jobProgress[jobName] && jobProgress[jobName].exceptions) {
            jobProgress[jobName].exceptions = [];
        }

        // Update the UI to hide the exceptions section
        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardExceptions(jobCard, []);
        }

        // Also clear recovery information and error messages from the UI immediately
        clearJobRecoveryInfo(jobName);

        // Also trigger a data refresh to clear any error messages from the database
        setTimeout(refreshData, 500);
    }

    function clearJobRecoveryInfo(jobName) {
        // Clear recovery information from the job card
        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            // Remove recovery details section
            const recoverySection = jobCard.querySelector('.recovery-details');
            if (recoverySection) {
                recoverySection.remove();
            }

            // Remove any error message sections
            const errorSections = jobCard.querySelectorAll('.text-red-500, .text-orange-500, .bg-red-50, .bg-orange-50');
            errorSections.forEach(section => {
                if (section.textContent.includes('Error') || section.textContent.includes('Recovery') || section.textContent.includes('Checkpoint')) {
                    section.remove();
                }
            });

            // Remove exception log sections
            const exceptionLogs = jobCard.querySelectorAll('.exception-log');
            exceptionLogs.forEach(log => log.remove());
        }
    }

    function updateJobStatus(jobName, status) {
        const jobCard = document.querySelector(`[data-job="${jobName}"]`);
        if (jobCard) {
            updateJobCardStatus(jobCard, status);
        }
    }

    function handleJobCompletion(jobName, success, summary) {

        if (success) {
            updateJobProgress(jobName, 100, 'Completed successfully');
        } else {
            addJobException(jobName, 'ERROR', summary.error || 'Job failed', new Date().toISOString());
        }

        setTimeout(() => {
            refreshData();
        }, 2000);
    }

    // Data refresh functions
    async function refreshData() {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch('/api/v1/home/jobs', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                console.error('Authentication failed - token may be expired');
                handleAuthenticationFailure();
                return;
            }

            const data = await response.json();
            // New endpoint returns array of job cards directly
            updateJobCards(data);
            updateLastRefreshTime();

            // Also refresh orchestrator status to keep it in sync
            refreshOrchestratorStatus();
        } catch (error) {
            console.error('Error fetching job status:', error);
        }
    }

    function updateJobCards(jobsData) {
        const container = document.getElementById('jobPipeline');
        container.innerHTML = '';

        // Handle new array format from /api/v1/home/jobs endpoint
        if (Array.isArray(jobsData)) {
            // Sort jobs by execution_order for vertical pipeline
            const sortedJobs = [...jobsData].sort((a, b) => (a.execution_order || 0) - (b.execution_order || 0));

            sortedJobs.forEach(jobCard => {
                // Initialize jobProgress for all jobs that support WebSocket progress
                const supportsWebSocket = ['jira', 'github', 'wex fabric', 'wex ad', 'vectorization'].includes(jobCard.job_name.toLowerCase());
                if (supportsWebSocket && !jobProgress[jobCard.job_name]) {
                    jobProgress[jobCard.job_name] = {
                        exceptions: [],
                        percentage: 0,
                        step: 'Ready'
                    };
                }

                // Convert to job row format
                const jobData = {
                    id: jobCard.id,
                    status: jobCard.status,
                    last_sync: jobCard.last_sync,
                    integration_type: jobCard.integration_type,
                    integration_logo_filename: jobCard.integration_logo_filename,
                    execution_order: jobCard.execution_order,
                    active: jobCard.active,
                    last_run_started_at: jobCard.last_run_started_at,
                    last_success_at: jobCard.last_success_at,
                    retry_count: jobCard.retry_count
                };
                const row = createJobRow(jobCard.job_name, jobData, sortedJobs);
                container.appendChild(row);
            });
        } else {
            // Fallback for old object format (if needed)
            const sortedEntries = Object.entries(jobsData).sort(([,a], [,b]) => (a.execution_order || 0) - (b.execution_order || 0));
            sortedEntries.forEach(([jobName, jobData]) => {
                const row = createJobRow(jobName, jobData, jobsData);
                container.appendChild(row);
            });
        }

        // Initialize drag and drop
        initializeDragAndDrop();

        // Re-initialize Lucide icons after job rows are rendered
        refreshLucideIcons();

        updateOrchestratorButtonState(jobsData);
    }

    function updateLastRefreshTime() {
        const now = new Date();
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
        }
    }

    function updateOrchestratorButtonState(jobsData) {
        // This function is now handled by updateOrchestratorUI
        // Just trigger a refresh of orchestrator status to update button states
        refreshOrchestratorStatus();
    }

    function setupAutoRefresh() {
        const select = document.getElementById('refreshInterval');

        // Check if the refresh interval select exists (it was removed from the new layout)
        if (!select) {
            return;
        }

        select.addEventListener('change', function () {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }

            const interval = parseInt(this.value);
            if (interval > 0) {
                refreshTimer = setInterval(refreshData, interval);
            }
        });

        const defaultInterval = parseInt(select.value);
        if (defaultInterval > 0) {
            refreshTimer = setInterval(refreshData, defaultInterval);
        }
    }



    function createJobRow(jobName, jobData, allJobsData) {
        const row = document.createElement('div');
        const isInactive = jobData.active === false;

        row.className = `job-row ${isInactive ? 'job-card-inactive' : ''}`;
        row.setAttribute('data-job', jobName);
        row.setAttribute('data-job-id', jobData.id);
        row.setAttribute('data-execution-order', jobData.execution_order || 0);
        row.draggable = true;

        // Use integration_type from API response to determine icon and styling
        const integrationType = jobData.integration_type || 'unknown';
        const integrationLogoFilename = jobData.integration_logo_filename;
        let jobIcon, jobIconClass, jobColor;

        // Use the actual job_name from database as the title, converted to uppercase
        const jobTitle = jobName.toUpperCase();

        // Check if we have a custom logo for this integration
        const tenantName = '{{ tenant_name|lower }}' || 'wex';
        const hasCustomLogo = integrationLogoFilename && integrationLogoFilename.trim() !== '';
        const logoPath = hasCustomLogo ? `/static/assets/${tenantName}/integrations/${integrationLogoFilename}` : null;

        // Get Lucide icon for jobs without integrations
        function getJobLucideIcon(jobName) {
            const name = jobName.toLowerCase();
            switch (name) {
                case 'vectorization':
                    return 'zap'; // Lightning bolt for vectorization processing
                case 'jira':
                    return 'ticket'; // Ticket icon for Jira
                case 'github':
                    return 'git-branch'; // Git branch for GitHub
                case 'wex fabric':
                case 'fabric':
                    return 'database'; // Database icon for Fabric
                case 'wex ad':
                case 'ad':
                    return 'users'; // Users icon for Active Directory
                default:
                    return 'cog'; // Default gear icon for unknown jobs
            }
        }

        // Get status info
        const status = jobData.status || 'UNKNOWN';
        const statusIcon = getStatusIcon(status);
        const statusClass = getStatusClass(status, isInactive);
        const duration = formatDuration(jobData.last_run_started_at, jobData.last_success_at, status);

        // Format job dates and duration
        const jobDates = formatJobDates(jobData.last_run_started_at, jobData.last_success_at);
        const errorMessage = getErrorMessage(jobData, status);

        row.innerHTML = `
            <!-- Drag Handle -->
            <div class="drag-handle">â‰¡</div>

            <!-- Execution Order Number -->
            <div class="execution-number">${jobData.execution_order || 0}</div>

            <!-- Job Icon -->
            <div class="job-icon">
                ${hasCustomLogo ?
                    `<img src="${logoPath}" alt="${jobTitle}" class="w-5 h-5 object-contain">` :
                    `<i data-lucide="${getJobLucideIcon(jobName)}" class="w-5 h-5" style="color: var(--color-1);"></i>`
                }
            </div>

            <!-- Job Name, Dates, and Duration -->
            <div class="job-name-section">
                <div class="job-name">${jobTitle}</div>
                <div class="job-metadata">
                    <span class="job-info">
                        ${jobDates ? `â€¢ ${jobDates}` : ''}
                        ${duration ? ` â€¢ Duration: ${duration}` : ''}
                    </span>
                    ${errorMessage ? `<span class="job-error-message">${errorMessage}</span>` : ''}
                </div>
            </div>

            <!-- 4) Force Pending Button -->
            <div class="job-force-pending">
                ${createForcePendingButton(jobName, jobData, isInactive)}
            </div>

            <!-- 3) Pause/Resume Button -->
            <div class="job-pause-resume">
                ${createPauseResumeButton(jobName, jobData, isInactive)}
            </div>

            <!-- 2) Details Button -->
            <div class="job-details">
                ${createDetailsButton(jobName)}
            </div>

            <!-- 1) Job Status (center aligned) -->
            <div class="job-status ${statusClass}">
                <i class="fas fa-${statusIcon} mr-1"></i>
                ${status}
            </div>

            <!-- 0) Toggle Switch (rightmost) -->
            <div class="job-toggle-container">
                <div class="job-toggle-switch" onclick="toggleJobActiveStatus('${jobName}', ${jobData.id})" title="${isInactive ? 'Activate this job' : 'Deactivate this job'}">
                    <div class="toggle-switch ${isInactive ? '' : 'active'}">
                        <div class="toggle-slider"></div>
                    </div>
                    <span class="toggle-label">${isInactive ? 'Off' : 'On'}</span>
                </div>
            </div>

            <!-- Progress Bar (hidden by default) -->
            <div class="job-progress"></div>`;

        return row;
    }

    function createJobActionButtons(jobName, jobData, isInactive) {
        const status = jobData.status || 'UNKNOWN';
        let buttons = '';

        // Determine if there are issues (single icon for errors OR alerts)
        const hasErrors = jobData.retry_count > 0 || status === 'ERROR';
        const hasAlerts = jobData.last_run_started_at && !jobData.last_success_at;
        const hasIssues = hasErrors || hasAlerts;

        if (isInactive) {
            // Inactive jobs: only details button
            buttons = `
                <button class="job-action-btn" onclick="showJobDetails('${jobName}')" title="View Details">
                    <i data-lucide="info" class="w-4 h-4"></i>
                </button>`;
        } else {
            // Order: details, pause/resume, force pending, alert/error (single icon)

            // 1. Details button (always present)
            buttons = `
                <button class="job-action-btn" onclick="showJobDetails('${jobName}')" title="View Details">
                    <i data-lucide="info" class="w-4 h-4"></i>
                </button>`;

            // 2. Pause/Resume button (state-dependent)
            if (status === 'RUNNING') {
                buttons += `
                    <button class="job-action-btn" onclick="pauseJob('${jobName}', ${jobData.id})" title="Pause Job">
                        <i data-lucide="pause" class="w-4 h-4"></i>
                    </button>`;
            } else if (status === 'PAUSED') {
                buttons += `
                    <button class="job-action-btn" onclick="resumeJob('${jobName}', ${jobData.id})" title="Resume Job">
                        <i data-lucide="play" class="w-4 h-4"></i>
                    </button>`;
            }

            // 3. Force Pending button (always present for active jobs)
            buttons += `
                <button class="job-action-btn" onclick="forcePendingJob('${jobName}', ${jobData.id})" title="Force Pending">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                </button>`;

            // 4. Single Alert/Error button (if there are any issues)
            if (hasIssues) {
                const iconType = hasErrors ? 'alert-circle' : 'alert-triangle';
                const buttonClass = hasErrors ? 'error-btn' : 'alert-btn';
                const title = hasErrors ? 'View Errors' : 'View Alerts';
                const clickHandler = hasErrors ? 'showJobErrors' : 'showJobAlerts';

                buttons += `
                    <button class="job-action-btn ${buttonClass}" onclick="${clickHandler}('${jobName}')" title="${title}">
                        <i data-lucide="${iconType}" class="w-4 h-4"></i>
                    </button>`;
            }
        }

        return buttons;
    }

    function createDetailsButton(jobName) {
        return `
            <button class="job-action-btn" onclick="showJobDetails('${jobName}')" title="View Details">
                <i data-lucide="info" class="w-4 h-4"></i>
            </button>`;
    }

    function createPauseResumeButton(jobName, jobData, isInactive) {
        const status = jobData.status || 'UNKNOWN';

        if (isInactive) {
            // Show disabled play button for inactive jobs
            return `
                <button class="job-action-btn disabled" title="Job is inactive - activate first">
                    <i data-lucide="play" class="w-4 h-4"></i>
                </button>`;
        }

        // For active jobs, always show pause/resume button based on current state
        if (status === 'RUNNING') {
            return `
                <button class="job-action-btn" onclick="pauseJob('${jobName}', ${jobData.id})" title="Pause Job">
                    <i data-lucide="pause" class="w-4 h-4"></i>
                </button>`;
        } else if (status === 'PAUSED') {
            return `
                <button class="job-action-btn" onclick="resumeJob('${jobName}', ${jobData.id})" title="Resume Job">
                    <i data-lucide="play" class="w-4 h-4"></i>
                </button>`;
        } else {
            // For other states (NOT_STARTED, PENDING, FINISHED), show pause button
            // User can pause to prevent job from running when it becomes pending
            return `
                <button class="job-action-btn" onclick="pauseJob('${jobName}', ${jobData.id})" title="Pause Job">
                    <i data-lucide="pause" class="w-4 h-4"></i>
                </button>`;
        }
    }

    function createForcePendingButton(jobName, jobData, isInactive) {
        // Force pending should be available for all jobs (active and inactive)
        const buttonClass = isInactive ? 'job-action-btn disabled' : 'job-action-btn';
        const clickHandler = isInactive ? '' : `onclick="forcePendingJob('${jobName}', ${jobData.id})"`;
        const title = isInactive ? 'Job is inactive - activate first' : 'Force Pending';

        return `
            <button class="${buttonClass}" ${clickHandler} title="${title}">
                <i data-lucide="clock" class="w-4 h-4"></i>
            </button>`;
    }



    function formatDuration(startTime, endTime, status) {
        if (status === 'RUNNING' && startTime) {
            const start = new Date(startTime);
            const now = new Date();
            const diffMs = now - start;
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);
            return `${minutes}m ${seconds}s`;
        } else if (endTime && startTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const minutes = Math.floor(diffMs / 60000);
            return `${minutes}m`;
        } else if (endTime) {
            const end = new Date(endTime);
            const now = new Date();
            const diffMs = now - end;
            const hours = Math.floor(diffMs / 3600000);
            const minutes = Math.floor((diffMs % 3600000) / 60000);
            if (hours > 0) {
                return `${hours}h ago`;
            } else {
                return `${minutes}m ago`;
            }
        }
        return ''; // Return empty string instead of '--'
    }

    function formatJobDates(lastRunStarted, lastSuccess) {
        let dates = [];

        if (lastRunStarted) {
            const startDate = new Date(lastRunStarted);
            const formattedStart = startDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            dates.push(`Started: ${formattedStart}`);
        }

        if (lastSuccess) {
            const successDate = new Date(lastSuccess);
            const formattedSuccess = successDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            dates.push(`Success: ${formattedSuccess}`);
        }

        return dates.length > 0 ? dates.join(' â€¢ ') : '';
    }

    function getErrorMessage(jobData, status) {
        const hasErrors = jobData.retry_count > 0 || status === 'ERROR';
        const hasAlerts = jobData.last_run_started_at && !jobData.last_success_at;

        if (hasErrors) {
            return '<span class="error-text">ERROR: check details</span>';
        } else if (hasAlerts) {
            return '<span class="alert-text">ALERT: check details</span>';
        }

        return '';
    }

    function initializeDragAndDrop() {
        const jobPipeline = document.getElementById('jobPipeline');
        let draggedElement = null;
        let dropZones = [];

        // Add drag event listeners to all job rows
        const jobRows = jobPipeline.querySelectorAll('.job-row');
        jobRows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragend', handleDragEnd);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
        });

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');

            // Create drop zones between job rows
            createDropZones();

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;

            // Remove drop zones
            removeDropZones();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();

            if (this !== draggedElement) {
                // Determine if we're dropping above or below the target
                const rect = this.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                const dropAbove = e.clientY < midpoint;

                // Insert the dragged element
                if (dropAbove) {
                    this.parentNode.insertBefore(draggedElement, this);
                } else {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                }

                // Update execution order
                updateExecutionOrder();
            }
        }

        function createDropZones() {
            const rows = Array.from(jobPipeline.querySelectorAll('.job-row'));

            rows.forEach((row, index) => {
                // Add drop zone before first row
                if (index === 0) {
                    const dropZone = document.createElement('div');
                    dropZone.className = 'drop-zone';
                    dropZone.addEventListener('dragover', handleDropZoneOver);
                    dropZone.addEventListener('drop', handleDropZoneDrop);
                    jobPipeline.insertBefore(dropZone, row);
                    dropZones.push(dropZone);
                }

                // Add drop zone after each row
                const dropZone = document.createElement('div');
                dropZone.className = 'drop-zone';
                dropZone.addEventListener('dragover', handleDropZoneOver);
                dropZone.addEventListener('drop', handleDropZoneDrop);
                jobPipeline.insertBefore(dropZone, row.nextSibling);
                dropZones.push(dropZone);
            });
        }

        function removeDropZones() {
            dropZones.forEach(zone => zone.remove());
            dropZones = [];
        }

        function handleDropZoneOver(e) {
            e.preventDefault();
            this.classList.add('active');
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDropZoneDrop(e) {
            e.preventDefault();
            this.parentNode.insertBefore(draggedElement, this);
            updateExecutionOrder();
        }

        function updateExecutionOrder() {
            const rows = Array.from(jobPipeline.querySelectorAll('.job-row'));
            const updates = [];

            rows.forEach((row, index) => {
                const newOrder = index + 1;
                const currentOrder = parseInt(row.getAttribute('data-execution-order'));
                const jobId = row.getAttribute('data-job-id');

                if (newOrder !== currentOrder) {
                    // Update the DOM
                    row.setAttribute('data-execution-order', newOrder);
                    row.querySelector('.execution-number').textContent = newOrder;

                    // Prepare for backend update
                    updates.push({
                        job_id: jobId,
                        execution_order: newOrder
                    });
                }
            });

            // Send updates to backend
            if (updates.length > 0) {
                updateJobExecutionOrderBackend(updates);
            }
        }

        async function updateJobExecutionOrderBackend(updates) {
            try {
                const response = await fetch('/api/v1/jobs/execution-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ updates })
                });

                if (response.ok) {
                    showNotification('Job execution order updated successfully', 'success');
                } else {
                    const result = await response.json();
                    showNotification(`Failed to update execution order: ${result.detail}`, 'error');
                    // Refresh to restore original order
                    setTimeout(refreshData, 1000);
                }
            } catch (error) {
                console.error('Error updating execution order:', error);
                showNotification('Error updating execution order', 'error');
                // Refresh to restore original order
                setTimeout(refreshData, 1000);
            }
        }
    }



    function showJobErrors(jobName) {
        // Show modal with job error details
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i data-lucide="alert-circle" class="w-5 h-5 mr-2 text-red-500"></i>Job Errors - ${jobName}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="jobErrorContent">Loading error details...</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    <button class="btn btn-primary" onclick="retryJob('${jobName}')">Retry Job</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Load error details
        loadJobErrorDetails(jobName);

        // Initialize Lucide icons in modal
        refreshLucideIcons();
    }

    function showJobAlerts(jobName) {
        // Show modal with job alert details
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-yellow-500"></i>Job Alerts - ${jobName}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="jobAlertContent">Loading alert details...</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    <button class="btn btn-primary" onclick="acknowledgeAlerts('${jobName}')">Acknowledge</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Load alert details
        loadJobAlertDetails(jobName);

        // Initialize Lucide icons in modal
        refreshLucideIcons();
    }

    async function loadJobErrorDetails(jobName) {
        try {
            const response = await fetch(`/api/v1/jobs/${jobName}/errors`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const content = document.getElementById('jobErrorContent');
                if (content) {
                    content.innerHTML = formatErrorDetails(data.errors);
                }
            } else {
                document.getElementById('jobErrorContent').innerHTML = 'Failed to load error details.';
            }
        } catch (error) {
            console.error('Error loading job error details:', error);
            document.getElementById('jobErrorContent').innerHTML = 'Error loading error details.';
        }
    }

    async function loadJobAlertDetails(jobName) {
        try {
            const response = await fetch(`/api/v1/jobs/${jobName}/alerts`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const content = document.getElementById('jobAlertContent');
                if (content) {
                    content.innerHTML = formatAlertDetails(data.alerts);
                }
            } else {
                document.getElementById('jobAlertContent').innerHTML = 'Failed to load alert details.';
            }
        } catch (error) {
            console.error('Error loading job alert details:', error);
            document.getElementById('jobAlertContent').innerHTML = 'Error loading alert details.';
        }
    }

    function formatErrorDetails(errors) {
        if (!errors || errors.length === 0) {
            return '<p class="text-gray-500">No error details available.</p>';
        }

        return errors.map(error => `
            <div class="error-item mb-4 p-3 bg-red-50 border border-red-200 rounded">
                <div class="font-semibold text-red-800">${error.timestamp}</div>
                <div class="text-red-700 mt-1">${error.message}</div>
                ${error.details ? `<div class="text-sm text-red-600 mt-2">${error.details}</div>` : ''}
            </div>
        `).join('');
    }

    function formatAlertDetails(alerts) {
        if (!alerts || alerts.length === 0) {
            return '<p class="text-gray-500">No alert details available.</p>';
        }

        return alerts.map(alert => `
            <div class="alert-item mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <div class="font-semibold text-yellow-800">${alert.timestamp}</div>
                <div class="text-yellow-700 mt-1">${alert.message}</div>
                ${alert.details ? `<div class="text-sm text-yellow-600 mt-2">${alert.details}</div>` : ''}
            </div>
        `).join('');
    }

    function createJobDetails(jobName, jobData) {
        let details = `
            <div class="space-y-3 text-sm" style="color: var(--text-secondary);">
                <div class="flex justify-between">
                    <span>Last Run - Started At:</span>
                    <span>${jobData.last_run_started_at ? new Date(jobData.last_run_started_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Last Run - Finished At:</span>
                    <span>${jobData.last_success_at ? new Date(jobData.last_success_at).toLocaleString() : 'Never'}</span>
                </div>
                <div class="flex justify-between">
                    <span>Retry Count:</span>
                    <span>${jobData.retry_count || 0}</span>
                </div>
            </div>
        `;

        // Recovery details and error messages moved to createMessagesSection() below buttons

        return details;
    }

    function createRecoveryDetails(checkpointData) {
        if (!checkpointData) return '';

        let recoveryHtml = `
            <div class="mt-3 p-3 rounded-lg border" style="background-color: rgba(var(--status-warning-rgb), 0.1); border-color: rgba(var(--status-warning-rgb), 0.3);">
                <div class="text-xs font-medium mb-2" style="color: var(--status-warning);">
                    <i class="fas fa-redo mr-1"></i>Recovery Information:
                </div>
        `;

        if (checkpointData.repo_processing_queue) {
            let queue;
            if (typeof checkpointData.repo_processing_queue === 'string') {
                queue = JSON.parse(checkpointData.repo_processing_queue);
            } else {
                queue = checkpointData.repo_processing_queue;
            }

            const finished = queue.filter(r => r.finished).length;
            const total = queue.length;
            const remaining = total - finished;

            recoveryHtml += `
                <div class="text-xs mb-1" style="color: var(--text-secondary);">
                    Repositories: ${finished}/${total} completed (${remaining} remaining)
                </div>
            `;
        }

        const cursors = ['last_pr_cursor', 'current_pr_node_id', 'last_commit_cursor', 'last_review_cursor', 'last_comment_cursor'];
        cursors.forEach(cursor => {
            if (checkpointData[cursor]) {
                recoveryHtml += `
                    <div class="text-xs mb-1" style="color: var(--text-secondary);">
                        ${cursor.replace(/_/g, ' ')}: ${checkpointData[cursor].substring(0, 20)}...
                    </div>
                `;
            }
        });

        recoveryHtml += '</div>';
        return recoveryHtml;
    }

    function createMessagesSection(jobName, jobData) {
        let messagesHtml = '';

        // Recovery details for GitHub jobs (moved from createJobDetails)
        if (jobName.toLowerCase() === 'github' && jobData.status === 'PENDING' && jobData.checkpoint_data &&
            jobData.checkpoint_data.repo_processing_queue) {
            messagesHtml += createRecoveryDetails(jobData.checkpoint_data);
        }

        // Error messages for all jobs (moved from createJobDetails)
        if (jobData.error_message) {
            messagesHtml += `
                <div class="mt-3 p-3 rounded-lg border" style="background-color: rgba(var(--status-error-rgb), 0.1); border-color: rgba(var(--status-error-rgb), 0.3);">
                    <div class="text-xs font-medium mb-1" style="color: var(--status-error);">Error Message:</div>
                    <div class="text-xs" style="color: var(--text-primary);">${jobData.error_message}</div>
                </div>
            `;
        }

        return messagesHtml;
    }

    function createActionButtons(jobName, jobData, allJobsData) {
        const isInactive = jobData.active === false;
        const canActivate = ['PENDING', 'FINISHED', 'NOT_STARTED', 'PAUSED'].includes(jobData.status);
        const canPause = !['ERROR'].includes(jobData.status); // Can pause any status except ERROR
        const canUnpause = jobData.status === 'PAUSED';

        const otherJobRunning = Object.entries(allJobsData).some(([name, data]) =>
            name !== jobName && data.status === 'RUNNING'
        );

        const canActivateSafe = canActivate && !otherJobRunning && !isInactive;
        const canPauseSafe = canPause && !isInactive; // Disabled if job is inactive



        // Determine button titles based on state
        let forcePendingTitle = 'Set job to pending';
        if (isInactive) {
            forcePendingTitle = 'Job is inactive - cannot be executed';
        } else if (!canActivateSafe && otherJobRunning) {
            forcePendingTitle = 'Cannot activate while another job is running';
        }

        let pauseTitle = canUnpause ? 'Resume job' : 'Pause job';
        if (isInactive) {
            pauseTitle = 'Job is inactive - cannot be controlled';
        } else if (!canPauseSafe && jobData.status === 'RUNNING') {
            pauseTitle = 'Cannot pause while job is running';
        }

        let buttons = `
            <button onclick="setJobActive('${jobName}', ${jobData.id})"
                    ${!canActivateSafe || isInactive ? 'disabled' : ''}
                    class="action-icon-btn ${canActivateSafe && !isInactive ? 'force-pending' : 'disabled'}"
                    title="${isInactive ? 'Job is inactive - activate first' : forcePendingTitle}">
                <i data-lucide="clock"></i>
            </button>
            <button onclick="${canUnpause ? 'unpauseJob' : 'pauseJob'}('${jobName}', ${jobData.id})"
                    ${!(canPauseSafe || canUnpause) || isInactive ? 'disabled' : ''}
                    class="action-icon-btn ${canUnpause && !isInactive ? 'resume' : (canPauseSafe && !isInactive ? 'pause-resume' : 'disabled')}"
                    title="${isInactive ? 'Job is inactive - activate first' : pauseTitle}">
                <i data-lucide="${canUnpause ? 'play' : 'pause'}"></i>
            </button>
            <button onclick="showJobDetails('${jobName}', ${jobData.id})"
                    ${isInactive ? 'disabled' : ''}
                    class="action-icon-btn ${isInactive ? 'disabled' : 'details'}"
                    title="${isInactive ? 'Job is inactive - activate first' : 'View job details'}">
                <i data-lucide="info"></i>
            </button>
        `;

        return buttons;
    }

    // Job control functions
    async function setJobActive(jobName, jobId) {
        try {
            // Clear any existing error messages when starting a new job run
            clearJobExceptions(jobName);

            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/jobs/${jobId}/set-active`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ active: true })
            });

            if (response.ok) {
                setTimeout(refreshData, 1000);
            } else {
                const result = await response.json();
                console.error(`Failed to set ${jobName} (ID: ${jobId}) active: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error setting ${jobName} (ID: ${jobId}) active: ${error.message}`);
        }
    }

    // Toggle job active/inactive status
    async function toggleJobActiveStatus(jobName, jobId) {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/home/jobs/${jobId}/toggle`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(result.message, 'success');
                // Refresh the job cards to show updated status
                setTimeout(refreshData, 500);
            } else {
                const result = await response.json();
                showNotification(`Failed to toggle ${jobName.toUpperCase()}: ${result.detail}`, 'error');
            }
        } catch (error) {
            console.error(`Error toggling ${jobName} status: ${error.message}`);
            showNotification(`Error toggling ${jobName.toUpperCase()} status: ${error.message}`, 'error');
        }
    }

    async function showLogManagement() {
        // Check if jobs are running and prevent access
        const logsBtn = document.querySelector('button[onclick="showLogManagement()"]');
        if (logsBtn && logsBtn.disabled) {
            showNotification('Log management is unavailable while jobs are running', 'warning');
            return;
        }

        try {
            // Show loading state
            document.getElementById('logManagementContent').innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-2 mx-auto" style="color: var(--text-secondary);"></i>
                    <p style="color: var(--text-secondary);">Loading log files...</p>
                </div>
            `;

            // Show modal
            const modal = document.getElementById('logManagementModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.classList.remove('hidden');

            // Fetch real log data
            await loadLogManagementData();

            // Refresh Lucide icons after content is loaded
            refreshLucideIcons();

        } catch (error) {
            console.error('Failed to load log management:', error);
            showNotification('Failed to load log management: ' + error.message, 'error');
        }
    }

    async function loadLogManagementData() {
        try {
            // Get client name from server for client-specific log files
            const token = getAuthToken();
            const clientResponse = await fetch('/api/v1/auth/validate', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            let clientName = 'default';
            if (clientResponse.ok) {
                // Extract client name from environment or use default
                // For now, we'll determine this from the available log files
            }

            // Update the modal content with dynamic log files
            document.getElementById('logManagementContent').innerHTML = `
                <!-- Log Files List -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-medium" style="color: var(--text-primary);">Current Log Files</h4>
                        <div class="flex items-center space-x-2">
                            <select id="bulkCleanupDays" class="px-2 py-1 rounded text-xs border" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30" selected>30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                                <option value="0">All logs</option>
                            </select>
                            <button onclick="bulkCleanupLogs()" class="btn-crud-delete px-6 py-1 text-sm whitespace-nowrap" title="Delete files based on selected option">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>Delete All
                            </button>
                        </div>
                    </div>
                    <div id="logFilesList" class="space-y-2 p-4 rounded-lg border max-h-48 overflow-y-auto" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <!-- Log files will be populated dynamically -->
                    </div>
                </div>
            `;

            // Populate log files dynamically
            await populateLogFiles();

        } catch (error) {
            console.error('Error loading log management data:', error);
            document.getElementById('logManagementContent').innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="alert-triangle" class="w-8 h-8 mb-2 mx-auto text-red-600"></i>
                    <p class="text-red-600">Failed to load log management data</p>
                    <p class="text-sm" style="color: var(--text-secondary);">${error.message}</p>
                </div>
            `;

            // Refresh Lucide icons after error content is loaded
            refreshLucideIcons();
        }
    }

    async function populateLogFiles() {
        try {
            const logFilesList = document.getElementById('logFilesList');
            let foundFiles = [];

            // Use the logs/files API endpoint to get available files
            try {
                const token = getAuthToken();
                const response = await fetch('/api/v1/logs/files', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    foundFiles = data.files.map(file => file.filename);
                }
            } catch (e) {
                console.warn('Could not fetch log files list, using fallback approach');
            }

            // If no files found via API, try the download endpoint for common files
            if (foundFiles.length === 0) {
                const possibleLogFiles = [
                    'etl_service_wex.log',
                    'orchestrator_wex.log',
                    'etl_service_techcorp.log',
                    'orchestrator_techcorp.log',
                    'etl_service.log',  // Legacy fallback
                    'orchestrator.log'  // Legacy fallback
                ];

                // Test which files exist by trying to download them (GET only, no HEAD)
                for (const filename of possibleLogFiles) {
                    try {
                        const token = getAuthToken();
                        const response = await fetch(`/api/v1/logs/download/${filename}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Range': 'bytes=0-0'  // Just get first byte to test existence
                            }
                        });

                        if (response.ok || response.status === 206) {
                            foundFiles.push(filename);
                        }
                    } catch (e) {
                        // File doesn't exist or other error, skip
                        continue;
                    }
                }
            }

            // If still no files found, show default files
            if (foundFiles.length === 0) {
                foundFiles = ['etl_service_wex.log', 'orchestrator_wex.log'];
            }

            // Generate HTML for found files
            const filesHtml = foundFiles.map(filename => {
                const isActive = !filename.includes('.1'); // Not a rotated file
                const displayName = filename.replace('_wex', ' (WEX)').replace('_techcorp', ' (TechCorp)');

                return `
                    <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--bg-tertiary);">
                        <div>
                            <span class="font-mono text-sm" style="color: var(--text-primary);">${displayName}</span>
                            ${isActive ? '<span class="text-xs ml-2" style="color: var(--text-secondary);">(Current)</span>' : ''}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="downloadLogFile('${filename}')" class="btn-neutral-secondary text-xs px-2 py-1" title="Download">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteLogFile('${filename}')" class="btn-crud-delete text-xs px-2 py-1" title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            logFilesList.innerHTML = filesHtml;

            // Refresh Lucide icons after populating files
            refreshLucideIcons();

        } catch (error) {
            console.error('Error populating log files:', error);
            document.getElementById('logFilesList').innerHTML = `
                <div class="text-center py-4">
                    <p style="color: var(--text-secondary);">Unable to load log files</p>
                </div>
            `;

            // Refresh Lucide icons even in error state
            refreshLucideIcons();
        }
    }

    function hideLogManagement() {
        const modal = document.getElementById('logManagementModal');
        modal.style.display = 'none';
        modal.classList.add('hidden');
    }

    // Simple notification system
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm max-w-sm transition-all duration-300 transform translate-x-full`;

        // Set background color based on type
        switch (type) {
            case 'success':
                notification.style.backgroundColor = '#10b981';
                break;
            case 'error':
                notification.style.backgroundColor = '#ef4444';
                break;
            case 'warning':
                notification.style.backgroundColor = 'var(--color-1)';
                break;
            default:
                notification.style.backgroundColor = '#3b82f6';
        }

        notification.textContent = message;
        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(full)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    async function downloadLogFile(filename) {
        try {
            const token = getAuthToken();
            if (!token) {
                showNotification('Authentication required', 'error');
                return;
            }

            // Use fetch with proper Authorization header first to check if file exists
            const response = await fetch(`/api/v1/logs/download/${filename}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                // If successful, create a blob and download it
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showNotification(`Downloaded ${filename}`, 'success');
            } else {
                const errorData = await response.json().catch(() => ({ detail: 'Download failed' }));
                showNotification(`Failed to download ${filename}: ${errorData.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error downloading log file:', error);
            showNotification(`Failed to download ${filename}`, 'error');
        }
    }

    async function deleteLogFile(filename) {
        try {
            const token = getAuthToken();
            if (!token) {
                showNotification('Authentication required', 'error');
                return;
            }

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete the log file "${filename}"?`)) {
                return;
            }

            const response = await fetch(`/api/v1/logs/file/${filename}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(result.message, 'success');
                // Refresh the log files list
                await populateLogFiles();
            } else {
                const errorData = await response.json().catch(() => ({ detail: 'Delete failed' }));
                showNotification(`Failed to delete ${filename}: ${errorData.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error deleting log file:', error);
            showNotification(`Failed to delete ${filename}`, 'error');
        }
    }

    async function bulkCleanupLogs() {
        try {
            const token = getAuthToken();
            if (!token) {
                showNotification('Authentication required', 'error');
                return;
            }

            // Get selected days from dropdown
            const daysSelect = document.getElementById('bulkCleanupDays');
            const days = parseInt(daysSelect.value);

            // Confirm bulk cleanup
            const confirmMessage = days === 0
                ? 'Are you sure you want to delete ALL log files? This action cannot be undone.'
                : `Are you sure you want to delete log files older than ${days} days?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            const response = await fetch(`/api/v1/logs/cleanup?days=${days}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const result = await response.json();
                const deletedCount = result.deleted_files ? result.deleted_files.length : 0;
                const clearedCount = result.cleared_files ? result.cleared_files.length : 0;

                let message = '';
                if (deletedCount > 0 && clearedCount > 0) {
                    message = `Successfully deleted ${deletedCount} files and cleared ${clearedCount} files`;
                } else if (deletedCount > 0) {
                    message = `Successfully deleted ${deletedCount} log files`;
                } else if (clearedCount > 0) {
                    message = `Successfully cleared ${clearedCount} log files`;
                } else {
                    message = 'No log files were found to clean up';
                }

                showNotification(message, 'success');
                // Refresh the log files list
                await populateLogFiles();
            } else {
                const errorData = await response.json().catch(() => ({ detail: 'Cleanup failed' }));
                showNotification(`Failed to cleanup logs: ${errorData.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error during bulk cleanup:', error);
            showNotification('Failed to cleanup logs', 'error');
        }
    }





    function getStatusClass(status, isInactive = false) {
        // If job is inactive, use disabled styling regardless of status
        if (isInactive) {
            return 'status-badge status-badge-disabled';
        }

        // Use dedicated status badge classes (non-interactive)
        switch (status) {
            // Database status values (uppercase) - use status badge classes
            case 'RUNNING': return 'status-badge status-badge-running'; // Blue (crud-edit)
            case 'PENDING': return 'status-badge status-badge-pending'; // Blue (color-1)
            case 'FINISHED': return 'status-badge status-badge-finished'; // Green
            case 'PAUSED': return 'status-badge status-badge-paused'; // Yellow/Amber
            case 'NOT_STARTED': return 'status-badge status-badge-not-started'; // Gray
            case 'ERROR': return 'status-badge status-badge-error'; // Red
            // Special API status values
            case 'inactive': return 'status-badge status-badge-disabled'; // Gray (for inactive integrations)
            default: return 'status-badge status-badge-error';
        }
    }

    function getStatusIcon(status) {
        switch (status) {
            // Database status values (uppercase)
            case 'RUNNING': return 'loader-2'; // Will need animate-spin class
            case 'PENDING': return 'clock';
            case 'FINISHED': return 'check-circle';
            case 'PAUSED': return 'pause-circle';
            case 'NOT_STARTED': return 'circle';
            case 'ERROR': return 'alert-triangle';
            // Special API status values
            case 'inactive': return 'circle'; // For inactive integrations
            default: return 'exclamation-triangle';
        }
    }



    function getStatusDotClass(status) {
        switch (status) {
            // Database status values (uppercase)
            case 'RUNNING': return 'bg-blue-500';
            case 'PENDING': return 'status-dot-color-1';
            case 'FINISHED': return 'bg-gray-500';
            case 'PAUSED': return 'bg-orange-500';
            case 'NOT_STARTED': return 'bg-gray-400';
            case 'ERROR': return 'bg-red-500';
            // Special API status values
            case 'inactive': return 'bg-gray-400'; // For inactive integrations
            default: return 'bg-gray-400';
        }
    }

    function createWebSocketProgress(jobName) {
        const progress = jobProgress[jobName];
        // Only show progress bar if job has progress data AND percentage > 0
        if (!progress || !progress.percentage || progress.percentage === 0) {
            return '';
        }

        return `
            <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-medium text-white">Real-time Progress</span>
                    <span class="text-xs text-white">${Math.round(progress.percentage)}%</span>
                </div>
                <div class="ws-progress-container">
                    <div class="ws-progress-bar" style="width: ${progress.percentage}%"></div>
                </div>
                <div class="ws-progress-text">${progress.step}</div>
            </div>
        `;
    }

    function createExceptionLog(jobName) {
        // Safety check for jobProgress existence
        if (!jobProgress[jobName] || !jobProgress[jobName].exceptions) {
            return '';
        }

        const exceptions = jobProgress[jobName].exceptions;
        if (!exceptions || exceptions.length === 0) {
            return '';
        }

        const exceptionsHtml = exceptions.map(exception => `
            <div class="exception-item ${exception.level.toLowerCase()}">
                <div class="flex justify-between items-start">
                    <span class="font-medium">${exception.level}:</span>
                    <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="mt-1">${exception.message}</div>
            </div>
        `).join('');

        return `
            <div class="mt-4">
                <div class="text-xs font-medium text-white mb-2">Issues & Warnings</div>
                <div class="exception-log">
                    ${exceptionsHtml}
                </div>
            </div>
        `;
    }

    function updateJobCardProgress(jobRow, percentage, step) {
        // For job rows, update the progress bar at the bottom
        const progressBar = jobRow.querySelector('.job-progress');
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;

            // Show progress bar when there's actual progress
            if (percentage > 0) {
                progressBar.classList.add('visible');
            } else {
                progressBar.classList.remove('visible');
            }

            // Update job status to show RUNNING without percentage
            const statusElement = jobRow.querySelector('.job-status');
            if (statusElement && percentage > 0 && percentage < 100) {
                statusElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>RUNNING`;
                // Keep the proper status badge classes with background color
                statusElement.className = 'job-status status-badge status-badge-running';
            }

            // Add tooltip with step information and percentage
            jobRow.title = `${step} (${Math.round(percentage)}%)`;
        }
    }

    function updateJobCardExceptions(jobCard, exceptions) {
        let exceptionSection = jobCard.querySelector('.exception-log');
        if (!exceptionSection && exceptions.length > 0) {
            const progressSection = jobCard.querySelector('.ws-progress-container');
            const insertPoint = progressSection ? progressSection.parentElement : jobCard.querySelector('.space-y-3');
            if (insertPoint) {
                const exceptionHtml = createExceptionLog(jobCard.getAttribute('data-job'));
                insertPoint.insertAdjacentHTML('afterend', exceptionHtml);
                exceptionSection = jobCard.querySelector('.exception-log');
            }
        }

        if (exceptionSection && exceptions.length > 0) {
            const exceptionsHtml = exceptions.map(exception => `
                <div class="exception-item ${exception.level.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <span class="font-medium">${exception.level}:</span>
                        <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-1">${exception.message}</div>
                </div>
            `).join('');
            exceptionSection.innerHTML = exceptionsHtml;
        }
    }

    function updateJobCardStatus(jobCard, status) {
        const statusSpan = jobCard.querySelector('.text-sm');
        if (statusSpan) {
            // Check if the job is inactive by looking at the toggle switch
            const toggleSwitch = jobCard.querySelector('.toggle-switch');
            const isInactive = toggleSwitch && !toggleSwitch.classList.contains('active');

            const statusClass = getStatusClass(status, isInactive);
            const statusIcon = getStatusIcon(status);
            statusSpan.className = `text-sm ${statusClass}`;
            statusSpan.innerHTML = `<i class="fas fa-${statusIcon} mr-1"></i>${status}`;
        }
    }

    // Job action functions
    async function forceStart(jobName) {
        if (!confirm(`Are you sure you want to force start ${jobName.toUpperCase()}?`)) return;

        try {
            // Clear any existing error messages when starting a job
            clearJobExceptions(jobName);

            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch(`/api/v1/jobs/${jobName}/start`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                refreshData();
            } else {
                console.error(`Failed to start ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error starting ${jobName}: ${error.message}`);
        }
    }

    async function forceStop(jobName) {
        if (!confirm(`Are you sure you want to force stop ${jobName.toUpperCase()}?`)) return;

        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobName}/stop`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log(`${jobName} stopped successfully`);
                refreshData();
            } else {
                console.error(`Failed to stop ${jobName}: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error stopping ${jobName}: ${error.message}`);
        }
    }

    async function pauseJob(jobName, jobId) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobId}/pause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            console.log(`[PAUSE] Response for ${jobName}:`, result);
            if (response.ok) {
                console.log(`[PAUSE] ${jobName} paused successfully, refreshing data...`);
                await refreshData();
            } else {
                console.error(`[PAUSE] Failed to pause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error pausing ${jobName}: ${error.message}`);
        }
    }

    async function unpauseJob(jobName, jobId) {
        try {
            const token = getAuthToken();
            const response = await fetch(`/api/v1/jobs/${jobId}/unpause`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            console.log(`[UNPAUSE] Response for ${jobName}:`, result);
            if (response.ok) {
                console.log(`[UNPAUSE] ${jobName} unpaused successfully - new status: ${result.status}, refreshing data...`);
                await refreshData();
            } else {
                console.error(`[UNPAUSE] Failed to unpause ${jobName}: ${result.detail || result.message}`);
            }
        } catch (error) {
            console.error(`Error unpausing ${jobName}: ${error.message}`);
        }
    }



    // Orchestrator Control Functions
    let orchestratorStarting = false; // Prevent multiple simultaneous starts

    function disableOrchestratorButtons() {
        // Disable pause/resume button
        const pauseBtn = document.getElementById('pauseOrchestratorBtn');
        if (pauseBtn) {
            pauseBtn.disabled = true;
            pauseBtn.className = 'btn-status-warning-sm opacity-50 cursor-not-allowed';
            pauseBtn.title = 'Orchestrator starting...';
        }

        // Disable logs button
        const logsBtn = document.querySelector('button[onclick="showLogManagement()"]');
        if (logsBtn) {
            logsBtn.disabled = true;
            logsBtn.className = 'btn-neutral-secondary opacity-50 cursor-not-allowed';
            logsBtn.title = 'Logs unavailable while orchestrator is starting';
        }

        // Disable settings button
        const settingsBtn = document.querySelector('button[onclick="showOrchestratorSettings()"]');
        if (settingsBtn) {
            settingsBtn.disabled = true;
            settingsBtn.className = 'btn-neutral-primary-sm opacity-50 cursor-not-allowed';
            settingsBtn.title = 'Settings unavailable while orchestrator is starting';
        }
    }

    function disableAllJobButtons() {
        // Get all job cards and disable their action buttons
        const jobCards = document.querySelectorAll('[data-job]');
        jobCards.forEach(jobCard => {
            const actionButtons = jobCard.querySelectorAll('.action-icon-btn');
            actionButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('force-pending', 'pause-resume', 'resume', 'details');
                btn.classList.add('disabled');

                // Update title based on button type
                const icon = btn.querySelector('i');
                if (icon) {
                    if (icon.classList.contains('fa-clock') || icon.getAttribute('data-lucide') === 'clock') {
                        btn.title = 'Cannot activate while orchestrator is starting';
                    } else if (icon.classList.contains('fa-pause') || icon.getAttribute('data-lucide') === 'pause' ||
                              icon.classList.contains('fa-play') || icon.getAttribute('data-lucide') === 'play') {
                        btn.title = 'Cannot pause/resume while orchestrator is starting';
                    } else if (icon.classList.contains('fa-info') || icon.getAttribute('data-lucide') === 'info') {
                        btn.title = 'Details unavailable while orchestrator is starting';
                    }
                }
            });
        });
    }

    async function forceStartOrchestrator() {
        const button = event.target.closest('button');

        if (button.disabled || orchestratorStarting) {
            console.warn('Cannot start orchestrator - already starting or jobs are running');
            return;
        }

        // Set flag to prevent multiple simultaneous starts
        orchestratorStarting = true;

        // Clear error messages for all jobs when starting orchestrator
        clearJobExceptions('Jira');
        clearJobExceptions('GitHub');

        const originalText = button.innerHTML;

        try {
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;

            // Immediately disable all orchestrator control buttons
            disableOrchestratorButtons();

            // Immediately disable all job action buttons
            disableAllJobButtons();

            // Refresh Lucide icons after button state changes
            refreshLucideIcons();



            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                // Refresh both job data and orchestrator status after a short delay
                // Don't re-enable buttons here - let the refresh functions handle proper state
                setTimeout(() => {
                    refreshData();
                    refreshOrchestratorStatus();
                    // Reset the orchestrator starting flag after refresh
                    orchestratorStarting = false;
                    // Reset the force start button
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 1000);
            } else {
                console.error(`Failed to start orchestrator: ${result.detail}`);
                // Re-enable buttons on error
                button.innerHTML = originalText;
                button.disabled = false;
                orchestratorStarting = false;
                // Refresh to restore proper button states
                refreshData();
                refreshOrchestratorStatus();
            }
        } catch (error) {
            console.error(`Error starting orchestrator: ${error.message}`);
            // Re-enable buttons on error
            button.innerHTML = originalText;
            button.disabled = false;
            orchestratorStarting = false;
            // Refresh to restore proper button states
            refreshData();
            refreshOrchestratorStatus();
        }
    }

    async function pauseOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/pause', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to pause orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error pausing orchestrator: ${error.message}`);
        }
    }

    async function resumeOrchestrator() {
        try {
            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/resume', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                setTimeout(refreshOrchestratorStatus, 500);
            } else {
                console.error(`Failed to resume orchestrator: ${result.detail}`);
            }
        } catch (error) {
            console.error(`Error resuming orchestrator: ${error.message}`);
        }
    }

    async function toggleOrchestratorPause() {
        // Get current status from the pause button to determine action
        const pauseBtn = document.getElementById('pauseOrchestratorBtn');
        const buttonTitle = pauseBtn ? pauseBtn.title.toLowerCase() : '';

        if (buttonTitle === 'resume') {
            await resumeOrchestrator();
        } else {
            await pauseOrchestrator();
        }
    }

    async function refreshOrchestratorSchedule() {
        const button = document.getElementById('refreshScheduleBtn');
        const originalText = button.innerHTML;

        try {
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
            button.disabled = true;

            const token = getAuthToken();
            const response = await fetch('/api/v1/orchestrator/reinitialize', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();
            if (response.ok) {
                console.log('Orchestrator schedule refreshed successfully');
                // Refresh the orchestrator status to show updated countdown
                setTimeout(refreshOrchestratorStatus, 500);
                // Show success message briefly
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Refreshed!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            } else {
                console.error(`Failed to refresh orchestrator schedule: ${result.detail}`);
                button.innerHTML = '<i class="fas fa-times mr-1"></i>Failed';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        } catch (error) {
            console.error(`Error refreshing orchestrator schedule: ${error.message}`);
            button.innerHTML = '<i class="fas fa-times mr-1"></i>Error';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
    }

    async function refreshOrchestratorStatus() {
        try {
            const token = getAuthToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch('/api/v1/orchestrator/status', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                console.error('Authentication failed - token may be expired');
                handleAuthenticationFailure();
                return;
            }

            if (response.ok) {
                const status = await response.json();
                updateOrchestratorUI(status);
            } else {
                console.error('Failed to fetch orchestrator status:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error fetching orchestrator status:', error);
        }
    }

    let countdownInterval = null;

    function updateOrchestratorUI(status) {
        const statusDot = document.getElementById('orchestratorStatusDot');
        const pauseBtn = document.getElementById('pauseOrchestratorBtn');
        const runNowBtn = document.getElementById('forceStartOrchestratorBtn');
        const logsBtn = document.querySelector('button[onclick="showLogManagement()"]');
        const settingsBtn = document.querySelector('button[onclick="showOrchestratorSettings()"]');
        const countdownTimer = document.getElementById('countdownTimer');

        if (statusDot) {
            // Update status dot color based on status
            statusDot.className = 'w-2 h-2 rounded-full ';
            if (status.status === 'paused') {
                statusDot.className += 'bg-yellow-500';
                if (pauseBtn) {
                    pauseBtn.classList.remove('hidden');
                    pauseBtn.className = 'btn-status-success-sm';
                    pauseBtn.innerHTML = '<i data-lucide="play"></i>';
                    pauseBtn.title = 'Resume';
                    pauseBtn.disabled = false;
                    refreshLucideIcons();
                }
                if (runNowBtn) {
                    runNowBtn.disabled = false;
                    runNowBtn.className = 'action-icon-btn force-pending';
                    runNowBtn.title = 'Run Now';
                }
                // Enable logs and settings buttons when paused
                if (logsBtn) {
                    logsBtn.disabled = false;
                    logsBtn.className = 'btn-neutral-secondary';
                    logsBtn.title = 'Logs';
                }
                if (settingsBtn) {
                    settingsBtn.disabled = false;
                    settingsBtn.className = 'btn-neutral-primary-sm';
                    settingsBtn.title = 'Settings';
                }
                stopCountdownTimer();
            } else {
                // Active orchestrator - show green dot
                statusDot.className += 'bg-green-500';

                // Check if jobs are running to disable/enable buttons
                const jobsRunning = status.any_job_running;

                if (pauseBtn) {
                    pauseBtn.classList.remove('hidden');
                    pauseBtn.innerHTML = '<i data-lucide="pause"></i>';
                    pauseBtn.title = 'Pause';
                    refreshLucideIcons();
                    if (jobsRunning) {
                        pauseBtn.disabled = true;
                        pauseBtn.className = 'btn-status-warning-sm opacity-50 cursor-not-allowed';
                    } else {
                        pauseBtn.disabled = false;
                        pauseBtn.className = 'btn-status-warning-sm';
                    }
                }

                if (runNowBtn) {
                    if (jobsRunning) {
                        runNowBtn.disabled = true;
                        runNowBtn.className = 'action-icon-btn force-pending opacity-50 cursor-not-allowed';
                        runNowBtn.title = 'Cannot run while jobs are running';
                    } else {
                        runNowBtn.disabled = false;
                        runNowBtn.className = 'action-icon-btn force-pending';
                        runNowBtn.title = 'Run Now';
                    }
                }

                // Disable/enable logs and settings buttons based on job status
                if (logsBtn) {
                    if (jobsRunning) {
                        logsBtn.disabled = true;
                        logsBtn.className = 'btn-neutral-secondary opacity-50 cursor-not-allowed';
                        logsBtn.title = 'Logs unavailable while jobs are running';
                    } else {
                        logsBtn.disabled = false;
                        logsBtn.className = 'btn-neutral-secondary';
                        logsBtn.title = 'Logs';
                    }
                }

                if (settingsBtn) {
                    if (jobsRunning) {
                        settingsBtn.disabled = true;
                        settingsBtn.className = 'btn-neutral-primary-sm opacity-50 cursor-not-allowed';
                        settingsBtn.title = 'Settings unavailable while jobs are running';
                    } else {
                        settingsBtn.disabled = false;
                        settingsBtn.className = 'btn-neutral-primary-sm';
                        settingsBtn.title = 'Settings';
                    }
                }

                // Show/hide countdown based on whether jobs are running
                if (status.show_countdown && status.next_run) {
                    startCountdownTimer(status.next_run);
                    if (countdownTimer) {
                        countdownTimer.style.opacity = '1';
                    }
                } else {
                    stopCountdownTimer();
                    if (countdownTimer) {
                        countdownTimer.style.opacity = '0.3';
                        countdownTimer.textContent = 'Jobs running...';
                    }
                }
            }
        }
    }

    function startCountdownTimer(nextRunTime) {
        stopCountdownTimer();

        if (!nextRunTime) {
            document.getElementById('countdownTimer').textContent = '--:--:--';
            return;
        }

        const nextRun = new Date(nextRunTime);

        countdownInterval = setInterval(() => {
            const now = new Date();
            const timeDiff = nextRun - now;

            if (timeDiff <= 0) {
                document.getElementById('countdownTimer').textContent = '00:00:00';
                // Check status more frequently when timer expires (orchestrator should be running)
                setTimeout(refreshOrchestratorStatus, 2000);
                setTimeout(refreshOrchestratorStatus, 5000);
                setTimeout(refreshOrchestratorStatus, 10000);
                return;
            }

            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('countdownTimer').textContent = timeString;
        }, 1000);
    }

    function stopCountdownTimer() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        document.getElementById('countdownTimer').textContent = '--:--:--';
    }

    // Logout function
    async function logout() {
        try {
            // Get token before clearing localStorage
            const token = getAuthToken();

            if (token) {
                // Call Backend Service directly to invalidate session
                const response = await fetch('http://localhost:3001/api/v1/admin/auth/invalidate-session', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
            }
        } catch (error) {
            // Silently handle session invalidation errors
        }

        // Clear localStorage
        localStorage.removeItem('pulse_token');

        // ETL service logout to clear cookies and redirect
        window.location.href = '/logout';
    }

    // Orchestrator Settings Functions
    async function showOrchestratorSettings() {
        // Check if jobs are running and prevent access
        const settingsBtn = document.querySelector('button[onclick="showOrchestratorSettings()"]');
        if (settingsBtn && settingsBtn.disabled) {
            showNotification('Orchestrator settings are unavailable while jobs are running', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/v1/settings', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const settings = data.settings;

                const intervalSelect = document.getElementById('orchestratorInterval');
                const enabledCheckbox = document.getElementById('orchestratorEnabled');
                const retryEnabledCheckbox = document.getElementById('orchestratorRetryEnabled');
                const retryIntervalSelect = document.getElementById('orchestratorRetryInterval');
                const maxRetryAttemptsSelect = document.getElementById('orchestratorMaxRetryAttempts');

                if (settings.orchestrator_interval_minutes) {
                    intervalSelect.value = settings.orchestrator_interval_minutes.value;
                }

                if (settings.orchestrator_enabled) {
                    enabledCheckbox.checked = settings.orchestrator_enabled.value;
                }

                if (settings.orchestrator_retry_enabled) {
                    retryEnabledCheckbox.checked = settings.orchestrator_retry_enabled.value;
                }

                if (settings.orchestrator_retry_interval_minutes) {
                    retryIntervalSelect.value = settings.orchestrator_retry_interval_minutes.value;
                }

                if (settings.orchestrator_max_retry_attempts) {
                    maxRetryAttemptsSelect.value = settings.orchestrator_max_retry_attempts.value;
                }
            }

            document.getElementById('orchestratorSettingsModal').classList.remove('hidden');

        } catch (error) {
            console.error('Failed to load orchestrator settings:', error);
        }
    }

    function hideOrchestratorSettings() {
        document.getElementById('orchestratorSettingsModal').classList.add('hidden');
    }

    async function saveOrchestratorSettings() {
        try {
            const intervalSelect = document.getElementById('orchestratorInterval');
            const enabledCheckbox = document.getElementById('orchestratorEnabled');
            const retryEnabledCheckbox = document.getElementById('orchestratorRetryEnabled');
            const retryIntervalSelect = document.getElementById('orchestratorRetryInterval');
            const maxRetryAttemptsSelect = document.getElementById('orchestratorMaxRetryAttempts');

            const intervalMinutes = parseInt(intervalSelect.value);
            const enabled = enabledCheckbox.checked;
            const retryEnabled = retryEnabledCheckbox.checked;
            const retryIntervalMinutes = parseInt(retryIntervalSelect.value);
            const maxRetryAttempts = parseInt(maxRetryAttemptsSelect.value);

            // Save orchestrator schedule settings
            const scheduleResponse = await fetch('/api/v1/orchestrator/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    interval_minutes: intervalMinutes,
                    enabled: enabled
                })
            });

            // Save retry settings
            const retryResponse = await fetch('/api/v1/settings/bulk', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    settings: [
                        {
                            key: 'orchestrator_retry_enabled',
                            value: retryEnabled,
                            description: 'Enable orchestrator fast retry for failed jobs'
                        },
                        {
                            key: 'orchestrator_retry_interval_minutes',
                            value: retryIntervalMinutes,
                            description: 'Interval in minutes for orchestrator retry attempts'
                        },
                        {
                            key: 'orchestrator_max_retry_attempts',
                            value: maxRetryAttempts,
                            description: 'Maximum number of retry attempts (0 = unlimited)'
                        }
                    ]
                })
            });

            if (scheduleResponse.ok && retryResponse.ok) {

                hideOrchestratorSettings();
                setTimeout(refreshOrchestratorStatus, 1000);
            } else {
                if (!scheduleResponse.ok) {
                    const scheduleResult = await scheduleResponse.json();
                    console.error(`Failed to update orchestrator schedule: ${scheduleResult.detail}`);
                }
                if (!retryResponse.ok) {
                    const retryResult = await retryResponse.json();
                    console.error(`Failed to update retry settings: ${retryResult.detail}`);
                }
            }

        } catch (error) {
            console.error('Failed to save orchestrator settings:', error);
        }
    }

    // Job Details Modal Functions
    async function showJobDetails(jobName, jobId) {
        try {
            if (jobName.toLowerCase() === 'jira') {
                // Show Jira-specific modal with summary data
                await showJiraDetailsModal();
                return;
            }

            if (jobName.toLowerCase() === 'github') {
                // Show GitHub-specific modal with summary data
                await showGitHubDetailsModal();
                return;
            }

            if (jobName.toLowerCase() === 'vectorization') {
                // Show Vectorization-specific modal with queue and vector data
                await showVectorizationDetailsModal();
                return;
            }

            // For other jobs, show regular job details using job ID
            const response = await fetch(`/api/v1/jobs/${jobId}/details`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const jobDetails = await response.json();

                // Set icon and title based on job type
                const jobIcon = document.getElementById('jobDetailsIcon');
                const jobTitle = document.getElementById('jobDetailsTitle');

                if (jobName.toLowerCase() === 'github') {
                    jobIcon.innerHTML = '<i class="fab fa-github mr-2" style="color: var(--text-primary);"></i>';
                    jobTitle.textContent = 'GitHub Sync Job Details';
                } else {
                    jobIcon.innerHTML = '<i class="fas fa-info-circle mr-2"></i>';
                    jobTitle.textContent = `${jobName.replace('_', ' ').toUpperCase()} Details`;
                }

                const content = document.getElementById('jobDetailsContent');
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basic Information -->
                        <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                                <i class="fas fa-cog mr-2"></i>Basic Information
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Job ID:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.id || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Status:</span>
                                    <span class="font-semibold" style="color: var(--text-primary);">${jobDetails.status}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Active:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.active ? 'Yes' : 'No'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Retry Count:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.retry_count}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Timing Information -->
                        <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                                <i class="fas fa-clock mr-2"></i>Timing Information
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Created:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.created_at ? new Date(jobDetails.created_at).toLocaleString() : 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Last Updated:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.last_updated_at ? new Date(jobDetails.last_updated_at).toLocaleString() : 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Last Run Started:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.last_run_started_at ? new Date(jobDetails.last_run_started_at).toLocaleString() : 'Never'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Last Success:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.last_success_at ? new Date(jobDetails.last_success_at).toLocaleString() : 'Never'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Job Status Info -->
                        <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                                <i class="fas fa-chart-line mr-2"></i>Job Status
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Is Recovery Run:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.is_recovery_run ? 'Yes' : 'No'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Has Checkpoints:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.checkpoint_data ? 'Yes' : 'No'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info -->
                        <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                                <i class="fas fa-info-circle mr-2"></i>Additional Info
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Current PR Node:</span>
                                    <span class="font-mono text-xs" style="color: var(--text-primary);">${jobDetails.current_pr_node_id || 'None'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Repo Checkpoint:</span>
                                    <span style="color: var(--text-primary);">${jobDetails.last_repo_sync_checkpoint ? new Date(jobDetails.last_repo_sync_checkpoint).toLocaleString() : 'None'}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Checkpoint Data -->
                    <div class="mt-4 rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                            <i class="fas fa-bookmark mr-2"></i>Checkpoint Data
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <span style="color: var(--text-secondary);">PR Cursor:</span>
                                <div class="p-2 rounded mt-1 font-mono text-xs" style="color: var(--text-primary); background-color: var(--bg-tertiary);">
                                    ${jobDetails.last_pr_cursor || 'None'}
                                </div>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Commit Cursor:</span>
                                <div class="p-2 rounded mt-1 font-mono text-xs" style="color: var(--text-primary); background-color: var(--bg-tertiary);">
                                    ${jobDetails.last_commit_cursor || 'None'}
                                </div>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Review Cursor:</span>
                                <div class="p-2 rounded mt-1 font-mono text-xs" style="color: var(--text-primary); background-color: var(--bg-tertiary);">
                                    ${jobDetails.last_review_cursor || 'None'}
                                </div>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Comment Cursor:</span>
                                <div class="p-2 rounded mt-1 font-mono text-xs" style="color: var(--text-primary); background-color: var(--bg-tertiary);">
                                    ${jobDetails.last_comment_cursor || 'None'}
                                </div>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Review Thread Cursor:</span>
                                <div class="p-2 rounded mt-1 font-mono text-xs" style="color: var(--text-primary); background-color: var(--bg-tertiary);">
                                    ${jobDetails.last_review_thread_cursor || 'None'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Repository Processing Queue -->
                    ${jobDetails.repo_processing_queue ? `
                    <div class="mt-4 rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-md font-semibold" style="color: var(--text-primary);">
                                <i class="fas fa-list mr-2"></i>Repository Processing Queue
                            </h3>
                            <div class="text-sm" style="color: var(--text-secondary);" id="repoQueueStats">
                                ${(() => {
                                    try {
                                        const queue = typeof jobDetails.repo_processing_queue === 'string'
                                            ? JSON.parse(jobDetails.repo_processing_queue)
                                            : jobDetails.repo_processing_queue;
                                        const finished = queue.filter(repo => repo.finished).length;
                                        const pending = queue.length - finished;
                                        return `
                                            <span class="text-green-600 font-medium">${finished} Finished</span>
                                            <span class="mx-2">â€¢</span>
                                            <span class="text-yellow-600 font-medium">${pending} Pending</span>
                                            <span class="mx-2">â€¢</span>
                                            <span class="font-medium" style="color: var(--text-secondary);">${queue.length} Total</span>
                                        `;
                                    } catch (e) {
                                        return '<span class="text-red-600">Error parsing data</span>';
                                    }
                                })()}
                            </div>
                        </div>
                        <div class="max-h-64 overflow-y-auto border rounded" style="border-color: var(--border-color);">
                            <table class="w-full text-sm">
                                <thead class="sticky top-0 border-b" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                    <tr>
                                        <th class="text-left py-2 px-3" style="color: var(--text-secondary);">Repo ID</th>
                                        <th class="text-left py-2 px-3" style="color: var(--text-secondary);">Full Name</th>
                                        <th class="text-center py-2 px-3" style="color: var(--text-secondary);">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(() => {
                                        try {
                                            const queue = typeof jobDetails.repo_processing_queue === 'string'
                                                ? JSON.parse(jobDetails.repo_processing_queue)
                                                : jobDetails.repo_processing_queue;
                                            return queue.slice(0, 10).map((repo, index) => `
                                                <tr class="border-b hover:bg-opacity-30" style="border-color: var(--border-color);">
                                                    <td class="py-2 px-3 font-mono text-xs" style="color: var(--text-primary);">${repo.repo_id || 'N/A'}</td>
                                                    <td class="py-2 px-3" style="color: var(--text-primary);">${repo.full_name || 'N/A'}</td>
                                                    <td class="py-2 px-3 text-center">
                                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${repo.finished ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                            <i class="fas fa-${repo.finished ? 'check' : 'clock'} mr-1"></i>
                                                            ${repo.finished ? 'Finished' : 'Pending'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('');
                                        } catch (e) {
                                            return '<tr><td colspan="3" class="py-2 px-3 text-red-600">Error parsing queue data</td></tr>';
                                        }
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <!-- GitHub Rate Limits (only for GitHub job) -->
                    ${jobName.toLowerCase() === 'github' ? `
                    <div class="mt-4 rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-md font-semibold" style="color: var(--text-primary);">
                                <i class="fas fa-tachometer-alt mr-2"></i>GitHub API Rate Limits
                            </h3>
                            <button onclick="loadGitHubRateLimitsInDetails()" class="text-xs px-2 py-1 rounded" style="background-color: var(--color-1); color: white;">
                                <i class="fas fa-sync mr-1"></i>Refresh
                            </button>
                        </div>
                        <div id="rateLimitsInDetails">
                            <div class="text-center py-2">
                                <span style="color: var(--text-muted);">Click Refresh to load rate limits</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Error Message -->
                    ${jobDetails.error_message ? `
                    <div class="mt-4 rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <button onclick="toggleErrorMessage()" class="w-full text-left flex justify-between items-center">
                            <h3 class="text-md font-semibold" style="color: var(--status-error);">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Error Message
                            </h3>
                            <i id="errorToggleIcon" class="fas fa-chevron-down" style="color: var(--status-error);"></i>
                        </button>
                        <div id="errorMessageContent" class="hidden mt-2 p-2 rounded text-sm max-h-32 overflow-y-auto" style="color: var(--status-error); background-color: rgba(var(--status-error-rgb), 0.1);">
                            ${jobDetails.error_message}
                        </div>
                    </div>
                    ` : ''}
                `;
            } else {
                document.getElementById('jobDetailsContent').innerHTML = `
                    <div class="text-center py-4">
                        <span style="color: var(--text-muted);">Failed to load job details</span>
                    </div>
                `;
            }

            // Show modal with proper display
            const modal = document.getElementById('jobDetailsModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.classList.remove('hidden');
            modal.classList.add('modal-show');

        } catch (error) {
            console.error('Failed to load job details:', error);
        }
    }

    function hideJobDetails() {
        const modal = document.getElementById('jobDetailsModal');
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('modal-show');
    }

    function closeJobDetailsModal() {
        hideJobDetails();
    }

    function toggleErrorMessage() {
        const content = document.getElementById('errorMessageContent');
        const icon = document.getElementById('errorToggleIcon');

        if (content && icon) {
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
    }

    // Jira-specific modal functions
    async function showJiraDetailsModal() {
        try {
            // Fetch Jira summary data from API
            const response = await fetch('/api/v1/jobs/Jira/summary', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch Jira summary: ${response.statusText}`);
            }

            const summary = await response.json();
            displayJiraDetailsModal(summary);

        } catch (error) {
            console.error('Error fetching Jira details:', error);
            showNotification('Failed to load Jira details: ' + error.message, 'error');
        }
    }

    function displayJiraDetailsModal(summary) {
        // Set icon and title for Jira
        const jobIcon = document.getElementById('jobDetailsIcon');
        const jobTitle = document.getElementById('jobDetailsTitle');

        jobIcon.innerHTML = '<i class="fab fa-atlassian mr-2" style="color: #0052CC;"></i>';
        jobTitle.textContent = 'Jira Sync Job Details';

        // Create Jira-specific content with compact layout for Full HD screens
        const content = document.getElementById('jobDetailsContent');
        content.innerHTML = `
            <!-- All 6 cards in 2 rows of 3 columns for compact layout -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <!-- Projects Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-project-diagram mr-2"></i>Projects
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.projects?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.projects?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.tables?.projects?.inactive_count || 0}</span>
                        </div>
                    </div>
                </div>

                <!-- Issue Types Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-tags mr-2"></i>Work Item Types
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.wits?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.wits?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.tables?.wits?.inactive_count || 0}</span>
                        </div>
                    </div>
                </div>

                <!-- Statuses Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-flag mr-2"></i>Statuses
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.statuses?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.statuses?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.tables?.statuses?.inactive_count || 0}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row: Issues, Changelogs, PR Links -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <!-- Issues Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-ticket-alt mr-2"></i>Issues
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.issues?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.issues?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.tables?.issues?.inactive_count || 0}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t" style="border-color: var(--border-color);">
                            <div class="text-xs" style="color: var(--text-secondary);">Top Types:</div>
                            ${(summary.tables?.issues?.top_types || []).slice(0, 3).map(type => `
                                <div class="flex justify-between text-xs">
                                    <span style="color: var(--text-muted);">${type.name}:</span>
                                    <span class="text-blue-600">${type.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Changelogs Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-history mr-2"></i>Changelogs
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.changelogs?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.changelogs?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Recent (30d):</span>
                            <span class="font-medium text-blue-600">${summary.tables?.changelogs?.recent_activity_30d || 0}</span>
                        </div>
                    </div>
                </div>

                <!-- PR Links Summary -->
                <div class="rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-link mr-2"></i>PR Links
                    </h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.tables?.jira_pull_request_links?.total_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.tables?.jira_pull_request_links?.active_count || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Repositories:</span>
                            <span class="font-medium text-purple-600">${summary.tables?.jira_pull_request_links?.unique_repositories || 0}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t" style="border-color: var(--border-color);">
                            <div class="text-xs" style="color: var(--text-secondary);">PR Status:</div>
                            ${(summary.tables?.jira_pull_request_links?.pr_status_breakdown || []).slice(0, 2).map(status => `
                                <div class="flex justify-between text-xs">
                                    <span style="color: var(--text-muted);">${status.status}:</span>
                                    <span class="text-blue-600">${status.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>


        `;

        // Show modal with proper display
        const modal = document.getElementById('jobDetailsModal');
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.remove('hidden');
    }

    // GitHub-specific modal functions
    async function showGitHubDetailsModal() {
        try {
            // Fetch GitHub summary data from API
            const response = await fetch('/api/v1/jobs/GitHub/summary', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch GitHub summary: ${response.statusText}`);
            }

            const summary = await response.json();
            displayGitHubDetailsModal(summary);

        } catch (error) {
            console.error('Error fetching GitHub details:', error);
            showNotification('Failed to load GitHub details: ' + error.message, 'error');
        }
    }

    function displayGitHubDetailsModal(summary) {
        // Set icon and title for GitHub
        const jobIcon = document.getElementById('jobDetailsIcon');
        const jobTitle = document.getElementById('jobDetailsTitle');

        jobIcon.innerHTML = '<i class="fab fa-github mr-2"></i>';
        jobTitle.textContent = 'GitHub Sync Job Details';

        // Create GitHub-specific content with 4-row layout
        const content = `
            <!-- Row 1: GitHub Rate Limits (Auto-displayed at top) -->
            <div class="mb-4 rounded-lg p-3 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md font-semibold" style="color: var(--text-primary);">
                        <i class="fas fa-tachometer-alt mr-2"></i>GitHub API Rate Limits
                    </h3>
                    <button onclick="loadGitHubRateLimitsInDetails()" class="text-xs px-2 py-1 rounded" style="background-color: var(--color-1); color: white;">
                        <i class="fas fa-sync mr-1"></i>Refresh
                    </button>
                </div>
                <div id="rateLimitsInDetails">
                    <div class="text-center py-2">
                        <span style="color: var(--text-muted);">Loading rate limits...</span>
                    </div>
                </div>
            </div>

            <!-- Row 2: Repositories, Pull Requests, Reviews/Commits/Comments (Same Height) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4" style="min-height: 200px;">

                <!-- Column 1: Repositories -->
                <div class="rounded-lg p-3 border h-full flex flex-col" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fab fa-github mr-2"></i>Repositories
                    </h3>
                    <div class="space-y-1 text-sm flex-1">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.repositories?.total || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.repositories?.active || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.repositories?.inactive || 0}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t" style="border-color: var(--border-color);">
                            <div class="text-xs" style="color: var(--text-secondary);">Top Languages:</div>
                            ${(summary.repositories?.top_languages || []).slice(0, 3).map(lang => `
                                <div class="flex justify-between text-xs">
                                    <span style="color: var(--text-muted);">${lang.language}:</span>
                                    <span class="text-blue-600">${lang.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Column 2: Pull Requests -->
                <div class="rounded-lg p-3 border h-full flex flex-col" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <h3 class="text-md font-semibold mb-2" style="color: var(--text-primary);">
                        <i class="fas fa-code-branch mr-2"></i>Pull Requests
                    </h3>
                    <div class="space-y-1 text-sm flex-1">
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Total:</span>
                            <span class="font-medium" style="color: var(--text-primary);">${summary.pull_requests?.total || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Active:</span>
                            <span class="font-medium text-green-600">${summary.pull_requests?.active || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: var(--text-secondary);">Inactive:</span>
                            <span class="font-medium" style="color: var(--text-muted);">${summary.pull_requests?.inactive || 0}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t" style="border-color: var(--border-color);">
                            <div class="text-xs" style="color: var(--text-secondary);">Code Changes:</div>
                            <div class="flex justify-between text-xs">
                                <span style="color: var(--text-muted);">Additions:</span>
                                <span class="text-green-600">+${(summary.pull_requests?.total_additions || 0).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span style="color: var(--text-muted);">Deletions:</span>
                                <span class="text-red-600">-${(summary.pull_requests?.total_deletions || 0).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span style="color: var(--text-muted);">Files:</span>
                                <span class="text-blue-600">${(summary.pull_requests?.total_changed_files || 0).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Reviews, Commits, Comments (Stacked) -->
                <div class="h-full flex flex-col gap-2">
                    <!-- Reviews -->
                    <div class="rounded-lg p-2 border flex-1" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <h4 class="text-sm font-semibold mb-1" style="color: var(--text-primary);">
                            <i class="fas fa-eye mr-1"></i>Reviews
                        </h4>
                        <div class="grid grid-cols-3 gap-1 text-center text-xs">
                            <div>
                                <div class="font-medium" style="color: var(--text-primary);">${summary.reviews?.total || 0}</div>
                                <div style="color: var(--text-secondary);">Total</div>
                            </div>
                            <div>
                                <div class="font-medium text-green-600">${summary.reviews?.active || 0}</div>
                                <div style="color: var(--text-secondary);">Active</div>
                            </div>
                            <div>
                                <div class="font-medium" style="color: var(--text-muted);">${summary.reviews?.inactive || 0}</div>
                                <div style="color: var(--text-secondary);">Inactive</div>
                            </div>
                        </div>
                    </div>

                    <!-- Commits -->
                    <div class="rounded-lg p-2 border flex-1" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <h4 class="text-sm font-semibold mb-1" style="color: var(--text-primary);">
                            <i class="fas fa-code-commit mr-1"></i>Commits
                        </h4>
                        <div class="grid grid-cols-3 gap-1 text-center text-xs">
                            <div>
                                <div class="font-medium" style="color: var(--text-primary);">${summary.commits?.total || 0}</div>
                                <div style="color: var(--text-secondary);">Total</div>
                            </div>
                            <div>
                                <div class="font-medium text-green-600">${summary.commits?.active || 0}</div>
                                <div style="color: var(--text-secondary);">Active</div>
                            </div>
                            <div>
                                <div class="font-medium" style="color: var(--text-muted);">${summary.commits?.inactive || 0}</div>
                                <div style="color: var(--text-secondary);">Inactive</div>
                            </div>
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="rounded-lg p-2 border flex-1" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <h4 class="text-sm font-semibold mb-1" style="color: var(--text-primary);">
                            <i class="fas fa-comments mr-1"></i>Comments
                        </h4>
                        <div class="grid grid-cols-3 gap-1 text-center text-xs">
                            <div>
                                <div class="font-medium" style="color: var(--text-primary);">${summary.comments?.total || 0}</div>
                                <div style="color: var(--text-secondary);">Total</div>
                            </div>
                            <div>
                                <div class="font-medium text-green-600">${summary.comments?.active || 0}</div>
                                <div style="color: var(--text-secondary);">Active</div>
                            </div>
                            <div>
                                <div class="font-medium" style="color: var(--text-muted);">${summary.comments?.inactive || 0}</div>
                                <div style="color: var(--text-secondary);">Inactive</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Recovery Information (Full Width) -->
            <div class="mb-4 rounded-lg p-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
                    <i class="fas fa-redo mr-2"></i>Recovery Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Recovery State -->
                    <div>
                        <h4 class="text-sm font-medium mb-2" style="color: var(--text-primary);">Recovery State</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Recovery Mode:</span>
                                <span class="font-medium ${summary.recovery?.has_active_cursors ? 'text-yellow-600' : 'text-green-600'}">
                                    ${summary.recovery?.has_active_cursors ? 'Active (Resuming)' : 'Normal (Fresh Start)'}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Retry Count:</span>
                                <span class="font-medium ${(summary.recovery?.retry_count || 0) > 0 ? 'text-orange-600' : 'text-green-600'}">
                                    ${summary.recovery?.retry_count || 0}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Execution Order:</span>
                                <span style="color: var(--text-primary);">
                                    ${summary.recovery?.execution_order || 'Unknown'}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Repo Sync Checkpoint:</span>
                                <span style="color: var(--text-primary);">
                                    ${summary.recovery?.last_repo_sync_checkpoint ? new Date(summary.recovery.last_repo_sync_checkpoint).toLocaleString() : 'None'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Recovery Cursors & Queue -->
                    <div>
                        <h4 class="text-sm font-medium mb-2" style="color: var(--text-primary);">Recovery Cursors & Queue</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Repositories in Queue:</span>
                                <span class="font-medium" style="color: var(--text-primary);">
                                    ${summary.recovery?.repo_processing_queue ? summary.recovery.repo_processing_queue.length : 0}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--text-secondary);">Current PR Node ID:</span>
                                <span class="font-mono text-xs" style="color: var(--text-primary);">
                                    ${summary.recovery?.current_pr_node_id ? summary.recovery.current_pr_node_id.substring(0, 12) + '...' : 'None'}
                                </span>
                            </div>
                            ${summary.recovery?.has_active_cursors && summary.recovery?.cursors ? `
                                <div class="mt-2">
                                    <div class="text-xs font-medium mb-1" style="color: var(--text-secondary);">Active Cursors:</div>
                                    ${Object.entries(summary.recovery.cursors).slice(0, 3).map(([key, value]) => `
                                        <div class="flex justify-between text-xs">
                                            <span style="color: var(--text-secondary);">${key.replace(/_/g, ' ').replace(/cursor/gi, '').trim()}:</span>
                                            <span class="font-mono" style="color: var(--text-primary);">${value ? value.substring(0, 10) + '...' : 'None'}</span>
                                        </div>
                                    `).join('')}
                                    ${Object.keys(summary.recovery.cursors).length > 3 ? `<div class="text-xs" style="color: var(--text-muted);">+${Object.keys(summary.recovery.cursors).length - 3} more cursors</div>` : ''}
                                </div>
                            ` : '<div style="color: var(--text-muted);">No recovery cursors</div>'}
                            ${summary.recovery?.error_message ? `
                                <div class="mt-2 p-2 rounded" style="background-color: rgba(220, 38, 38, 0.1);">
                                    <div class="text-xs font-medium text-red-600">Last Error:</div>
                                    <div class="text-xs" style="color: var(--text-secondary);">${summary.recovery.error_message.substring(0, 100)}${summary.recovery.error_message.length > 100 ? '...' : ''}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 4: Repository Processing Queue with Filtering -->
            ${summary.recovery?.repo_processing_queue && summary.recovery.repo_processing_queue.length > 0 ? `
            <div class="rounded-lg border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <div class="p-4 border-b" style="border-color: var(--border-color);">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold" style="color: var(--text-primary);">
                            <i class="fas fa-list mr-2"></i>Repository Processing Queue
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="filterRepoQueue('all')" class="repo-filter-btn active text-sm px-3 py-1 rounded" style="background-color: var(--color-1); color: white;">
                                All (${summary.recovery.repo_processing_queue.length})
                            </button>
                            <button onclick="filterRepoQueue('completed')" class="repo-filter-btn text-sm px-3 py-1 rounded" style="background-color: var(--text-muted); color: white;">
                                Completed (${summary.recovery.repo_processing_queue.filter(r => r.status === 'completed').length})
                            </button>
                            <button onclick="filterRepoQueue('pending')" class="repo-filter-btn text-sm px-3 py-1 rounded" style="background-color: var(--text-muted); color: white;">
                                Pending (${summary.recovery.repo_processing_queue.filter(r => r.status !== 'completed').length})
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-auto" style="max-height: 400px;">
                    <table class="w-full">
                        <thead class="sticky top-0" style="background-color: var(--bg-primary);">
                            <tr class="border-b" style="border-color: var(--border-color);">
                                <th class="text-left p-3 font-medium" style="color: var(--text-primary);">Repository</th>
                                <th class="text-left p-3 font-medium" style="color: var(--text-primary);">Status</th>
                                <th class="text-left p-3 font-medium" style="color: var(--text-primary);">Progress</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summary.recovery.repo_processing_queue.map(repo => `
                                <tr class="repo-row border-b hover:bg-opacity-50" data-status="${repo.status}" style="border-color: var(--border-color);">
                                    <td class="p-3" style="color: var(--text-primary);">
                                        <div class="font-medium">${repo.repository}</div>
                                    </td>
                                    <td class="p-3">
                                        <span class="px-3 py-1 rounded text-sm font-medium ${repo.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                            ${repo.status.charAt(0).toUpperCase() + repo.status.slice(1)}
                                        </span>
                                    </td>
                                    <td class="p-3" style="color: var(--text-secondary);">
                                        ${repo.progress || 'N/A'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            ` : `
            <div class="rounded-lg border p-4 text-center" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <h3 class="text-lg font-semibold mb-2" style="color: var(--text-primary);">
                    <i class="fas fa-list mr-2"></i>Repository Processing Queue
                </h3>
                <p style="color: var(--text-muted);">No repository processing queue data available</p>
            </div>
            `}

        `;

        // Set the modal content
        document.getElementById('jobDetailsContent').innerHTML = content;

        // Auto-load rate limits when modal opens
        loadGitHubRateLimitsInDetails();

        // Show modal with proper display (same as Jira modal)
        const modal = document.getElementById('jobDetailsModal');
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.remove('hidden');
    }

    // Function to load GitHub rate limits in the details modal
    function loadGitHubRateLimitsInDetails() {
        const rateLimitsDiv = document.getElementById('rateLimitsInDetails');
        if (!rateLimitsDiv) return;

        rateLimitsDiv.innerHTML = '<div class="text-center py-2"><span style="color: var(--text-muted);">Loading...</span></div>';

        fetch('/api/v1/github/rate-limits')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    rateLimitsDiv.innerHTML = `<div class="text-center py-2 text-red-600">${data.error}</div>`;
                    return;
                }

                const rateLimitsHtml = `
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="text-center">
                            <div class="font-medium" style="color: var(--text-primary);">${data.core.remaining}/${data.core.limit}</div>
                            <div class="text-xs" style="color: var(--text-secondary);">Core API</div>
                        </div>
                        <div class="text-center">
                            <div class="font-medium" style="color: var(--text-primary);">${data.search.remaining}/${data.search.limit}</div>
                            <div class="text-xs" style="color: var(--text-secondary);">Search API</div>
                        </div>
                    </div>
                `;
                rateLimitsDiv.innerHTML = rateLimitsHtml;
            })
            .catch(error => {
                console.error('Error loading rate limits:', error);
                rateLimitsDiv.innerHTML = '<div class="text-center py-2 text-red-600">Failed to load rate limits</div>';
            });
    }

    // Function to filter repository queue
    function filterRepoQueue(status) {
        const rows = document.querySelectorAll('.repo-row');
        const buttons = document.querySelectorAll('.repo-filter-btn');

        // Update button styles
        buttons.forEach(btn => {
            btn.classList.remove('active');
            btn.style.backgroundColor = 'var(--text-muted)';
        });
        event.target.classList.add('active');
        event.target.style.backgroundColor = 'var(--color-1)';

        // Filter rows
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === 'all') {
                row.style.display = '';
            } else if (status === 'completed' && rowStatus === 'completed') {
                row.style.display = '';
            } else if (status === 'pending' && rowStatus !== 'completed') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Helper functions for GitHub modal
    function showCursorDetails(cursors) {
        let details = '<div class="space-y-2">';
        for (const [key, value] of Object.entries(cursors)) {
            const displayName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            details += `
                <div class="flex justify-between">
                    <span style="color: var(--text-secondary);">${displayName}:</span>
                    <span class="font-mono text-xs" style="color: var(--text-primary);">${value.substring(0, 20)}...</span>
                </div>
            `;
        }
        details += '</div>';

        showNotification('Cursor Details', 'info', details);
    }

    function showRepoQueue(queue) {
        if (!queue || !Array.isArray(queue)) {
            showNotification('No repository queue data available', 'warning');
            return;
        }

        let tableHtml = `
            <div class="mb-3">
                <button onclick="filterRepoQueue('all')" class="text-xs px-2 py-1 rounded mr-2" style="background-color: var(--color-1); color: white;">All</button>
                <button onclick="filterRepoQueue('completed')" class="text-xs px-2 py-1 rounded mr-2" style="background-color: var(--status-success); color: white;">Completed</button>
                <button onclick="filterRepoQueue('pending')" class="text-xs px-2 py-1 rounded" style="background-color: var(--status-warning); color: white;">Pending</button>
            </div>
            <div class="max-h-64 overflow-y-auto">
                <table class="w-full text-xs">
                    <thead>
                        <tr style="background-color: var(--bg-primary);">
                            <th class="p-2 text-left" style="color: var(--text-primary);">Repository</th>
                            <th class="p-2 text-left" style="color: var(--text-primary);">Status</th>
                            <th class="p-2 text-left" style="color: var(--text-primary);">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="repoQueueTableBody">
        `;

        queue.forEach((repo, index) => {
            const status = repo.completed ? 'completed' : 'pending';
            const statusColor = repo.completed ? 'var(--status-success)' : 'var(--status-warning)';
            tableHtml += `
                <tr class="repo-queue-row" data-status="${status}" style="border-bottom: 1px solid var(--border-color);">
                    <td class="p-2" style="color: var(--text-primary);">${repo.full_name || repo.name || 'Unknown'}</td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded text-xs" style="background-color: ${statusColor}; color: white;">
                            ${status.toUpperCase()}
                        </span>
                    </td>
                    <td class="p-2" style="color: var(--text-secondary);">${repo.progress || 'N/A'}</td>
                </tr>
            `;
        });

        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;

        showNotification('Repository Processing Queue', 'info', tableHtml);
    }

    function filterRepoQueue(filter) {
        const rows = document.querySelectorAll('.repo-queue-row');
        rows.forEach(row => {
            if (filter === 'all' || row.dataset.status === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // GitHub Rate Limits Modal Functions
    async function showGitHubRateLimits() {
        try {
            const response = await fetch('/api/v1/github/rate-limits', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const rateLimits = await response.json();

                // Helper function to get status color based on remaining vs limit
                function getStatusColor(remaining, limit) {
                    if (!remaining || !limit) return 'text-gray-500';
                    const percentage = (remaining / limit) * 100;
                    if (percentage > 50) return 'text-green-600';
                    if (percentage > 20) return 'text-yellow-600';
                    return 'text-red-600';
                }

                // Helper function to format reset time
                function formatResetTime(resetTimestamp) {
                    if (!resetTimestamp) return 'N/A';
                    const resetDate = new Date(resetTimestamp * 1000);
                    return resetDate.toLocaleString();
                }

                const content = document.getElementById('rateLimitsContent');
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Core API -->
                        <div class="rounded-lg p-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
                                <i class="fas fa-server mr-2"></i>Core API
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.core?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Used:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.core?.used || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.core?.remaining || 0, rateLimits.core?.limit || 1)}">${rateLimits.core?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.core?.reset)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Search API -->
                        <div class="rounded-lg p-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
                                <i class="fas fa-search mr-2"></i>Search API
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.search?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Used:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.search?.used || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.search?.remaining || 0, rateLimits.search?.limit || 1)}">${rateLimits.search?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.search?.reset)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- GraphQL API -->
                        <div class="rounded-lg p-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
                                <i class="fas fa-code mr-2"></i>GraphQL API
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.graphql?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Used:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.graphql?.used || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.graphql?.remaining || 0, rateLimits.graphql?.limit || 1)}">${rateLimits.graphql?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.graphql?.reset)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="mt-6 rounded-lg p-4 border" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                        <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">
                            <i class="fas fa-info-circle mr-2"></i>Rate Limit Information
                        </h3>
                        <div class="text-sm space-y-2" style="color: var(--text-secondary);">
                            <p><strong>Core API:</strong> General GitHub API requests (repositories, issues, etc.)</p>
                            <p><strong>Search API:</strong> Repository and code search requests (30 requests/minute)</p>
                            <p><strong>GraphQL API:</strong> GraphQL queries (5000 points/hour, varies by query complexity)</p>
                            <p class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-1"></i>Rate limits reset at the specified times above</p>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('rateLimitsContent').innerHTML = `
                    <div class="text-center py-4">
                        <span style="color: var(--text-muted);">Failed to load rate limit information</span>
                    </div>
                `;
            }

            // Show modal with proper display
            const modal = document.getElementById('rateLimitsModal');
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.classList.remove('hidden');

        } catch (error) {
            console.error('Failed to load GitHub rate limits:', error);
        }
    }

    function hideGitHubRateLimits() {
        const modal = document.getElementById('rateLimitsModal');
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('modal-show');
    }

    // Load GitHub rate limits within the job details modal
    async function loadGitHubRateLimitsInDetails() {
        try {
            const container = document.getElementById('rateLimitsInDetails');
            container.innerHTML = '<div class="text-center py-2"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>';

            const response = await fetch('/api/v1/github/rate-limits', {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const rateLimits = await response.json();

                // Helper function to get status color based on remaining vs limit
                function getStatusColor(remaining, limit) {
                    const percentage = (remaining / limit) * 100;
                    if (percentage > 50) return 'text-green-600';
                    if (percentage > 20) return 'text-yellow-600';
                    return 'text-red-600';
                }

                // Helper function to format reset time
                function formatResetTime(resetTimestamp) {
                    if (!resetTimestamp) return 'N/A';
                    const resetDate = new Date(resetTimestamp * 1000);
                    return resetDate.toLocaleString();
                }

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                        <!-- Core API -->
                        <div class="p-2 rounded border" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                            <h4 class="font-semibold mb-1" style="color: var(--text-primary);">Core API</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.core?.remaining || 0, rateLimits.core?.limit || 1)}">${rateLimits.core?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.core?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.core?.reset)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Search API -->
                        <div class="p-2 rounded border" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                            <h4 class="font-semibold mb-1" style="color: var(--text-primary);">Search API</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.search?.remaining || 0, rateLimits.search?.limit || 1)}">${rateLimits.search?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.search?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.search?.reset)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- GraphQL API -->
                        <div class="p-2 rounded border" style="background-color: var(--bg-tertiary); border-color: var(--border-color);">
                            <h4 class="font-semibold mb-1" style="color: var(--text-primary);">GraphQL API</h4>
                            <div class="space-y-1">
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Remaining:</span>
                                    <span class="${getStatusColor(rateLimits.graphql?.remaining || 0, rateLimits.graphql?.limit || 1)}">${rateLimits.graphql?.remaining || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Limit:</span>
                                    <span style="color: var(--text-primary);">${rateLimits.graphql?.limit || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span style="color: var(--text-secondary);">Reset:</span>
                                    <span class="text-xs" style="color: var(--text-primary);">${formatResetTime(rateLimits.graphql?.reset)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const errorText = await response.text();
                console.error('Rate limits API error:', response.status, errorText);
                container.innerHTML = `
                    <div class="text-center py-2">
                        <span style="color: var(--status-error);">Failed to load rate limits (${response.status})</span>
                        <div class="text-xs mt-1" style="color: var(--text-muted);">${errorText}</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load GitHub rate limits in details:', error);
            document.getElementById('rateLimitsInDetails').innerHTML = `
                <div class="text-center py-2">
                    <span style="color: var(--status-error);">Error loading rate limits</span>
                    <div class="text-xs mt-1" style="color: var(--text-muted);">${error.message}</div>
                </div>
            `;
        }
    }

    // Vectorization-specific modal functions
    async function showVectorizationDetailsModal() {
        try {
            // Fetch vectorization queue and vector data from API
            const [queueResponse, vectorResponse] = await Promise.all([
                fetch('/api/v1/vectorization/queue-stats', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                }),
                fetch('/api/v1/vectorization/vector-stats', {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                })
            ]);

            let queueData = null;
            let vectorData = null;

            if (queueResponse.ok) {
                queueData = await queueResponse.json();
            }

            if (vectorResponse.ok) {
                vectorData = await vectorResponse.json();
            }

            displayVectorizationDetailsModal(queueData, vectorData);

        } catch (error) {
            console.error('Error fetching vectorization details:', error);
            showNotification('Failed to load vectorization details: ' + error.message, 'error');
        }
    }

    function displayVectorizationDetailsModal(queueData, vectorData) {
        // Set icon and title for Vectorization
        const jobIcon = document.getElementById('jobDetailsIcon');
        const jobTitle = document.getElementById('jobDetailsTitle');

        jobIcon.innerHTML = '<i data-lucide="zap" class="mr-2" style="color: var(--text-primary);"></i>';
        jobTitle.textContent = 'Vectorization Job Details';

        const content = document.getElementById('jobDetailsContent');

        content.innerHTML = `
            <div class="space-y-6">
                <!-- Queue Statistics -->
                <div class="bg-card border border-border rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i data-lucide="database" class="mr-2 w-5 h-5"></i>
                        Vectorization Queue
                    </h4>
                    ${queueData ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${queueData.pending || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Pending</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600">${queueData.processing || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Processing</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${queueData.completed || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Completed</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600">${queueData.failed || 0}</div>
                                <div class="text-sm" style="color: var(--text-secondary);">Failed</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t" style="border-color: var(--border-color);">
                            <div class="flex justify-between text-sm">
                                <span style="color: var(--text-secondary);">Total Items:</span>
                                <span class="font-medium" style="color: var(--text-primary);">${queueData.total || 0}</span>
                            </div>
                            <div class="flex justify-between text-sm mt-2">
                                <span style="color: var(--text-secondary);">Last Updated:</span>
                                <span class="font-medium" style="color: var(--text-primary);">${queueData.last_updated ? new Date(queueData.last_updated).toLocaleString() : 'Never'}</span>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-4">
                            <span style="color: var(--text-muted);">Queue statistics unavailable</span>
                        </div>
                    `}
                </div>

                <!-- Vector Database Statistics -->
                <div class="bg-card border border-border rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i data-lucide="layers" class="mr-2 w-5 h-5"></i>
                        Vector Database (Qdrant)
                    </h4>
                    ${vectorData ? `
                        <div class="space-y-4">
                            ${vectorData.collections && vectorData.collections.length > 0 ? `
                                <div class="grid gap-3">
                                    ${vectorData.collections.map(collection => `
                                        <div class="border rounded-lg p-3" style="border-color: var(--border-color);">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium" style="color: var(--text-primary);">${collection.name}</span>
                                                <span class="text-sm px-2 py-1 rounded" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">
                                                    ${collection.vectors_count || 0} vectors
                                                </span>
                                            </div>
                                            <div class="mt-2 text-sm grid grid-cols-2 gap-2">
                                                <div>
                                                    <span style="color: var(--text-secondary);">Status:</span>
                                                    <span class="ml-1" style="color: var(--text-primary);">${collection.status || 'Unknown'}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--text-secondary);">Size:</span>
                                                    <span class="ml-1" style="color: var(--text-primary);">${collection.disk_usage || 'Unknown'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-4">
                                    <span style="color: var(--text-muted);">No vector collections found</span>
                                </div>
                            `}

                            ${vectorData.total_vectors ? `
                                <div class="mt-4 pt-4 border-t" style="border-color: var(--border-color);">
                                    <div class="flex justify-between text-sm">
                                        <span style="color: var(--text-secondary);">Total Vectors:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${vectorData.total_vectors}</span>
                                    </div>
                                    <div class="flex justify-between text-sm mt-2">
                                        <span style="color: var(--text-secondary);">Total Collections:</span>
                                        <span class="font-medium" style="color: var(--text-primary);">${vectorData.collections ? vectorData.collections.length : 0}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="text-center py-4">
                            <span style="color: var(--text-muted);">Vector database statistics unavailable</span>
                        </div>
                    `}
                </div>

                <!-- Processing Statistics -->
                <div class="bg-card border border-border rounded-lg p-4">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i data-lucide="activity" class="mr-2 w-5 h-5"></i>
                        Processing Metrics
                    </h4>
                    ${queueData && queueData.processing_stats ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span style="color: var(--text-secondary);">Success Rate:</span>
                                    <span class="font-medium" style="color: var(--text-primary);">${queueData.processing_stats.success_rate || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span style="color: var(--text-secondary);">Avg Processing Time:</span>
                                    <span class="font-medium" style="color: var(--text-primary);">${queueData.processing_stats.avg_processing_time || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span style="color: var(--text-secondary);">Last Batch Size:</span>
                                    <span class="font-medium" style="color: var(--text-primary);">${queueData.processing_stats.last_batch_size || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span style="color: var(--text-secondary);">Last Run:</span>
                                    <span class="font-medium" style="color: var(--text-primary);">${queueData.processing_stats.last_run ? new Date(queueData.processing_stats.last_run).toLocaleString() : 'Never'}</span>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-4">
                            <span style="color: var(--text-muted);">Processing metrics will appear after job runs</span>
                        </div>
                    `}
                </div>
            </div>
        `;

        // Refresh Lucide icons for the new content
        refreshLucideIcons();

        // Show modal with proper display
        const modal = document.getElementById('jobDetailsModal');
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.remove('hidden');
    }

    // Function to re-initialize Lucide icons after dynamic content updates
    function refreshLucideIcons() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Call refreshLucideIcons after major DOM updates
    // This should be called after job cards are rendered, modals are updated, etc.
</script>
{% endblock %}

