<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse ETL - Dashboard v2</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-running {
            background-color: #3b82f6;
            color: white;
        }

        .status-pending {
            background-color: #eab308;
            color: white;
        }

        .status-finished {
            background-color: #22c55e;
            color: white;
        }

        .status-paused {
            background-color: #d97706;
            color: white;
        }

        .status-not-started {
            background-color: #6b7280;
            color: white;
        }

        .status-error {
            background-color: #ef4444;
            color: white;
        }



        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: relative;
            z-index: 9999;
        }

        .menu-dropdown {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
            background: #2d3748 !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            min-width: 200px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
            z-index: 999999 !important;
            display: none !important;
        }

        .menu-dropdown.show {
            display: block !important;
        }

        .menu-item {
            display: block;
            padding: 12px 16px;
            color: white;
            text-decoration: none;
            transition: background-color 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .menu-item:hover {
            background: #4299e1;
            color: white;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item i {
            width: 20px;
            margin-right: 8px;
        }



        /* Fix for select dropdown z-index issues */
        select {
            position: relative !important;
            z-index: 9999 !important;
        }

        /* Fix dropdown option colors */
        select option {
            background-color: #333 !important;
            color: white !important;
            padding: 8px !important;
        }

        select option:hover {
            background-color: #555 !important;
            color: white !important;
        }

        /* Specific styling for refresh interval dropdown */
        #refreshInterval option {
            background-color: #2d3748 !important;
            color: white !important;
            border: none !important;
        }

        #refreshInterval option:checked {
            background-color: #4299e1 !important;
            color: white !important;
        }

        /* Ensure the parent container doesn't clip the dropdown */
        .glass-effect {
            overflow: visible !important;
        }

        /* WebSocket Progress Bar Styles */
        .ws-progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .ws-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }

        .ws-progress-bar.completed {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .ws-progress-bar.error {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .ws-progress-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
        }

        /* Exception Log Styles */
        .exception-log {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
        }

        .exception-item {
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
            border-left: 3px solid;
        }

        .exception-item.error {
            background: rgba(239, 68, 68, 0.2);
            border-left-color: #ef4444;
            color: #fecaca;
        }

        .exception-item.warning {
            background: rgba(245, 158, 11, 0.2);
            border-left-color: #f59e0b;
            color: #fde68a;
        }

        .exception-item.info {
            background: rgba(59, 130, 246, 0.2);
            border-left-color: #3b82f6;
            color: #bfdbfe;
        }
    </style>
</head>

<body class="gradient-bg min-h-screen">
    <!-- Hamburger Menu Dropdown (positioned at body level to avoid z-index issues) -->
    <div id="menuDropdown" class="menu-dropdown">
        <a href="/dashboard" class="menu-item">
            <i class="fas fa-tachometer-alt"></i>Dashboard
        </a>
        <a href="/docs" class="menu-item">
            <i class="fas fa-book"></i>API Documentation
        </a>
        <a href="/health" class="menu-item">
            <i class="fas fa-heartbeat"></i>Health Check
        </a>
        <!-- Admin Panel - Only visible to admin users -->
        <a href="/admin" class="menu-item" id="admin-menu-item" style="display: none;">
            <i class="fas fa-users-cog"></i>Admin Panel
        </a>
        <div class="menu-item"
            style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: 4px; padding-top: 12px;">
            <button onclick="logout()" class="w-full text-left">
                <i class="fas fa-sign-out-alt"></i>Logout
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-effect border-b border-white border-opacity-20">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div
                        class="inline-flex items-center justify-center w-10 h-10 bg-white bg-opacity-20 rounded-full mr-4">
                        <i class="fas fa-database text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Pulse ETL Dashboard</h1>
                        <p class="text-white text-opacity-70 text-sm">Data Pipeline Management</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-opacity-80 text-sm">
                        <i class="fas fa-user mr-2"></i><span id="user-email">{{ user.email }}</span>
                        <span id="user-role-badge" class="ml-2 px-2 py-1 rounded text-xs font-semibold"
                            style="display: none;"></span>
                    </div>

                    <!-- Hamburger Menu Button -->
                    <div class="hamburger-menu">
                        <button onclick="toggleMenu()"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg transition duration-300">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- System Health Section -->
        <div class="glass-effect rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-white">
                    <i class="fas fa-heartbeat mr-2"></i>System Health
                </h3>
                <button onclick="refreshSystemHealth()"
                    class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-1 rounded text-sm transition duration-300">
                    <i class="fas fa-sync mr-1"></i>Refresh
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Database Status -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white text-opacity-80 text-sm">Database</span>
                        <span id="dbStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                            <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                        </span>
                    </div>
                    <div id="dbDetails" class="text-white text-opacity-60 text-xs">
                        PostgreSQL Connection
                    </div>
                </div>

                <!-- Jira API Status -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white text-opacity-80 text-sm">Jira API</span>
                        <span id="jiraApiStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                            <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                        </span>
                    </div>
                    <div id="jiraApiDetails" class="text-white text-opacity-60 text-xs">
                        API Connectivity
                    </div>
                </div>

                <!-- GitHub API Status -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white text-opacity-80 text-sm">GitHub API</span>
                        <span id="githubApiStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                            <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                        </span>
                    </div>
                    <div id="githubApiDetails" class="text-white text-opacity-60 text-xs">
                        Rate Limits & Connectivity
                    </div>
                </div>

                <!-- System Resources -->
                <div class="bg-white bg-opacity-10 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white text-opacity-80 text-sm">System</span>
                        <span id="systemStatus" class="px-2 py-1 rounded text-xs font-medium bg-gray-500 text-white">
                            <i class="fas fa-spinner fa-spin mr-1"></i>Checking...
                        </span>
                    </div>
                    <div id="systemDetails" class="text-white text-opacity-60 text-xs">
                        Memory & CPU Usage
                    </div>
                </div>
            </div>
        </div>

        <!-- Auto-refresh controls -->
        <div class="glass-effect rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h2 class="text-xl font-semibold text-white">
                        <i class="fas fa-sync-alt mr-2"></i>Job Status Monitor
                    </h2>
                    <div class="flex items-center space-x-2">
                        <label class="text-white text-sm">Auto-refresh:</label>
                        <select id="refreshInterval" class="bg-white bg-opacity-20 text-white rounded px-3 py-1 text-sm"
                            style="position: relative; z-index: 9999;">
                            <option value="0">Off</option>
                            <option value="5000">5s</option>
                            <option value="10000">10s</option>
                            <option value="30000" selected>30s</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span id="lastUpdate" class="text-white text-opacity-70 text-sm"></span>
                    <button onclick="refreshData(); refreshSystemHealth();"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition duration-300">
                        <i class="fas fa-refresh mr-2"></i>Refresh Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Orchestrator Controls -->
        <div id="orchestratorControlsSection" class="glass-effect rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h3 id="orchestratorSectionTitle" class="text-lg font-semibold text-white">
                        <i class="fas fa-cogs mr-2"></i>Orchestrator Controls
                    </h3>
                    <div id="orchestratorStatus" class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-white text-opacity-70 text-sm">Status:</span>
                            <span id="orchestratorStatusBadge" class="px-2 py-1 rounded text-xs font-medium">
                                Loading...
                            </span>
                        </div>
                        <div id="orchestratorCountdown" class="flex items-center space-x-2">
                            <span class="text-white text-opacity-70 text-sm">Next run in:</span>
                            <span id="countdownTimer"
                                class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-medium">
                                --:--:--
                            </span>
                        </div>
                    </div>
                </div>
                <div id="orchestratorControlButtons" class="flex items-center space-x-2">
                    <button onclick="forceStartOrchestrator()" id="forceStartOrchestratorBtn"
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium">
                        <i class="fas fa-play mr-1"></i>Force Start
                    </button>

                    <button onclick="pauseOrchestrator()" id="pauseOrchestratorBtn"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm font-medium">
                        <i class="fas fa-pause mr-1"></i>Pause
                    </button>
                    <button onclick="resumeOrchestrator()" id="resumeOrchestratorBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium hidden">
                        <i class="fas fa-play mr-1"></i>Resume
                    </button>
                    <button onclick="showOrchestratorSettings()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-medium">
                        <i class="fas fa-cog mr-1"></i>Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Orchestrator Settings Modal -->
        <div id="orchestratorSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-cog mr-2"></i>Orchestrator Settings
                        </h3>
                    </div>
                    <div class="px-6 py-4">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Run Interval
                                </label>
                                <select id="orchestratorInterval"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="60" selected>Every 1 hour</option>
                                    <option value="120">Every 2 hours</option>
                                    <option value="240">Every 4 hours</option>
                                    <option value="480">Every 8 hours</option>
                                    <option value="720">Every 12 hours</option>
                                    <option value="1440">Every 24 hours</option>
                                </select>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="orchestratorEnabled" checked
                                        class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm font-medium text-gray-700">Enable Orchestrator</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="hideOrchestratorSettings()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                            Cancel
                        </button>
                        <button onclick="saveOrchestratorSettings()"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Cards Container -->
        <div id="jobsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Job cards will be dynamically inserted here -->
        </div>




    </main>

    <script>
        // @ts-nocheck
        let refreshTimer = null;

        // WebSocket connections for real-time progress
        let websockets = {
            jira_sync: null,
            github_sync: null,
            orchestrator: null
        };

        // Progress and exception data
        let jobProgress = {
            jira_sync: { percentage: 0, step: '', exceptions: [] },
            github_sync: { percentage: 0, step: '', exceptions: [] },
            orchestrator: { percentage: 0, step: '', exceptions: [] }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            refreshData();
            setupAutoRefresh();
            refreshOrchestratorStatus();
            refreshSystemHealth();
            initializeWebSockets();
        });

        function checkAuth() {
            const token = localStorage.getItem('pulse_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        }

        // WebSocket Management
        function initializeWebSockets() {
            const jobs = ['jira_sync', 'github_sync'];

            jobs.forEach(jobName => {
                connectWebSocket(jobName);
            });
        }

        function connectWebSocket(jobName) {
            if (websockets[jobName]) {
                websockets[jobName].close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/progress/${jobName}`;

            try {
                const ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    websockets[jobName] = ws;
                };

                ws.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(jobName, data);
                    } catch (e) {
                        console.error(`‚ùå Error parsing WebSocket message for ${jobName}:`, e);
                    }
                };

                ws.onclose = function (event) {
                    console.log(`üîå WebSocket disconnected for ${jobName}. Code: ${event.code}, Reason: ${event.reason}`);
                    websockets[jobName] = null;

                    // Reconnect after 5 seconds
                    setTimeout(() => {
                        if (!websockets[jobName]) {
                            console.log(`üîÑ Reconnecting WebSocket for ${jobName}...`);
                            connectWebSocket(jobName);
                        }
                    }, 5000);
                };

                ws.onerror = function (error) {
                    console.error(`‚ùå WebSocket error for ${jobName}:`, error);
                };

            } catch (e) {
                console.error(`Failed to create WebSocket for ${jobName}:`, e);
            }
        }

        function handleWebSocketMessage(jobName, data) {
            switch (data.type) {
                case 'progress':
                    updateJobProgress(jobName, data.percentage, data.step);
                    break;
                case 'exception':
                    addJobException(jobName, data.level, data.message, data.timestamp);
                    break;
                case 'status':
                    updateJobStatus(jobName, data.status);
                    break;
                case 'completion':
                    handleJobCompletion(jobName, data.success, data.summary);
                    break;
                default:
                    console.log(`Unknown WebSocket message type: ${data.type}`);
            }
        }

        function updateJobProgress(jobName, percentage, step) {
            // Clear previous exceptions if this is a new job start (low percentage)
            if (percentage <= 10) {
                jobProgress[jobName].exceptions = [];
            }

            jobProgress[jobName].percentage = percentage;
            jobProgress[jobName].step = step;

            // Update progress bar in job card
            const jobCard = document.querySelector(`[data-job="${jobName}"]`);
            if (jobCard) {
                updateJobCardProgress(jobCard, percentage, step);

                // Additional verification for 100% completion
                if (percentage >= 100) {
                    // Double-check the progress bar was updated
                    setTimeout(() => {
                        const progressBar = jobCard.querySelector('.ws-progress-bar');
                        const progressText = jobCard.querySelector('.ws-progress-text');
                        const progressPercentage = jobCard.querySelector('.ws-progress-container')?.parentElement?.querySelector('.text-xs:last-child');
                    }, 100);
                }
            } else {
                console.warn(`‚ö†Ô∏è No job card found for ${jobName}`);
            }
        }

        function addJobException(jobName, level, message, timestamp) {
            const exception = {
                level: level,
                message: message,
                timestamp: timestamp
            };

            jobProgress[jobName].exceptions.unshift(exception);

            // Keep only last 10 exceptions
            if (jobProgress[jobName].exceptions.length > 10) {
                jobProgress[jobName].exceptions = jobProgress[jobName].exceptions.slice(0, 10);
            }

            // Update exception log in job card
            const jobCard = document.querySelector(`[data-job="${jobName}"]`);
            if (jobCard) {
                updateJobCardExceptions(jobCard, jobProgress[jobName].exceptions);
            }
        }

        function updateJobStatus(jobName, status) {
            // Update job status in the UI
            const jobCard = document.querySelector(`[data-job="${jobName}"]`);
            if (jobCard) {
                updateJobCardStatus(jobCard, status);
            }
        }

        function handleJobCompletion(jobName, success, summary) {
            // Force update progress to 100% on completion
            if (success) {
                // Check if this is a rate limit case (partial success)
                if (summary.rate_limit_reached) {
                    updateJobProgress(jobName, 100, '‚úÖ Rate limit reached - will resume on next run');
                    addJobException(jobName, 'INFO', summary.message || 'Rate limit reached - progress saved', new Date().toISOString());
                } else if (summary.partial_success) {
                    updateJobProgress(jobName, 100, '‚úÖ Partially completed - will resume later');
                    addJobException(jobName, 'INFO', summary.message || 'Partial completion - progress saved', new Date().toISOString());
                } else {
                    updateJobProgress(jobName, 100, '‚úÖ Completed successfully');
                }
            } else {
                addJobException(jobName, 'ERROR', summary.error || 'Job failed', new Date().toISOString());
            }

            // Force final progress bar update and refresh job status
            setTimeout(() => {
                // Force update the progress bar one more time
                const jobCard = document.querySelector(`[data-job="${jobName}"]`);
                if (jobCard) {
                    updateJobCardProgress(jobCard, 100, success ? '‚úÖ Completed successfully' : '‚ùå Failed');
                }

                // Refresh the entire dashboard
                refreshData();
            }, 1000);
        }

        // Job status checking simplified - no individual stop buttons to manage

        function createWebSocketProgress(jobName) {
            const progress = jobProgress[jobName];
            if (!progress || progress.percentage === 0) {
                return '';
            }

            return `
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-medium text-white">Real-time Progress</span>
                        <span class="text-xs text-white">${Math.round(progress.percentage)}%</span>
                    </div>
                    <div class="ws-progress-container">
                        <div class="ws-progress-bar" style="width: ${progress.percentage}%"></div>
                    </div>
                    <div class="ws-progress-text">${progress.step}</div>
                </div>
            `;
        }

        function createErrorMessage(jobData) {
            if (!jobData.error_message) {
                return '';
            }

            return `
                <div class="mt-3 p-3 bg-red-500 bg-opacity-20 rounded-lg border border-red-500 border-opacity-50">
                    <div class="text-red-200 text-xs font-medium mb-1">Error Message:</div>
                    <div class="text-red-100 text-xs">${jobData.error_message}</div>
                </div>
            `;
        }

        function createExceptionLog(jobName) {
            const exceptions = jobProgress[jobName].exceptions;
            if (!exceptions || exceptions.length === 0) {
                return '';
            }

            const exceptionsHtml = exceptions.map(exception => `
                <div class="exception-item ${exception.level.toLowerCase()}">
                    <div class="flex justify-between items-start">
                        <span class="font-medium">${exception.level}:</span>
                        <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="mt-1">${exception.message}</div>
                </div>
            `).join('');

            return `
                <div class="mt-4">
                    <div class="text-xs font-medium text-white mb-2">Issues & Warnings</div>
                    <div class="exception-log">
                        ${exceptionsHtml}
                    </div>
                </div>
            `;
        }

        function updateJobCardProgress(jobCard, percentage, step) {
            // Update or create progress section in the dynamic content area
            let progressSection = jobCard.querySelector('.ws-progress-container');
            if (!progressSection) {
                // Create progress section in the dynamic content area
                const dynamicContentSection = jobCard.querySelector('.space-y-3:last-child');
                if (dynamicContentSection) {
                    const progressHtml = createWebSocketProgress(jobCard.getAttribute('data-job'));
                    dynamicContentSection.insertAdjacentHTML('afterbegin', progressHtml);
                    progressSection = jobCard.querySelector('.ws-progress-container');
                }
            }

            if (progressSection) {
                const progressBar = progressSection.querySelector('.ws-progress-bar');
                const progressText = jobCard.querySelector('.ws-progress-text');
                const progressPercentage = jobCard.querySelector('.ws-progress-container').parentElement.querySelector('.text-xs:last-child');

                if (progressBar) progressBar.style.width = `${percentage}%`;
                if (progressText) progressText.textContent = step;
                if (progressPercentage) progressPercentage.textContent = `${Math.round(percentage)}%`;
            }
        }

        function updateJobCardExceptions(jobCard, exceptions) {
            // Update or create exception log section in the dynamic content area
            let exceptionSection = jobCard.querySelector('.exception-log');
            if (!exceptionSection && exceptions.length > 0) {
                // Create exception section in the dynamic content area
                const dynamicContentSection = jobCard.querySelector('.space-y-3:last-child');
                if (dynamicContentSection) {
                    const exceptionHtml = createExceptionLog(jobCard.getAttribute('data-job'));
                    dynamicContentSection.insertAdjacentHTML('beforeend', exceptionHtml);
                    exceptionSection = jobCard.querySelector('.exception-log');
                }
            }

            if (exceptionSection && exceptions.length > 0) {
                const exceptionsHtml = exceptions.map(exception => `
                    <div class="exception-item ${exception.level.toLowerCase()}">
                        <div class="flex justify-between items-start">
                            <span class="font-medium">${exception.level}:</span>
                            <span class="text-xs opacity-75">${new Date(exception.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="mt-1">${exception.message}</div>
                    </div>
                `).join('');
                exceptionSection.innerHTML = exceptionsHtml;
            }
        }

        function updateJobCardStatus(jobCard, status) {
            const statusSpan = jobCard.querySelector('.px-3.py-1.rounded-full');
            if (statusSpan) {
                const statusClass = getStatusClass(status);
                const statusIcon = getStatusIcon(status);
                statusSpan.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClass}`;
                statusSpan.innerHTML = `<i class="fas fa-${statusIcon} mr-1"></i>${status}`;
            }
        }

        function logout() {
            // Clear localStorage
            localStorage.removeItem('pulse_token');

            // Call server-side logout to clear cookies properly
            window.location.href = '/logout';
        }

        async function refreshData() {
            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch('/api/v1/jobs/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();
                updateJobCards(data.jobs || data);
                updateLastRefreshTime();



                // Note: Orchestrator status refreshed separately via countdown timer
            } catch (error) {
                console.error('Error fetching job status:', error);
            }
        }

        // System Health Functions
        async function refreshSystemHealth() {
            try {
                // Check database health
                const healthResponse = await fetch('/api/v1/health', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('pulse_token')}`
                    }
                });

                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    updateHealthStatus('db', healthData.database_status === 'healthy', healthData.database_message);
                } else {
                    updateHealthStatus('db', false, 'Health check failed');
                }

                // Check system status (placeholder for now)
                updateHealthStatus('system', true, 'Memory: 2.1GB / 8GB, CPU: 15%');
                updateHealthStatus('jiraApi', true, 'Connected');
                updateHealthStatus('githubApi', true, 'Rate limit: 4,850/5,000');

            } catch (error) {
                console.error('Error checking system health:', error);
                updateHealthStatus('db', false, 'Connection error');
                updateHealthStatus('system', false, 'Check failed');
                updateHealthStatus('jiraApi', false, 'Check failed');
                updateHealthStatus('githubApi', false, 'Check failed');
            }
        }

        function updateHealthStatus(component, isHealthy, details) {
            const statusElement = document.getElementById(`${component}Status`);
            const detailsElement = document.getElementById(`${component}Details`);

            if (statusElement) {
                statusElement.className = `px-2 py-1 rounded text-xs font-medium ${isHealthy ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                    }`;
                statusElement.innerHTML = `<i class="fas fa-${isHealthy ? 'check' : 'times'} mr-1"></i>${isHealthy ? 'Healthy' : 'Error'
                    }`;
            }

            if (detailsElement) {
                detailsElement.textContent = details;
            }
        }

        function updateJobCards(jobsData) {
            const container = document.getElementById('jobsContainer');
            container.innerHTML = '';

            Object.entries(jobsData).forEach(([jobName, jobData]) => {
                const card = createJobCard(jobName, jobData, jobsData);
                container.appendChild(card);
            });

            // Update orchestrator button state based on job status
            updateOrchestratorButtonState(jobsData);
        }

        function updateOrchestratorButtonState(jobsData) {
            const orchestratorBtn = document.getElementById('forceStartOrchestratorBtn');
            if (!orchestratorBtn) return;

            // Check if any job is running
            const anyJobRunning = Object.values(jobsData).some(jobData => jobData.status === 'RUNNING');

            if (anyJobRunning) {
                orchestratorBtn.disabled = true;
                orchestratorBtn.className = 'bg-gray-500 cursor-not-allowed text-white px-3 py-1 rounded text-sm font-medium';
                orchestratorBtn.title = 'Cannot start orchestrator while jobs are running';
            } else {
                orchestratorBtn.disabled = false;
                orchestratorBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium';
                orchestratorBtn.title = '';
            }
        }

        function setupAutoRefresh() {
            const select = document.getElementById('refreshInterval');
            select.addEventListener('change', function () {
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                    refreshTimer = null;
                }

                const interval = parseInt(this.value);
                if (interval > 0) {
                    refreshTimer = setInterval(() => {
                        refreshData();
                        refreshSystemHealth();
                    }, interval);
                }
            });

            // Start with default 30s refresh
            const defaultInterval = parseInt(select.value);
            if (defaultInterval > 0) {
                refreshTimer = setInterval(() => {
                    refreshData();
                    refreshSystemHealth();
                }, defaultInterval);
            }
        }

        function updateLastRefreshTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        function createJobCard(jobName, jobData, allJobsData) {
            const card = document.createElement('div');
            card.className = 'glass-effect rounded-lg p-6';
            card.setAttribute('data-job', jobName); // Add data attribute for WebSocket updates

            const statusClass = getStatusClass(jobData.status);
            const statusIcon = getStatusIcon(jobData.status);

            card.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-white capitalize">
                        <i class="fas fa-${jobName === 'jira_sync' ? 'ticket-alt' : 'code-branch'} mr-2"></i>
                        ${jobName.replace('_', ' ')}
                    </h3>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                        <i class="fas fa-${statusIcon} mr-1"></i>${jobData.status}
                    </span>
                </div>

                ${createJobDetails(jobName, jobData)}

                <!-- Fixed Action Buttons Section -->
                <div class="mt-4 pt-3 border-t border-white border-opacity-20">
                    <div class="flex flex-wrap gap-2 justify-start">
                        ${createActionButtons(jobName, jobData, allJobsData)}
                    </div>
                </div>

                <!-- Dynamic Content Section (below buttons) -->
                <div class="mt-4 space-y-3">
                    ${createWebSocketProgress(jobName)}
                    ${createRecoveryDetails(jobName, jobData)}
                    ${createExceptionLog(jobName)}
                </div>
            `;

            return card;
        }

        function createJobDetails(jobName, jobData) {
            let details = `
                <div class="space-y-3 text-white text-opacity-80 text-sm">
                    <div class="flex justify-between">
                        <span>Last Run:</span>
                        <span>${jobData.last_run_started_at ? new Date(jobData.last_run_started_at).toLocaleString() : 'Never'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Last Success:</span>
                        <span>${jobData.last_success_at ? new Date(jobData.last_success_at).toLocaleString() : 'Never'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Retry Count:</span>
                        <span>${jobData.retry_count || 0}</span>
                    </div>
            `;



            details += `</div>`;

            // Note: Error message moved to createErrorMessage function (after buttons)
            // Note: Recovery details moved to dynamic content section (after progress bar)

            details += '</div>';
            return details;
        }

        function createRecoveryDetails(jobName, jobData) {
            // Only show recovery details for PENDING GitHub jobs with checkpoint data
            if (jobName !== 'github_sync' || jobData.status !== 'PENDING' || !jobData.checkpoint_data) {
                return '';
            }

            const checkpointData = jobData.checkpoint_data;

            // Repository queue information
            if (checkpointData.repo_processing_queue) {
                // Handle both string and object formats
                let queue;
                if (typeof checkpointData.repo_processing_queue === 'string') {
                    queue = JSON.parse(checkpointData.repo_processing_queue);
                } else {
                    queue = checkpointData.repo_processing_queue;
                }

                const finished = queue.filter(r => r.finished).length;
                const total = queue.length;
                const remaining = total - finished;

                return `
                    <div class="mt-3 p-3 bg-yellow-500 bg-opacity-20 rounded-lg border border-yellow-500 border-opacity-50">
                        <div class="text-yellow-200 text-xs font-medium mb-2">
                            <i class="fas fa-redo mr-1"></i>Recovery Information:
                        </div>
                        <div class="text-yellow-100 text-xs">
                            Repositories: ${finished}/${total} completed (${remaining} remaining)
                        </div>
                    </div>
                `;
            }

            return '';
        }

        function createActionButtons(jobName, jobData, allJobsData) {
            // Check if user is admin - only admins get control buttons
            if (!currentUser || (currentUser.role !== 'admin' && !currentUser.is_admin)) {
                // Non-admin users only get the details button
                return `
                    <button onclick="showJobDetails('${jobName}')"
                            class="px-3 py-1 rounded text-sm bg-purple-500 hover:bg-purple-600 text-white transition duration-300">
                        <i class="fas fa-info-circle mr-1"></i>Details
                    </button>
                    ${jobName === 'github_sync' ? `
                        <button onclick="showGitHubRateLimits()"
                                class="px-3 py-1 rounded text-sm bg-blue-500 hover:bg-blue-600 text-white transition duration-300">
                            <i class="fab fa-github mr-1"></i>Rate Limits
                        </button>
                    ` : ''}
                `;
            }

            // Admin users get full control buttons
            const canStart = ['PENDING', 'FINISHED', 'NOT_STARTED'].includes(jobData.status);
            const canStop = jobData.status === 'RUNNING';
            const canPause = ['PENDING', 'FINISHED'].includes(jobData.status);
            const canUnpause = jobData.status === 'PAUSED';

            // Check if any other job is running to disable Force Start
            const otherJobRunning = Object.entries(allJobsData).some(([name, data]) =>
                name !== jobName && data.status === 'RUNNING'
            );

            // Disable Force Start if other job is running
            const canStartSafe = canStart && !otherJobRunning;

            // Disable Pause if this job is running
            const canPauseSafe = canPause && jobData.status !== 'RUNNING';

            // Can set active if job is not running and not already pending
            const canSetActive = jobData.status !== 'RUNNING' && jobData.status !== 'PENDING' && !otherJobRunning;

            return `
                <button onclick="setJobActive('${jobName}')"
                        ${!canSetActive ? 'disabled' : ''}
                        class="px-3 py-1 rounded text-sm ${canSetActive ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                        title="${!canSetActive ? (jobData.status === 'RUNNING' ? 'Cannot set active while running' : jobData.status === 'PENDING' ? 'Job is already active' : 'Another job is running') : 'Set this job as active (PENDING) and the other as FINISHED'}">
                    <i class="fas fa-${jobData.status === 'PENDING' ? 'check' : 'play'} mr-1"></i>${jobData.status === 'PENDING' ? 'Active' : 'Set Active'}
                </button>
                <button onclick="${canUnpause ? 'unpauseJob' : 'pauseJob'}('${jobName}')"
                        ${!(canPauseSafe || canUnpause) ? 'disabled' : ''}
                        class="px-3 py-1 rounded text-sm ${(canPauseSafe || canUnpause) ? (canUnpause ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-amber-500 hover:bg-amber-600') : 'bg-gray-500 cursor-not-allowed'} text-white transition duration-300"
                        title="${!canPauseSafe && jobData.status === 'RUNNING' ? 'Cannot pause while job is running' : ''}">
                    <i class="fas fa-${canUnpause ? 'play' : 'pause'} mr-1"></i>${canUnpause ? 'Unpause' : 'Pause'}
                </button>
                <button onclick="showJobDetails('${jobName}')"
                        class="px-3 py-1 rounded text-sm bg-purple-500 hover:bg-purple-600 text-white transition duration-300">
                    <i class="fas fa-info-circle mr-1"></i>Details
                </button>
                ${jobName === 'github_sync' ? `
                    <button onclick="showGitHubRateLimits()"
                            class="px-3 py-1 rounded text-sm bg-blue-500 hover:bg-blue-600 text-white transition duration-300">
                        <i class="fab fa-github mr-1"></i>Rate Limits
                    </button>
                ` : ''}
            `;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'RUNNING': return 'status-running';
                case 'PENDING': return 'status-pending';
                case 'FINISHED': return 'status-finished';
                case 'PAUSED': return 'status-paused';
                case 'NOT_STARTED': return 'status-not-started';
                default: return 'status-error';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'RUNNING': return 'spinner fa-spin';
                case 'PENDING': return 'clock';
                case 'FINISHED': return 'check-circle';
                case 'PAUSED': return 'pause-circle';
                case 'NOT_STARTED': return 'circle';
                default: return 'exclamation-triangle';
            }
        }



        // Individual job controls removed - use orchestrator Force Start/Stop buttons instead



        async function showJobDetails(jobName) {
            try {
                // Fetch job schedule details from API
                const response = await fetch(`/api/v1/jobs/${jobName}/schedule-details`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('pulse_token')}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // Authentication failed - redirect to login
                        logout();
                        return;
                    }
                    throw new Error(`Failed to fetch job details: ${response.statusText}`);
                }

                const scheduleDetails = await response.json();
                showJobDetailsModal(jobName, scheduleDetails);

            } catch (error) {
                console.error('Error fetching job details:', error);
                alert(`Failed to load job details: ${error.message}`);
            }
        }

        function showJobDetailsModal(jobName, details) {
            // Create modal HTML
            const modalHtml = `
                <div id="jobDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">
                                <i class="fas fa-info-circle mr-2"></i>${jobName} Job Schedule Details
                            </h2>
                            <button onclick="closeJobDetailsModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Basic Information -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-cog mr-2"></i>Basic Information
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Job ID:</span>
                                        <span class="text-white">${details.id}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Status:</span>
                                        <span class="text-white font-semibold">${details.status}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Active:</span>
                                        <span class="text-white">${details.active ? 'Yes' : 'No'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Retry Count:</span>
                                        <span class="text-white">${details.retry_count}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Timing Information -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-clock mr-2"></i>Timing Information
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Created:</span>
                                        <span class="text-white">${details.created_at ? new Date(details.created_at).toLocaleString() : 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Last Updated:</span>
                                        <span class="text-white">${details.last_updated_at ? new Date(details.last_updated_at).toLocaleString() : 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Last Run Started:</span>
                                        <span class="text-white">${details.last_run_started_at ? new Date(details.last_run_started_at).toLocaleString() : 'Never'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Last Success:</span>
                                        <span class="text-white">${details.last_success_at ? new Date(details.last_success_at).toLocaleString() : 'Never'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Status Info -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-chart-line mr-2"></i>Job Status
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Is Recovery Run:</span>
                                        <span class="text-white">${details.is_recovery_run ? 'Yes' : 'No'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Has Checkpoints:</span>
                                        <span class="text-white">${(details.last_pr_cursor || details.repo_processing_queue) ? 'Yes' : 'No'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-info-circle mr-2"></i>Additional Info
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Current PR Node:</span>
                                        <span class="text-white font-mono text-xs">${details.current_pr_node_id || 'None'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Repo Checkpoint:</span>
                                        <span class="text-white">${details.last_repo_sync_checkpoint ? new Date(details.last_repo_sync_checkpoint).toLocaleString() : 'None'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Checkpoint Data -->
                        <div class="mt-6 glass-effect rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-white mb-3">
                                <i class="fas fa-bookmark mr-2"></i>Checkpoint Data
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-300">PR Cursor:</span>
                                    <div class="text-white bg-gray-700 p-2 rounded mt-1 font-mono text-xs">
                                        ${details.last_pr_cursor || 'None'}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Commit Cursor:</span>
                                    <div class="text-white bg-gray-700 p-2 rounded mt-1 font-mono text-xs">
                                        ${details.last_commit_cursor || 'None'}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Review Cursor:</span>
                                    <div class="text-white bg-gray-700 p-2 rounded mt-1 font-mono text-xs">
                                        ${details.last_review_cursor || 'None'}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Comment Cursor:</span>
                                    <div class="text-white bg-gray-700 p-2 rounded mt-1 font-mono text-xs">
                                        ${details.last_comment_cursor || 'None'}
                                    </div>
                                </div>
                                <div>
                                    <span class="text-gray-300">Review Thread Cursor:</span>
                                    <div class="text-white bg-gray-700 p-2 rounded mt-1 font-mono text-xs">
                                        ${details.last_review_thread_cursor || 'None'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Repository Processing Queue -->
                        ${details.repo_processing_queue ? `
                        <div class="mt-6 glass-effect rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-white">
                                    <i class="fas fa-list mr-2"></i>Repository Processing Queue
                                </h3>
                                <div class="text-sm text-gray-300">
                                    ${(() => {
                                        try {
                                            const queue = typeof details.repo_processing_queue === 'string'
                                                ? JSON.parse(details.repo_processing_queue)
                                                : details.repo_processing_queue;
                                            const finished = queue.filter(repo => repo.finished).length;
                                            const pending = queue.length - finished;
                                            return `
                                                <span class="text-green-400 font-medium">${finished} Finished</span>
                                                <span class="mx-2">‚Ä¢</span>
                                                <span class="text-yellow-400 font-medium">${pending} Pending</span>
                                            `;
                                        } catch (e) {
                                            return '<span class="text-red-400">Error parsing data</span>';
                                        }
                                    })()}
                                </div>
                            </div>
                            <div class="max-h-64 overflow-y-auto border border-gray-600 rounded">
                                <table class="w-full text-sm text-white">
                                    <thead class="sticky top-0 bg-gray-800 border-b border-gray-600">
                                        <tr>
                                            <th class="text-left py-2 px-3 text-gray-300">Repo ID</th>
                                            <th class="text-left py-2 px-3 text-gray-300">Full Name</th>
                                            <th class="text-center py-2 px-3 text-gray-300">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(() => {
                                            try {
                                                const queue = typeof details.repo_processing_queue === 'string'
                                                    ? JSON.parse(details.repo_processing_queue)
                                                    : details.repo_processing_queue;
                                                return queue.map(repo => `
                                                    <tr class="border-b border-gray-700 hover:bg-gray-700 hover:bg-opacity-30">
                                                        <td class="py-2 px-3 font-mono text-xs">${repo.repo_id || 'N/A'}</td>
                                                        <td class="py-2 px-3">${repo.full_name || 'N/A'}</td>
                                                        <td class="py-2 px-3 text-center">
                                                            <span class="px-2 py-1 rounded-full text-xs font-medium ${repo.finished ? 'bg-green-500 bg-opacity-20 text-green-400' : 'bg-yellow-500 bg-opacity-20 text-yellow-400'}">
                                                                <i class="fas fa-${repo.finished ? 'check' : 'clock'} mr-1"></i>
                                                                ${repo.finished ? 'Finished' : 'Pending'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `).join('');
                                            } catch (e) {
                                                return '<tr><td colspan="3" class="py-2 px-3 text-red-400">Error parsing queue data</td></tr>';
                                            }
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Error Message -->
                        ${details.error_message ? `
                        <div class="mt-6 glass-effect rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-red-400 mb-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Error Message
                            </h3>
                            <div class="text-red-300 bg-red-900 bg-opacity-30 p-3 rounded">
                                ${details.error_message}
                            </div>
                        </div>
                        ` : ''}

                        <div class="mt-6 flex justify-end">
                            <button onclick="closeJobDetailsModal()"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition duration-300">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Add keyboard event listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
        }

        function closeJobDetailsModal() {
            const modal = document.getElementById('jobDetailsModal');
            if (modal) {
                modal.remove();
                // Remove keyboard event listener
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        function handleModalKeydown(event) {
            if (event.key === 'Escape') {
                closeJobDetailsModal();
                closeGitHubRateLimitsModal();
            }
        }

        async function showGitHubRateLimits() {
            try {
                // Fetch GitHub rate limits from API
                const response = await fetch('/api/v1/github/rate-limits', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('pulse_token')}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error(`Failed to fetch GitHub rate limits: ${response.statusText}`);
                }

                const rateLimits = await response.json();
                showGitHubRateLimitsModal(rateLimits);

            } catch (error) {
                console.error('Error fetching GitHub rate limits:', error);
                alert(`Failed to load GitHub rate limits: ${error.message}`);
            }
        }

        function showGitHubRateLimitsModal(rateLimits) {
            // Helper function to format reset time
            function formatResetTime(resetTimestamp) {
                if (!resetTimestamp) return 'N/A';
                const resetDate = new Date(resetTimestamp * 1000);
                return resetDate.toLocaleString();
            }

            // Helper function to get status color
            function getStatusColor(remaining, limit) {
                const percentage = (remaining / limit) * 100;
                if (percentage > 50) return 'text-green-400';
                if (percentage > 20) return 'text-yellow-400';
                return 'text-red-400';
            }

            // Create modal HTML
            const modalHtml = `
                <div id="gitHubRateLimitsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">
                                <i class="fab fa-github mr-2"></i>GitHub API Rate Limits
                            </h2>
                            <button onclick="closeGitHubRateLimitsModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Core API -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-server mr-2"></i>Core API
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Limit:</span>
                                        <span class="text-white">${rateLimits.core?.limit || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Used:</span>
                                        <span class="text-white">${rateLimits.core?.used || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Remaining:</span>
                                        <span class="${getStatusColor(rateLimits.core?.remaining || 0, rateLimits.core?.limit || 1)}">${rateLimits.core?.remaining || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Reset:</span>
                                        <span class="text-white text-xs">${formatResetTime(rateLimits.core?.reset)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Search API -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-search mr-2"></i>Search API
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Limit:</span>
                                        <span class="text-white">${rateLimits.search?.limit || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Used:</span>
                                        <span class="text-white">${rateLimits.search?.used || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Remaining:</span>
                                        <span class="${getStatusColor(rateLimits.search?.remaining || 0, rateLimits.search?.limit || 1)}">${rateLimits.search?.remaining || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Reset:</span>
                                        <span class="text-white text-xs">${formatResetTime(rateLimits.search?.reset)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- GraphQL API -->
                            <div class="glass-effect rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">
                                    <i class="fas fa-code mr-2"></i>GraphQL API
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Limit:</span>
                                        <span class="text-white">${rateLimits.graphql?.limit || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Used:</span>
                                        <span class="text-white">${rateLimits.graphql?.used || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Remaining:</span>
                                        <span class="${getStatusColor(rateLimits.graphql?.remaining || 0, rateLimits.graphql?.limit || 1)}">${rateLimits.graphql?.remaining || 'N/A'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Reset:</span>
                                        <span class="text-white text-xs">${formatResetTime(rateLimits.graphql?.reset)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Info Section -->
                        <div class="mt-6 glass-effect rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-white mb-3">
                                <i class="fas fa-info-circle mr-2"></i>Rate Limit Information
                            </h3>
                            <div class="text-sm text-gray-300 space-y-2">
                                <p><strong>Core API:</strong> General GitHub API requests (repositories, issues, etc.)</p>
                                <p><strong>Search API:</strong> Repository and code search requests (30 requests/minute)</p>
                                <p><strong>GraphQL API:</strong> GraphQL queries (5000 points/hour, varies by query complexity)</p>
                                <p class="text-yellow-300"><i class="fas fa-exclamation-triangle mr-1"></i>Rate limits reset at the specified times above</p>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="closeGitHubRateLimitsModal()"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition duration-300">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Add keyboard event listener for ESC key
            document.addEventListener('keydown', handleModalKeydown);
        }

        function closeGitHubRateLimitsModal() {
            const modal = document.getElementById('gitHubRateLimitsModal');
            if (modal) {
                modal.remove();
                // Remove keyboard event listener
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        async function pauseJob(jobName) {
            if (!confirm(`Are you sure you want to pause ${jobName}?`)) return;

            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch(`/api/v1/jobs/${jobName}/pause`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.log(`${jobName} paused successfully`);
                    await refreshData(); // Refresh to show updated status
                } else {
                    console.error(`Failed to pause ${jobName}: ${result.detail || result.message}`);
                }
            } catch (error) {
                console.error(`Error pausing ${jobName}: ${error.message}`);
            }
        }

        async function unpauseJob(jobName) {
            if (!confirm(`Are you sure you want to unpause ${jobName}?`)) return;

            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch(`/api/v1/jobs/${jobName}/unpause`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.log(`${jobName} unpaused successfully - new status: ${result.status}`);
                    await refreshData(); // Refresh to show updated status
                } else {
                    console.error(`Failed to unpause ${jobName}: ${result.detail || result.message}`);
                }
            } catch (error) {
                console.error(`Error unpausing ${jobName}: ${error.message}`);
            }
        }

        async function setJobActive(jobName) {
            if (!confirm(`Set ${jobName} as active? This will set ${jobName} to PENDING and the other job to FINISHED.`)) return;

            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch(`/api/v1/jobs/${jobName}/set-active`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.log(`${jobName} set as active successfully`);
                    console.log(`Result: ${result.note}`);

                    // Show success message
                    const successMsg = `‚úÖ ${jobName} is now active and ready to run!\n${result.note}`;
                    alert(successMsg);

                    await refreshData(); // Refresh to show updated status
                } else {
                    console.error(`Failed to set ${jobName} as active: ${result.detail || result.message}`);
                    alert(`Failed to set ${jobName} as active: ${result.detail || result.message}`);
                }
            } catch (error) {
                console.error(`Error setting ${jobName} as active: ${error.message}`);
                alert(`Error setting ${jobName} as active: ${error.message}`);
            }
        }

        // Orchestrator Control Functions
        async function forceStartOrchestrator() {
            const button = event.target.closest('button');

            // Check if button is disabled
            if (button.disabled) {
                console.warn('Cannot start orchestrator while jobs are running');
                return;
            }

            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Starting...';
                button.disabled = true;

                const token = localStorage.getItem('pulse_token');
                const response = await fetch('/api/v1/orchestrator/start', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    // Refresh status after a short delay to allow scheduler to update
                    setTimeout(refreshOrchestratorStatus, 1000);
                } else {
                    console.error(`Failed to start orchestrator: ${result.detail}`);
                }
            } catch (error) {
                console.error(`Error starting orchestrator: ${error.message}`);
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }



        async function pauseOrchestrator() {
            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch('/api/v1/orchestrator/pause', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.warn('Orchestrator paused');
                    setTimeout(refreshOrchestratorStatus, 500);
                } else {
                    console.error(`Failed to pause orchestrator: ${result.detail}`);
                }
            } catch (error) {
                console.error(`Error pausing orchestrator: ${error.message}`);
            }
        }

        async function resumeOrchestrator() {
            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch('/api/v1/orchestrator/resume', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    console.log('Orchestrator resumed');
                    setTimeout(refreshOrchestratorStatus, 500);
                } else {
                    console.error(`Failed to resume orchestrator: ${result.detail}`);
                }
            } catch (error) {
                console.error(`Error resuming orchestrator: ${error.message}`);
            }
        }

        async function refreshOrchestratorStatus() {
            try {
                const token = localStorage.getItem('pulse_token');
                const response = await fetch('/api/v1/orchestrator/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const status = await response.json();
                    updateOrchestratorUI(status);
                }
            } catch (error) {
                console.error('Error fetching orchestrator status:', error);
            }
        }

        let countdownInterval = null;

        function updateOrchestratorUI(status) {
            const statusBadge = document.getElementById('orchestratorStatusBadge');
            const pauseBtn = document.getElementById('pauseOrchestratorBtn');
            const resumeBtn = document.getElementById('resumeOrchestratorBtn');

            // Update status badge
            statusBadge.textContent = status.status;
            statusBadge.className = 'px-2 py-1 rounded text-xs font-medium ';

            if (status.status === 'running') {
                statusBadge.className += 'bg-green-600 text-white';
                pauseBtn.classList.remove('hidden');
                resumeBtn.classList.add('hidden');

                // Start countdown timer
                startCountdownTimer(status.next_run);
            } else if (status.status === 'paused') {
                statusBadge.className += 'bg-yellow-600 text-white';
                pauseBtn.classList.add('hidden');
                resumeBtn.classList.remove('hidden');

                // Stop countdown timer when paused
                stopCountdownTimer();
            } else {
                statusBadge.className += 'bg-gray-600 text-white';
                pauseBtn.classList.add('hidden');
                resumeBtn.classList.add('hidden');

                // Stop countdown timer when not running
                stopCountdownTimer();
            }
        }

        function startCountdownTimer(nextRunTime) {
            // Clear any existing timer
            stopCountdownTimer();

            if (!nextRunTime) {
                document.getElementById('countdownTimer').textContent = '--:--:--';
                return;
            }

            const nextRun = new Date(nextRunTime);

            countdownInterval = setInterval(() => {
                const now = new Date();
                const timeDiff = nextRun - now;

                if (timeDiff <= 0) {
                    document.getElementById('countdownTimer').textContent = '00:00:00';
                    // Refresh orchestrator status when countdown reaches zero
                    setTimeout(refreshOrchestratorStatus, 1000);
                    return;
                }

                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('countdownTimer').textContent = timeString;
            }, 1000);
        }

        function stopCountdownTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            document.getElementById('countdownTimer').textContent = '--:--:--';
        }

        // Orchestrator Settings Functions
        async function showOrchestratorSettings() {
            try {
                // Load current settings
                const response = await fetch('/api/v1/settings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('pulse_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const settings = data.settings;

                    // Update modal with current values
                    const intervalSelect = document.getElementById('orchestratorInterval');
                    const enabledCheckbox = document.getElementById('orchestratorEnabled');

                    if (settings.orchestrator_interval_minutes) {
                        intervalSelect.value = settings.orchestrator_interval_minutes.value;
                    }

                    if (settings.orchestrator_enabled) {
                        enabledCheckbox.checked = settings.orchestrator_enabled.value;
                    }
                }

                // Show modal
                document.getElementById('orchestratorSettingsModal').classList.remove('hidden');

            } catch (error) {
                console.error('Failed to load orchestrator settings:', error);
            }
        }

        function hideOrchestratorSettings() {
            document.getElementById('orchestratorSettingsModal').classList.add('hidden');
        }

        async function saveOrchestratorSettings() {
            try {
                const intervalSelect = document.getElementById('orchestratorInterval');
                const enabledCheckbox = document.getElementById('orchestratorEnabled');

                const intervalMinutes = parseInt(intervalSelect.value);
                const enabled = enabledCheckbox.checked;

                const response = await fetch('/api/v1/orchestrator/schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('pulse_token')}`
                    },
                    body: JSON.stringify({
                        interval_minutes: intervalMinutes,
                        enabled: enabled
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    console.log(`Orchestrator schedule updated: ${intervalMinutes} minutes, enabled: ${enabled}`);
                    hideOrchestratorSettings();

                    // Refresh orchestrator status to show new schedule
                    setTimeout(refreshOrchestratorStatus, 1000);
                } else {
                    console.error(`Failed to update orchestrator schedule: ${result.detail}`);
                }

            } catch (error) {
                console.error('Failed to save orchestrator settings:', error);
            }
        }

        // Hamburger Menu Functions
        function toggleMenu() {
            const dropdown = document.getElementById('menuDropdown');
            console.log('Toggle menu clicked, dropdown:', dropdown);
            dropdown.classList.toggle('show');
            console.log('Menu classes after toggle:', dropdown.className);
        }

        // Close menu when clicking outside
        document.addEventListener('click', function (event) {
            const menu = document.querySelector('.hamburger-menu');
            const dropdown = document.getElementById('menuDropdown');

            if (!menu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Role-based UI Management
        let currentUser = null;

        // Initialize role-based UI on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadUserInfo();
        });

        // Load current user information
        async function loadUserInfo() {
            // Use server-side user info directly
            currentUser = {
                email: '{{ user.email }}',
                role: '{{ user.role }}',
                is_admin: '{{ user.is_admin }}' === 'True'
            };
            updateUIForRole();
        }

        // Update UI based on user role
        function updateUIForRole() {
            if (!currentUser) return;

            // Show/hide admin menu item
            const adminMenuItem = document.getElementById('admin-menu-item');
            if (currentUser.is_admin || currentUser.role === 'admin') {
                adminMenuItem.style.display = 'block';
            }

            // Update user role badge
            const roleBadge = document.getElementById('user-role-badge');
            if (roleBadge) {
                roleBadge.textContent = currentUser.role.toUpperCase();
                roleBadge.style.display = 'inline';

                // Style badge based on role
                roleBadge.className = 'ml-2 px-2 py-1 rounded text-xs font-semibold ';
                if (currentUser.role === 'admin') {
                    roleBadge.className += 'bg-red-600 text-white';
                } else if (currentUser.role === 'user') {
                    roleBadge.className += 'bg-blue-600 text-white';
                } else if (currentUser.role === 'view') {
                    roleBadge.className += 'bg-gray-600 text-white';
                }
            }

            // Hide job control buttons for non-admin users
            if (currentUser.role !== 'admin' && !currentUser.is_admin) {
                hideJobControlButtons();
            }
        }

        // Hide job control buttons for users without job control permissions
        function hideJobControlButtons() {
            // Hide only the orchestrator control buttons, keep status visible
            const orchestratorControlButtons = document.getElementById('orchestratorControlButtons');
            if (orchestratorControlButtons) {
                orchestratorControlButtons.style.display = 'none';
            }

            // Change the section title to "Orchestrator Status" for non-admin users
            const orchestratorTitle = document.getElementById('orchestratorSectionTitle');
            if (orchestratorTitle) {
                orchestratorTitle.innerHTML = '<i class="fas fa-eye mr-2"></i>Orchestrator Status';
            }

            // Add a notice for non-admin users at the top of the main content area
            if (!document.getElementById('role-notice')) {
                const notice = document.createElement('div');
                notice.id = 'role-notice';
                notice.className = 'glass-effect rounded-lg p-4 mb-6';
                notice.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                        <div class="text-white">
                            <h3 class="font-semibold">View-Only Access</h3>
                            <p class="text-white text-opacity-70 text-sm">You have read-only access to the ETL dashboard. Job controls are available to admin users only.</p>
                        </div>
                    </div>
                `;

                // Insert at the very beginning of the main content area
                const mainContent = document.querySelector('main.container');
                if (mainContent && mainContent.firstChild) {
                    mainContent.insertBefore(notice, mainContent.firstChild);
                }
            }
        }

        // Override job control functions for non-admin users
        const originalForceStart = window.forceStart;
        const originalForceStop = window.forceStop;
        const originalPauseJob = window.pauseJob;
        const originalUnpauseJob = window.unpauseJob;

        window.forceStart = function (jobName) {
            if (currentUser && currentUser.role !== 'admin' && !currentUser.is_admin) {
                alert('Job control is restricted to admin users only.');
                return;
            }
            return originalForceStart(jobName);
        };

        window.forceStop = function (jobName) {
            if (currentUser && currentUser.role !== 'admin' && !currentUser.is_admin) {
                alert('Job control is restricted to admin users only.');
                return;
            }
            return originalForceStop(jobName);
        };

        window.pauseJob = function (jobName) {
            if (currentUser && currentUser.role !== 'admin' && !currentUser.is_admin) {
                alert('Job control is restricted to admin users only.');
                return;
            }
            return originalPauseJob(jobName);
        };

        window.unpauseJob = function (jobName) {
            if (currentUser && currentUser.role !== 'admin' && !currentUser.is_admin) {
                alert('Job control is restricted to admin users only.');
                return;
            }
            return originalUnpauseJob(jobName);
        };
    </script>
</body>

</html>