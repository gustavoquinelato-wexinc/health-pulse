<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Mappings - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .stats-card {
            transition: transform 0.2s ease-in-out;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }

        /* Sortable column styles */
        .sortable {
            cursor: pointer;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }

        .sortable.sort-asc i:before {
            content: "\f0de";
            opacity: 1;
        }

        .sortable.sort-desc i:before {
            content: "\f0dd";
            opacity: 1;
        }

        /* Category badge colors */
        .category-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .category-todo {
            background-color: #6c757d;
            color: white;
        }

        .category-inprogress {
            background-color: #0d6efd;
            color: white;
        }

        .category-waiting {
            background-color: #ffc107;
            color: black;
        }

        .category-done {
            background-color: #198754;
            color: white;
        }

        .category-discarded {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Pulse ETL
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fas fa-tachometer-alt me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-mappings">
                            <i class="fas fa-sitemap me-2"></i>Issue Type Mappings
                        </a></li>
                        <li><a class="dropdown-item" href="/admin/issuetype-hierarchies">
                            <i class="fas fa-layer-group me-2"></i>Issue Type Hierarchies
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/admin/workflows">
                            <i class="fas fa-stream me-2"></i>Workflows
                        </a></li>
                        <li><a class="dropdown-item active" href="/admin/status-mappings">
                            <i class="fas fa-exchange-alt me-2"></i>Status Mappings
                        </a></li>
                    </ul>
                </div>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-exchange-alt me-3"></i>Status Mappings
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage status mappings for workflow standardization</p>
                </div>

            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Status Mappings Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Status Mappings
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshStatusMappings()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showCreateStatusMappingModal()">
                                    <i class="fas fa-plus"></i> Add Mapping
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filters -->
                        <div class="row mb-3">
                            <div class="col-lg-3 col-md-4">
                                <label for="searchFromStatus" class="form-label text-dark fw-bold">Search Status Mappings</label>
                                <input type="text" class="form-control" id="searchFromStatus" placeholder="Search from status..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterToStatus" class="form-label text-dark fw-bold">To Status</label>
                                <select class="form-select" id="filterToStatus" onchange="applyFilters()">
                                    <option value="">All To Status</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterCategory" class="form-label text-dark fw-bold">Category</label>
                                <select class="form-select" id="filterCategory" onchange="applyFilters()">
                                    <option value="">All Categories</option>
                                    <option value="To Do">To Do</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Waiting">Waiting</option>
                                    <option value="Done">Done</option>
                                    <option value="Discarded">Discarded</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterWorkflow" class="form-label text-dark fw-bold">Workflow</label>
                                <select class="form-select" id="filterWorkflow" onchange="applyFilters()">
                                    <option value="">All Workflows</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-3">
                                <label for="filterIntegration" class="form-label text-dark fw-bold">Integration</label>
                                <select class="form-select" id="filterIntegration" onchange="applyFilters()">
                                    <option value="">All Integrations</option>
                                </select>
                            </div>
                            <div class="col-lg-1 col-md-2">
                                <label for="filterActive" class="form-label text-dark fw-bold">Status</label>
                                <select class="form-select" id="filterActive" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" onclick="sortTable('status_from')">
                                            From Status <i class="fas fa-sort" id="sort-status_from"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('status_to')">
                                            To Status <i class="fas fa-sort" id="sort-status_to"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('status_category')">
                                            Category <i class="fas fa-sort" id="sort-status_category"></i>
                                        </th>
                                        <th class="sortable" onclick="sortTable('workflow_step')">
                                            Workflow Name <i class="fas fa-sort" id="sort-workflow_step"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('step_number')">
                                            Step # <i class="fas fa-sort" id="sort-step_number"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('integration_name')">
                                            Integration <i class="fas fa-sort" id="sort-integration_name"></i>
                                        </th>
                                        <th class="sortable text-center" onclick="sortTable('active')">
                                            Status <i class="fas fa-sort" id="sort-active"></i>
                                        </th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="status-mappings-table-body">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading status mappings...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Status Mapping Modal -->
    <div class="modal fade" id="statusMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusMappingModalTitle">Add Status Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusMappingForm">
                        <div class="mb-3">
                            <label for="statusFrom" class="form-label">From Status</label>
                            <input type="text" class="form-control" id="statusFrom" required>
                        </div>
                        <div class="mb-3">
                            <label for="statusTo" class="form-label">To Status</label>
                            <input type="text" class="form-control" id="statusTo" required>
                        </div>
                        <div class="mb-3">
                            <label for="statusCategory" class="form-label">Status Category</label>
                            <select class="form-control" id="statusCategory" required>
                                <option value="">Select Category</option>
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Done">Done</option>
                                <option value="Discarded">Discarded</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="workflow" class="form-label">Workflow</label>
                            <select class="form-control" id="workflow">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="integration" class="form-label">Integration</label>
                            <select class="form-control" id="integration">
                                <option value="">Select Integration</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStatusMapping()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Status Mapping Modal -->
    <div class="modal fade" id="editStatusMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Status Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStatusMappingForm">
                        <input type="hidden" id="editMappingId">
                        <div class="mb-3">
                            <label for="editStatusFrom" class="form-label">From Status</label>
                            <input type="text" class="form-control" id="editStatusFrom" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStatusTo" class="form-label">To Status</label>
                            <input type="text" class="form-control" id="editStatusTo" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStatusCategory" class="form-label">Category</label>
                            <select class="form-control" id="editStatusCategory" required>
                                <option value="">Select Category</option>
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Waiting">Waiting</option>
                                <option value="Done">Done</option>
                                <option value="Discarded">Discarded</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editWorkflow" class="form-label">Workflow</label>
                            <select class="form-control" id="editWorkflow">
                                <option value="">Loading workflows...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editIntegration" class="form-label">Integration</label>
                            <select class="form-control" id="editIntegration">
                                <option value="">Select Integration</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStatusMappingChanges()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivation Modal -->
    <div class="modal fade" id="deactivationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-pause me-2"></i>Deactivate Status Mapping
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="deactivationContent">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmDeactivationBtn" onclick="confirmDeactivation()">
                        <i class="fas fa-pause me-1"></i>Deactivate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let statusMappings = [];
        let filteredMappings = [];
        let workflows = [];
        let integrations = [];
        let editingMappingId = null;
        let currentSort = { column: 'status_from', direction: 'asc' };

        // Load integrations
        async function loadIntegrations() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/integrations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    integrations = await response.json();
                    populateIntegrationDropdowns();
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
            }
        }

        function populateIntegrationDropdowns() {
            const createSelect = document.getElementById('integration');
            const editSelect = document.getElementById('editIntegration');
            const filterSelect = document.getElementById('filterIntegration');

            // Clear existing options
            createSelect.innerHTML = '<option value="">Select Integration</option>';
            editSelect.innerHTML = '<option value="">Select Integration</option>';
            filterSelect.innerHTML = '<option value="">All Integrations</option>';

            // Add integration options
            integrations.forEach(integration => {
                if (integration.active) {
                    const createOption = new Option(integration.name, integration.id);
                    const editOption = new Option(integration.name, integration.id);
                    const filterOption = new Option(integration.name, integration.name);
                    createSelect.appendChild(createOption);
                    editSelect.appendChild(editOption);
                    filterSelect.appendChild(filterOption);
                }
            });
        }

        // Get integration icon and color
        function getIntegrationIcon(integrationName) {
            if (!integrationName) return '<i class="fas fa-plug text-secondary"></i>';

            const name = integrationName.toUpperCase();
            let icon = 'fas fa-plug';
            let iconColor = 'text-secondary';

            if (name === 'GITHUB') {
                icon = 'fab fa-github';
                iconColor = 'text-dark';
            } else if (name === 'JIRA') {
                icon = 'fab fa-atlassian';
                iconColor = 'text-primary';
            } else if (name === 'AHA!') {
                icon = 'fas fa-lightbulb';
                iconColor = 'text-warning';
            } else if (name === 'AZURE DEVOPS') {
                icon = 'fab fa-microsoft';
                iconColor = 'text-info';
            }

            return `<i class="${icon} ${iconColor}"></i>`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            loadWorkflows();
            loadStatusMappings();
            loadIntegrations();
            updateSortIndicators();
        });

        // Load workflows
        async function loadWorkflows() {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('/api/v1/admin/workflows', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    workflows = await response.json();
                    populateWorkflowFilters();
                }
            } catch (error) {
                console.error('Error loading workflows:', error);
            }
        }

        function populateWorkflowFilters() {
            const editSelect = document.getElementById('editWorkflow');
            const filterSelect = document.getElementById('filterWorkflow');

            // Clear existing options
            editSelect.innerHTML = '<option value="">None</option>';
            filterSelect.innerHTML = '<option value="">All Workflows</option>';

            // Add workflow options
            workflows.forEach(workflow => {
                const editOption = new Option(workflow.step_name, workflow.id);
                const filterOption = new Option(workflow.step_name, workflow.step_name);
                editSelect.add(editOption);
                filterSelect.add(filterOption);
            });
        }

        // Sorting functionality
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            filteredMappings.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                // Convert to lowercase for case-insensitive sorting
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                if (currentSort.direction === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            updateStatusMappingsDisplay();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            // Reset all sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Set current sort indicator
            const currentHeader = document.querySelector(`#sort-${currentSort.column}`);
            if (currentHeader) {
                const th = currentHeader.closest('th');
                th.classList.add(`sort-${currentSort.direction}`);
            }
        }

        // Filtering functionality
        function applyFilters() {
            const searchFromStatus = document.getElementById('searchFromStatus').value.toLowerCase();
            const filterToStatus = document.getElementById('filterToStatus').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterWorkflow = document.getElementById('filterWorkflow').value;
            const filterIntegration = document.getElementById('filterIntegration').value;
            const filterActive = document.getElementById('filterActive').value;

            filteredMappings = statusMappings.filter(mapping => {
                // Search by from status
                const matchesFromStatus = !searchFromStatus ||
                    mapping.status_from.toLowerCase().includes(searchFromStatus);

                // Filter by to status
                const matchesToStatus = !filterToStatus ||
                    mapping.status_to === filterToStatus;

                // Filter by category
                const matchesCategory = !filterCategory ||
                    mapping.status_category === filterCategory;

                // Filter by workflow
                const matchesWorkflow = !filterWorkflow ||
                    mapping.workflow_step_name === filterWorkflow;

                // Filter by integration
                const matchesIntegration = !filterIntegration ||
                    mapping.integration_name === filterIntegration;

                // Filter by active status
                const matchesActive = !filterActive ||
                    mapping.active.toString() === filterActive;

                return matchesFromStatus && matchesToStatus && matchesCategory && matchesWorkflow && matchesIntegration && matchesActive;
            });

            // Re-apply current sort to filtered data
            if (currentSort.column) {
                sortTable(currentSort.column);
            } else {
                updateStatusMappingsDisplay();
            }
        }

        function populateFilterOptions() {
            // Populate To Status filter
            const toStatusSet = new Set(statusMappings.map(m => m.status_to));
            const toStatusSelect = document.getElementById('filterToStatus');
            toStatusSelect.innerHTML = '<option value="">All To Status</option>';
            Array.from(toStatusSet).sort().forEach(status => {
                toStatusSelect.add(new Option(status, status));
            });
        }

        // Get authentication token from cookie
        function getAuthToken() {
            // Try localStorage first (for compatibility)
            let token = localStorage.getItem('pulse_token') || localStorage.getItem('token');

            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'pulse_token' || name === 'access_token') {
                        token = value;
                        break;
                    }
                }
            }

            return token;
        }

        // Load status mappings
        async function loadStatusMappings() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No authentication token found');
                    window.location.href = '/login?error=authentication_required';
                    return;
                }

                const response = await fetch('/api/v1/admin/status-mappings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    statusMappings = await response.json();
                    filteredMappings = [...statusMappings]; // Initialize filtered data
                    populateFilterOptions();
                    updateStatusMappingsDisplay();
                } else if (response.status === 401) {
                    console.error('Authentication failed');
                    window.location.href = '/login?error=authentication_expired';
                } else {
                    console.error('Failed to load status mappings');
                    document.getElementById('status-mappings-table-body').innerHTML = `
                        <tr><td colspan="5" class="text-center text-danger">Failed to load status mappings</td></tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading status mappings:', error);
                document.getElementById('status-mappings-table-body').innerHTML = `
                    <tr><td colspan="5" class="text-center text-danger">Error loading status mappings</td></tr>
                `;
            }
        }

        function updateStatusMappingsDisplay() {
            const tbody = document.getElementById('status-mappings-table-body');
            tbody.innerHTML = '';

            if (!filteredMappings || filteredMappings.length === 0) {
                const message = statusMappings.length === 0 ? 'No status mappings found' : 'No mappings match the current filters';
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted">${message}</td></tr>
                `;
                return;
            }

            filteredMappings.forEach(mapping => {
                const row = document.createElement('tr');

                // Add inactive row styling if needed
                if (!mapping.active) {
                    row.classList.add('table-secondary', 'text-muted');
                }

                // Get category color class
                const categoryClass = getCategoryColorClass(mapping.status_category);

                row.innerHTML = `
                    <td>${mapping.status_from}</td>
                    <td>${mapping.status_to}</td>
                    <td class="text-center"><span class="category-badge ${categoryClass}">${mapping.status_category}</span></td>
                    <td>${mapping.workflow_step_name || '-'}</td>
                    <td class="text-center">${mapping.step_number || '-'}</td>
                    <td class="text-center">${getIntegrationIcon(mapping.integration_name)}</td>
                    <td class="text-center">
                        ${mapping.active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'
                        }
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editStatusMapping(${mapping.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${mapping.active
                            ? `<button class="btn btn-sm btn-outline-warning me-1" onclick="deactivateStatusMapping(${mapping.id})" title="Deactivate">
                                <i class="fas fa-pause"></i>
                               </button>`
                            : `<button class="btn btn-sm btn-outline-success me-1" onclick="activateStatusMapping(${mapping.id})" title="Activate">
                                <i class="fas fa-play"></i>
                               </button>`
                        }
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStatusMapping(${mapping.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getCategoryColorClass(category) {
            const categoryLower = category.toLowerCase();

            if (categoryLower === 'to do') {
                return 'category-todo';
            } else if (categoryLower === 'in progress') {
                return 'category-inprogress';
            } else if (categoryLower === 'waiting') {
                return 'category-waiting';
            } else if (categoryLower === 'done') {
                return 'category-done';
            } else if (categoryLower === 'discarded') {
                return 'category-discarded';
            } else {
                // Default to a neutral color for unknown categories
                return 'category-todo';
            }
        }

        function refreshStatusMappings() {
            loadStatusMappings();
        }

        function showCreateStatusMappingModal() {
            editingMappingId = null;
            document.getElementById('statusMappingModalTitle').textContent = 'Add Status Mapping';
            document.getElementById('statusMappingForm').reset();

            // Populate workflows dropdown
            const workflowSelect = document.getElementById('workflow');
            workflowSelect.innerHTML = '<option value="">None</option>';
            workflows.forEach(workflow => {
                const option = new Option(workflow.step_name, workflow.id);
                workflowSelect.add(option);
            });

            // Populate integrations dropdown
            const integrationSelect = document.getElementById('integration');
            integrationSelect.innerHTML = '<option value="">Select Integration</option>';
            integrations.forEach(integration => {
                if (integration.active) {
                    const option = new Option(integration.name, integration.id);
                    integrationSelect.add(option);
                }
            });

            new bootstrap.Modal(document.getElementById('statusMappingModal')).show();
        }

        async function editStatusMapping(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/status-mappings/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const mapping = await response.json();

                    // Populate the modal
                    document.getElementById('editMappingId').value = mapping.id;
                    document.getElementById('editStatusFrom').value = mapping.status_from;
                    document.getElementById('editStatusTo').value = mapping.status_to;
                    document.getElementById('editStatusCategory').value = mapping.status_category;
                    document.getElementById('editWorkflow').value = mapping.workflow_id || '';
                    document.getElementById('editIntegration').value = mapping.integration_id || '';

                    // Show the modal
                    new bootstrap.Modal(document.getElementById('editStatusMappingModal')).show();
                } else {
                    alert('Failed to load status mapping details');
                }
            } catch (error) {
                console.error('Error loading status mapping:', error);
                alert('Error loading status mapping details');
            }
        }

        async function saveStatusMappingChanges() {
            const id = document.getElementById('editMappingId').value;
            const statusFrom = document.getElementById('editStatusFrom').value;
            const statusTo = document.getElementById('editStatusTo').value;
            const statusCategory = document.getElementById('editStatusCategory').value;
            const workflowId = document.getElementById('editWorkflow').value;
            const integrationId = document.getElementById('editIntegration').value;

            if (!statusFrom || !statusTo || !statusCategory) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) return;

                const updateData = {
                    status_from: statusFrom,
                    status_to: statusTo,
                    status_category: statusCategory,
                    workflow_id: workflowId || null,
                    integration_id: integrationId || null
                };

                const response = await fetch(`/api/v1/admin/status-mappings/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    // Close modal and refresh data
                    bootstrap.Modal.getInstance(document.getElementById('editStatusMappingModal')).hide();
                    loadStatusMappings();
                    alert('Status mapping updated successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed to update status mapping: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating status mapping:', error);
                alert('Error updating status mapping');
            }
        }

        async function deleteStatusMapping(id) {
            // First check if this mapping has dependencies
            try {
                const token = getAuthToken();
                if (!token) return;

                // Check dependencies first
                const depResponse = await fetch(`/api/v1/admin/status-mappings/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (depResponse.ok) {
                    const depData = await depResponse.json();

                    if (!depData.has_dependencies) {
                        // Safe to delete - confirm with user
                        const mapping = statusMappings.find(m => m.id === id);
                        if (confirm(`Are you sure you want to permanently delete the status mapping "${mapping.status_from} → ${mapping.status_to}"?\n\nThis action cannot be undone.`)) {
                            await performDelete(id);
                        }
                        return;
                    }
                }

                // Has dependencies - open deactivation modal with delete context
                await showDeactivationModal(id, true); // true indicates delete context
            } catch (error) {
                console.error('Error checking dependencies:', error);
                // Fallback to modal
                await showDeactivationModal(id, true);
            }
        }

        async function activateStatusMapping(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/status-mappings/${id}/activate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Status mapping activated successfully');
                    loadStatusMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to activate status mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error activating status mapping:', error);
                alert('Error activating status mapping');
            }
        }

        async function deactivateStatusMapping(id) {
            // Show the deactivation modal
            await showDeactivationModal(id, false); // false indicates deactivate context
        }

        // Deactivation modal functionality
        let currentDeactivationMappingId = null;
        let isDeleteContext = false;

        async function showDeactivationModal(id, deleteContext = false) {
            isDeleteContext = deleteContext;
            try {
                const token = getAuthToken();
                if (!token) return;

                currentDeactivationMappingId = id;
                const mapping = statusMappings.find(m => m.id === id);

                // Show loading state first
                document.getElementById('deactivationContent').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>Checking dependencies...
                    </div>
                `;

                // Update modal title and button based on context
                const modalTitle = document.querySelector('#deactivationModal .modal-title');
                const confirmButton = document.getElementById('confirmDeactivationBtn');

                if (isDeleteContext) {
                    modalTitle.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Status Mapping';
                    confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                    confirmButton.className = 'btn btn-danger';
                } else {
                    modalTitle.innerHTML = '<i class="fas fa-pause me-2"></i>Deactivate Status Mapping';
                    confirmButton.innerHTML = '<i class="fas fa-pause me-1"></i>Deactivate';
                    confirmButton.className = 'btn btn-warning';
                }

                new bootstrap.Modal(document.getElementById('deactivationModal')).show();

                // Check for dependencies
                const response = await fetch(`/api/v1/admin/status-mappings/${id}/dependencies`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    const contextMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Status Mapping:</strong> ${mapping.status_from} → ${mapping.status_to}
                           </div>`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Status Mapping:</strong> ${mapping.status_from} → ${mapping.status_to}
                           </div>`;

                    let content = contextMessage;

                    if (data.has_dependencies) {
                        content += `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Impact:</strong> This mapping has active dependencies:
                            </div>
                            <ul class="mb-3">
                                <li><strong>${data.dependent_issues_count}</strong> active issue(s) using this status mapping</li>
                            </ul>
                        `;

                        if (data.reassignment_targets.length > 0) {
                            content += `
                                <h6 class="mb-3">${isDeleteContext
                                    ? 'Reassign dependencies before deletion:'
                                    : 'Choose how to handle dependent issues:'}</h6>
                                ${isDeleteContext
                                    ? '<p class="text-muted mb-3">To delete this mapping, all dependent issues must be reassigned to another active mapping.</p>'
                                    : ''}

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="deactivationAction" id="reassignIssues" value="reassign_issues" checked>
                                    <label class="form-check-label" for="reassignIssues">
                                        <strong>Reassign issues to another mapping</strong> ${isDeleteContext ? '(required for deletion)' : '(recommended)'}
                                        <div class="mt-2">
                                            <select class="form-select" id="targetMapping">
                                                <option value="">Select target mapping...</option>
                                                ${data.reassignment_targets.map(target =>
                                                    `<option value="${target.id}">${target.status_from} → ${target.status_to} (${target.status_category}) - Active</option>`
                                                ).join('')}
                                            </select>
                                            <small class="text-muted">Only active mappings are shown as reassignment targets.</small>
                                        </div>
                                    </label>
                                </div>

                                ${!isDeleteContext ? `
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="deactivationAction" id="keepIssues" value="keep_issues">
                                    <label class="form-check-label" for="keepIssues">
                                        <strong>Keep issues active</strong> (they will reference this inactive mapping)
                                        <small class="d-block text-muted mt-1">Issues will continue to work but may cause data inconsistencies</small>
                                    </label>
                                </div>
                                ` : ''}
                            `;
                        } else {
                            content += `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Cannot ${isDeleteContext ? 'delete' : 'deactivate'}:</strong> No other active mappings available for reassignment.
                                </div>
                                <p>You must have at least one other active mapping to reassign the dependent issues before ${isDeleteContext ? 'deletion' : 'deactivation'} can proceed.</p>
                                <p><strong>Options:</strong></p>
                                <ul>
                                    <li>Create a new mapping first, then try again</li>
                                    <li>Activate an existing inactive mapping, then try again</li>
                                </ul>
                                <input type="hidden" name="deactivationAction" value="blocked">
                            `;
                        }
                    } else {
                        if (isDeleteContext) {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to delete:</strong> No active issues are using this mapping.
                                </div>
                                <p>This mapping can be safely deleted without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="safe_delete">
                            `;
                        } else {
                            content += `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Safe to deactivate:</strong> No active issues are using this mapping.
                                </div>
                                <p>This mapping can be safely deactivated without affecting existing data.</p>
                                <input type="hidden" name="deactivationAction" value="keep_issues">
                            `;
                        }
                    }

                    document.getElementById('deactivationContent').innerHTML = content;

                    // Disable confirmation button if action is blocked
                    const confirmButton = document.getElementById('confirmDeactivationBtn');
                    if (data.has_dependencies && data.reassignment_targets.length === 0) {
                        confirmButton.disabled = true;
                        confirmButton.innerHTML = '<i class="fas fa-ban me-1"></i>Cannot Proceed';
                        confirmButton.className = 'btn btn-secondary';
                    } else {
                        confirmButton.disabled = false;
                        if (isDeleteContext) {
                            confirmButton.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
                            confirmButton.className = 'btn btn-danger';
                        } else {
                            confirmButton.innerHTML = '<i class="fas fa-pause me-1"></i>Deactivate';
                            confirmButton.className = 'btn btn-warning';
                        }
                    }
                } else {
                    // Fallback to simple modal if dependencies check fails
                    const fallbackMessage = isDeleteContext
                        ? `<div class="alert alert-danger">
                            <i class="fas fa-trash me-2"></i>
                            <strong>Delete Status Mapping:</strong> ${mapping.status_from} → ${mapping.status_to}
                           </div>
                           <p>Unable to check dependencies. This mapping will be deleted.</p>
                           <input type="hidden" name="deactivationAction" value="safe_delete">`
                        : `<div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Deactivate Status Mapping:</strong> ${mapping.status_from} → ${mapping.status_to}
                           </div>
                           <p>This mapping will be deactivated and excluded from future processing.</p>
                           <input type="hidden" name="deactivationAction" value="keep_issues">`;

                    document.getElementById('deactivationContent').innerHTML = fallbackMessage;
                }
            } catch (error) {
                console.error('Error showing deactivation modal:', error);
                alert('Error showing deactivation modal');
            }
        }

        async function confirmDeactivation() {
            try {
                const token = getAuthToken();
                if (!token) return;

                // Get selected action
                const selectedAction = document.querySelector('input[name="deactivationAction"]:checked')?.value || 'keep_issues';

                let targetMappingId = null;
                if (selectedAction === 'reassign_issues') {
                    targetMappingId = document.getElementById('targetMapping')?.value;
                    if (!targetMappingId) {
                        alert('Please select a target mapping for reassignment');
                        return;
                    }

                    // Additional validation: ensure target is not the same as current mapping
                    if (parseInt(targetMappingId) === currentDeactivationMappingId) {
                        alert('Cannot reassign to the same mapping. Please select a different target.');
                        return;
                    }
                }

                // For delete context: handle both safe delete and reassignment
                if (isDeleteContext) {
                    if (selectedAction === 'safe_delete') {
                        // Safe to delete directly - no dependencies
                        await performDelete(currentDeactivationMappingId);
                        return;
                    }

                    if (selectedAction === 'blocked') {
                        alert('Cannot proceed: No other active mappings available for reassignment. Please create or activate another mapping first.');
                        return;
                    }

                    // Force reassignment for delete context with dependencies
                    if (selectedAction !== 'reassign_issues') {
                        alert('Reassignment is required for deletion');
                        return;
                    }

                    // Validate target selection
                    const targetSelect = document.getElementById('targetMapping');
                    if (!targetSelect) {
                        alert('Cannot delete: No reassignment targets available.');
                        return;
                    }

                    // Step 1: Reassign dependencies using the enhanced deactivate API
                    const reassignBody = {
                        action: 'reassign_issues',
                        target_mapping_id: parseInt(targetMappingId)
                    };

                    const reassignResponse = await fetch(`/api/v1/admin/status-mappings/${currentDeactivationMappingId}/deactivate`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reassignBody)
                    });

                    if (!reassignResponse.ok) {
                        const error = await reassignResponse.json();
                        alert(`Failed to reassign dependencies: ${error.detail}`);
                        return;
                    }

                    // Step 2: Now delete the mapping (should be safe now)
                    const deleteResponse = await fetch(`/api/v1/admin/status-mappings/${currentDeactivationMappingId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (deleteResponse.ok) {
                        const deleteResult = await deleteResponse.json();
                        alert(`Dependencies reassigned and mapping deleted successfully`);
                        bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                        loadStatusMappings();
                    } else {
                        const error = await deleteResponse.json();
                        alert(`Dependencies reassigned but failed to delete mapping: ${error.detail}`);
                    }
                    return;
                }

                // For deactivate context, use enhanced deactivate API
                const requestBody = {
                    action: selectedAction,
                    target_mapping_id: targetMappingId ? parseInt(targetMappingId) : null
                };

                const response = await fetch(`/api/v1/admin/status-mappings/${currentDeactivationMappingId}/deactivate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Status mapping deactivated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('deactivationModal')).hide();
                    loadStatusMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to deactivate mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deactivating mapping:', error);
                alert('Error deactivating mapping');
            }
        }

        async function performDelete(id) {
            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`/api/v1/admin/status-mappings/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'Status mapping deleted successfully');
                    // Close modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deactivationModal'));
                    if (modal) modal.hide();
                    loadStatusMappings();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete mapping: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error deleting mapping:', error);
                alert('Error deleting mapping');
            }
        }

        async function saveStatusMapping() {
            const statusFrom = document.getElementById('statusFrom').value;
            const statusTo = document.getElementById('statusTo').value;
            const statusCategory = document.getElementById('statusCategory').value;
            const workflowId = document.getElementById('workflow').value;
            const integrationId = document.getElementById('integration').value;

            if (!statusFrom || !statusTo || !statusCategory) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) return;

                const createData = {
                    status_from: statusFrom,
                    status_to: statusTo,
                    status_category: statusCategory,
                    workflow_id: workflowId || null,
                    integration_id: integrationId || null
                };

                const response = await fetch('/api/v1/admin/status-mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(createData)
                });

                if (response.ok) {
                    // Close modal and refresh data
                    bootstrap.Modal.getInstance(document.getElementById('statusMappingModal')).hide();
                    loadStatusMappings();
                    alert('Status mapping created successfully');
                } else {
                    const error = await response.json();
                    alert(`Failed to create status mapping: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error creating status mapping:', error);
                alert('Error creating status mapping');
            }
        }
    </script>
</body>
</html>
