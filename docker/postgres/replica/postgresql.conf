# PostgreSQL Replica Database Configuration
# Optimized for read operations and replication

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================
listen_addresses = '*'
port = 5432
max_connections = 100

# =============================================================================
# MEMORY SETTINGS (Optimized for read operations)
# =============================================================================
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 8MB  # Higher for read queries
maintenance_work_mem = 64MB

# =============================================================================
# WRITE-AHEAD LOGGING (WAL) - REPLICA SETTINGS
# =============================================================================
# WAL settings for replica
wal_level = replica
max_wal_senders = 0  # Replica doesn't send WAL
max_replication_slots = 0  # Replica doesn't have slots

# =============================================================================
# HOT STANDBY SETTINGS
# =============================================================================
# Enable hot standby for read queries
hot_standby = on
hot_standby_feedback = on

# Hot standby query settings
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s

# =============================================================================
# RECOVERY SETTINGS
# =============================================================================
# Primary connection info (will be set by setup script)
# primary_conninfo is set dynamically in setup-replica.sh

# Recovery settings
recovery_target_timeline = 'latest'
standby_mode = on

# =============================================================================
# QUERY TUNING (Optimized for reads)
# =============================================================================
# Random page cost (lower for SSD)
random_page_cost = 1.1

# Effective I/O concurrency
effective_io_concurrency = 200

# Read-ahead settings
seq_page_cost = 1.0

# =============================================================================
# LOGGING
# =============================================================================
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-replica-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 10MB
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 2000  # Log queries taking longer than 2 seconds

# Log replication activity
log_replication_commands = on

# =============================================================================
# PERFORMANCE TUNING (Read-optimized)
# =============================================================================
# Checkpoint settings (less frequent on replica)
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 1GB
min_wal_size = 80MB

# Background writer (less aggressive on replica)
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 50
bgwriter_lru_multiplier = 1.0

# =============================================================================
# LOCK MANAGEMENT
# =============================================================================
deadlock_timeout = 1s
lock_timeout = 30s
statement_timeout = 120s  # Shorter timeout for read queries

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================
default_text_search_config = 'pg_catalog.english'
timezone = 'America/New_York'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# =============================================================================
# READ-ONLY OPTIMIZATIONS
# =============================================================================
# Since this is a read replica, optimize for read performance
default_transaction_read_only = on
